var co=Object.defineProperty;var lo=(s,t,a)=>t in s?co(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a;var J=(s,t,a)=>lo(s,typeof t!="symbol"?t+"":t,a);import{q as mo,j as e,$ as uo,t as ho,v as po,r as l,w as xo,i as se,x as Fs,y as vs,L as ve,z as we,A as Re,B as vr,C as go,D as er,E as sr,F as Le,G as le,H as Se,I as tr,J as ar,K as xt,M as xe,W as Bt,N as Ge,O as fo,P as wa,Q as jo,S as vo,T as yr,U as br,V as yo,X as bo,Y as wo,Z as rr,_ as nr,a0 as Js,a1 as Ot,a2 as ge,a3 as No,a4 as at,a5 as So,a6 as da,a7 as ma,a8 as ua,a9 as rt,aa as ta,ab as Co,ac as wr,ad as St,ae as Nr,af as Sr,ag as Cr,ah as bt,ai as ko,aj as kr,ak as _r,al as _o,am as Ro,an as To,ao as Ao}from"./vendor-CEP8mb-O.js";import{C as Rr,P as Eo,R as Do,T as Po,S as Xs,a as Tr,b as Ar,c as Io,d as Er,I as Dr,e as Pr,f as Ir,g as Mr,L as Br,h as Or,i as Mo,j as Bo,k as Fr,l as Lr,F as qr,O as Ft,m as Ur,n as Lt,o as $r,p as qt,D as Ut,q as zr,r as Vr,s as Gr,t as Hr,u as Yr,v as Oo,w as Wr,x as Qr,y as Fo,z as Kr,V as Lo,A as Jr,B as Xr,E as qo,G as Uo,H as Zr,J as $o,K as zo,M as Vo,N as en,Q as Go,U as Ho,W as sn,X as Yo,Y as tn,Z as Wo,_ as an,$ as rn,a0 as Qo,a1 as nn,a2 as Ko,a3 as on,a4 as cn,a5 as ln,a6 as dn,a7 as mn,a8 as Jo,a9 as un,aa as hn,ab as pn,ac as Xo,ad as xn,ae as gn,af as Zo,ag as ec,ah as fn,ai as sc,aj as jn,ak as vn,al as yn,am as bn,an as wn,ao as Nn,ap as tc}from"./ui-components-BlaVsD5w.js";import{L as Ke,T as _e,C as js,a as Is,b as Na,G as ac,M as qe,c as Sa,U as Be,d as rc,S as nc,e as X,f as Ls,X as rs,g as Ms,h as Sn,i as $t,j as Ca,k as ic,l as oc,m as Cn,n as de,H as ws,E as Ct,o as nt,p as te,V as ne,q as Ss,r as os,s as gt,t as hs,u as Je,v as fe,R as ns,w as Ws,x as ft,y as ha,Q as cc,z as Ns,W as Xe,A as Cs,B as Qs,D as ds,F as lc,I as dt,J as dc,K as mc,N as pa,Z as ka,O as uc,P as hc,Y as pc,_ as zt,$ as us,a0 as xc,a1 as gc,a2 as fc,a3 as jc,a4 as vc,a5 as yc,a6 as Rt,a7 as bc,a8 as _a,a9 as wc,aa as kn,ab as Nc,ac as _n,ad as Sc,ae as Cc,af as kc,ag as _c,ah as Rc,ai as is,aj as qs,ak as Vt,al as Ra,am as Rn,an as Ta,ao as Aa,ap as mt,aq as ut,ar as Tc,as as Pe,at as Tn,au as An,av as Tt,aw as Ac,ax as Ec,ay as Ea,az as Da,aA as Dc,aB as En,aC as Pc,aD as Ic,aE as Dn,aF as Mc,aG as Bc,aH as Oc,aI as Fc,aJ as Lc}from"./icons-DGk-eOq0.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();const qc=({...s})=>{const{theme:t="system"}=mo();return e.jsx(uo,{theme:t,className:"toaster group",toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...s})};function C(...s){return ho(po(s))}const Pa=Eo,Uc=Do,$c=Po,Pn=l.forwardRef(({className:s,sideOffset:t=4,...a},r)=>e.jsx(Rr,{ref:r,sideOffset:t,className:C("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...a}));Pn.displayName=Rr.displayName;const zc="https://mlevmxueubhwfezfujxa.supabase.co",Vc="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sZXZteHVldWJod2ZlemZ1anhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2MjY0NjgsImV4cCI6MjA1OTIwMjQ2OH0.hDfCn3jPrAf-Tmru1jB3W3liMUtw8QXzC-4jzt99A3I",w=xo(zc,Vc,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storageKey:"mindbloom-auth",storage:typeof window<"u"?window.localStorage:void 0,flowType:"pkce"},db:{schema:"public"},global:{headers:{"Content-Type":"application/json","X-Client-Info":"mindbloom-web@1.0.0"},fetch:(s,t={})=>fetch(s,{...t,keepalive:!0})},realtime:{params:{eventsPerSecond:2}}});typeof window<"u"&&w.auth.getSession().catch(()=>{});const Gc=Object.freeze(Object.defineProperty({__proto__:null,supabase:w},Symbol.toStringTag,{value:"Module"})),Rs=class Rs{constructor(){J(this,"healthInterval",null);J(this,"retryCount",0);J(this,"maxRetries",3);J(this,"backoffDelay",1e3)}static getInstance(){return Rs.instance||(Rs.instance=new Rs),Rs.instance}startMonitoring(t=6e4){this.healthInterval||(this.performHealthCheck(),this.healthInterval=setInterval(()=>{this.performHealthCheck()},t))}stopMonitoring(){this.healthInterval&&(clearInterval(this.healthInterval),this.healthInterval=null)}async performHealthCheck(){const t=performance.now(),a={database:{connected:!1,responseTime:0,errorRate:0},webrtc:{available:!1,supportLevel:"none"},network:{online:navigator.onLine},performance:{totalResponseTime:0,memoryUsage:0,cpuUsage:0}};try{return await this.checkDatabaseHealth(a),this.checkWebRTCSupport(a),await this.checkNetworkQuality(a),this.collectPerformanceMetrics(a,t),await this.storeHealthCheck(a),this.retryCount=0,a}catch(r){throw await this.handleHealthCheckError(r,a),r}}async checkDatabaseHealth(t){const a=performance.now();let r=0;for(;r<=this.maxRetries;)try{const{error:n}=await w.from("health_checks").select("id").limit(1);if(t.database.responseTime=performance.now()-a,t.database.connected=!n,!n)break;r++,r<=this.maxRetries&&await new Promise(o=>setTimeout(o,this.backoffDelay*r))}catch(n){if(r++,r>this.maxRetries)throw n;await new Promise(o=>setTimeout(o,this.backoffDelay*r))}}checkWebRTCSupport(t){var o;const a=!!window.RTCPeerConnection,r=!!((o=navigator.mediaDevices)!=null&&o.getUserMedia),n=!!navigator.mediaDevices;a&&r&&n?(t.webrtc.available=!0,t.webrtc.supportLevel="full"):a?(t.webrtc.available=!0,t.webrtc.supportLevel="partial"):(t.webrtc.available=!1,t.webrtc.supportLevel="none")}async checkNetworkQuality(t){if(t.network.online=navigator.onLine,"connection"in navigator){const a=navigator.connection;t.network.effectiveType=a==null?void 0:a.effectiveType,t.network.rtt=a==null?void 0:a.rtt,t.network.downlink=a==null?void 0:a.downlink}if(t.network.online)try{const a=performance.now();await fetch("/health",{method:"HEAD",cache:"no-cache"}).catch(()=>{}),t.network.rtt=performance.now()-a}catch{}}collectPerformanceMetrics(t,a){if(t.performance.totalResponseTime=performance.now()-a,"memory"in performance){const r=performance.memory;t.performance.memoryUsage=r.usedJSHeapSize/(1024*1024)}t.performance.cpuUsage=Math.min(t.performance.totalResponseTime/10,100)}async storeHealthCheck(t){const r={service_name:"enhanced_client_monitoring",status:this.calculateOverallStatus(t),response_time_ms:Math.round(t.performance.totalResponseTime),database_connected:t.database.connected,webrtc_available:t.webrtc.available,metadata:{webrtc_support:t.webrtc.supportLevel,network_type:t.network.effectiveType,network_rtt:t.network.rtt,memory_usage_mb:t.performance.memoryUsage,timestamp:new Date().toISOString()}};await w.from("health_checks").insert([r]),Ds.getInstance().recordMetric("health_check_response_time",t.performance.totalResponseTime),Ds.getInstance().recordMetric("database_response_time",t.database.responseTime),Ds.getInstance().recordMetric("memory_usage_mb",t.performance.memoryUsage)}calculateOverallStatus(t){return!t.database.connected||!t.network.online||!t.webrtc.available||t.webrtc.supportLevel==="none"?"unhealthy":t.database.responseTime>5e3||t.performance.totalResponseTime>3e3||t.webrtc.supportLevel==="partial"?"degraded":"healthy"}async handleHealthCheckError(t,a){this.retryCount++;const r={retryCount:this.retryCount,metrics:a,timestamp:new Date().toISOString()};if(Ks.getInstance().reportError(t,"health_check_failed",r),this.retryCount>=this.maxRetries)try{await w.from("health_checks").insert([{service_name:"enhanced_client_monitoring",status:"unhealthy",response_time_ms:Math.round(a.performance.totalResponseTime),database_connected:!1,webrtc_available:a.webrtc.available,error_message:t.message,metadata:{error_context:r,timestamp:new Date().toISOString()}}])}catch(n){console.error("Failed to store error health check:",n)}}async getHealthStatus(){try{return await this.performHealthCheck()}catch(t){return console.error("Failed to get health status:",t),null}}};J(Rs,"instance");let xa=Rs;const Hc=xa.getInstance(),kt={MAX_PARTICIPANTS_PER_SESSION:20,MAX_SESSION_DURATION_HOURS:4,SESSION_CLEANUP_INTERVAL_MINUTES:5,MIN_BANDWIDTH_KBPS:100,TARGET_BANDWIDTH_KBPS:500,MAX_BANDWIDTH_KBPS:2e3,CONNECTION_TIMEOUT_MS:1e4,RECONNECTION_ATTEMPTS:3,RECONNECTION_DELAY_MS:2e3,ANALYTICS_BATCH_SIZE:50,ANALYTICS_FLUSH_INTERVAL_MS:3e4,ERROR_REPORTING_ENABLED:!0,DETAILED_ERROR_LOGGING:!1,FEATURES:{RECORDING_ENABLED:!1,SCREEN_SHARING_ENABLED:!0,CHAT_ENABLED:!0,BANDWIDTH_OPTIMIZATION:!0,AUTOMATIC_RECONNECTION:!0}},Yc=()=>window.location.hostname!=="localhost"&&!window.location.hostname.includes("127.0.0.1")&&!window.location.hostname.includes(".local"),Ts=class Ts{constructor(){J(this,"metrics",new Map);J(this,"flushInterval",null)}static getInstance(){return Ts.instance||(Ts.instance=new Ts),Ts.instance}startMonitoring(){this.flushInterval||(this.flushInterval=setInterval(()=>{this.flushMetrics()},kt.ANALYTICS_FLUSH_INTERVAL_MS))}stopMonitoring(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flushMetrics()}recordMetric(t,a){this.metrics.has(t)||this.metrics.set(t,[]);const r=this.metrics.get(t);r.push(a),r.length>kt.ANALYTICS_BATCH_SIZE&&r.splice(0,r.length-kt.ANALYTICS_BATCH_SIZE)}async flushMetrics(){if(this.metrics.size===0)return;const t=new Map(this.metrics);this.metrics.clear();try{const a=Array.from(t.entries()).map(([r,n])=>({metric_name:r,count:n.length,average:n.reduce((o,i)=>o+i,0)/n.length,min:Math.min(...n),max:Math.max(...n),timestamp:new Date().toISOString()}));await w.from("performance_metrics").insert(a)}catch(a){console.error("Failed to flush performance metrics:",a)}}};J(Ts,"instance");let Ds=Ts;const As=class As{constructor(){J(this,"errorQueue",[])}static getInstance(){return As.instance||(As.instance=new As),As.instance}initialize(){window.onerror=(t,a,r,n,o)=>{this.reportError(o||new Error(String(t)),"global_error",{source:a,lineno:r,colno:n})},window.onunhandledrejection=t=>{this.reportError(new Error(t.reason),"unhandled_promise_rejection")}}async reportError(t,a,r){try{const n={error_message:t.message,error_stack:t.stack,context:a,additional_data:r,timestamp:new Date().toISOString(),user_agent:navigator.userAgent,url:window.location.href,user_id:await this.getCurrentUserId()};Yc()?(this.errorQueue.push({error:t,context:a,timestamp:n.timestamp,userId:n.user_id}),this.errorQueue.length>=10&&await this.flushErrors()):await w.from("error_logs").insert([n]),kt.DETAILED_ERROR_LOGGING}catch(n){console.error("Failed to report error:",n)}}async flushErrors(){if(this.errorQueue.length===0)return;const t=[...this.errorQueue];this.errorQueue=[];try{const a=t.map(r=>({error_message:r.error.message,error_stack:r.error.stack,context:r.context,timestamp:r.timestamp,user_id:r.userId,user_agent:navigator.userAgent,url:window.location.href}));await w.from("error_logs").insert(a)}catch(a){console.error("Failed to flush error reports:",a),this.errorQueue.unshift(...t)}}async getCurrentUserId(){try{const{data:{user:t}}=await w.auth.getUser();return(t==null?void 0:t.id)||null}catch{return null}}};J(As,"instance");let Ks=As;const Wc=async()=>{try{Ks.getInstance().initialize(),Ds.getInstance().startMonitoring(),Hc.startMonitoring(),await Qc(),console.log("Production services initialized successfully")}catch(s){console.error("Failed to initialize production services:",s)}},Qc=async()=>{try{const{error:s}=await w.rpc("cleanup_expired_instant_sessions");if(s)throw s}catch(s){Ks.getInstance().reportError(s,"session_cleanup_failed")}},aa=Ds.getInstance(),Kc=Ks.getInstance();class Jc extends se.Component{constructor(a){super(a);J(this,"resetError",()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0})});this.state={hasError:!1}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,r){var n,o;this.setState({errorInfo:r}),Kc.reportError(a,this.props.context||"react_error_boundary",{componentStack:r.componentStack,errorBoundary:this.constructor.name}),(o=(n=this.props).onError)==null||o.call(n,a,r)}render(){if(this.state.hasError&&this.state.error){if(this.props.fallback){const a=this.props.fallback;return e.jsx(a,{error:this.state.error,resetError:this.resetError})}return e.jsx(Xc,{error:this.state.error,resetError:this.resetError})}return this.props.children}}const Xc=({error:s,resetError:t})=>e.jsx("div",{className:"min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8",children:e.jsx("div",{className:"sm:mx-auto sm:w-full sm:max-w-md",children:e.jsx("div",{className:"bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100",children:e.jsx("svg",{className:"h-6 w-6 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900",children:"Something went wrong"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"We're sorry, but something unexpected happened. Our team has been notified."}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{onClick:t,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Try again"})}),!1]})})})}),In=s=>{const t=l.useRef(0),a=l.useRef(0);l.useEffect(()=>(a.current=performance.now(),aa.recordMetric(`${s}_mount_time`,a.current),()=>{const o=performance.now();aa.recordMetric(`${s}_lifetime`,o-a.current)}),[s]);const r=l.useCallback(()=>{t.current=performance.now()},[]),n=l.useCallback(()=>{if(t.current>0){const o=performance.now()-t.current;aa.recordMetric(`${s}_render_time`,o),t.current=0}},[s]);return{startRender:r,endRender:n}},Zc=({children:s})=>{const{startRender:t,endRender:a}=In("ProductionWrapper");return l.useEffect(()=>{t();let r=!1;(async()=>{r||(r=!0,await Wc())})(),a()},[t,a]),e.jsx(Jc,{context:"main_application",children:s})},el=({children:s,showHealthIndicator:t=!0})=>{const{startRender:a,endRender:r}=In("ProductionLayout");return l.useEffect(()=>(a(),()=>r()),[a,r]),e.jsxs("div",{className:"min-h-screen bg-background",children:[t&&e.jsx(sl,{}),e.jsx(Zc,{children:s})]})},sl=()=>{const[s,t]=se.useState(!1),[a,r]=se.useState("healthy");if(l.useEffect(()=>{t(a!=="healthy")},[a]),!s)return null;const n={healthy:"bg-green-500",degraded:"bg-yellow-500",unhealthy:"bg-red-500"};return e.jsx("div",{className:"fixed top-4 right-4 z-50",children:e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-white shadow-lg rounded-full border",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${n[a]}`}),e.jsx("span",{className:"text-xs font-medium capitalize",children:a})]})})},tl=20,Vs=[],al=()=>Math.random().toString(36).substring(2,9);function Ia({title:s,description:t,action:a,...r}){const o={id:al(),title:s,description:t,action:a,...r};return Vs.push(o),Vs.length>tl&&Vs.shift(),o}const rl=l.createContext({toasts:[],toast:Ia,dismiss:()=>{}});function Mn(){const s=l.useContext(rl);return s===void 0?{toasts:Vs,toast:Ia,dismiss:t=>{if(t){const a=Vs.findIndex(r=>r.id===t);a!==-1&&Vs.splice(a,1)}}}:s}const Z=Mn,ls=Ia,Bn=l.createContext(void 0),nl=({children:s})=>{const[t,a]=l.useState(null),[r,n]=l.useState(null),[o,i]=l.useState(!0),[c,u]=l.useState(!1),[m,h]=l.useState([]),[p,d]=l.useState([]),[x,j]=l.useState(!1),{toast:g}=Z(),v=U=>{var ee;if(!U)return console.log("[AuthRBAC] No user provided to getUserRolesFromMetadata"),[];const G=(ee=U==null?void 0:U.raw_user_meta_data)==null?void 0:ee.accountType;return console.log("[AuthRBAC] User ID:",U.id),console.log("[AuthRBAC] Full metadata:",U.raw_user_meta_data),console.log("[AuthRBAC] Extracting role from metadata accountType:",G),G&&["admin","therapist","patient","support"].includes(G)?(console.log("[AuthRBAC] Valid role found in metadata:",G),[G]):(console.log("[AuthRBAC] No valid role in metadata, will attempt database fallback"),[])},f=async U=>{try{console.log("[AuthRBAC] Fetching roles from database for user:",U);const{data:G,error:ee}=await w.rpc("get_user_roles",{p_user_id:U});if(ee)return console.error("[AuthRBAC] Database role fetch error:",ee),["patient"];if(G&&Array.isArray(G)&&G.length>0){const K=G.map(ie=>ie.role_name).filter(Boolean);return console.log("[AuthRBAC] Database roles found:",K),K.length>0?K:["patient"]}return console.log("[AuthRBAC] No roles found in database, defaulting to patient"),["patient"]}catch(G){return console.error("[AuthRBAC] Error fetching roles from database:",G),["patient"]}};l.useEffect(()=>{let U=!0;console.log("[AuthRBAC] Initializing auth...");const{data:{subscription:G}}=w.auth.onAuthStateChange((K,ie)=>{if(U)if(console.log("[AuthRBAC] Auth state changed:",K,!!ie),n(ie),a((ie==null?void 0:ie.user)??null),ie!=null&&ie.user){const pe=v(ie.user);pe.length>0?(h(pe),j(!0),console.log("[AuthRBAC] Set roles from metadata:",pe)):(console.log("[AuthRBAC] Metadata roles empty, attempting database fallback"),j(!1),f(ie.user.id).then(W=>{U&&(h(W),j(!0),console.log("[AuthRBAC] Set roles from database fallback:",W))}).catch(W=>{console.error("[AuthRBAC] Database fallback failed:",W),U&&(h(["patient"]),j(!0))}))}else console.log("[AuthRBAC] No session, clearing roles"),h([]),d([]),j(!1)});return(async()=>{try{const{data:{session:K},error:ie}=await w.auth.getSession();if(ie){console.error("[AuthRBAC] Session error:",ie);return}if(console.log("[AuthRBAC] Initial session:",!!K),n(K),a((K==null?void 0:K.user)??null),K!=null&&K.user){const pe=v(K.user);pe.length>0?(h(pe),j(!0),console.log("[AuthRBAC] Set initial roles from metadata:",pe)):(console.log("[AuthRBAC] Initial metadata roles empty, attempting database fallback"),f(K.user.id).then(W=>{U&&(h(W),j(!0),console.log("[AuthRBAC] Set initial roles from database:",W))}).catch(W=>{console.error("[AuthRBAC] Initial database fallback failed:",W),U&&(h(["patient"]),j(!0))}))}else j(!0)}catch(K){console.error("[AuthRBAC] Failed to get session:",K)}finally{i(!1),u(!0),console.log("[AuthRBAC] Auth initialization completed")}})(),()=>{U=!1,G.unsubscribe()}},[]);const y=async()=>{if(t!=null&&t.id)try{j(!1),console.log("[AuthRBAC] Refreshing roles for user:",t.id);const{data:{user:U}}=await w.auth.getUser(),G=v(U);if(G.length>0)h(G),j(!0),console.log("[AuthRBAC] Refreshed roles from metadata:",G);else{const ee=await f(t.id);h(ee),j(!0),console.log("[AuthRBAC] Refreshed roles from database:",ee)}}catch(U){console.error("[AuthRBAC] Error refreshing roles:",U),h(["patient"]),j(!0)}},b=async()=>{var U;try{if(!(t!=null&&t.id))return!1;const{data:{user:G}}=await w.auth.getUser(),ee=(U=G==null?void 0:G.raw_user_meta_data)==null?void 0:U.accountType;return ee&&["admin","therapist","patient","support"].includes(ee)}catch(G){return console.error("[AuthRBAC] Consistency check failed:",G),!1}},_=async()=>{try{console.log("[AuthRBAC] Signing out..."),await w.auth.signOut(),a(null),n(null),h([]),d([]),j(!1),console.log("[AuthRBAC] Sign out completed")}catch(U){console.error("[AuthRBAC] Sign out error:",U),g({title:"Error",description:"Failed to sign out. Please try again.",variant:"destructive"})}},k=U=>m.includes(U),S=U=>U.some(G=>k(G)),E=U=>U.every(G=>k(G)),B=!!t,M=k("admin"),q=k("therapist"),F=k("patient"),P=k("support"),L=m[0],Y={user:t,session:r,isAuthenticated:B,isInitialized:c,loading:o,rolesLoaded:x,userRoles:m,roles:m,primaryRole:L,permissions:p,hasRole:k,hasAnyRole:S,hasAllRoles:E,isAdmin:M,isTherapist:q,isPatient:F,isSupport:P,hasPermission:U=>p.some(G=>G.name===U),checkPermissions:(U,G)=>G!=null&&G.requireAll?U.every(ee=>p.some(K=>K.name===ee.name)):U.some(ee=>p.some(K=>K.name===ee.name)),getFieldAccess:U=>({readOnly:!M&&!q,hidden:!1,mask:!1}),signOut:_,refreshRoles:y,performConsistencyCheck:b};return e.jsx(Bn.Provider,{value:Y,children:s})},V=()=>{const s=l.useContext(Bn);if(s===void 0)throw new Error("useAuthRBAC must be used within an AuthRBACProvider");return s};function it({className:s,...t}){return e.jsx("div",{className:C("animate-pulse rounded-md bg-muted",s),...t})}const Bs=({variant:s="spinner",size:t="md",text:a="Loading...",className:r,fullscreen:n=!1,isLoading:o=!0,children:i})=>{if(!o)return e.jsx(e.Fragment,{children:i});const c={sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"},u=C("flex flex-col items-center justify-center",n?"min-h-screen fixed inset-0 bg-background/80 backdrop-blur-sm z-50":"py-6",r);return e.jsxs("div",{className:u,role:"status","aria-live":"polite",children:[s==="spinner"&&e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:C(c[t],"animate-spin text-primary")}),a&&e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:a})]}),s==="skeleton"&&e.jsxs("div",{className:"w-full space-y-2",children:[e.jsx(it,{className:"h-8 w-full"}),e.jsx(it,{className:"h-8 w-3/4"}),e.jsx(it,{className:"h-8 w-1/2"})]}),s==="progress"&&e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"h-2 w-full bg-muted overflow-hidden rounded-full",children:e.jsx("div",{className:"h-full bg-primary animate-pulse origin-left",style:{width:"75%"}})}),a&&e.jsx("p",{className:"mt-2 text-xs text-center text-muted-foreground",children:a})]})]})};class il extends l.Component{constructor(t){super(t),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(t,a){console.error("Icon loading error:",t,a)}render(){return this.state.hasError?this.props.fallback||e.jsx(_e,{className:"h-4 w-4 text-muted-foreground"}):this.props.children}}const as={HOME:"/",LOGIN:"/login",REGISTER:"/register",DASHBOARD:"/dashboard",ADMIN_DASHBOARD:"/admin",THERAPIST_DASHBOARD:"/therapist",PATIENT_DASHBOARD:"/patient"};function Gs(s){switch(console.log("[UnifiedRouteConfig] Getting dashboard for role:",s),s){case"admin":return as.ADMIN_DASHBOARD;case"therapist":return as.THERAPIST_DASHBOARD;case"patient":case"support":default:return as.PATIENT_DASHBOARD}}function ol(){return as.LOGIN}function cl(s,t,a){const r=[],n=t[0];return console.log("[RouteValidator] Validating:",{currentPath:s,userRoles:t,isAuthenticated:a,primaryRole:n}),[as.HOME,as.LOGIN,as.REGISTER].includes(s)?{isValid:!0,redirectNeeded:!1,errors:[]}:a?s===as.DASHBOARD?{isValid:!1,expectedPath:n?Gs(n):as.PATIENT_DASHBOARD,redirectNeeded:!0,errors:["Generic dashboard should redirect to role-specific dashboard"]}:s.startsWith("/admin")&&!t.includes("admin")?(r.push("Admin access required for admin routes"),{isValid:!1,expectedPath:n?Gs(n):as.PATIENT_DASHBOARD,redirectNeeded:!0,errors:r}):s.startsWith("/therapist")&&!t.includes("therapist")&&!t.includes("admin")?(r.push("Therapist access required for therapist routes"),{isValid:!1,expectedPath:n?Gs(n):as.PATIENT_DASHBOARD,redirectNeeded:!0,errors:r}):s.startsWith("/patient")?{isValid:!0,redirectNeeded:!1,errors:[]}:{isValid:!0,redirectNeeded:!1,errors:[]}:(r.push("User not authenticated for protected route"),{isValid:!1,expectedPath:as.LOGIN,redirectNeeded:!0,errors:r})}const ll=Fs("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-therapy-purple text-white hover:bg-therapy-deep-purple",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground border-therapy-purple",warning:"border-transparent bg-amber-500 text-white hover:bg-amber-600",success:"border-transparent bg-green-500 text-white hover:bg-green-600",therapy:"border-transparent bg-therapy-purple text-white hover:bg-therapy-deep-purple","therapy-light":"border-transparent bg-therapy-light-purple text-therapy-deep-purple"}},defaultVariants:{variant:"default"}});function D({className:s,variant:t,...a}){return e.jsx("div",{className:C(ll({variant:t}),s),...a})}const dl=({showInProduction:s=!1})=>{const t=vs(),{userRoles:a,isAuthenticated:r,loading:n}=V(),[o,i]=l.useState(null);if(!s||(l.useEffect(()=>{if(!n){const c=cl(t.pathname,a,r);i(c)}},[t.pathname,a,r,n]),n||!o))return null},ht=Fs("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-therapy-purple text-white hover:bg-therapy-deep-purple",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline",success:"bg-green-500 text-white hover:bg-green-600",therapy:"bg-therapy-purple text-white hover:bg-therapy-deep-purple","therapy-outline":"border-2 border-therapy-purple text-therapy-purple hover:bg-therapy-light-purple"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),N=l.forwardRef(({className:s,variant:t,size:a,asChild:r=!1,...n},o)=>{const i=r?Xs:"button";return e.jsx(i,{className:C(ht({variant:t,size:a,className:s})),ref:o,...n})});N.displayName="Button";const On=l.createContext(void 0),ml=({children:s,defaultTheme:t="system",storageKey:a="theme"})=>{const[r,n]=l.useState(()=>{const i=localStorage.getItem(a);return i||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")});l.useEffect(()=>{const i=window.document.documentElement;if(i.classList.remove("light","dark"),r==="system"){const c=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";i.classList.add(c)}else i.classList.add(r);localStorage.setItem(a,r)},[r,a]),l.useEffect(()=>{if(r==="system"){const i=window.matchMedia("(prefers-color-scheme: dark)"),c=()=>{const u=window.document.documentElement;u.classList.remove("light","dark"),u.classList.add(i.matches?"dark":"light")};return i.addEventListener("change",c),()=>i.removeEventListener("change",c)}},[r]);const o=()=>{n(i=>i==="light"?"dark":"light")};return e.jsx(On.Provider,{value:{theme:r,setTheme:n,toggleTheme:o},children:s})},Gt=()=>{const s=l.useContext(On);if(s===void 0)throw new Error("useTheme must be used within a ThemeProvider");return s},ul={home:{en:"Home","pt-BR":"Início"},features:{en:"Features","pt-BR":"Recursos"},pricing:{en:"Pricing","pt-BR":"Preços"},login:{en:"Login","pt-BR":"Entrar"},logout:{en:"Logout","pt-BR":"Sair"},ai_chat:{en:"AI Chat","pt-BR":"Chat com IA"},aiTherapy:{en:"AI Therapy","pt-BR":"Terapia com IA"},therapists:{en:"Find Therapists","pt-BR":"Encontrar Terapeutas"},support:{en:"Support","pt-BR":"Suporte"},account:{en:"My Account","pt-BR":"Minha Conta"},admin_portal:{en:"Admin Portal","pt-BR":"Portal do Admin"},security:{en:"Security","pt-BR":"Segurança"},profile:{en:"Profile","pt-BR":"Perfil"},theme:{en:"Theme","pt-BR":"Tema"},darkMode:{en:"Dark Mode","pt-BR":"Modo Escuro"},lightMode:{en:"Light Mode","pt-BR":"Modo Claro"},welcome:{en:"Welcome","pt-BR":"Bem-vindo"},welcome_therapist:{en:"Welcome, Therapist","pt-BR":"Bem-vindo, Terapeuta"},editProfile:{en:"Edit Profile","pt-BR":"Editar Perfil"},dashboard:{en:"Dashboard","pt-BR":"Painel"},appointments:{en:"Appointments","pt-BR":"Consultas"},upcomingAppointments:{en:"Upcoming Appointments","pt-BR":"Próximas Consultas"},resources:{en:"Resources","pt-BR":"Recursos"},moodTracker:{en:"Mood Tracker","pt-BR":"Rastreador de Humor"},healthRecords:{en:"Health Records","pt-BR":"Registros de Saúde"},calendar:{en:"Calendar","pt-BR":"Calendário"},about:{en:"About","pt-BR":"Sobre"},signUp:{en:"Sign Up","pt-BR":"Cadastrar"},therapist:{en:"Therapist Dashboard","pt-BR":"Painel do Terapeuta"},patientDashboard:{en:"Patient Dashboard","pt-BR":"Painel do Paciente"},availability:{en:"Manage Availability","pt-BR":"Gerenciar Disponibilidade"},routeTypeLegend:{en:"Route Type Legend","pt-BR":"Legenda de Tipos de Rotas"},publicRoutes:{en:"Public Routes","pt-BR":"Rotas Públicas"},authRoutes:{en:"Auth Routes","pt-BR":"Rotas de Autenticação"},protectedRoutes:{en:"Protected Routes","pt-BR":"Rotas Protegidas"},adminRoutes:{en:"Admin Routes","pt-BR":"Rotas de Administrador"},accessibleToAll:{en:"Accessible to all users","pt-BR":"Acessível para todos os usuários"},requiresAuth:{en:"Requires authentication","pt-BR":"Requer autenticação"},requiresAdmin:{en:"Requires admin privileges","pt-BR":"Requer privilégios de administrador"}},hl={heroTitle:{en:"Mental wellness with support & human expertise","pt-BR":"Bem-estar mental com suporte e acompanhamento humano"},heroSubtitle:{en:"Experience therapeutic conversations with our AI assistant, and connect with licensed therapists for deeper support.","pt-BR":"Experimente conversas terapêuticas com nosso assistente de IA e conecte-se com terapeutas licenciados para um suporte mais profundo."},tryAiNow:{en:"Try AI Therapy Now","pt-BR":"Experimente a Terapia com IA Agora"},seePlans:{en:"See Plans","pt-BR":"Ver Planos"},aiGreeting:{en:"How are you feeling today? I'm here to listen and support you.","pt-BR":"Como você está se sentindo hoje? Estou aqui para ouvir e apoiar você."},userMessage:{en:"I've been feeling anxious about my upcoming presentation.","pt-BR":"Estou me sentindo ansioso com minha próxima apresentação."},aiResponse:{en:"It's completely normal to feel anxious before presentations. Let's try some breathing exercises that might help...","pt-BR":"É completamente normal sentir ansiedade antes de apresentações. Vamos tentar alguns exercícios de respiração que podem ajudar..."}},pl={featuresTitle:{en:"How MindBloom Helps You","pt-BR":"Como o MindBloom Te Ajuda"},featuresSubtitle:{en:"Our platform combines AI-powered support with human expertise to provide a comprehensive mental wellness experience.","pt-BR":"Nossa plataforma combina suporte baseado em IA com experiência humana para proporcionar uma experiência completa de bem-estar mental."},aiTherapyChat:{en:"AI Therapy Chat","pt-BR":"Chat de Terapia com IA"},aiTherapyDesc:{en:"24/7 access to our AI therapy assistant for support whenever you need it.","pt-BR":"Acesso 24/7 ao nosso assistente de terapia com IA para suporte sempre que precisar."},groupTherapy:{en:"Group Therapy","pt-BR":"Terapia em Grupo"},groupTherapyDesc:{en:"Join virtual group sessions led by licensed therapists, focused on specific topics.","pt-BR":"Participe de sessões em grupo virtuais lideradas por terapeutas licenciados, focadas em tópicos específicos."},oneOnOne:{en:"1-on-1 Sessions","pt-BR":"Sessões Individuais"},oneOnOneDesc:{en:"Connect with a licensed therapist for personalized one-on-one therapy sessions.","pt-BR":"Conecte-se com um terapeuta licenciado para sessões de terapia individuais personalizadas."},flexibleScheduling:{en:"Flexible Scheduling","pt-BR":"Agendamento Flexível"},flexibleSchedulingDesc:{en:"Book sessions at your convenience with our easy-to-use scheduling system.","pt-BR":"Agende sessões conforme sua conveniência com nosso sistema de agendamento fácil de usar."}},xl={testimonialTitle:{en:"What Our Users Say","pt-BR":"O que dizem quem experimenta"},testimonialSubtitle:{en:"Real experiences from people who have found support through MindBloom.","pt-BR":"Experiencias reais de pessoas que encontraram o apoio que precisavam na MindBloom."},testimonial1:{en:"The AI therapy sessions have been a game-changer for my daily anxiety. I can talk through my concerns anytime, and the responses are surprisingly insightful.","pt-BR":"As sessões de terapia com IA foram um divisor de águas para minha ansiedade diária. Posso conversar sobre minhas preocupações a qualquer momento e as respostas são surpreendentemente perspicazes."},testimonial2:{en:"As a therapist on the platform, I appreciate how the AI support complements my work with clients. It gives them continuous support between our sessions.","pt-BR":"Como terapeuta na plataforma, aprecio como o suporte de IA complementa meu trabalho com os clientes. Isso proporciona a eles suporte contínuo entre nossas sessões."},testimonial3:{en:"The group sessions helped me realize I wasn't alone in my struggles. Combined with the AI chat, I've developed healthier coping mechanisms.","pt-BR":"As sessões em grupo me ajudaram a perceber que não estou sozinho em minhas dificuldades. Combinado com o chat de IA, desenvolvi mecanismos de enfrentamento mais saudáveis."}},gl={pricingTitle:{en:"Simple, Transparent Pricing","pt-BR":"Preços Simples e Transparentes"},pricingSubtitle:{en:"Choose the plan that best suits your mental wellness journey. Switch or cancel anytime.","pt-BR":"Escolha o plano que melhor se adapta à sua jornada de bem-estar mental. Troque ou cancele a qualquer momento."},basic:{en:"Basic","pt-BR":"Básico"},premium:{en:"Premium","pt-BR":"Premium"},complete:{en:"Complete","pt-BR":"Completo"},free:{en:"Free","pt-BR":"Grátis"},month:{en:"/month","pt-BR":"/mês"},basicDesc:{en:"Get started with AI therapy","pt-BR":"Comece com a terapia de IA"},premiumDesc:{en:"Enhanced AI therapy with group sessions","pt-BR":"Terapia com IA aprimorada com sessões em grupo"},completeDesc:{en:"Full therapy support with 1-on-1 sessions","pt-BR":"Suporte terapêutico completo com sessões individuais"},startFree:{en:"Start Free","pt-BR":"Começar Grátis"},subscribeNow:{en:"Subscribe Now","pt-BR":"Assinar Agora"},getStarted:{en:"Get Started","pt-BR":"Começar"},mostPopular:{en:"Most Popular","pt-BR":"Mais Popular"},aiTherapyLimited:{en:"AI therapy chat (5 sessions/month)","pt-BR":"Chat de terapia com IA (5 sessões/mês)"},weeklyTips:{en:"Weekly mental wellness tips","pt-BR":"Dicas semanais de bem-estar mental"},basicTracking:{en:"Basic mood tracking","pt-BR":"Monitoramento básico de humor"},communityAccess:{en:"Community forum access","pt-BR":"Acesso ao fórum da comunidade"},aiTherapyUnlimited:{en:"Unlimited AI therapy sessions 24/7","pt-BR":"Sessões ilimitadas de terapia com IA 24/7"},groupSessionsLimited:{en:"2 group therapy sessions/month","pt-BR":"2 sessões de terapia em grupo/mês"},advancedTracking:{en:"Advanced mood & progress tracking","pt-BR":"Monitoramento avançado de humor e progresso"},personalPlan:{en:"Personalized wellness plan","pt-BR":"Plano de bem-estar personalizado"},prioritySupport:{en:"Priority support","pt-BR":"Suporte prioritário"},premiumFeatures:{en:"All Premium features","pt-BR":"Todos os recursos Premium"},oneOnOneSessions:{en:"2 one-on-one sessions with licensed therapists/month","pt-BR":"2 sessões individuais com terapeutas licenciados/mês"},groupSessionsExtended:{en:"4 group therapy sessions/month","pt-BR":"4 sessões de terapia em grupo/mês"},therapistMatching:{en:"Therapist matching service","pt-BR":"Serviço de correspondência com terapeuta"},resourceLibrary:{en:"Full access to resource library","pt-BR":"Acesso completo à biblioteca de recursos"},support247:{en:"24/7 priority support","pt-BR":"Suporte prioritário 24/7"}},fl={ctaTitle:{en:"Start Your Wellness Journey Today","pt-BR":"Comece Sua Jornada de Bem-Estar Hoje"},ctaSubtitle:{en:"Take the first step towards better mental health with AI-powered therapy and human support from licensed professionals.","pt-BR":"Dê o primeiro passo em direção a uma melhor saúde mental com terapia baseada em IA e suporte humano de profissionais licenciados."},signUpFree:{en:"Sign Up Free","pt-BR":"Cadastre-se Grátis"},tryAiTherapy:{en:"Try AI Therapy","pt-BR":"Experimente a Terapia com IA"}},jl={services:{en:"Services","pt-BR":"Serviços"},company:{en:"Company","pt-BR":"Empresa"},legal:{en:"Legal","pt-BR":"Legal"},footerDescription:{en:"AI-powered therapy combined with human expertise for comprehensive mental wellness support.","pt-BR":"Terapia com IA combinada com expertise humana para um suporte abrangente de bem-estar mental."},footerAboutUs:{en:"About Us","pt-BR":"Sobre Nós"},forTherapists:{en:"For Therapists","pt-BR":"Para Terapeutas"},blog:{en:"Blog","pt-BR":"Blog"},careers:{en:"Careers","pt-BR":"Carreiras"},privacyPolicy:{en:"Privacy Policy","pt-BR":"Política de Privacidade"},termsOfService:{en:"Terms of Service","pt-BR":"Termos de Serviço"},hipaaCompliance:{en:"HIPAA Compliance","pt-BR":"Conformidade HIPAA"},hipaaRoadmap:{en:"HIPAA Roadmap","pt-BR":"Roteiro HIPAA"},cookiePolicy:{en:"Cookie Policy","pt-BR":"Política de Cookies"},copyright:{en:"All rights reserved.","pt-BR":"Todos os direitos reservados."},projectDocumentation:{en:"Project Documentation","pt-BR":"Documentação do Projeto"}},vl={loginTitle:{en:"Login","pt-BR":"Entrar"},loginSubtitle:{en:"Enter your email and password to access your account","pt-BR":"Digite seu email e senha para acessar sua conta"},email:{en:"Email","pt-BR":"Email"},password:{en:"Password","pt-BR":"Senha"},forgotPassword:{en:"Forgot password?","pt-BR":"Esqueceu a senha?"},signingIn:{en:"Signing in...","pt-BR":"Entrando..."},signIn:{en:"Sign in","pt-BR":"Entrar"},orContinueWith:{en:"Or continue with","pt-BR":"Ou continue com"},dontHaveAccount:{en:"Don't have an account?","pt-BR":"Não tem uma conta?"},needHelp:{en:"Need Help?","pt-BR":"Precisa de Ajuda?"},signUp:{en:"Sign up","pt-BR":"Cadastrar"},forTherapists:{en:"For Therapists","pt-BR":"Para Terapeutas"}},yl={termsOfServiceTitle:{en:"Terms of Service","pt-BR":"Termos de Serviço"},termsLastUpdated:{en:"Last Updated","pt-BR":"Última atualização"},termsResponsible:{en:"Responsible","pt-BR":"Responsável"},termsContact:{en:"Contact","pt-BR":"Contato"}},bl={privacyPolicy:{en:"Privacy Policy","pt-BR":"Política de Privacidade"},hipaaCompliance:{en:"HIPAA Compliance","pt-BR":"Conformidade HIPAA"},dataEncryption:{en:"Data Encryption","pt-BR":"Criptografia de Dados"},consentRequired:{en:"Consent Required","pt-BR":"Consentimento Necessário"},hipaaConsentTitle:{en:"HIPAA Consent","pt-BR":"Consentimento HIPAA"},hipaaConsentDescription:{en:"I consent to the collection and processing of my health information in accordance with HIPAA regulations and MindBloom's Privacy Policy.","pt-BR":"Eu consinto com a coleta e processamento das minhas informações de saúde de acordo com as regulamentações HIPAA e a Política de Privacidade da MindBloom."},iAgree:{en:"I Agree","pt-BR":"Eu Concordo"},iDisagree:{en:"I Disagree","pt-BR":"Eu Discordo"},hipaaPrivacyTitle:{en:"HIPAA Privacy Practices","pt-BR":"Práticas de Privacidade HIPAA"},consentSuccess:{en:"Thank you for providing your consent.","pt-BR":"Obrigado por fornecer seu consentimento."},sessionWarningTitle:{en:"Session Timeout Warning","pt-BR":"Aviso de Tempo Limite da Sessão"},sessionWarningDescription:{en:"Your session is about to expire due to inactivity. Do you want to continue?","pt-BR":"Sua sessão está prestes a expirar devido à inatividade. Deseja continuar?"},continueSession:{en:"Continue Session","pt-BR":"Continuar Sessão"},sessionExpiredTitle:{en:"Session Expired","pt-BR":"Sessão Expirada"},sessionExpiredDescription:{en:"Your session has expired due to inactivity. Please log in again.","pt-BR":"Sua sessão expirou devido à inatividade. Por favor, faça login novamente."},videoSession:{en:"Video Session","pt-BR":"Sessão de Vídeo"},recordingConsentTitle:{en:"Session Recording Consent","pt-BR":"Consentimento para Gravação de Sessão"},recordingConsentDescription:{en:"Your therapist has requested permission to record this session","pt-BR":"Seu terapeuta solicitou permissão para gravar esta sessão"},giveConsent:{en:"Give Consent","pt-BR":"Dar Consentimento"},declineConsent:{en:"Decline","pt-BR":"Recusar"},waitingRoom:{en:"Waiting Room","pt-BR":"Sala de Espera"},admitPatient:{en:"Admit Patient","pt-BR":"Admitir Paciente"},joinSession:{en:"Join Session","pt-BR":"Entrar na Sessão"},leaveSession:{en:"Leave Session","pt-BR":"Sair da Sessão"},deviceSettings:{en:"Device Settings","pt-BR":"Configurações de Dispositivo"},testDevices:{en:"Test Devices","pt-BR":"Testar Dispositivos"}},wl={hipaaRoadmap:{en:"HIPAA Compliance Roadmap","pt-BR":"Roteiro de Conformidade HIPAA"},currentStatus:{en:"Current Implementation Status","pt-BR":"Status Atual de Implementação"},implementationPlan:{en:"90-Day Implementation Plan","pt-BR":"Plano de Implementação de 90 Dias"},implemented:{en:"Implemented","pt-BR":"Implementado"},inProgress:{en:"In Progress","pt-BR":"Em Andamento"},planned:{en:"Planned","pt-BR":"Planejado"},technicalMeasures:{en:"Technical Measures","pt-BR":"Medidas Técnicas"},administrativeMeasures:{en:"Administrative Measures","pt-BR":"Medidas Administrativas"},physicalMeasures:{en:"Physical Measures","pt-BR":"Medidas Físicas"},dataEncryption:{en:"Data Encryption","pt-BR":"Criptografia de Dados"},dataEncryptionDesc:{en:"All data is encrypted in transit and at rest using industry-standard protocols.","pt-BR":"Todos os dados são criptografados em trânsito e em repouso usando protocolos padrão da indústria."},accessControl:{en:"Access Control","pt-BR":"Controle de Acesso"},accessControlDesc:{en:"Role-based access controls and multi-factor authentication for all system users.","pt-BR":"Controles de acesso baseados em função e autenticação multifator para todos os usuários do sistema."},auditLogging:{en:"Audit Logging","pt-BR":"Registro de Auditoria"},auditLoggingDesc:{en:"Comprehensive audit logs for all PHI access, modification, and transmission events.","pt-BR":"Registros de auditoria abrangentes para todos os eventos de acesso, modificação e transmissão de PHI."},backupRecovery:{en:"Backup & Recovery","pt-BR":"Backup e Recuperação"},backupRecoveryDesc:{en:"Secure, encrypted backups and tested disaster recovery procedures.","pt-BR":"Backups seguros e criptografados e procedimentos de recuperação de desastres testados."},securityRiskAssessment:{en:"Security Risk Assessment","pt-BR":"Avaliação de Risco de Segurança"},securityRiskAssessmentDesc:{en:"Regular security risk assessments to identify and mitigate vulnerabilities.","pt-BR":"Avaliações regulares de risco de segurança para identificar e mitigar vulnerabilidades."},trainingProgram:{en:"Training Program","pt-BR":"Programa de Treinamento"},trainingProgramDesc:{en:"Comprehensive HIPAA training program for all staff members.","pt-BR":"Programa abrangente de treinamento HIPAA para todos os membros da equipe."},policiesProcedures:{en:"Policies & Procedures","pt-BR":"Políticas e Procedimentos"},policiesProceduresDesc:{en:"Documented policies and procedures for handling PHI and security incidents.","pt-BR":"Políticas e procedimentos documentados para lidar com PHI e incidentes de segurança."},businessAssociates:{en:"Business Associates","pt-BR":"Associados de Negócios"},businessAssociatesDesc:{en:"Business Associate Agreements with all vendors who handle PHI.","pt-BR":"Acordos de Associado de Negócios com todos os fornecedores que lidam com PHI."},facilityAccess:{en:"Facility Access Controls","pt-BR":"Controles de Acesso às Instalações"},facilityAccessDesc:{en:"Physical safeguards for facilities housing systems with PHI.","pt-BR":"Salvaguardas físicas para instalações que abrigam sistemas com PHI."},dataDisposal:{en:"Data Disposal","pt-BR":"Descarte de Dados"},dataDisposalDesc:{en:"Proper disposal of PHI and media containing PHI.","pt-BR":"Descarte adequado de PHI e mídia contendo PHI."},phase1:{en:"Phase 1: Foundations (Days 1-30)","pt-BR":"Fase 1: Fundamentos (Dias 1-30)"},phase2:{en:"Phase 2: Implementation (Days 31-60)","pt-BR":"Fase 2: Implementação (Dias 31-60)"},phase3:{en:"Phase 3: Refinement (Days 61-90)","pt-BR":"Fase 3: Refinamento (Dias 61-90)"},phase1Tasks:{en:"Complete risk assessment, establish encryption standards, implement access controls","pt-BR":"Completar avaliação de risco, estabelecer padrões de criptografia, implementar controles de acesso"},phase2Tasks:{en:"Develop policies and procedures, implement audit logging, establish backup procedures","pt-BR":"Desenvolver políticas e procedimentos, implementar registro de auditoria, estabelecer procedimentos de backup"},phase3Tasks:{en:"Conduct training, finalize documentation, perform security testing, prepare for audit","pt-BR":"Conduzir treinamento, finalizar documentação, realizar testes de segurança, preparar para auditoria"},contactUs:{en:"Questions about our HIPAA compliance efforts? ","pt-BR":"Perguntas sobre nossos esforços de conformidade HIPAA? "},contactLink:{en:"Contact our Privacy Officer","pt-BR":"Entre em contato com nosso Oficial de Privacidade"}},Nl={securitySettings:{en:"Security Settings","pt-BR":"Configurações de Segurança"},securitySettingsDescription:{en:"Manage your account security settings","pt-BR":"Gerencie as configurações de segurança da sua conta"},twoFactorAuth:{en:"Two-Factor Authentication","pt-BR":"Autenticação de Dois Fatores"},twoFactorVerification:{en:"Two-Factor Verification","pt-BR":"Verificação de Dois Fatores"},enterCodeFromApp:{en:"Enter the 6-digit code from your authenticator app","pt-BR":"Digite o código de 6 dígitos do seu aplicativo autenticador"},checkAuthenticator:{en:"Open your authenticator app to view your verification code","pt-BR":"Abra seu aplicativo autenticador para ver seu código de verificação"},verify:{en:"Verify","pt-BR":"Verificar"},verifying:{en:"Verifying...","pt-BR":"Verificando..."},back:{en:"Back","pt-BR":"Voltar"},invalidCode:{en:"Invalid Code","pt-BR":"Código Inválido"},enterValidCode:{en:"Please enter a valid 6-digit verification code","pt-BR":"Por favor, digite um código de verificação válido de 6 dígitos"},password:{en:"Password","pt-BR":"Senha"},changePassword:{en:"Change Password","pt-BR":"Alterar Senha"},changePasswordDescription:{en:"Update your password regularly to keep your account secure","pt-BR":"Atualize sua senha regularmente para manter sua conta segura"},currentPassword:{en:"Current Password","pt-BR":"Senha Atual"},newPassword:{en:"New Password","pt-BR":"Nova Senha"},confirmPassword:{en:"Confirm New Password","pt-BR":"Confirmar Nova Senha"},updatePassword:{en:"Update Password","pt-BR":"Atualizar Senha"},securityDashboard:{en:"Security Dashboard","pt-BR":"Painel de Segurança"},securityDashboardDescription:{en:"Monitor and manage security features and compliance","pt-BR":"Monitore e gerencie recursos de segurança e conformidade"},securityScore:{en:"Security Score","pt-BR":"Pontuação de Segurança"},securityAudit:{en:"Security Audit","pt-BR":"Auditoria de Segurança"},auditLogs:{en:"Audit Logs","pt-BR":"Logs de Auditoria"},roleBasedAccess:{en:"Role-Based Access","pt-BR":"Acesso Baseado em Função"}},Sl={profilePageTitle:{en:"Profile","pt-BR":"Perfil"},personalInfo:{en:"Personal Info","pt-BR":"Informações Pessoais"},personalInfoDescription:{en:"Update your personal information here","pt-BR":"Atualize suas informações pessoais aqui"},accountType:{en:"Account Type","pt-BR":"Tipo de Conta"},accountTypeDescription:{en:"Manage your account type and related settings","pt-BR":"Gerencie seu tipo de conta e configurações relacionadas"},activity:{en:"Activity","pt-BR":"Atividade"},activityHistory:{en:"Activity History","pt-BR":"Histórico de Atividades"},activityHistoryDescription:{en:"Recent account activity and security events","pt-BR":"Atividades recentes da conta e eventos de segurança"},name:{en:"Name","pt-BR":"Nome"},email:{en:"Email","pt-BR":"Email"},saving:{en:"Saving...","pt-BR":"Salvando..."},saveChanges:{en:"Save Changes","pt-BR":"Salvar Alterações"},profileUpdated:{en:"Profile Updated","pt-BR":"Perfil Atualizado"},profileUpdateSuccess:{en:"Your profile has been updated successfully.","pt-BR":"Seu perfil foi atualizado com sucesso."},profileUpdateFailed:{en:"Update Failed","pt-BR":"Falha na Atualização"},profileUpdateError:{en:"There was an error updating your profile. Please try again.","pt-BR":"Ocorreu um erro ao atualizar seu perfil. Por favor, tente novamente."},currentAccountType:{en:"Current Account Type","pt-BR":"Tipo de Conta Atual"},therapist:{en:"Therapist","pt-BR":"Terapeuta"},patient:{en:"Patient","pt-BR":"Paciente"},therapistAccountDescription:{en:"You have a therapist account with provider privileges.","pt-BR":"Você tem uma conta de terapeuta com privilégios de provedor."},patientAccountDescription:{en:"You have a patient account with standard privileges.","pt-BR":"Você tem uma conta de paciente com privilégios padrão."},hipaaCompliance:{en:"HIPAA Compliance","pt-BR":"Conformidade HIPAA"},hipaaComplianceDescription:{en:"HIPAA consent is required to use certain features.","pt-BR":"O consentimento HIPAA é necessário para usar certos recursos."},consentStatus:{en:"Consent Status","pt-BR":"Status de Consentimento"},consentProvided:{en:"Consent Provided","pt-BR":"Consentimento Fornecido"},consentRequired:{en:"Consent Required","pt-BR":"Consentimento Necessário"},provideHipaaConsent:{en:"Provide HIPAA Consent","pt-BR":"Fornecer Consentimento HIPAA"},signedIn:{en:"Signed In","pt-BR":"Entrou"},signedOut:{en:"Signed Out","pt-BR":"Saiu"},twoFactorSetupInitiated:{en:"Two-Factor Setup Initiated","pt-BR":"Configuração de Dois Fatores Iniciada"},twoFactorEnabled:{en:"Two-Factor Authentication Enabled","pt-BR":"Autenticação de Dois Fatores Ativada"},twoFactorDisabled:{en:"Two-Factor Authentication Disabled","pt-BR":"Autenticação de Dois Fatores Desativada"},hipaaConsentProvided:{en:"HIPAA Consent Provided","pt-BR":"Consentimento HIPAA Fornecido"},securitySettingsChanged:{en:"Security Settings Changed","pt-BR":"Configurações de Segurança Alteradas"},failedLoginAttempt:{en:"Failed Login Attempt","pt-BR":"Tentativa de Login Falhou"},noActivityHistory:{en:"No activity history available","pt-BR":"Nenhum histórico de atividade disponível"}},Cl={about:{en:"About","pt-BR":"Sobre"},aboutUs:{en:"About Us","pt-BR":"Sobre Nós"}},kl={...ul,...hl,...pl,...xl,...gl,...fl,...jl,...vl,...yl,...bl,...wl,...Nl,...Sl,...Cl},Fn=l.createContext(void 0),_l=({children:s})=>{const[t,a]=l.useState("pt-BR"),r=n=>{var o;return((o=kl[n])==null?void 0:o[t])||n};return e.jsx(Fn.Provider,{value:{language:t,setLanguage:a,t:r},children:s})},Ze=()=>{const s=l.useContext(Fn);if(s===void 0)throw new Error("useLanguage must be used within a LanguageProvider");return s},Ma=Mo,Ba=Bo,Rl=l.forwardRef(({className:s,inset:t,children:a,...r},n)=>e.jsxs(Tr,{ref:n,className:C("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",t&&"pl-8",s),...r,children:[a,e.jsx(js,{className:"ml-auto h-4 w-4"})]}));Rl.displayName=Tr.displayName;const Tl=l.forwardRef(({className:s,...t},a)=>e.jsx(Ar,{ref:a,className:C("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...t}));Tl.displayName=Ar.displayName;const Ht=l.forwardRef(({className:s,sideOffset:t=4,...a},r)=>e.jsx(Io,{children:e.jsx(Er,{ref:r,sideOffset:t,className:C("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...a})}));Ht.displayName=Er.displayName;const gs=l.forwardRef(({className:s,inset:t,...a},r)=>e.jsx(Dr,{ref:r,className:C("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t&&"pl-8",s),...a}));gs.displayName=Dr.displayName;const Al=l.forwardRef(({className:s,children:t,checked:a,...r},n)=>e.jsxs(Pr,{ref:n,className:C("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ir,{children:e.jsx(Is,{className:"h-4 w-4"})})}),t]}));Al.displayName=Pr.displayName;const El=l.forwardRef(({className:s,children:t,...a},r)=>e.jsxs(Mr,{ref:r,className:C("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ir,{children:e.jsx(Na,{className:"h-2 w-2 fill-current"})})}),t]}));El.displayName=Mr.displayName;const Ln=l.forwardRef(({className:s,inset:t,...a},r)=>e.jsx(Br,{ref:r,className:C("px-2 py-1.5 text-sm font-semibold",t&&"pl-8",s),...a}));Ln.displayName=Br.displayName;const qn=l.forwardRef(({className:s,...t},a)=>e.jsx(Or,{ref:a,className:C("-mx-1 my-1 h-px bg-muted",s),...t}));qn.displayName=Or.displayName;const Oa=()=>{const{language:s,setLanguage:t}=Ze();return e.jsxs(Ma,{children:[e.jsx(Ba,{asChild:!0,children:e.jsx(N,{variant:"outline",size:"icon",className:"rounded-full",children:e.jsx(ac,{size:18})})}),e.jsxs(Ht,{align:"end",children:[e.jsx(gs,{onClick:()=>t("en"),className:s==="en"?"bg-gray-100":"",children:"🇺🇸 English"}),e.jsx(gs,{onClick:()=>t("pt-BR"),className:s==="pt-BR"?"bg-gray-100":"",children:"🇧🇷 Português (Brasil)"})]})]})},Un=()=>e.jsx(ve,{to:"/",className:"flex items-center space-x-2",children:e.jsx("span",{className:"font-bold text-2xl gradient-text",children:"MindBloom"})}),$n=()=>{const s=vs();return e.jsx("div",{className:"flex items-center space-x-6",children:e.jsxs(ve,{to:"/chat",className:C("flex items-center gap-2 text-sm font-medium transition-colors hover:text-therapy-purple",s.pathname==="/chat"?"text-therapy-purple":"text-gray-700 dark:text-gray-300"),children:[e.jsx(qe,{className:"w-4 h-4"}),"AI Chat"]})})},es=l.forwardRef(({className:s,...t},a)=>e.jsx(Fr,{ref:a,className:C("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...t}));es.displayName=Fr.displayName;const Us=l.forwardRef(({className:s,...t},a)=>e.jsx(Lr,{ref:a,className:C("aspect-square h-full w-full",s),...t}));Us.displayName=Lr.displayName;const ss=l.forwardRef(({className:s,...t},a)=>e.jsx(qr,{ref:a,className:C("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...t}));ss.displayName=qr.displayName;const st={DASHBOARD:"/dashboard",PROFILE:"/profile",APPOINTMENTS:"/appointments",SECURITY_SETTINGS:"/security-settings"},wt={HOME:"/",ABOUT:"/about",CONTACT:"/contact",PRICING:"/pricing"},At={LOGIN:"/login",REGISTER:"/register"},zn=()=>{var u,m;const s=we(),{user:t,signOut:a}=V(),[r,n]=l.useState(!1),o=async()=>{await a(),s(st.DASHBOARD)},i=((u=t==null?void 0:t.user_metadata)==null?void 0:u.name)||(t==null?void 0:t.email)||"User",c=(m=t==null?void 0:t.user_metadata)==null?void 0:m.avatar_url;return e.jsxs(Ma,{open:r,onOpenChange:n,children:[e.jsx(Ba,{asChild:!0,children:e.jsxs(N,{variant:"ghost",className:"h-8 w-8 p-0 lg:h-10 lg:w-10 rounded-full",children:[e.jsx(es,{className:"h-8 w-8 lg:h-10 lg:w-10",children:c?e.jsx(Us,{src:c,alt:i}):e.jsx(ss,{children:i==null?void 0:i.charAt(0).toUpperCase()})}),e.jsx(Sa,{className:"h-4 w-4 ml-1 opacity-50"})]})}),e.jsxs(Ht,{className:"w-56 mr-2",children:[e.jsx(Ln,{children:"My Account"}),e.jsxs(gs,{onClick:()=>s(st.DASHBOARD),children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Dashboard"})]}),e.jsxs(gs,{onClick:()=>s(st.PROFILE),children:[e.jsx(rc,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Profile"})]}),e.jsxs(gs,{onClick:()=>s(st.SECURITY_SETTINGS),children:[e.jsx(nc,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Security"})]}),e.jsxs(gs,{onClick:()=>s(st.APPOINTMENTS),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Appointments"})]}),e.jsx(qn,{}),e.jsxs(gs,{onClick:o,className:"cursor-pointer",children:[e.jsx(Ls,{className:"h-4 w-4 mr-2"}),e.jsx("span",{children:"Log out"})]})]})]})},Fa=zr,Vn=Vr,Dl=Ur,Gn=l.forwardRef(({className:s,...t},a)=>e.jsx(Ft,{className:C("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));Gn.displayName=Ft.displayName;const Pl=Fs("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Yt=l.forwardRef(({side:s="right",className:t,children:a,...r},n)=>e.jsxs(Dl,{children:[e.jsx(Gn,{}),e.jsxs(Lt,{ref:n,className:C(Pl({side:s}),t),...r,children:[a,e.jsxs($r,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[e.jsx(rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Yt.displayName=Lt.displayName;const Hn=({className:s,...t})=>e.jsx("div",{className:C("flex flex-col space-y-2 text-center sm:text-left",s),...t});Hn.displayName="SheetHeader";const Yn=l.forwardRef(({className:s,...t},a)=>e.jsx(qt,{ref:a,className:C("text-lg font-semibold text-foreground",s),...t}));Yn.displayName=qt.displayName;const Wn=l.forwardRef(({className:s,...t},a)=>e.jsx(Ut,{ref:a,className:C("text-sm text-muted-foreground",s),...t}));Wn.displayName=Ut.displayName;class Il{constructor(){J(this,"events",[]);J(this,"stats",{totalComponents:177,migratedComponents:0,compatibilityLayerUsage:177,errorCount:0,performanceMetrics:{authCheckTime:0,roleCheckTime:0,permissionCheckTime:0},lastUpdated:new Date})}logMigration(t,a,r){const n={id:`migration-${Date.now()}`,timestamp:new Date,type:"migration",component:t,message:`Migrated from ${a} to ${r}`,details:{fromSystem:a,toSystem:r}};this.events.push(n),this.updateStats()}logError(t,a,r){const n={id:`error-${Date.now()}`,timestamp:new Date,type:"error",component:t,message:a.message,details:{stack:a.stack,context:r}};this.events.push(n),this.stats.errorCount++,this.stats.lastUpdated=new Date,console.error(`❌ [Migration Error] ${t}:`,a)}logPerformance(t,a,r){const n={id:`perf-${Date.now()}`,timestamp:new Date,type:"performance",component:r,message:`${t} check took ${a}ms`,details:{operation:t,duration:a}};switch(this.events.push(n),t){case"auth":this.stats.performanceMetrics.authCheckTime=a;break;case"role":this.stats.performanceMetrics.roleCheckTime=a;break;case"permission":this.stats.performanceMetrics.permissionCheckTime=a;break}this.stats.lastUpdated=new Date,a>100&&console.warn(`⚠️ [Performance] Slow ${t} check in ${r}: ${a}ms`)}getStats(){return{...this.stats}}getRecentEvents(t=50){return this.events.sort((a,r)=>r.timestamp.getTime()-a.timestamp.getTime()).slice(0,t)}getEventsByType(t){return this.events.filter(a=>a.type===t)}updateStats(){const t=this.getEventsByType("migration");this.stats.migratedComponents=t.length,this.stats.compatibilityLayerUsage=Math.max(0,this.stats.totalComponents-t.length),this.stats.lastUpdated=new Date}generateReport(){const t=this.getStats();this.getEventsByType("error");const a=this.getEventsByType("warning"),r=this.getRecentEvents(10),n=(t.migratedComponents/t.totalComponents*100).toFixed(1);return`
# Auth Migration Report
Generated: ${new Date().toISOString()}

## Progress
- Total Components: ${t.totalComponents}
- Migrated: ${t.migratedComponents} (${n}%)
- Still Using Compatibility Layer: ${t.compatibilityLayerUsage}

## System Health
- Total Errors: ${t.errorCount}
- Recent Warnings: ${a.length}
- Performance Issues: ${r.filter(o=>{var i;return o.type==="performance"&&((i=o.details)==null?void 0:i.duration)>100}).length}

## Performance Metrics
- Auth Check Time: ${t.performanceMetrics.authCheckTime}ms
- Role Check Time: ${t.performanceMetrics.roleCheckTime}ms
- Permission Check Time: ${t.performanceMetrics.permissionCheckTime}ms

## Recent Activity
${r.slice(0,5).map(o=>`- ${o.timestamp.toISOString()}: ${o.type.toUpperCase()} in ${o.component} - ${o.message}`).join(`
`)}
    `.trim()}cleanupEvents(){this.events.length>1e3&&(this.events=this.events.sort((t,a)=>a.timestamp.getTime()-t.timestamp.getTime()).slice(0,1e3))}}const Ml=new Il;function Ue(s,t){se.useEffect(()=>{Ml.logMigration(s,"useAuth","useAuthRBAC")},[s,t])}const Bl=()=>{const s=vs(),{isAuthenticated:t,primaryRole:a}=V();Ue("NavigationItems","useAuthRBAC");const r=[{path:wt.HOME,label:"Home"},{path:wt.ABOUT,label:"About"},{path:wt.PRICING,label:"Pricing"},{path:wt.CONTACT,label:"Contact"}],n=[{path:"/patient",label:"Dashboard",roles:["patient"]},{path:"/therapist",label:"Dashboard",roles:["therapist"]},{path:"/admin",label:"Dashboard",roles:["admin"]}],o=u=>u.roles?!t||!a?!1:u.roles.includes(a):!0,i=u=>s.pathname.startsWith(u)||s.pathname===u,c=[...t?[]:r,...t?n.filter(o):[]];return e.jsx("div",{className:"flex flex-col space-y-2 p-4",children:c.map(u=>e.jsx(N,{variant:i(u.path)?"default":"ghost",size:"sm",asChild:!0,className:C("justify-start text-sm font-medium transition-colors w-full",i(u.path)?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:e.jsx(ve,{to:u.path,children:u.label})},u.path))})},Ol=()=>{const{language:s}=Ze();return e.jsxs("div",{className:"flex space-x-4 items-center",children:[e.jsx(Oa,{}),e.jsx("span",{className:"text-sm",children:s==="en"?"English":"Português"})]})},Fl=()=>{var n;const{user:s,signOut:t}=V(),{t:a}=Ze();if(Ue("MobileUserProfile","useAuthRBAC"),!s)return null;const r=()=>{var i;if(!((i=s.user_metadata)!=null&&i.name))return"?";const o=s.user_metadata.name.split(" ");return o.length>1?`${o[0][0]}${o[1][0]}`.toUpperCase():o[0][0].toUpperCase()};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(es,{className:"h-8 w-8 bg-therapy-purple text-white",children:e.jsx(ss,{children:r()})}),e.jsx("span",{className:"font-medium",children:((n=s.user_metadata)==null?void 0:n.name)||s.email})]}),e.jsxs(ve,{to:"/profile",className:"flex items-center space-x-2 pl-2",children:[e.jsx(Be,{size:16}),e.jsx("span",{children:a("profile")})]}),e.jsxs(ve,{to:"/security-settings",className:"flex items-center space-x-2 pl-2",children:[e.jsx(Ms,{size:16}),e.jsx("span",{children:a("security")})]}),e.jsxs(N,{variant:"outline",className:"w-full flex items-center justify-center space-x-2 mt-2 text-red-500 border-red-200 hover:bg-red-50",onClick:()=>t(),children:[e.jsx(Ls,{size:16}),e.jsx("span",{children:a("logout")})]})]})},Ll=()=>{const{t:s}=Ze();return e.jsxs(e.Fragment,{children:[e.jsx(ve,{to:At.LOGIN,children:e.jsx(N,{variant:"outline",className:"w-full border-therapy-purple text-therapy-purple",children:s("login")})}),e.jsx(ve,{to:At.REGISTER,children:e.jsx(N,{className:"w-full bg-therapy-purple text-white",children:s("signUp")})})]})},Qn=()=>{const{user:s}=V(),{theme:t,toggleTheme:a}=Gt(),{t:r}=Ze();return e.jsxs(Fa,{children:[e.jsx(Vn,{asChild:!0,className:"md:hidden",children:e.jsx(N,{variant:"ghost",size:"icon",children:e.jsx(Sn,{})})}),e.jsx(Yt,{children:e.jsxs("div",{className:"flex flex-col space-y-4 mt-8",children:[e.jsx(Bl,{}),e.jsx(Ol,{}),e.jsxs(N,{variant:"ghost",onClick:a,className:"flex justify-start items-center space-x-2 pl-2",children:[t==="dark"?e.jsx($t,{size:16}):e.jsx(Ca,{size:16}),e.jsx("span",{children:r(t==="dark"?"lightMode":"darkMode")})]}),s?e.jsx(Fl,{}):e.jsx(Ll,{})]})})]})},Kn=()=>{const{t:s}=Ze();return e.jsxs(e.Fragment,{children:[e.jsx(ve,{to:At.LOGIN,children:e.jsxs(N,{variant:"outline",className:"border-therapy-purple text-therapy-purple hover:bg-therapy-purple hover:text-white flex items-center gap-1",size:"sm",children:[e.jsx(ic,{className:"h-4 w-4"}),s("login")]})}),e.jsx(ve,{to:At.REGISTER,children:e.jsxs(N,{className:"bg-therapy-purple hover:bg-therapy-deep-purple text-white flex items-center gap-1",size:"sm",children:[e.jsx(oc,{className:"h-4 w-4"}),s("signUp")]})})]})},ql={admin:{label:"Admin",icon:Ms,color:"bg-orange-100 text-orange-800 border-orange-200 hover:bg-orange-200"},therapist:{label:"Therapist",icon:Cn,color:"bg-purple-100 text-purple-800 border-purple-200 hover:bg-purple-200"},patient:{label:"Patient",icon:Be,color:"bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200"}},La=({role:s,variant:t="default",className:a})=>{const r=ql[s],n=r.icon;return t==="icon-only"?e.jsx("div",{className:C("inline-flex items-center justify-center w-6 h-6 rounded-full",r.color,a),children:e.jsx(n,{className:"h-3 w-3"})}):e.jsxs(D,{variant:"outline",className:C("inline-flex items-center gap-1 text-xs font-medium",r.color,t==="compact"&&"px-2 py-0.5",a),children:[e.jsx(n,{className:"h-3 w-3"}),t!=="compact"&&e.jsx("span",{children:r.label})]})},Ul=()=>{const{theme:s,toggleTheme:t}=Gt(),{user:a,signOut:r,userRoles:n,primaryRole:o}=V();Ue("Navbar","useAuthRBAC");const c=a?n.includes("admin")?{border:"border-t-orange-500",bg:"bg-orange-50/30"}:n.includes("therapist")?{border:"border-t-purple-500",bg:"bg-purple-50/30"}:{border:"border-t-blue-500",bg:"bg-blue-50/30"}:{border:"border-t-blue-500",bg:"bg-blue-50/30"};return e.jsx("nav",{className:C("w-full py-3 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800 fixed top-0 z-50 border-t-2 transition-colors","bg-white/90 dark:bg-gray-900/90",c.border,a&&c.bg),children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Un,{}),a&&o&&e.jsx(La,{role:o,variant:"compact"})]}),e.jsx("div",{className:"hidden lg:flex items-center",children:e.jsx($n,{})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"hidden md:flex items-center space-x-2",children:[e.jsx(Oa,{}),e.jsx(N,{variant:"ghost",size:"sm",onClick:t,className:"rounded-full","aria-label":s==="dark"?"Switch to light mode":"Switch to dark mode",children:s==="dark"?e.jsx($t,{className:"h-4 w-4"}):e.jsx(Ca,{className:"h-4 w-4"})})]}),a?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"hidden md:block",children:e.jsx(zn,{})}),e.jsxs(N,{variant:"outline",size:"sm",onClick:r,className:"hidden md:flex items-center gap-2 border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 dark:border-red-800 dark:text-red-400 dark:hover:bg-red-950",children:[e.jsx(Ls,{className:"h-4 w-4"}),"Logout"]})]}):e.jsx("div",{className:"hidden md:block",children:e.jsx(Kn,{})}),e.jsx("div",{className:"md:hidden",children:e.jsx(Qn,{})})]})]})})})},$l=()=>{const{t:s}=Ze();return e.jsx("div",{className:"relative bg-therapy-light-purple py-32",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row items-center",children:[e.jsxs("div",{className:"w-full md:w-1/2 space-y-6 mb-12 md:mb-0 animate-fade-in",children:[e.jsx("h1",{className:"text-4xl md:text-5xl lg:text-6xl font-bold leading-tight",children:s("heroTitle")}),e.jsx("p",{className:"text-lg md:text-xl text-gray-700",children:s("heroSubtitle")}),e.jsxs("div",{className:"flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 pt-4",children:[e.jsx(ve,{to:"/chat",children:e.jsx(N,{className:"w-full sm:w-auto bg-therapy-purple hover:bg-therapy-deep-purple text-white text-lg py-6 px-8",children:s("tryAiNow")})}),e.jsx(ve,{to:"/pricing",children:e.jsx(N,{variant:"outline",className:"w-full sm:w-auto border-therapy-purple text-therapy-purple hover:bg-therapy-purple hover:text-white text-lg py-6 px-8",children:s("seePlans")})})]})]}),e.jsxs("div",{className:"w-full md:w-1/2 relative animate-fade-in",style:{animationDelay:"0.3s"},children:[e.jsx("div",{className:"bg-white rounded-2xl shadow-lg p-6 md:p-8 border border-gray-100 transform rotate-3 absolute top-4 right-4",children:e.jsxs("div",{className:"flex items-start mb-4",children:[e.jsx("div",{className:"bg-therapy-purple rounded-full w-10 h-10 flex items-center justify-center text-white",children:"AI"}),e.jsx("div",{className:"bg-gray-100 rounded-2xl p-4 ml-4",children:e.jsx("p",{children:s("aiGreeting")})})]})}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 md:p-8 border border-gray-100 transform -rotate-2 relative z-10",children:[e.jsxs("div",{className:"flex items-start mb-4",children:[e.jsx("div",{className:"bg-therapy-blue rounded-2xl p-4 mr-4",children:e.jsx("p",{children:s("userMessage")})}),e.jsx("div",{className:"bg-therapy-purple rounded-full w-10 h-10 flex items-center justify-center text-white",children:"U"})]}),e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"bg-therapy-purple rounded-full w-10 h-10 flex items-center justify-center text-white",children:"AI"}),e.jsx("div",{className:"bg-gray-100 rounded-2xl p-4 ml-4",children:e.jsx("p",{children:s("aiResponse")})})]})]})]})]})})})},R=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:C("rounded-lg border bg-card text-card-foreground shadow-sm",s),...t}));R.displayName="Card";const I=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:C("flex flex-col space-y-1.5 p-6",s),...t}));I.displayName="CardHeader";const O=l.forwardRef(({className:s,...t},a)=>e.jsx("h3",{ref:a,className:C("text-2xl font-semibold leading-none tracking-tight",s),...t}));O.displayName="CardTitle";const me=l.forwardRef(({className:s,...t},a)=>e.jsx("p",{ref:a,className:C("text-sm text-muted-foreground",s),...t}));me.displayName="CardDescription";const T=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:C("p-6 pt-0",s),...t}));T.displayName="CardContent";const Wt=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:C("flex items-center p-6 pt-0",s),...t}));Wt.displayName="CardFooter";const zl=()=>{const{t:s}=Ze(),t=[{icon:e.jsx(qe,{className:"h-12 w-12 text-therapy-purple"}),title:s("aiTherapyChat"),description:s("aiTherapyDesc")},{icon:e.jsx(de,{className:"h-12 w-12 text-therapy-purple"}),title:s("groupTherapy"),description:s("groupTherapyDesc")},{icon:e.jsx(ws,{className:"h-12 w-12 text-therapy-purple"}),title:s("oneOnOne"),description:s("oneOnOneDesc")},{icon:e.jsx(X,{className:"h-12 w-12 text-therapy-purple"}),title:s("flexibleScheduling"),description:s("flexibleSchedulingDesc")}];return e.jsx("div",{className:"py-20 bg-white",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold mb-4",children:s("featuresTitle")}),e.jsx("p",{className:"text-lg text-gray-700 max-w-2xl mx-auto",children:s("featuresSubtitle")})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8",children:t.map((a,r)=>e.jsxs(R,{className:"card-hover border border-gray-100",children:[e.jsxs(I,{className:"pb-2",children:[e.jsx("div",{className:"mb-4",children:a.icon}),e.jsx(O,{children:a.title})]}),e.jsx(T,{children:e.jsx(me,{className:"text-base",children:a.description})})]},r))})]})})},Vl=()=>{const{t:s}=Ze(),t=[{quote:s("testimonial1"),name:"Maria S.",role:"Student",avatar:"MS"},{quote:s("testimonial2"),name:"Dr. James Wilson",role:"Clinical Psychologist",avatar:"JW"},{quote:s("testimonial3"),name:"Alex T.",role:"Marketing Professional",avatar:"AT"}];return e.jsx("div",{className:"py-20 bg-white",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold mb-4",children:s("testimonialTitle")}),e.jsx("p",{className:"text-lg text-gray-700 max-w-2xl mx-auto",children:s("testimonialSubtitle")})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto",children:t.map((a,r)=>e.jsx(R,{className:"card-hover",children:e.jsxs(T,{className:"p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"45",height:"36",fill:"none",className:"text-therapy-purple/20",children:e.jsx("path",{fill:"currentColor",d:"M13.304 0C6.042 0 0 6.042 0 13.304c0 7.262 6.042 13.304 13.304 13.304 2.05 0 3.99-.477 5.716-1.318C16.647 32.118 8.684 36 0 36V30.87c5.177 0 9.783-2.408 12.771-6.164C5.15 23.368 0 18.048 0 13.304 0 8.57 5.15 4.57 13.304 4.57V0Zm31.696 0c-7.262 0-13.304 6.042-13.304 13.304 0 7.262 6.042 13.304 13.304 13.304 2.05 0 3.99-.477 5.716-1.318C48.343 32.118 40.38 36 31.696 36V30.87c5.177 0 9.783-2.408 12.771-6.164C36.846 23.368 31.696 18.048 31.696 13.304c0-4.734 5.15-8.734 13.304-8.734V0Z"})})}),e.jsx("p",{className:"text-gray-700 mb-6",children:a.quote}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(es,{className:"h-10 w-10 border border-therapy-purple/20",children:e.jsx(ss,{className:"bg-therapy-purple/10 text-therapy-purple",children:a.avatar})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"font-medium",children:a.name}),e.jsx("p",{className:"text-sm text-gray-500",children:a.role})]})]})]})},r))})]})})},Gl=()=>{const{t:s,language:t}=Ze(),a=[{name:s("basic"),price:s("free"),description:s("basicDesc"),features:[s("aiTherapyLimited"),s("weeklyTips"),s("basicTracking"),s("communityAccess")],buttonText:s("startFree"),highlight:!1,path:"/register/patient"},{name:s("premium"),price:t==="pt-BR"?"R$397":"$67.00",period:s("month"),description:s("premiumDesc"),features:[s("aiTherapyUnlimited"),s("groupSessionsLimited"),s("advancedTracking"),s("personalPlan"),s("prioritySupport")],buttonText:s("subscribeNow"),highlight:!0,path:"/register/patient"},{name:s("complete"),price:t==="pt-BR"?"R$997":"$197.00",period:s("month"),description:s("completeDesc"),features:[s("premiumFeatures"),s("oneOnOneSessions"),s("groupSessionsExtended"),s("therapistMatching"),s("resourceLibrary"),s("support247")],buttonText:s("getStarted"),highlight:!1,path:"/register/patient"}];return e.jsx("div",{className:"py-20 bg-therapy-light-purple",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold mb-4",children:s("pricingTitle")}),e.jsx("p",{className:"text-lg text-gray-700 max-w-2xl mx-auto",children:s("pricingSubtitle")})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto",children:a.map((r,n)=>e.jsxs(R,{className:`card-hover ${r.highlight?"border-therapy-purple shadow-lg":"border-gray-200"} relative`,children:[r.highlight&&e.jsx("div",{className:"absolute top-0 inset-x-0 -translate-y-1/2 bg-therapy-purple text-white text-xs uppercase tracking-wide font-bold py-1 px-3 rounded-full mx-auto w-max",children:s("mostPopular")}),e.jsxs(I,{children:[e.jsx(O,{className:`${r.highlight?"text-therapy-purple":""} text-2xl font-bold`,children:r.name}),e.jsxs("div",{className:"mt-2 flex items-baseline",children:[e.jsx("span",{className:"text-3xl font-bold",children:r.price}),r.period&&e.jsx("span",{className:"text-gray-500 ml-1",children:r.period})]}),e.jsx(me,{className:"mt-2",children:r.description})]}),e.jsx(T,{className:"space-y-4",children:e.jsx("ul",{className:"space-y-3",children:r.features.map((o,i)=>e.jsxs("li",{className:"flex items-start",children:[e.jsx("span",{className:"flex-shrink-0 mr-2 mt-0.5",children:e.jsx(Is,{size:16,className:`${r.highlight?"text-therapy-purple":"text-gray-600"}`})}),e.jsx("span",{className:"text-sm text-gray-700",children:o})]},i))})}),e.jsx(Wt,{children:e.jsx(ve,{to:r.path,className:"w-full",children:e.jsx(N,{className:`w-full ${r.highlight?"bg-therapy-purple hover:bg-therapy-deep-purple":"bg-gray-200 hover:bg-gray-300 text-gray-800"}`,children:r.buttonText})})})]},n))})]})})},Hl=()=>{const{t:s}=Ze();return e.jsx("div",{className:"py-20 bg-gradient-to-r from-therapy-purple to-therapy-deep-purple text-white",children:e.jsxs("div",{className:"container mx-auto px-4 text-center",children:[e.jsx("h2",{className:"text-3xl md:text-4xl font-bold mb-6",children:s("ctaTitle")}),e.jsx("p",{className:"text-lg mb-8 max-w-2xl mx-auto opacity-90",children:s("ctaSubtitle")}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4",children:[e.jsx(ve,{to:"/register",children:e.jsx(N,{className:"bg-white text-therapy-deep-purple hover:bg-gray-100 text-lg py-6 px-8 w-full sm:w-auto",children:s("signUpFree")})}),e.jsx(ve,{to:"/ai-chat",children:e.jsx(N,{variant:"outline",className:"border-white text-white hover:bg-white/10 text-lg py-6 px-8 w-full sm:w-auto",children:s("tryAiTherapy")})})]})]})})},jt=l.forwardRef(({className:s,orientation:t="horizontal",decorative:a=!0,...r},n)=>e.jsx(Gr,{ref:n,decorative:a,orientation:t,className:C("shrink-0 bg-border",t==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...r}));jt.displayName=Gr.displayName;const Yl=()=>{const s=new Date().getFullYear();return e.jsx("footer",{className:"bg-gray-50 border-t border-gray-200 mt-auto",children:e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Therapy Platform"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Connecting patients with licensed therapists through secure, accessible mental healthcare."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Platform"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{to:"/about",className:"block text-sm text-gray-600 hover:text-gray-900",children:"About Us"}),e.jsx(ve,{to:"/pricing",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Pricing"}),e.jsx(ve,{to:"/register",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Get Started"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"For Therapists"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{to:"/therapist-register",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Join as Therapist"}),e.jsx(ve,{to:"/login",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Therapist Login"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"Legal"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{to:"/privacy",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Privacy Policy"}),e.jsx(ve,{to:"/terms",className:"block text-sm text-gray-600 hover:text-gray-900",children:"Terms of Service"})]})]})]}),e.jsx(jt,{className:"my-6"}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["© ",s," Therapy Platform. All rights reserved."]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(ve,{to:"/privacy",className:"text-sm text-gray-600 hover:text-gray-900",children:"Privacy"}),e.jsx(ve,{to:"/terms",className:"text-sm text-gray-600 hover:text-gray-900",children:"Terms"})]})]})]})})},Wl=()=>e.jsxs(e.Fragment,{children:[e.jsx(Ul,{}),e.jsxs("main",{className:"min-h-screen",children:[e.jsx($l,{}),e.jsx(zl,{}),e.jsx(Gl,{}),e.jsx(Vl,{}),e.jsx(Hl,{})]}),e.jsx(Yl,{})]}),Ne=l.forwardRef(({className:s,type:t,...a},r)=>e.jsx("input",{type:t,className:C("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:r,...a}));Ne.displayName="Input";const Ql=Fs("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ce=l.forwardRef(({className:s,...t},a)=>e.jsx(Hr,{ref:a,className:C(Ql(),s),...t}));ce.displayName=Hr.displayName;const Kl=Fs("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",warning:"border-amber-500/30 text-amber-800 dark:border-amber-500/20 dark:text-amber-300 [&>svg]:text-amber-500",success:"border-green-500/30 text-green-800 dark:border-green-500/20 dark:text-green-300 [&>svg]:text-green-500"}},defaultVariants:{variant:"default"}}),ye=l.forwardRef(({className:s,variant:t,...a},r)=>e.jsx("div",{ref:r,role:"alert",className:C(Kl({variant:t}),s),...a}));ye.displayName="Alert";const Jn=l.forwardRef(({className:s,...t},a)=>e.jsx("h5",{ref:a,className:C("mb-1 font-medium leading-none tracking-tight",s),...t}));Jn.displayName="AlertTitle";const be=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:C("text-sm [&_p]:leading-relaxed",s),...t}));be.displayName="AlertDescription";const ga=s=>!s||typeof s!="string"?"":s.replace(/<[^>]*>/g,"").replace(/javascript:/gi,"").replace(/data:/gi,"").replace(/vbscript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/expression\s*\(/gi,"").replace(/eval\s*\(/gi,"").replace(/setTimeout\s*\(/gi,"").replace(/setInterval\s*\(/gi,"").trim(),Hs={email:Re().email().max(254),password:Re().min(8).max(128),name:Re().min(1).max(100).regex(/^[a-zA-Z\s\-'\.]+$/),phone:Re().regex(/^\+?[\d\s\-\(\)]{10,15}$/),message:Re().min(1).max(5e3),sessionId:Re().uuid(),userId:Re().uuid(),notes:Re().max(1e4),appointmentId:Re().uuid(),therapyGoals:Re().max(2e3),symptoms:Re().max(2e3),medications:Re().max(1e3),medicalHistory:Re().max(3e3)};function Nt(s,t){try{let a=s;typeof s=="string"?a=ga(s):typeof s=="object"&&s!==null&&(a=Xn(s));const r=t.safeParse(a);return r.success?{success:!0,data:r.data}:{success:!1,error:`Validation failed: ${r.error.errors.map(n=>n.message).join(", ")}`}}catch{return{success:!1,error:"Invalid input format"}}}function Xn(s){const t={};for(const[a,r]of Object.entries(s))typeof r=="string"?t[a]=ga(r):typeof r=="object"&&r!==null&&!Array.isArray(r)?t[a]=Xn(r):Array.isArray(r)?t[a]=r.map(n=>typeof n=="string"?ga(n):n):t[a]=r;return t}class Jl{constructor(t=5,a=15*60*1e3,r=30*60*1e3){J(this,"attempts",new Map);J(this,"maxAttempts");J(this,"windowMs");J(this,"blockDurationMs");this.maxAttempts=t,this.windowMs=a,this.blockDurationMs=r}isAllowed(t){const a=Date.now(),r=this.attempts.get(t);return r?r.count>=this.maxAttempts?a-r.lastAttempt<this.blockDurationMs?!1:(this.attempts.set(t,{count:1,lastAttempt:a}),!0):a-r.lastAttempt>this.windowMs?(this.attempts.set(t,{count:1,lastAttempt:a}),!0):(r.count++,r.lastAttempt=a,r.count<=this.maxAttempts):(this.attempts.set(t,{count:1,lastAttempt:a}),!0)}recordFailedAttempt(t){const a=Date.now(),r=this.attempts.get(t)||{count:0,lastAttempt:a};r.count++,r.lastAttempt=a,this.attempts.set(t,r)}reset(t){this.attempts.delete(t)}}const _s=new Jl(5,15*60*1e3,30*60*1e3),Zn=Re().min(8,"Password must be at least 8 characters long").max(128,"Password must be less than 128 characters").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[0-9]/,"Password must contain at least one number").regex(/[^a-zA-Z0-9]/,"Password must contain at least one special character");class _t{static generateToken(){const t=new Uint8Array(32);crypto.getRandomValues(t),this.token=Array.from(t,a=>a.toString(16).padStart(2,"0")).join("");try{sessionStorage.setItem("csrf_token",this.token)}catch(a){console.warn("Failed to store CSRF token:",a)}return this.token}static getToken(){if(!this.token)try{this.token=sessionStorage.getItem("csrf_token")}catch(t){console.warn("Failed to retrieve CSRF token:",t)}return this.token}static validateToken(t){return this.getToken()===t&&t.length===64}static clearToken(){this.token=null;try{sessionStorage.removeItem("csrf_token")}catch(t){console.warn("Failed to clear CSRF token:",t)}}}J(_t,"token",null);const Xl=vr({email:Hs.email,password:Re().min(1,"Password is required"),csrfToken:Re().min(1,"Security token is required")}),Zl=vr({email:Hs.email,password:Zn,confirmPassword:Re(),fullName:Hs.name,accountType:go(["patient","therapist"]),csrfToken:Re().min(1,"Security token is required")}).refine(s=>s.password===s.confirmPassword,{message:"Passwords don't match",path:["confirmPassword"]}),ed=({onSignIn:s,onSignUp:t,isLoading:a=!1})=>{const[r,n]=l.useState(!1),[o,i]=l.useState(!1),[c,u]=l.useState(!1),[m,h]=l.useState(!1),[p,d]=l.useState(0),[x,j]=l.useState(""),{toast:g}=Z();l.useEffect(()=>{const k=_t.generateToken();j(k)},[]),l.useEffect(()=>{if(p>0){const k=setTimeout(()=>{d(p-1),p<=1&&h(!1)},1e3);return()=>clearTimeout(k)}},[p]);const v=er({resolver:sr(Xl),defaultValues:{email:"",password:"",csrfToken:x}}),f=er({resolver:sr(Zl),defaultValues:{email:"",password:"",confirmPassword:"",fullName:"",accountType:"patient",csrfToken:x}});l.useEffect(()=>{v.setValue("csrfToken",x),f.setValue("csrfToken",x)},[x,v,f]);const y=async k=>{const S=k.email.toLowerCase();if(!_s.isAllowed(S)){h(!0),d(30*60),g({title:"Too Many Attempts",description:"Account temporarily locked due to multiple failed login attempts. Please try again in 30 minutes.",variant:"destructive"});return}if(!_t.validateToken(k.csrfToken)){g({title:"Security Error",description:"Invalid security token. Please refresh the page and try again.",variant:"destructive"});return}const E=Nt(k.email,Hs.email);if(!E.success){g({title:"Invalid Email",description:E.error,variant:"destructive"});return}try{(await s(E.data,k.password)).error?(_s.recordFailedAttempt(S),g({title:"Authentication Failed",description:"Invalid email or password. Please check your credentials and try again.",variant:"destructive"})):(_s.reset(S),g({title:"Welcome Back",description:"Successfully signed in."}))}catch{_s.recordFailedAttempt(S),g({title:"Sign In Error",description:"An unexpected error occurred. Please try again.",variant:"destructive"})}},b=async k=>{const S=k.email.toLowerCase();if(!_s.isAllowed(S)){h(!0),d(30*60),g({title:"Too Many Attempts",description:"Too many registration attempts. Please try again in 30 minutes.",variant:"destructive"});return}if(!_t.validateToken(k.csrfToken)){g({title:"Security Error",description:"Invalid security token. Please refresh the page and try again.",variant:"destructive"});return}const E=Nt(k.email,Hs.email),B=Nt(k.fullName,Hs.name),M=Nt(k.password,Zn);if(!E.success){g({title:"Invalid Email",description:E.error,variant:"destructive"});return}if(!B.success){g({title:"Invalid Name",description:B.error,variant:"destructive"});return}if(!M.success){g({title:"Invalid Password",description:M.error,variant:"destructive"});return}try{const q=await t(E.data,M.data,B.data,k.accountType);q.error?(_s.recordFailedAttempt(S),g({title:"Registration Failed",description:q.error.message||"Failed to create account. Please try again.",variant:"destructive"})):g({title:"Account Created",description:"Please check your email to verify your account."})}catch{_s.recordFailedAttempt(S),g({title:"Registration Error",description:"An unexpected error occurred. Please try again.",variant:"destructive"})}},_=k=>{const S=Math.floor(k/60),E=k%60;return`${S}:${E.toString().padStart(2,"0")}`};return m?e.jsx("div",{className:"w-full max-w-md mx-auto space-y-6",children:e.jsxs(ye,{className:"border-destructive",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsxs(be,{children:["Account temporarily locked due to multiple failed attempts. Please try again in ",_(p),"."]})]})}):e.jsxs("div",{className:"w-full max-w-md mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-6",children:[e.jsx(Ms,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Secure Authentication"})]}),e.jsxs("div",{className:"flex border-b",children:[e.jsx("button",{onClick:()=>n(!1),className:`flex-1 py-2 px-4 text-center ${r?"text-muted-foreground hover:text-foreground":"border-b-2 border-primary text-primary"}`,children:"Sign In"}),e.jsx("button",{onClick:()=>n(!0),className:`flex-1 py-2 px-4 text-center ${r?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"}`,children:"Sign Up"})]}),r?e.jsxs("form",{onSubmit:f.handleSubmit(b),className:"space-y-4",children:[e.jsx("input",{type:"hidden",...f.register("csrfToken"),value:x}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signup-name",children:"Full Name"}),e.jsx(Ne,{id:"signup-name",type:"text",placeholder:"Enter your full name",...f.register("fullName"),autoComplete:"name"}),f.formState.errors.fullName&&e.jsx("p",{className:"text-sm text-destructive",children:f.formState.errors.fullName.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signup-email",children:"Email"}),e.jsx(Ne,{id:"signup-email",type:"email",placeholder:"Enter your email",...f.register("email"),autoComplete:"email"}),f.formState.errors.email&&e.jsx("p",{className:"text-sm text-destructive",children:f.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signup-account-type",children:"Account Type"}),e.jsxs("select",{id:"signup-account-type",...f.register("accountType"),className:"w-full p-2 border rounded-md",children:[e.jsx("option",{value:"patient",children:"Patient"}),e.jsx("option",{value:"therapist",children:"Therapist"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signup-password",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{id:"signup-password",type:o?"text":"password",placeholder:"Create a strong password",...f.register("password"),autoComplete:"new-password"}),e.jsx("button",{type:"button",onClick:()=>i(!o),className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:o?e.jsx(Ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(nt,{className:"h-4 w-4 text-gray-400"})})]}),f.formState.errors.password&&e.jsx("p",{className:"text-sm text-destructive",children:f.formState.errors.password.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signup-confirm-password",children:"Confirm Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{id:"signup-confirm-password",type:c?"text":"password",placeholder:"Confirm your password",...f.register("confirmPassword"),autoComplete:"new-password"}),e.jsx("button",{type:"button",onClick:()=>u(!c),className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:c?e.jsx(Ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(nt,{className:"h-4 w-4 text-gray-400"})})]}),f.formState.errors.confirmPassword&&e.jsx("p",{className:"text-sm text-destructive",children:f.formState.errors.confirmPassword.message})]}),e.jsx(N,{type:"submit",className:"w-full",disabled:a,children:a?"Creating Account...":"Create Account"})]}):e.jsxs("form",{onSubmit:v.handleSubmit(y),className:"space-y-4",children:[e.jsx("input",{type:"hidden",...v.register("csrfToken"),value:x}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signin-email",children:"Email"}),e.jsx(Ne,{id:"signin-email",type:"email",placeholder:"Enter your email",...v.register("email"),autoComplete:"email"}),v.formState.errors.email&&e.jsx("p",{className:"text-sm text-destructive",children:v.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"signin-password",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{id:"signin-password",type:o?"text":"password",placeholder:"Enter your password",...v.register("password"),autoComplete:"current-password"}),e.jsx("button",{type:"button",onClick:()=>i(!o),className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:o?e.jsx(Ct,{className:"h-4 w-4 text-gray-400"}):e.jsx(nt,{className:"h-4 w-4 text-gray-400"})})]}),v.formState.errors.password&&e.jsx("p",{className:"text-sm text-destructive",children:v.formState.errors.password.message})]}),e.jsx(N,{type:"submit",className:"w-full",disabled:a,children:a?"Signing In...":"Sign In"})]})]})},Et=({children:s,className:t,variant:a="default"})=>{const r={default:"app-layout",dashboard:"dashboard-layout",auth:"app-layout flex items-center justify-center",fullscreen:"min-h-screen w-full"};return e.jsx("div",{className:C(r[a],t),children:s})};function ei(s){return["admin","therapist","patient","support"].includes(s)}function sd(s){if(ei(s))return s;switch(s.toLowerCase()){case"user":case"client":case"member":return"patient";case"doctor":case"counselor":case"psychiatrist":case"psychologist":return"therapist";case"administrator":case"superuser":return"admin";case"customer_support":case"help_desk":return"support";default:return console.warn(`Unmapped role "${s}" defaulting to "patient"`),"patient"}}async function td(s,t){try{console.log(`Initializing role '${t}' for user: ${s}`);const{data:a,error:r}=await w.rpc("manage_user_role",{p_user_id:s,p_role_name:t,p_operation:"assign"});if(r){console.error("Error initializing user role:",r);try{await w.from("audit_logs").insert({user_id:s,activity_type:"role_init_failed",resource_type:"user_roles",resource_id:s,metadata:{role:t,error:r.message}})}catch(n){console.error("Failed to log role initialization error:",n)}throw r}try{await w.from("audit_logs").insert({user_id:s,activity_type:"role_initialized",resource_type:"user_roles",resource_id:s,metadata:{role:t,success:!0}})}catch(n){console.error("Failed to log role initialization:",n)}return console.log(`Successfully initialized role '${t}' for user: ${s}`),!0}catch(a){return console.error("Error initializing user role:",a),!1}}async function ad(s){try{const{data:t,error:a}=await w.rpc("get_user_roles",{p_user_id:s});if(a)throw a;return(t||[]).map(r=>{const n=r.role_name;return ei(n)?n:sd(n)})}catch(t){return console.error("Error fetching user roles from DB:",t),[]}}async function si(s){try{const{data:t,error:a}=await w.rpc("sync_user_roles",{p_user_id:s});if(a)throw a;return!!t}catch(t){return console.error("Error synchronizing user roles:",t),!1}}async function rd(s,t=3,a=1e3){let r=0;const n=async()=>{try{if(await si(s))return console.log(`Successfully synchronized roles for user ${s} on attempt ${r+1}`),!0;if(r<t-1){r++;const i=a*Math.pow(2,r);return console.log(`Retrying role sync in ${i}ms (attempt ${r+1}/${t})`),new Promise(c=>{setTimeout(async()=>{c(await n())},i)})}return console.error(`Failed to sync roles for user ${s} after ${t} attempts`),!1}catch(o){if(console.error(`Error in retry attempt ${r+1}:`,o),r<t-1){r++;const i=a*Math.pow(2,r);return new Promise(c=>{setTimeout(async()=>{c(await n())},i)})}return!1}};return n()}const nd=async(s,t,a,r)=>{try{const{data:n,error:o}=await w.auth.signUp({email:s,password:t,options:{data:{name:a,full_name:a,accountType:r}}});if(o)throw o;if(!n.user)throw new Error("User creation failed");const c={admin:"admin",therapist:"therapist",patient:"patient",support:"support"}[r]||"patient";return await td(n.user.id,c)||(console.warn(`User created but role initialization failed. Will retry in background: ${n.user.id}`),setTimeout(()=>rd(n.user.id),0)),{success:!0,userId:n.user.id}}catch(n){return console.error("Sign up error:",n),{success:!1,error:n}}},id=async(s,t)=>{var a,r;try{const{data:n,error:o}=await w.auth.signInWithPassword({email:s,password:t});if(o)throw o;if(!n.user)throw new Error("Sign in failed");let i=[];const c=(a=n.user.user_metadata)==null?void 0:a.roles;if(c&&Array.isArray(c)&&c.length>0)i=c;else if((r=n.user.user_metadata)!=null&&r.accountType){const u=n.user.user_metadata.accountType;i=[{admin:"admin",therapist:"therapist",patient:"patient",support:"support"}[u]||"patient"]}return i.length===0&&(i=await ad(n.user.id)),setTimeout(()=>si(n.user.id),100),{success:!0,user:n.user,roles:i}}catch(n){return console.error("Sign in error:",n),{success:!1,error:n}}},ra=async()=>{try{const{error:s}=await w.auth.signOut();if(s)throw s;return{success:!0}}catch(s){return console.error("Sign out error:",s),{success:!1,error:s}}};async function ir(s){try{const{data:t,error:a}=await w.from("profiles").select("approval_status, account_type").eq("id",s).single();return a||!t?{approved:!1,status:"unknown"}:t.account_type!=="therapist"?{approved:!0}:{approved:t.approval_status==="approved",status:t.approval_status}}catch(t){return console.error("Error checking therapist approval:",t),{approved:!1,status:"error"}}}const od=()=>{const{toast:s}=Z(),[t,a]=l.useState(!1);return{signIn:async(c,u)=>{var m;try{const h=await id(c,u);if(!h.success)throw h.error;if(h.user&&((m=h.roles)!=null&&m.includes("therapist"))){const p=`approval_check_${h.user.id}`,d=localStorage.getItem(p),x=Date.now(),j=24*60*60*1e3;let g=!0;if(d)try{const v=JSON.parse(d);x-v.timestamp<j&&v.approved===!0&&(g=!1,console.log("[Auth] Using cached approval status (approved)"))}catch{localStorage.removeItem(p)}if(g){a(!0);try{const{approved:v,status:f}=await ir(h.user.id);if(!v&&f==="pending")throw s({title:"Access Restricted",description:"Your therapist account is pending approval by an administrator.",variant:"destructive"}),await ra(),new Error("Therapist account pending approval");if(!v&&f==="rejected")throw s({title:"Access Denied",description:"Your therapist application has been rejected. Please contact support for more information.",variant:"destructive"}),await ra(),new Error("Therapist account rejected");v&&(localStorage.setItem(p,JSON.stringify({approved:!0,timestamp:x})),console.log("[Auth] Therapist approval verified and cached"))}finally{a(!1)}}}return h}catch(h){throw console.error("[useAuthOperations] Sign in error:",h),s({title:"Login failed",description:h.message||"Failed to sign in. Please try again.",variant:"destructive"}),h}},signUp:async(c,u,m,h)=>{try{console.log("[useAuthOperations] Starting sign up:",{email:c,accountType:h});const p=await nd(c,u,m,h);if(!p.success)throw p.error;return s({title:"Registration Successful",description:h==="therapist"?"Your registration has been submitted for approval by an administrator.":"Please check your email to confirm your account."}),{data:{user:p.userId?{id:p.userId}:null,session:null},error:null}}catch(p){throw console.error("[useAuthOperations] Sign up error:",p),s({title:"Registration failed",description:p.message||"Failed to create account. Please try again.",variant:"destructive"}),p}},signOut:async()=>{try{console.log("[useAuthOperations] Starting sign out");const{error:c}=await ra();if(c)throw c;console.log("[useAuthOperations] Sign out successful")}catch(c){console.error("[useAuthOperations] Sign out error:",c),s({title:"Sign out failed",description:c.message||"Failed to sign out. Please try again.",variant:"destructive"})}},checkTherapistApproval:async c=>{a(!0);try{return await ir(c)}finally{a(!1)}},isCheckingApproval:t}},na=()=>{const s=we(),{primaryRole:t,isAuthenticated:a}=V(),{signIn:r,signUp:n}=od();if(l.useEffect(()=>{if(a&&t){const c=Gs(t);s(c,{replace:!0})}},[a,t,s]),a)return e.jsx(Et,{variant:"auth",className:"bg-gradient-to-br from-primary/10 to-primary-foreground/10",children:e.jsxs("div",{className:"w-full max-w-md text-center space-y-4",children:[e.jsx("div",{className:"text-lg font-semibold",children:"Already signed in"}),e.jsx("div",{className:"text-muted-foreground",children:"Redirecting to your dashboard..."})]})});const o=async(c,u)=>{try{const m=await r(c,u);return m.error?m:{error:null}}catch(m){return{error:m}}},i=async(c,u,m,h)=>{try{return await n(c,u,m,h)}catch(p){return{error:p}}};return e.jsx(Et,{variant:"auth",className:"bg-gradient-to-br from-primary/10 to-primary-foreground/10",children:e.jsx("div",{className:"w-full max-w-md",children:e.jsx(ed,{onSignIn:o,onSignUp:i})})})},cd=()=>{const{user:s,signOut:t}=V();return e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Profile Settings"}),e.jsx("p",{className:"text-gray-600",children:"Manage your account information"})]}),e.jsxs(R,{className:"mb-6",children:[e.jsxs(I,{children:[e.jsx(O,{children:"Account Information"}),e.jsx(me,{children:"Your basic account details"})]}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"email",children:"Email"}),e.jsx(Ne,{id:"email",value:(s==null?void 0:s.email)||"",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"name",children:"Full Name"}),e.jsx(Ne,{id:"name",placeholder:"Enter your full name"})]}),e.jsx(N,{children:"Save Changes"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Account Actions"}),e.jsx(me,{children:"Manage your account"})]}),e.jsx(T,{children:e.jsx(N,{variant:"destructive",onClick:t,children:"Sign Out"})})]})]})})},qa=()=>{const s=Le(),{toast:t}=Z(),{user:a}=V(),{data:r,isLoading:n,error:o}=le({queryKey:["appointments",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:d,error:x}=await w.from("appointments").select("*").or(`patient_id.eq.${a.id},therapist_id.eq.${a.id}`).order("start_time",{ascending:!0});if(x)throw console.error("Error fetching appointments:",x),new Error(`Failed to fetch appointments: ${x.message}`);return d||[]},enabled:!!(a!=null&&a.id)}),i=Se({mutationFn:async d=>{if(console.log("Creating appointment with data:",d),!d.patient_id||!d.therapist_id)throw new Error("Patient ID and Therapist ID are required");if(!d.start_time||!d.end_time)throw new Error("Start time and end time are required");const x={...d};if(d.video_enabled){const v=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;x.video_meeting_id=v,x.video_url=`/video-conference/${v}`,x.appointment_type="video"}const{data:j,error:g}=await w.from("appointments").insert([x]).select().single();if(g)throw console.error("Supabase error:",g),new Error(`Failed to create appointment: ${g.message}`);if(!j)throw new Error("Failed to create appointment: No data returned");if(d.video_enabled&&x.video_meeting_id)try{await w.from("instant_sessions").insert({id:x.video_meeting_id,session_name:`${d.title} - Video Session`,session_token:btoa(`${x.video_meeting_id}_${Math.random().toString(36).substr(2,9)}`),therapist_id:d.therapist_id,expires_at:new Date(Date.now()+24*60*60*1e3).toISOString(),is_active:!1,waiting_room_enabled:!0,recording_enabled:!1,max_participants:2})}catch(v){console.warn("Failed to create instant session, but appointment was created:",v)}return console.log("Appointment created successfully:",j),j},onSuccess:d=>{s.invalidateQueries({queryKey:["appointments"]}),console.log("Appointment creation successful, data:",d)},onError:d=>{console.error("Appointment creation failed:",d),t({title:"Error Creating Appointment",description:d.message||"An unexpected error occurred",variant:"destructive"})}}),c=Se({mutationFn:async({id:d,...x})=>{const{data:j,error:g}=await w.from("appointments").update(x).eq("id",d).select().single();if(g)throw new Error(`Failed to update appointment: ${g.message}`);return j},onSuccess:()=>{s.invalidateQueries({queryKey:["appointments"]}),t({title:"Appointment Updated",description:"Your appointment has been updated successfully."})},onError:d=>{t({title:"Error Updating Appointment",description:d.message,variant:"destructive"})}}),u=Se({mutationFn:async d=>{const{data:x,error:j}=await w.from("appointments").delete().eq("id",d);if(j)throw new Error(`Failed to delete appointment: ${j.message}`);return x},onSuccess:()=>{s.invalidateQueries({queryKey:["appointments"]}),t({title:"Appointment Deleted",description:"Your appointment has been deleted successfully."})},onError:d=>{t({title:"Error Deleting Appointment",description:d.message,variant:"destructive"})}}),m=async d=>{const{data:x,error:j}=await w.from("appointments").select("*").eq("id",d).single();if(j)throw new Error(`Failed to fetch appointment: ${j.message}`);return x},h=d=>r==null?void 0:r.find(x=>x.id===d),p=Se({mutationFn:async({id:d,status:x})=>{const{data:j,error:g}=await w.from("appointments").update({status:x}).eq("id",d).select().single();if(g)throw new Error(`Failed to update appointment status: ${g.message}`);return j},onSuccess:()=>{s.invalidateQueries({queryKey:["appointments"]})}});return{appointments:r,isLoading:n,error:o,createAppointment:i,updateAppointment:c,deleteAppointment:u,fetchAppointment:m,getAppointment:h,updateAppointmentStatus:p}},ld=()=>{const{user:s}=V(),{toast:t}=Z(),a=Le(),[r,n]=l.useState(!1),[o,i]=l.useState(!0),[c,u]=l.useState(null),[m,h]=l.useState(null),{data:p,refetch:d}=le({queryKey:["google-calendar-events",c],queryFn:async()=>{if(!c||!r)return[];const{data:g,error:v}=await w.functions.invoke("google-calendar-events",{body:{calendarId:c}});return v?(console.error("Error fetching calendar events:",v),[]):(g==null?void 0:g.events)||[]},enabled:!!c&&r});return l.useEffect(()=>{(async()=>{i(!0);try{if(!(s!=null&&s.id)){i(!1);return}const{data:v,error:f}=await w.from("therapist_settings").select("is_oauth_connected, google_calendar_id").eq("user_id",s.id).single();if(f){console.error("Error fetching therapist settings:",f),i(!1);return}if(n((v==null?void 0:v.is_oauth_connected)||!1),u((v==null?void 0:v.google_calendar_id)||null),v!=null&&v.google_calendar_id){const{data:y,error:b}=await w.functions.invoke("google-calendar-oauth",{body:{action:"getCalendar",calendarId:v.google_calendar_id}});b?console.error("Error fetching calendar title:",b):h((y==null?void 0:y.summary)||null)}}finally{i(!1)}})()},[s==null?void 0:s.id,w]),{isConnected:r,isLoading:o,calendarId:c,calendarTitle:m,events:p||[],refetchEvents:d,connect:async()=>{try{const g=Math.random().toString(36).substring(2,15);localStorage.setItem("googleOAuthState",g);const{data:v,error:f}=await w.functions.invoke("google-calendar-oauth",{body:{action:"getAuthUrl",state:g}});if(f)throw f;window.location.href=v.url}catch(g){console.error("Failed to start Google authentication:",g),t({title:"Authentication Failed",description:"Could not connect to Google Calendar. Please try again.",variant:"destructive"})}},disconnect:async()=>{try{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{error:g}=await w.from("therapist_settings").update({is_oauth_connected:!1,access_token:null,refresh_token:null,token_expires_at:null,google_calendar_id:null}).eq("user_id",s.id);if(g)throw g;t({title:"Disconnected",description:"Successfully disconnected from Google Calendar."}),a.invalidateQueries({queryKey:["therapist_settings"]}),n(!1),u(null)}catch(g){console.error("Failed to disconnect from Google Calendar:",g),t({title:"Disconnection Failed",description:"Could not disconnect from Google Calendar. Please try again.",variant:"destructive"})}}}};class dd{constructor(){J(this,"operations",[]);J(this,"maxOperations",50)}startOperation(t){const a=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.operations.unshift({id:a,type:t,startTime:Date.now()}),this.operations.length>this.maxOperations&&(this.operations=this.operations.slice(0,this.maxOperations)),a}endOperation(t,a,r=0,n){const o=this.operations.find(i=>i.id===t);o&&(o.endTime=Date.now(),o.success=a,o.itemCount=r,o.error=n)}getStats(){const t=this.operations.filter(o=>o.endTime!==void 0),a=t.filter(o=>o.success===!0),r=t.filter(o=>o.success===!1),n=t.reduce((o,i)=>o+(i.endTime-i.startTime),0);return{totalOperations:this.operations.length,successCount:a.length,failCount:r.length,successRate:t.length?a.length/t.length*100:0,averageDuration:t.length?n/t.length:0,lastSync:t.length?t[0].endTime:void 0}}getRecentOperations(){return[...this.operations]}clear(){this.operations=[]}}const Ys=new dd,ti=()=>(Le(),{monitorSync:Se({mutationFn:async r=>({operationId:Ys.startOperation(r.sync_status==="pending"?"initial_sync":"update_sync"),appointment:r})}),completeSync:(r,n=1)=>{Ys.endOperation(r,!0,n)},failSync:(r,n)=>{Ys.endOperation(r,!1,0,n)}});async function ai(s,t=3,a=1e3,r=2){let n=null,o=a;for(let i=0;i<=t;i++)try{return i>0&&(await new Promise(c=>setTimeout(c,o)),o*=r),await s()}catch(c){if(n=c instanceof Error?c:new Error(String(c)),console.error(`Attempt ${i+1}/${t+1} failed:`,n),i===t)throw n}throw n||new Error("Unknown error in retry mechanism")}const ri=()=>({retrySync:Se({mutationFn:async t=>await ai(async()=>{const a=await w.functions.invoke("sync-appointment-to-calendar",{body:{appointment:t}});if(a.error)throw new Error(a.error.message||"Failed to sync appointment");return a},3,1e3,2)})}),ni=()=>{const{isConnected:s}=ld(),{monitorSync:t}=ti(),{retrySync:a}=ri();return{syncAppointmentWithGoogleCalendar:async n=>{if(!s)throw new Error("Google Calendar is not connected");const{operationId:o}=await t.mutateAsync(n);try{const i=await a.mutateAsync(n);if(i.error){const c=i.error;throw new Error(c.message||"Failed to sync with Google Calendar")}return i.data}catch(i){throw console.error("Google Calendar sync error:",i),i}},isGoogleCalendarConnected:s}};class md{constructor(){J(this,"cache",new Map);J(this,"expiry",new Map);J(this,"defaultTTL",5*60*1e3)}set(t,a,r){this.cache.set(t,a);const n=Date.now()+(r||this.defaultTTL);this.expiry.set(t,n)}get(t){if(this.cache.has(t)){const a=this.expiry.get(t);if(a&&a>Date.now())return this.cache.get(t);this.remove(t)}return null}remove(t){this.cache.delete(t),this.expiry.delete(t)}invalidate(t){this.remove(t)}clear(){this.cache.clear(),this.expiry.clear()}purgeExpired(){const t=Date.now();this.expiry.forEach((a,r)=>{a<=t&&this.remove(r)})}}const Qt=new md,ud=()=>{const{toast:s}=Z(),t=Le(),{monitorSync:a,completeSync:r,failSync:n}=ti(),{retrySync:o}=ri(),i=Se({mutationFn:async c=>{const{operationId:u}=await a.mutateAsync(c);try{const m=await o.mutateAsync(c);return r(u),Qt.clear(),m.data}catch(m){throw n(u,m instanceof Error?m.message:String(m)),m}},onSuccess:()=>{t.invalidateQueries({queryKey:["appointments"]}),t.invalidateQueries({queryKey:["google-calendar-events"]}),s({title:"Appointment Synced",description:"The appointment was successfully synchronized"})},onError:c=>{s({title:"Sync Failed",description:c instanceof Error?c.message:"Failed to sync appointment",variant:"destructive"})}});return{syncAppointment:i,isSyncing:i.isPending||a.isPending||o.isPending}},hd=()=>{const{toast:s}=Z(),t=Le(),a=Se({mutationFn:async()=>{var n;const r=Ys.startOperation("bulk_sync");try{const o=await ai(async()=>w.functions.invoke("sync-calendar-background"),3,2e3,2);if(o.error)throw o.error;return Ys.endOperation(r,!0,((n=o.data)==null?void 0:n.synced)||0),o.data}catch(o){throw Ys.endOperation(r,!1,0,o instanceof Error?o.message:String(o)),o}finally{Qt.clear()}},onSuccess:r=>{t.invalidateQueries({queryKey:["appointments"]}),t.invalidateQueries({queryKey:["google-calendar-events"]}),r.synced>0||r.failed>0?s({title:"Calendar Sync Complete",description:`${r.synced} appointments synced, ${r.failed} failed`,variant:r.failed>0?"destructive":"default"}):s({title:"No sync needed",description:"All appointments are already synced"})},onError:r=>{s({title:"Sync failed",description:r instanceof Error?r.message:"Failed to sync appointments",variant:"destructive"})}});return{syncAllPendingAppointments:a,isSyncing:a.isPending}};async function pd(s,t){const a={...t,status:t.status},{data:r,error:n}=await w.from("appointments").update(a).eq("id",s).select("*").single();if(n)throw new Error(`Failed to update appointment: ${n.message}`);return r}const xd=()=>{const{toast:s}=Z(),t=Le(),{syncAppointmentWithGoogleCalendar:a,isGoogleCalendarConnected:r}=ni();return{updateAppointment:Se({mutationFn:async o=>{const i={id:o.id,title:o.title,description:o.description,start_time:o.start_time,end_time:o.end_time,status:o.status,therapist_id:o.therapist_id,patient_id:o.patient_id,video_enabled:o.video_enabled},c=await pd(o.id,i),u={...c,conflicts:Array.isArray(c.conflicts)?c.conflicts.map(m=>({conflict_id:m.conflict_id||"",event_summary:m.event_summary||"",conflict_start:m.conflict_start||"",conflict_end:m.conflict_end||""})):[]};if(r)try{await a(u)}catch(m){console.error("Failed to sync appointment with Google Calendar:",m),s({title:"Sync Warning",description:"Appointment saved but not synced with Google Calendar",variant:"warning"})}return Qt.clear(),u},onSuccess:()=>{t.invalidateQueries({queryKey:["appointments"]}),s({title:"Appointment Updated",description:"The appointment was successfully updated"})},onError:o=>{s({title:"Update Failed",description:o instanceof Error?o.message:"Failed to update appointment",variant:"destructive"})}})}},gd=()=>{const{toast:s}=Z(),t=Le();return{deleteAppointment:Se({mutationFn:async r=>{if(r.google_calendar_event_id)try{await w.functions.invoke("delete-google-calendar-event",{body:{eventId:r.google_calendar_event_id}})}catch(o){console.error("Failed to delete Google Calendar event:",o)}const{error:n}=await w.from("appointments").delete().eq("id",r.id);if(n)throw n;return Qt.clear(),{success:!0}},onSuccess:()=>{t.invalidateQueries({queryKey:["appointments"]}),s({title:"Appointment Deleted",description:"The appointment was successfully deleted"})},onError:r=>{s({title:"Delete Failed",description:r instanceof Error?r.message:"Failed to delete appointment",variant:"destructive"})}})}},fd=()=>{const{syncAppointmentWithGoogleCalendar:s}=ni(),{syncAppointment:t,isSyncing:a}=ud(),{syncAllPendingAppointments:r,isSyncing:n}=hd(),{updateAppointment:o}=xd(),{deleteAppointment:i}=gd();return{syncAppointment:t,syncAllPendingAppointments:r,updateAppointment:o,deleteAppointment:i,syncAppointmentWithGoogleCalendar:s,isSyncing:a||n}},jd=()=>{const s=Le(),{toast:t}=Mn();return{updateAppointmentVideoDetails:Se({mutationFn:async({id:r,video_enabled:n,video_provider:o,video_url:i,video_meeting_id:c})=>{const{error:u}=await w.from("appointments").update({video_enabled:n!==void 0?n:!0,video_provider:o,video_url:i,video_meeting_id:c}).eq("id",r);if(u)throw u},onSuccess:(r,n)=>{s.invalidateQueries({queryKey:["appointments"]}),s.invalidateQueries({queryKey:["appointment",n.id]}),t({title:"Success",description:"Video conference details updated successfully"})},onError:r=>{t({title:"Error",description:"Failed to update video conference details",variant:"destructive"}),console.error("Error updating video details:",r)}})}},vd=()=>{const{createAppointment:s}=qa();return s},ii=()=>{const{appointments:s,isLoading:t,error:a,updateAppointmentStatus:r,createAppointment:n,fetchAppointment:o,getAppointment:i,updateAppointment:c,deleteAppointment:u}=qa(),{syncAppointment:m,updateAppointment:h,deleteAppointment:p,syncAppointmentWithGoogleCalendar:d,syncAllPendingAppointments:x,isSyncing:j}=fd(),{updateAppointmentVideoDetails:g}=jd();return{appointments:s,isLoading:t,error:a,updateAppointmentStatus:r,createAppointment:n,fetchAppointment:o,getAppointment:i,syncAppointment:m,updateAppointment:h,deleteAppointment:p,syncAppointmentWithGoogleCalendar:d,syncAllPendingAppointments:x,isSyncing:j,updateAppointmentVideoDetails:g,updateAppointmentCrud:c,deleteAppointmentCrud:u}},yd=()=>{const{updateAppointment:s}=ii(),{toast:t}=Z(),[a,r]=l.useState(!1),n=l.useCallback(async c=>{r(!0);try{const u=`session_${c}_${Date.now()}`,m=btoa(`${u}_${Math.random().toString(36).substr(2,9)}`),h=`/video-conference/${u}`;await s.mutateAsync({id:c,video_url:h,video_meeting_id:u,video_enabled:!0});const{error:p}=await w.from("instant_sessions").insert({id:u,session_name:"Appointment Session",session_token:m,therapist_id:"",expires_at:new Date(Date.now()+24*60*60*1e3).toISOString(),is_active:!0,waiting_room_enabled:!0,recording_enabled:!1,max_participants:2});if(p)throw console.error("Error creating instant session:",p),new Error("Failed to create video session");return t({title:"Video Session Created",description:"Video session is ready for your appointment"}),{sessionId:u,sessionToken:m,videoUrl:h,appointmentId:c}}catch(u){return console.error("Error creating video session:",u),t({title:"Video Session Error",description:u.message||"Failed to create video session",variant:"destructive"}),null}finally{r(!1)}},[s,t]),o=l.useCallback(c=>c.video_enabled&&c.video_url?c.video_url:null,[]),i=l.useCallback(c=>{const u=o(c);u?window.open(u,"_blank"):t({title:"No Video Session",description:"This appointment doesn't have a video session configured",variant:"destructive"})},[o,t]);return{createVideoSession:n,getVideoSessionUrl:o,joinVideoSession:i,isCreatingSession:a}},fa={isDevelopment:()=>{const s=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.port==="5173"||window.location.port==="3000";return console.log("Environment detection:",{isDev:s,mode:"staging",hostname:window.location.hostname,port:window.location.port,url:window.location.href}),s},isProduction:()=>!fa.isDevelopment(),getBaseUrl:()=>(fa.isDevelopment(),window.location.origin)},fs={TOKEN_ENDPOINT:"undefined/functions/v1/twilio-video-token",DEFAULT_ROOM_CONFIG:{audio:!0,video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:24,max:30}},bandwidthProfile:{video:{mode:"collaboration",maxTracks:10,dominantSpeakerPriority:"standard",renderDimensions:{high:{width:1280,height:720},standard:{width:640,height:480},low:{width:320,height:240}}}},maxAudioBitrate:16e3,preferredVideoCodecs:["VP8","H264"],networkQuality:{local:1,remote:2},dominantSpeaker:!0,automaticSubscription:!0},BREAKOUT_ROOM_CONFIG:{maxRoomsPerSession:10,maxParticipantsPerRoom:15,minParticipantsToCreate:2,autoCloseEmptyRoomDelay:5*60*1e3,defaultRoomNames:["Room 1","Room 2","Room 3","Room 4","Room 5","Room 6","Room 7","Room 8","Room 9","Room 10"]},CONNECTION:{reconnectAttempts:3,reconnectDelay:2e3,tokenRefreshBuffer:5*60*1e3,heartbeatInterval:30*1e3,connectionTimeout:15*1e3},QUALITY_PROFILES:{high:{video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},maxVideoBitrate:25e5},medium:{video:{width:{ideal:640},height:{ideal:480},frameRate:{ideal:24}},maxVideoBitrate:1e6},low:{video:{width:{ideal:320},height:{ideal:240},frameRate:{ideal:15}},maxVideoBitrate:5e5}},getQualityProfile(s){return s>=4?"high":s>=2?"medium":"low"},isDevelopment(){return fa.isDevelopment()},getRoomOptions(s){return{...fs.DEFAULT_ROOM_CONFIG,...s}}},bs={INVALID_ACCESS_TOKEN:20101,ACCESS_TOKEN_EXPIRED:20104,SIGNALING_CONNECTION_ERROR:53e3,SIGNALING_CONNECTION_TIMEOUT:53001,ROOM_CONNECT_FAILED:53104,MEDIA_NO_SUPPORTED_CODEC:53404,MEDIA_CONNECTION_FAILED:53405,PARTICIPANT_DUPLICATE_IDENTITY:53205};function bd(s){switch(s){case bs.INVALID_ACCESS_TOKEN:case bs.ACCESS_TOKEN_EXPIRED:return"Your session has expired. Please refresh and try again.";case bs.SIGNALING_CONNECTION_ERROR:case bs.SIGNALING_CONNECTION_TIMEOUT:return"Unable to connect to the video service. Please check your internet connection.";case bs.ROOM_CONNECT_FAILED:return"Failed to join the room. Please try again.";case bs.MEDIA_CONNECTION_FAILED:return"Media connection failed. Please check your network and try again.";case bs.MEDIA_NO_SUPPORTED_CODEC:return"Your browser does not support the required video codecs.";case bs.PARTICIPANT_DUPLICATE_IDENTITY:return"You are already connected to this session from another device.";default:return"An unexpected error occurred. Please try again."}}class wd{constructor(){J(this,"room",null);J(this,"localTracks",[]);J(this,"eventListeners",new Map);J(this,"reconnecting",!1)}async connect(t){try{console.log("🎥 [TwilioRoomManager] Connecting to room:",t.roomName),this.localTracks.length===0&&(this.localTracks=await this.createLocalTracks(t.audio??!0,t.video??!0));const a={name:t.roomName,audio:t.audio??!0,video:t.video??!0,tracks:this.localTracks,bandwidthProfile:t.bandwidthProfile,networkQuality:t.networkQuality!==!1?{local:1,remote:2}:void 0,dominantSpeaker:t.dominantSpeaker??!0,maxAudioBitrate:t.maxAudioBitrate,maxVideoBitrate:t.maxVideoBitrate,automaticSubscription:!0,preferredVideoCodecs:fs.DEFAULT_ROOM_CONFIG.preferredVideoCodecs};return this.room=await tr.connect(t.token,a),this.setupRoomEventListeners(this.room),console.log("✅ [TwilioRoomManager] Connected to room:",this.room.sid),this.emitEvent({type:"reconnected",timestamp:Date.now()}),this.room}catch(a){console.error("❌ [TwilioRoomManager] Failed to connect:",a);const r=a.code?bd(a.code):a.message;throw new Error(r)}}async createLocalTracks(t,a){try{const r={};t&&(r.audio=!0),a&&(r.video=fs.DEFAULT_ROOM_CONFIG.video);const n=await tr.createLocalTracks(r);return console.log("🎙️ [TwilioRoomManager] Local tracks created:",n.length),n}catch(r){throw console.error("❌ [TwilioRoomManager] Failed to create local tracks:",r),r}}setupRoomEventListeners(t){t.on("participantConnected",a=>{console.log("👤 [TwilioRoomManager] Participant connected:",a.identity),this.emitEvent({type:"participantConnected",participant:this.mapParticipantInfo(a,!1),timestamp:Date.now()}),this.setupParticipantEventListeners(a)}),t.on("participantDisconnected",a=>{console.log("👤 [TwilioRoomManager] Participant disconnected:",a.identity),this.emitEvent({type:"participantDisconnected",participant:this.mapParticipantInfo(a,!1),timestamp:Date.now()})}),t.on("reconnecting",a=>{console.warn("🔄 [TwilioRoomManager] Reconnecting...",a),this.reconnecting=!0,this.emitEvent({type:"reconnecting",data:{error:a},timestamp:Date.now()})}),t.on("reconnected",()=>{console.log("✅ [TwilioRoomManager] Reconnected"),this.reconnecting=!1,this.emitEvent({type:"reconnected",timestamp:Date.now()})}),t.on("disconnected",(a,r)=>{console.log("🔌 [TwilioRoomManager] Disconnected",r),this.emitEvent({type:"disconnected",data:{error:r},timestamp:Date.now()})}),t.dominantSpeaker&&this.emitEvent({type:"dominantSpeakerChanged",participant:this.mapParticipantInfo(t.dominantSpeaker,!1),timestamp:Date.now()}),t.on("dominantSpeakerChanged",a=>{a&&this.emitEvent({type:"dominantSpeakerChanged",participant:this.mapParticipantInfo(a,!1),timestamp:Date.now()})}),t.participants.forEach(a=>{this.setupParticipantEventListeners(a)})}setupParticipantEventListeners(t){t.on("trackSubscribed",a=>{console.log("📹 [TwilioRoomManager] Track subscribed:",a.kind,t.identity),this.emitEvent({type:"trackSubscribed",participant:this.mapParticipantInfo(t,!1),track:{trackName:a.name,trackSid:a.sid,kind:a.kind,isSubscribed:!0,isEnabled:a.isEnabled,priority:null},timestamp:Date.now()})}),t.on("trackUnsubscribed",a=>{console.log("📹 [TwilioRoomManager] Track unsubscribed:",a.kind,t.identity),this.emitEvent({type:"trackUnsubscribed",participant:this.mapParticipantInfo(t,!1),track:{trackName:a.name,trackSid:a.sid,kind:a.kind,isSubscribed:!1,isEnabled:a.isEnabled,priority:null},timestamp:Date.now()})}),t.on("trackEnabled",a=>{console.log("📹 [TwilioRoomManager] Track enabled:",a.kind,t.identity),this.emitEvent({type:"trackEnabled",participant:this.mapParticipantInfo(t,!1),timestamp:Date.now()})}),t.on("trackDisabled",a=>{console.log("📹 [TwilioRoomManager] Track disabled:",a.kind,t.identity),this.emitEvent({type:"trackDisabled",participant:this.mapParticipantInfo(t,!1),timestamp:Date.now()})}),t.on("networkQualityLevelChanged",a=>{this.emitEvent({type:"networkQualityLevelChanged",participant:this.mapParticipantInfo(t,!1),data:{networkQualityLevel:a},timestamp:Date.now()})})}disconnect(){this.room&&(console.log("🔌 [TwilioRoomManager] Disconnecting from room"),this.room.disconnect(),this.room=null),this.localTracks.forEach(t=>t.stop()),this.localTracks=[],this.eventListeners.clear()}toggleAudio(t){if(!this.room)return;this.room.localParticipant.audioTracks.forEach(r=>{t?r.track.enable():r.track.disable()}),console.log("🎙️ [TwilioRoomManager] Audio",t?"enabled":"disabled")}toggleVideo(t){if(!this.room)return;this.room.localParticipant.videoTracks.forEach(r=>{t?r.track.enable():r.track.disable()}),console.log("📹 [TwilioRoomManager] Video",t?"enabled":"disabled")}getRoom(){return this.room}getLocalParticipant(){var t;return((t=this.room)==null?void 0:t.localParticipant)??null}getParticipants(){if(!this.room)return[];const t=[this.mapParticipantInfo(this.room.localParticipant,!0)];return this.room.participants.forEach(a=>{t.push(this.mapParticipantInfo(a,!1))}),t}mapParticipantInfo(t,a){var o,i;const r=Array.from(t.audioTracks.values())[0],n=Array.from(t.videoTracks.values())[0];return{identity:t.identity,sid:t.sid,isLocal:a,state:t.state,networkQualityLevel:t.networkQualityLevel,audioTrackEnabled:((o=r==null?void 0:r.track)==null?void 0:o.isEnabled)??!1,videoTrackEnabled:((i=n==null?void 0:n.track)==null?void 0:i.isEnabled)??!1}}on(t,a){this.eventListeners.has(t)||this.eventListeners.set(t,new Set),this.eventListeners.get(t).add(a)}off(t,a){var r;(r=this.eventListeners.get(t))==null||r.delete(a)}emitEvent(t){const a=this.eventListeners.get(t.type);a&&a.forEach(r=>r(t))}isConnected(){var t;return((t=this.room)==null?void 0:t.state)==="connected"}isReconnecting(){return this.reconnecting}}let ia=null;function pt(){return ia||(ia=new wd),ia}class Qe{static async getAccessToken(t,a){try{console.log("🎫 [TwilioVideoService] Requesting access token for:",{identity:t,roomName:a});const{data:{session:r},error:n}=await w.auth.getSession();if(n||!r)throw new Error("Not authenticated");const o=await fetch(fs.TOKEN_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.access_token}`},body:JSON.stringify({identity:t,roomName:a})});if(!o.ok){const c=await o.json();throw new Error(c.error||"Failed to get access token")}const i=await o.json();return console.log("✅ [TwilioVideoService] Access token received"),i}catch(r){throw console.error("❌ [TwilioVideoService] Failed to get access token:",r),r}}static async validateAndRefreshToken(t,a,r){const n=new Date(t.expiresAt).getTime(),o=Date.now();return n-o<fs.CONNECTION.tokenRefreshBuffer?(console.log("🔄 [TwilioVideoService] Token expiring soon, refreshing..."),await this.getAccessToken(a,r)):t}static async getOrCreateRoomForSession(t){try{const{data:a,error:r}=await w.from("instant_sessions").select("id, session_token").eq("id",t).single();if(r||!a)throw new Error("Session not found");const n=`session-${a.session_token}`;return console.log("🏠 [TwilioVideoService] Room name:",n),n}catch(a){throw console.error("❌ [TwilioVideoService] Failed to get room name:",a),a}}static async logSessionEvent(t,a,r){try{const{data:{user:n}}=await w.auth.getUser();await w.from("session_analytics_events").insert({session_id:t,event_type:a,user_id:n==null?void 0:n.id,metadata:r||{}})}catch(n){console.error("❌ [TwilioVideoService] Failed to log event:",n)}}static async updateParticipantStatus(t,a,r){try{await w.from("instant_session_participants").update({is_active:r==="connected",left_at:r==="disconnected"?new Date().toISOString():null}).eq("id",a),await this.logSessionEvent(t,`participant_${r}`,{participant_id:a})}catch(n){console.error("❌ [TwilioVideoService] Failed to update participant status:",n)}}static async getSessionParticipants(t){try{const{data:a,error:r}=await w.from("instant_session_participants").select("*").eq("session_id",t).eq("is_active",!0).order("joined_at",{ascending:!0});if(r)throw r;return a||[]}catch(a){return console.error("❌ [TwilioVideoService] Failed to get participants:",a),[]}}static async isTherapist(t,a){try{const{data:r,error:n}=await w.from("instant_sessions").select("therapist_id").eq("id",t).single();return n||!r?!1:r.therapist_id===a}catch(r){return console.error("❌ [TwilioVideoService] Failed to check therapist status:",r),!1}}static async getOrCreateParticipant(t,a){try{const{data:{user:r}}=await w.auth.getUser();if(!r)throw new Error("Not authenticated");const{data:n}=await w.from("instant_session_participants").select("id").eq("session_id",t).eq("user_id",r.id).eq("is_active",!0).single();if(n)return n.id;const{data:o,error:i}=await w.from("instant_session_participants").insert({session_id:t,user_id:r.id,participant_name:a,role:await this.isTherapist(t,r.id)?"host":"participant"}).select("id").single();if(i||!o)throw new Error("Failed to create participant");return o.id}catch(r){throw console.error("❌ [TwilioVideoService] Failed to get/create participant:",r),r}}}const Nd=s=>{switch(s){case"idle":return"IDLE";case"connecting":return"CONNECTING";case"connected":return"CONNECTED";case"reconnecting":return"CONNECTING";case"disconnected":return"DISCONNECTED";case"failed":return"FAILED";default:return"IDLE"}},or=s=>s===null?"disconnected":s>=4?"excellent":s>=3?"good":s>=2?"fair":"poor",oi=l.createContext(void 0),ci=({children:s,sessionId:t,sessionType:a="instant"})=>{var Xa,Za;const{user:r,isTherapist:n,isAuthenticated:o}=V(),{toast:i}=Z(),[c,u]=l.useState(null),[m,h]=l.useState("idle"),[p,d]=l.useState([]),[x,j]=l.useState(!0),[g,v]=l.useState(!0),[f,y]=l.useState(5),[b,_]=l.useState(null),[k,S]=l.useState(null),[E,B]=l.useState(null),[M,q]=l.useState(0),[F,P]=l.useState(!1),[L,A]=l.useState(!1),[Q,$]=l.useState([]),[Y,U]=l.useState([]),[G,ee]=l.useState([]),K=l.useRef(pt()),ie=l.useRef(null),pe=l.useRef(null),W=m==="connected",ae=Nd(m),Te=((Xa=r==null?void 0:r.user_metadata)==null?void 0:Xa.fullName)||((Za=r==null?void 0:r.email)==null?void 0:Za.split("@")[0])||"Anonymous",Ye=l.useCallback(z=>{const Ce=z??M,Ae=Math.floor(Ce/60),et=Ce%60;return`${Ae}:${et.toString().padStart(2,"0")}`},[M]);l.useEffect(()=>{if(!E||!W)return;const z=setInterval(()=>{q(Math.floor((Date.now()-E.getTime())/1e3))},1e3);return()=>clearInterval(z)},[E,W]);const ze=p.map(z=>({id:z.sid,name:z.identity,role:z.isLocal&&n?"therapist":"patient",isVideoEnabled:z.videoTrackEnabled,isAudioEnabled:z.audioTrackEnabled,isCurrentUser:z.isLocal,connectionQuality:or(z.networkQualityLevel)})),ts=ze.find(z=>z.role==="therapist")||null,ys=ze.find(z=>z.role==="patient")||null,he={isVideoEnabled:x,isAudioEnabled:g,isScreenSharing:!1,isRecording:!1,isChatOpen:!1,connectionQuality:or(f),sessionDuration:Ye()},cs=(()=>{switch(m){case"idle":return"waiting";case"connecting":return"connecting";case"connected":return"connected";case"reconnecting":return"reconnecting";case"disconnected":return"ended";case"failed":return"failed";default:return"waiting"}})(),ks="available",We={localStream:W,remoteStreams:p.filter(z=>!z.isLocal).length,connectionState:ae,hasVideo:x,hasAudio:g,videoTrackCount:x?1:0,audioTrackCount:g?1:0,lastUpdated:new Date().toISOString()},re=l.useCallback(z=>{var Ce;switch(console.log("🎥 [TwilioVideoSession] Room event:",z.type),z.type){case"participantConnected":z.participant&&(d(Ae=>[...Ae,z.participant]),i({title:"Participant joined",description:`${z.participant.identity} joined the session`}));break;case"participantDisconnected":z.participant&&(d(Ae=>Ae.filter(et=>et.sid!==z.participant.sid)),i({title:"Participant left",description:`${z.participant.identity} left the session`}));break;case"dominantSpeakerChanged":z.participant&&_(z.participant.identity);break;case"networkQualityLevelChanged":((Ce=z.data)==null?void 0:Ce.networkQualityLevel)!==void 0&&y(z.data.networkQualityLevel);break;case"reconnecting":h("reconnecting"),i({title:"Reconnecting...",description:"Connection lost, attempting to reconnect"});break;case"reconnected":h("connected"),i({title:"Reconnected",description:"Connection restored"});break;case"disconnected":h("disconnected"),u(null);break}},[i]);l.useEffect(()=>{const z=K.current,Ce=["participantConnected","participantDisconnected","dominantSpeakerChanged","networkQualityLevelChanged","reconnecting","reconnected","disconnected"];return Ce.forEach(Ae=>z.on(Ae,re)),()=>{Ce.forEach(Ae=>z.off(Ae,re))}},[re]),l.useEffect(()=>{const z=async()=>{try{const Ce=await navigator.mediaDevices.enumerateDevices();$(Ce.filter(Ae=>Ae.kind==="videoinput")),U(Ce.filter(Ae=>Ae.kind==="audioinput")),ee(Ce.filter(Ae=>Ae.kind==="audiooutput"))}catch(Ce){console.error("Failed to enumerate devices:",Ce)}};return z(),navigator.mediaDevices.addEventListener("devicechange",z),()=>navigator.mediaDevices.removeEventListener("devicechange",z)},[]);const ke=l.useCallback(async()=>{if(!t||!o||!(r!=null&&r.id)){i({title:"Cannot join session",description:"Please log in to join the session",variant:"destructive"});return}if(m==="connecting"||m==="connected"){console.warn("⚠️ [TwilioVideoSession] Already connecting or connected");return}try{h("connecting"),S(null);const z=await Qe.getOrCreateRoomForSession(t),Ce=await Qe.getAccessToken(Te,z);await Qe.getOrCreateParticipant(t,Te);const Ae=await K.current.connect({roomName:z,token:Ce.token,audio:!0,video:!0,networkQuality:!0,dominantSpeaker:!0});u(Ae),h("connected"),B(new Date);const et=K.current.getParticipants();d(et),await Qe.logSessionEvent(t,"participant_connected",{participant_name:Te,room_name:z}),i({title:"Connected",description:"Successfully connected to video session"})}catch(z){console.error("❌ [TwilioVideoSession] Connection failed:",z),h("failed"),S(z.message||"Failed to connect"),i({title:"Connection failed",description:z.message||"Failed to connect to video session",variant:"destructive"})}},[t,o,r==null?void 0:r.id,Te,m,i]),je=l.useCallback(async()=>{console.log("🔌 [TwilioVideoSession] Leaving session..."),K.current.disconnect(),u(null),h("disconnected"),d([]),_(null),B(null),q(0),t&&await Qe.logSessionEvent(t,"participant_disconnected",{participant_name:Te}),i({title:"Session Ended",description:"You have left the video session"})},[t,Te,i]),ue=l.useCallback(async()=>{await je(),await ke()},[je,ke]),oe=l.useCallback(async()=>{const z=!x;return K.current.toggleVideo(z),j(z),t&&Qe.logSessionEvent(t,`video_${z?"enabled":"disabled"}`),z},[x,t]),Zs=l.useCallback(async()=>{const z=!g;return K.current.toggleAudio(z),v(z),t&&Qe.logSessionEvent(t,`audio_${z?"enabled":"disabled"}`),z},[g,t]),Ve=l.useCallback(async()=>(console.log("Screen sharing not yet implemented in Twilio context"),!1),[]),yt=l.useCallback(async()=>(console.log("Recording not yet implemented in Twilio context"),!1),[]),no=l.useCallback(async(z,Ce)=>{console.log(`Device change (${z}): ${Ce} - not yet implemented`)},[]),io=l.useCallback(async()=>{try{return(await navigator.mediaDevices.getUserMedia({video:!0,audio:!0})).getTracks().forEach(Ce=>Ce.stop()),!0}catch(z){return console.error("Device test failed:",z),!1}},[]);l.useEffect(()=>()=>{K.current.isConnected()&&K.current.disconnect()},[]);const oo={room:c,videoState:he,isInSession:W,sessionDuration:Ye(),connectionState:ae,isVideoEnabled:x,isAudioEnabled:g,therapistInfo:ts,patientInfo:ys,isTherapist:n,participants:ze,twilioParticipants:p,localVideoRef:ie,remoteVideoRef:pe,localStream:null,remoteStreams:[],connectedPeers:p.filter(z=>!z.isLocal).map(z=>z.sid),joinSession:ke,leaveSession:je,reconnectSession:ue,toggleVideo:oe,toggleAudio:Zs,toggleScreenSharing:Ve,toggleScreenShare:Ve,toggleRecording:yt,cameras:Q,microphones:Y,speakers:G,changeDevice:no,testDevices:io,deviceSettingsOpen:F,setDeviceSettingsOpen:P,waitingRoomActive:!1,showSessionSummary:L,setShowSessionSummary:A,deviceSwitching:!1,sessionStatus:cs,cameraStatus:ks,streamDebugInfo:We,networkQuality:f,dominantSpeaker:b,error:k,formatSessionDuration:Ye};return e.jsx(oi.Provider,{value:oo,children:s})},vt=()=>{const s=l.useContext(oi);if(s===void 0)throw new Error("useTwilioVideoSession must be used within a TwilioVideoSessionProvider");return s},Sd=({appointmentDetails:s,isInSession:t,waitingRoomActive:a,isRecording:r,deviceSettingsOpen:n,setDeviceSettingsOpen:o,videoState:i,devices:c,changeDevice:u,testDevices:m,formatSessionDuration:h})=>e.jsxs(R,{className:"mb-4",children:[e.jsx(I,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx(O,{className:"text-lg",children:s.title}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsx(D,{variant:t?"default":"secondary",children:t?"In Session":"Not Started"}),a&&e.jsxs(D,{variant:"outline",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Waiting Room"]}),r&&e.jsxs(D,{variant:"destructive",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"}),"Recording"]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[t&&e.jsxs("div",{className:"flex items-center space-x-1 text-sm text-muted-foreground",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{children:h(0)})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[i.isVideoEnabled?e.jsx(ne,{className:"h-4 w-4 text-green-600"}):e.jsx(Ss,{className:"h-4 w-4 text-red-600"}),i.isAudioEnabled?e.jsx(os,{className:"h-4 w-4 text-green-600"}):e.jsx(gt,{className:"h-4 w-4 text-red-600"})]}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>o(!n),children:e.jsx(hs,{className:"h-4 w-4"})})]})]})}),!s.recording_consent&&e.jsx(T,{className:"pt-0",children:e.jsxs("div",{className:"flex items-center space-x-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Je,{className:"h-4 w-4 text-yellow-600"}),e.jsx("span",{className:"text-sm text-yellow-800",children:"Recording consent not provided. Session will not be recorded."})]})})]}),Cd=({appointmentId:s,onComplete:t})=>{const{videoState:a,isTherapist:r,therapistInfo:n,patientInfo:o,deviceSettingsOpen:i,setDeviceSettingsOpen:c,cameraStatus:u,cameras:m,microphones:h,speakers:p,changeDevice:d,testDevices:x,localVideoRef:j}=vt(),[g,v]=l.useState("permissions"),[f,y]=l.useState(!1),[b,_]=l.useState(!1),[k,S]=l.useState(!1),[E,B]=l.useState(null);l.useEffect(()=>{g==="permissions"&&(async()=>{try{const L=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});B(L),j.current&&(j.current.srcObject=L),y(!0),v("devices")}catch(L){console.error("Permission check failed:",L),y(!1)}})()},[g,j]),l.useEffect(()=>()=>{E&&E.getTracks().forEach(P=>P.stop())},[E]);const M=async()=>{S(!0);try{await x()&&(_(!0),v("ready"))}finally{S(!1)}},q=()=>{E&&(E.getTracks().forEach(P=>P.stop()),B(null)),t()},F=[{id:"permissions",title:"Camera & Microphone Access",status:f?"completed":"current",description:"Grant access to your camera and microphone"},{id:"devices",title:"Device Check",status:b?"completed":f?"current":"pending",description:"Test your camera and microphone"},{id:"ready",title:"Ready to Join",status:g==="ready"?"current":"pending",description:"All systems ready for your session"}];return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Prepare for Your Session"}),e.jsx("p",{className:"text-muted-foreground",children:"Let's make sure everything is working before you join"})]}),e.jsx("div",{className:"flex justify-center mb-8",children:e.jsx("div",{className:"flex items-center space-x-4",children:F.map((P,L)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:C("w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium",P.status==="completed"&&"bg-green-500 text-white",P.status==="current"&&"bg-primary text-white",P.status==="pending"&&"bg-gray-200 text-gray-500"),children:P.status==="completed"?e.jsx(fe,{className:"h-4 w-4"}):L+1}),e.jsxs("div",{className:"ml-2 hidden sm:block",children:[e.jsx("div",{className:"text-sm font-medium",children:P.title}),e.jsx("div",{className:"text-xs text-muted-foreground",children:P.description})]})]}),L<F.length-1&&e.jsx("div",{className:"w-8 h-0.5 bg-gray-200"})]},P.id))})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"Video Preview"]})}),e.jsx(T,{children:e.jsxs("div",{className:"aspect-video bg-slate-900 rounded-lg overflow-hidden relative",children:[f?e.jsx("video",{ref:j,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-white",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ne,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Camera access needed"})]})}),e.jsx("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/50 px-2 py-1 rounded",children:r?n==null?void 0:n.name:o==null?void 0:o.name})]})})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5"}),"Session Setup"]})}),e.jsxs(T,{className:"space-y-4",children:[g==="permissions"&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Camera & Microphone Access"}),u==="permission-denied"?e.jsxs(ye,{variant:"destructive",children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(be,{children:"Camera access was denied. Please enable it in your browser settings and refresh the page."})]}):e.jsxs(ye,{children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(be,{children:"Please allow access to your camera and microphone when prompted."})]})]}),g==="devices"&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-4",children:"Test Your Devices"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Camera"}),e.jsxs("select",{className:"w-full mt-1 p-2 border rounded-md",onChange:P=>d("camera",P.target.value),value:a.selectedCamera||"",children:[e.jsx("option",{value:"",children:"Select Camera"}),m.map(P=>e.jsx("option",{value:P.deviceId,children:P.label||`Camera ${P.deviceId.slice(0,5)}`},P.deviceId))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Microphone"}),e.jsxs("select",{className:"w-full mt-1 p-2 border rounded-md",onChange:P=>d("microphone",P.target.value),value:a.selectedMicrophone||"",children:[e.jsx("option",{value:"",children:"Select Microphone"}),h.map(P=>e.jsx("option",{value:P.deviceId,children:P.label||`Microphone ${P.deviceId.slice(0,5)}`},P.deviceId))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Speaker"}),e.jsxs("select",{className:"w-full mt-1 p-2 border rounded-md",onChange:P=>d("speaker",P.target.value),value:a.selectedSpeaker||"",children:[e.jsx("option",{value:"",children:"Select Speaker"}),p.map(P=>e.jsx("option",{value:P.deviceId,children:P.label||`Speaker ${P.deviceId.slice(0,5)}`},P.deviceId))]})]}),e.jsx(N,{onClick:M,disabled:k,className:"w-full",children:k?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"mr-2 h-4 w-4 animate-spin"}),"Testing Devices..."]}):e.jsxs(e.Fragment,{children:[e.jsx(os,{className:"mr-2 h-4 w-4"}),"Test Devices"]})})]})]}),g==="ready"&&e.jsx("div",{children:e.jsxs("div",{className:"text-center py-6",children:[e.jsx(fe,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"All Set!"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Your camera and microphone are working properly. You're ready to join the session."}),e.jsx(N,{onClick:q,size:"lg",className:"px-8",children:"Join Session"})]})})]})]})]})]})})};class kd extends l.Component{constructor(a){super(a);J(this,"maxRetries",3);J(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries&&this.setState(a=>({hasError:!1,error:null,errorInfo:null,retryCount:a.retryCount+1}))});J(this,"handleGoHome",()=>{window.location.href="/"});J(this,"getErrorMessage",a=>a?a.message.includes("permission")?"Camera or microphone permission denied. Please allow access and try again.":a.message.includes("network")||a.message.includes("connection")?"Network connection error. Please check your internet connection.":a.message.includes("webrtc")||a.message.includes("peer")?"Video connection failed. This might be due to network restrictions.":a.message.includes("device")||a.message.includes("media")?"Device access error. Please check your camera and microphone.":a.message||"An unexpected error occurred during the session":"An unexpected error occurred");J(this,"getErrorSeverity",a=>{if(!a)return"error";const r=a.message.toLowerCase();return r.includes("permission")||r.includes("device")?"warning":"error"});this.state={hasError:!1,error:null,errorInfo:null,retryCount:0}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,r){this.setState({error:a,errorInfo:r}),this.props.onError&&this.props.onError(a,r),console.error("Session Error Boundary caught an error:",a,r)}render(){if(this.state.hasError){const a=this.getErrorMessage(this.state.error),r=this.getErrorSeverity(this.state.error),n=this.state.retryCount<this.maxRetries;return e.jsx("div",{className:"flex items-center justify-center min-h-[400px] p-4",children:e.jsxs(R,{className:"w-full max-w-lg border-destructive/20",children:[e.jsxs(I,{className:"text-center",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:`rounded-full p-4 ${r==="warning"?"bg-amber-500/10 text-amber-600":"bg-red-500/10 text-red-600"}`,children:e.jsx(_e,{className:"h-8 w-8"})})}),e.jsx(O,{className:"text-xl font-semibold",children:"Session Error"})]}),e.jsxs(T,{className:"space-y-6",children:[e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("p",{className:"text-muted-foreground",children:a}),e.jsx("div",{className:"flex justify-center",children:e.jsx(D,{variant:r==="warning"?"secondary":"destructive",children:r==="warning"?"Action Required":"System Error"})})]}),!1,e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[n&&e.jsxs(N,{onClick:this.handleRetry,className:"flex-1",variant:"default",children:[e.jsx(ns,{className:"mr-2 h-4 w-4"}),"Try Again (",this.maxRetries-this.state.retryCount," left)"]}),e.jsxs(N,{onClick:this.handleGoHome,variant:"outline",className:"flex-1",children:[e.jsx(Ws,{className:"mr-2 h-4 w-4"}),"Go Home"]})]}),!n&&e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Maximum retry attempts reached. Please refresh the page or contact support."})})]})]})})}return this.props.children}}const He=zr,Ua=Vr,_d=Ur,li=l.forwardRef(({className:s,...t},a)=>e.jsx(Ft,{ref:a,className:C("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t}));li.displayName=Ft.displayName;const $e=l.forwardRef(({className:s,children:t,...a},r)=>e.jsxs(_d,{children:[e.jsx(li,{}),e.jsxs(Lt,{ref:r,className:C("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...a,children:[t,e.jsxs($r,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));$e.displayName=Lt.displayName;const Oe=({className:s,...t})=>e.jsx("div",{className:C("flex flex-col space-y-1.5 text-center sm:text-left",s),...t});Oe.displayName="DialogHeader";const di=({className:s,...t})=>e.jsx("div",{className:C("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});di.displayName="DialogFooter";const Fe=l.forwardRef(({className:s,...t},a)=>e.jsx(qt,{ref:a,className:C("text-lg font-semibold leading-none tracking-tight",s),...t}));Fe.displayName=qt.displayName;const $s=l.forwardRef(({className:s,...t},a)=>e.jsx(Ut,{ref:a,className:C("text-sm text-muted-foreground",s),...t}));$s.displayName=Ut.displayName;const mi=()=>{const[s,t]=l.useState(!1),[a,r]=l.useState([]),{toast:n}=Z(),o=l.useCallback(async p=>{t(!0);try{console.log("🚀 Creating instant session with data:",p);const{data:{user:d},error:x}=await w.auth.getUser();if(x||!d)throw console.error("❌ User authentication failed:",x),new Error("User not authenticated");console.log("✅ User authenticated:",d.id);const j=ar(12),g=new Date;g.setHours(g.getHours()+(p.duration_hours||2)),console.log("📅 Session expires at:",g.toISOString());const v=`${p.session_name}-${ar(6)}`;console.log("📝 Unique session name:",v);const{data:f,error:y}=await w.from("instant_sessions").insert({therapist_id:d.id,session_token:j,session_name:v,max_participants:p.max_participants||2,expires_at:g.toISOString(),recording_enabled:p.recording_enabled||!1,waiting_room_enabled:p.waiting_room_enabled||!0}).select().single();if(y)throw console.error("❌ Database error creating session:",y),new Error(`Failed to create session: ${y.message}`);return console.log("✅ Session created successfully:",f),n({title:"Session Created",description:"Instant session created successfully!"}),f}catch(d){console.error("❌ Error creating instant session:",d);const x=d instanceof Error?d.message:"Failed to create instant session";throw n({title:"Error",description:x,variant:"destructive"}),d}finally{t(!1)}},[n]),i=l.useCallback(async p=>{try{const{data:d,error:x}=await w.from("instant_sessions").select("*").eq("therapist_id",p).eq("is_active",!0).gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1});if(x)throw x;return r(d),d}catch(d){return console.error("Error fetching sessions:",d),[]}},[]),c=l.useCallback(async p=>{try{const{data:d,error:x}=await w.from("instant_sessions").select("*").eq("session_token",p).eq("is_active",!0).gt("expires_at",new Date().toISOString()).single();if(x)throw x;return d}catch(d){return console.error("Error fetching session by token:",d),null}},[]),u=l.useCallback(async p=>{try{const{error:d}=await w.from("instant_sessions").update({is_active:!1}).eq("id",p);if(d)throw d;await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("session_id",p),n({title:"Session Ended",description:"The session has been ended successfully."});const{data:x}=await w.auth.getUser();x.user&&await i(x.user.id)}catch(d){console.error("Error ending session:",d),n({title:"Error",description:"Failed to end session",variant:"destructive"})}},[n,i]),m=l.useCallback(async(p,d)=>{var x,j;try{const{data:g}=await w.auth.getUser(),{error:v}=await w.from("instant_session_participants").insert({session_id:p,user_id:((x=g.user)==null?void 0:x.id)||null,participant_name:d||((j=g.user)==null?void 0:j.email)||"Anonymous",role:"participant"});if(v)throw v;n({title:"Joined Session",description:"Successfully joined the session!"})}catch(g){throw console.error("Error joining session:",g),n({title:"Error",description:"Failed to join session",variant:"destructive"}),g}},[n]),h=l.useCallback(p=>{const d=window.location.origin,x=a.find(j=>j.session_token===p);return x?`${d}/video-conference/${x.id}?join=true`:`${d}/session/instant/${p}`},[a]);return{loading:s,sessions:a,createInstantSession:o,getActiveSessionsByTherapist:i,getSessionByToken:c,endSession:u,joinSession:m,generateShareableLink:h}},ui=s=>{const[t,a]=l.useState(null),[r,n]=l.useState(!0),[o,i]=l.useState(null);return l.useEffect(()=>{if((async()=>{if(!s||s.trim()===""||s==="mock-appointment-id"){a(null),n(!1);return}try{n(!0),i(null);const{data:m,error:h}=await w.from("instant_sessions").select("*").eq("id",s).single();h?(h.code==="PGRST116"?i("Session not found"):i(h.message),a(null)):a(m)}catch(m){console.error("Error fetching session details:",m),i("Failed to load session details"),a(null)}finally{n(!1)}})(),s&&s.trim()!==""&&s!=="mock-appointment-id"){const m=w.channel(`session-${s}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"instant_sessions",filter:`id=eq.${s}`},h=>{a(h.new)}).subscribe();return()=>{w.removeChannel(m)}}},[s]),{sessionDetails:t,isLoading:r,error:o,updateSession:async u=>{if(!(!s||!t))try{const{error:m}=await w.from("instant_sessions").update(u).eq("id",s);if(m)throw m;a(h=>h?{...h,...u}:null)}catch(m){console.error("Error updating session:",m),i("Failed to update session")}}}},$a=({open:s,onOpenChange:t,sessionId:a})=>{const{generateShareableLink:r}=mi(),{sessionDetails:n}=ui(a),{toast:o}=Z(),[i,c]=l.useState(""),[u,m]=l.useState("");l.useEffect(()=>{if(n){const x=r(n.session_token);c(x)}},[n,r]),l.useEffect(()=>{if(!n)return;const x=()=>{const g=new Date,f=new Date(n.expires_at).getTime()-g.getTime();if(f<=0){m("Expired");return}const y=Math.floor(f/(1e3*60*60)),b=Math.floor(f%(1e3*60*60)/(1e3*60));y>0?m(`${y}h ${b}m remaining`):m(`${b}m remaining`)};x();const j=setInterval(x,6e4);return()=>clearInterval(j)},[n]);const h=async()=>{try{await navigator.clipboard.writeText(i),o({title:"Link Copied",description:"Session link copied to clipboard!"})}catch{o({title:"Copy Failed",description:"Failed to copy link to clipboard",variant:"destructive"})}},p=()=>{const x=`Join my video session: ${n==null?void 0:n.session_name}`,j=`You're invited to join my video session!

Session: ${n==null?void 0:n.session_name}
Link: ${i}

This link expires in ${u}.`;window.open(`mailto:?subject=${encodeURIComponent(x)}&body=${encodeURIComponent(j)}`)},d=()=>{const x=`Join my video session: ${n==null?void 0:n.session_name}
${i}

Expires in ${u}`;window.open(`https://wa.me/?text=${encodeURIComponent(x)}`)};return n?e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"sm:max-w-md",children:[e.jsxs(Oe,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(ft,{className:"h-5 w-5"}),"Invite Participants"]}),e.jsx($s,{children:"Share this link to invite others to join your session"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 space-y-2",children:[e.jsx("h4",{className:"font-medium",children:n.session_name}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsxs("span",{children:["Max ",n.max_participants," participants"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{children:u})]})]}),e.jsxs("div",{className:"flex gap-2",children:[n.recording_enabled&&e.jsx(D,{variant:"secondary",className:"text-xs",children:"Recording Enabled"}),n.waiting_room_enabled&&e.jsx(D,{variant:"outline",className:"text-xs",children:"Waiting Room"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Session Link"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ne,{value:i,readOnly:!0,className:"font-mono text-sm"}),e.jsx(N,{variant:"outline",size:"icon",onClick:h,className:"shrink-0",children:e.jsx(ha,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Share Via"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:p,className:"text-sm",children:"Email"}),e.jsx(N,{variant:"outline",size:"sm",onClick:d,className:"text-sm",children:"WhatsApp"})]})]}),e.jsx("div",{className:"flex justify-center p-4 border-2 border-dashed border-muted rounded-lg",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(cc,{className:"h-8 w-8 mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"QR Code"}),e.jsx("p",{className:"text-xs",children:"Coming soon"})]})}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsxs(N,{onClick:h,className:"flex-1",children:[e.jsx(ha,{className:"h-4 w-4 mr-2"}),"Copy Link"]}),e.jsx(N,{variant:"outline",onClick:()=>t(!1),children:"Done"})]})]})]})}):null},cr=({connectionState:s,connectionStates:t={},className:a})=>{const r=()=>{switch(s){case"CONNECTING":return e.jsx(Ke,{className:"h-4 w-4 animate-spin"});case"CONNECTED":return e.jsx(fe,{className:"h-4 w-4 text-green-500"});case"FAILED":return e.jsx(Ns,{className:"h-4 w-4 text-red-500"});case"DISCONNECTED":return e.jsx(Cs,{className:"h-4 w-4 text-orange-500"});default:return e.jsx(Xe,{className:"h-4 w-4 text-muted-foreground"})}},n=()=>{const c=Object.keys(t).length,u=Object.values(t).filter(m=>m==="connected").length;switch(s){case"CONNECTING":return"Connecting to session...";case"CONNECTED":return c>0?`Connected (${u}/${c} participants)`:"Connected - waiting for participants";case"FAILED":return"Connection failed";case"DISCONNECTED":return"Connection lost - attempting to reconnect";default:return"Ready to connect"}},o=()=>{switch(s){case"CONNECTED":return"default";case"CONNECTING":return"secondary";case"FAILED":return"destructive";case"DISCONNECTED":return"outline";default:return"secondary"}},i=s==="CONNECTED"&&Object.keys(t).length>0;return e.jsxs("div",{className:C("space-y-2",a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r(),e.jsx(D,{variant:o(),className:"text-xs",children:n()})]}),s==="FAILED"&&e.jsxs(ye,{variant:"destructive",className:"text-xs",children:[e.jsx(Ns,{className:"h-3 w-3"}),e.jsx(be,{className:"text-xs",children:"Unable to establish connection. Check your internet connection and try again."})]}),s==="DISCONNECTED"&&e.jsxs(ye,{className:"text-xs",children:[e.jsx(_e,{className:"h-3 w-3"}),e.jsx(be,{className:"text-xs",children:"Connection temporarily lost. Attempting to reconnect..."})]}),i&&e.jsx("div",{className:"text-xs text-muted-foreground space-y-1",children:Object.entries(t).map(([c,u])=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:C("h-2 w-2 rounded-full",u==="connected"?"bg-green-500":u==="connecting"?"bg-yellow-500":"bg-red-500")}),e.jsxs("span",{children:["Participant: ",u]})]},c))})]})},hi=({connectionState:s,isInSession:t,onRetry:a,className:r,deviceStatus:n})=>{if(s==="CONNECTED"||!t&&s==="IDLE")return null;const i=(()=>{if(n){if(n.camera==="detecting"||n.microphone==="detecting")return{icon:e.jsx(ds,{className:"h-8 w-8 animate-pulse text-primary"}),title:"Detecting Devices",description:"Checking for available cameras and microphones...",bgColor:"bg-background/95",showRetry:!1,showProgress:!0,progress:25};if(n.camera==="requesting"||n.microphone==="requesting"){const c=[];return n.camera==="requesting"&&c.push("camera"),n.microphone==="requesting"&&c.push("microphone"),{icon:e.jsx(Qs,{className:"h-8 w-8 animate-pulse text-primary"}),title:"Requesting Permissions",description:`Please allow access to your ${c.join(" and ")}...`,bgColor:"bg-primary/10",showRetry:!1,showProgress:!0,progress:50}}if(n.camera==="denied"||n.microphone==="denied"){const c=[];return n.camera==="denied"&&c.push("camera"),n.microphone==="denied"&&c.push("microphone"),{icon:e.jsx(Je,{className:"h-8 w-8 text-destructive"}),title:"Permission Required",description:`Please enable ${c.join(" and ")} access in your browser settings`,bgColor:"bg-destructive/10",showRetry:!0,showProgress:!1}}if(n.camera==="unavailable"&&n.microphone==="unavailable")return{icon:e.jsx(Je,{className:"h-8 w-8 text-amber-500"}),title:"No Devices Found",description:"No camera or microphone detected. Please connect your devices.",bgColor:"bg-amber-50/95 dark:bg-amber-950/95",showRetry:!0,showProgress:!1};if(n.step)return{icon:e.jsx(Ke,{className:"h-8 w-8 animate-spin text-primary"}),title:"Setting Up Connection",description:n.step,bgColor:"bg-background/95",showRetry:!1,showProgress:!0,progress:n.progress||75}}switch(s){case"CONNECTING":return{icon:e.jsx(Ke,{className:"h-8 w-8 animate-spin text-primary"}),title:"Connecting...",description:"Establishing video connection",bgColor:"bg-background/95",showRetry:!1,showProgress:!0,progress:75};case"DISCONNECTED":return{icon:e.jsx(Cs,{className:"h-8 w-8 text-amber-500"}),title:"Connection Lost",description:"Attempting to reconnect automatically",bgColor:"bg-amber-50/95 dark:bg-amber-950/95",showRetry:!0,showProgress:!1};case"FAILED":return{icon:e.jsx(Je,{className:"h-8 w-8 text-destructive"}),title:"Connection Failed",description:"Unable to establish video connection",bgColor:"bg-destructive/10",showRetry:!0,showProgress:!1};default:return{icon:e.jsx(Xe,{className:"h-8 w-8 text-muted-foreground"}),title:"Preparing Connection",description:"Getting ready to connect",bgColor:"bg-background/95",showRetry:!1,showProgress:!0,progress:25}}})();return e.jsx("div",{className:C("absolute inset-0 z-50 flex items-center justify-center",i.bgColor,"backdrop-blur-sm",r),children:e.jsxs("div",{className:"flex flex-col items-center gap-4 p-6 rounded-lg max-w-sm mx-4 text-center",children:[e.jsx("div",{className:"p-3 rounded-full bg-background/80 shadow-sm",children:i.icon}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:i.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i.description})]}),i.showProgress&&e.jsxs("div",{className:"w-full max-w-xs space-y-2",children:[e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary rounded-full transition-all duration-1000 ease-out",style:{width:`${i.progress||50}%`}})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(n==null?void 0:n.step)||"This may take a few seconds..."})]}),n&&e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:C("h-4 w-4",n.camera==="granted"&&"text-green-500",n.camera==="denied"&&"text-red-500",n.camera==="unavailable"&&"text-gray-400",(n.camera==="detecting"||n.camera==="requesting")&&"text-primary animate-pulse")}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[n.camera==="granted"&&"Camera OK",n.camera==="denied"&&"Camera Blocked",n.camera==="unavailable"&&"No Camera",(n.camera==="detecting"||n.camera==="requesting")&&"Camera..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:C("h-4 w-4",n.microphone==="granted"&&"text-green-500",n.microphone==="denied"&&"text-red-500",n.microphone==="unavailable"&&"text-gray-400",(n.microphone==="detecting"||n.microphone==="requesting")&&"text-primary animate-pulse")}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[n.microphone==="granted"&&"Mic OK",n.microphone==="denied"&&"Mic Blocked",n.microphone==="unavailable"&&"No Mic",(n.microphone==="detecting"||n.microphone==="requesting")&&"Mic..."]})]})]}),i.showRetry&&a&&e.jsxs(N,{onClick:a,variant:"outline",size:"sm",className:"mt-2",children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Try Again"]})]})})};function pi(){const{toast:s}=Z(),[t,a]=l.useState({availability:{hasCameras:!1,hasMicrophones:!1,hasSpeakers:!1,cameraCount:0,microphoneCount:0,speakerCount:0,loading:!0,error:null},capabilities:{video:!1,audio:!1,canDoVideoOnly:!1,canDoAudioOnly:!1,isMobile:!1,recommendedMode:"none"},permissions:{camera:"prompt",microphone:"prompt",canRequestCamera:!1,canRequestMicrophone:!1},devices:{cameras:[],microphones:[],speakers:[]}}),r=l.useCallback(()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),[]),n=l.useCallback(async()=>{try{console.log("📱 [EnhancedDeviceManager] Starting device enumeration..."),a(g=>({...g,availability:{...g.availability,loading:!0,error:null}}));const c=await navigator.mediaDevices.enumerateDevices(),u=c.filter(g=>g.kind==="videoinput"),m=c.filter(g=>g.kind==="audioinput"),h=c.filter(g=>g.kind==="audiooutput");console.log("📊 [EnhancedDeviceManager] Device counts:",{cameras:u.length,microphones:m.length,speakers:h.length});const p={hasCameras:u.length>0,hasMicrophones:m.length>0,hasSpeakers:h.length>0,cameraCount:u.length,microphoneCount:m.length,speakerCount:h.length,loading:!1,error:null},d=r(),x={video:p.hasCameras,audio:p.hasMicrophones,canDoVideoOnly:p.hasCameras,canDoAudioOnly:p.hasMicrophones,isMobile:d,recommendedMode:p.hasCameras&&p.hasMicrophones?"both":p.hasCameras?"video-only":p.hasMicrophones?"audio-only":"none"},j={camera:p.hasCameras?"prompt":"unavailable",microphone:p.hasMicrophones?"prompt":"unavailable",canRequestCamera:p.hasCameras,canRequestMicrophone:p.hasMicrophones};if(navigator.permissions)try{if(p.hasCameras){const g=await navigator.permissions.query({name:"camera"});j.camera=g.state}if(p.hasMicrophones){const g=await navigator.permissions.query({name:"microphone"});j.microphone=g.state}}catch{console.log("📊 [EnhancedDeviceManager] Permission API not available")}a({availability:p,capabilities:x,permissions:j,devices:{cameras:u,microphones:m,speakers:h}}),console.log("✅ [EnhancedDeviceManager] Device enumeration complete:",{availability:p,capabilities:x,permissions:{camera:j.camera,microphone:j.microphone,canRequestCamera:j.canRequestCamera,canRequestMicrophone:j.canRequestMicrophone}})}catch(c){console.error("❌ [EnhancedDeviceManager] Device enumeration failed:",c),a(u=>({...u,availability:{...u.availability,loading:!1,error:c instanceof Error?c.message:"Device enumeration failed"}}))}},[r]),o=l.useCallback(async(c={})=>{const{requestVideo:u=!0,requestAudio:m=!0,fallbackToAudioOnly:h=!0,fallbackToVideoOnly:p=!0}=c;console.log("🔒 [EnhancedDeviceManager] Requesting permissions:",{requestVideo:u,requestAudio:m,fallbackToAudioOnly:h,fallbackToVideoOnly:p,deviceState:{hasCameras:t.availability.hasCameras,hasMicrophones:t.availability.hasMicrophones}});const d=u&&t.availability.hasCameras,x=m&&t.availability.hasMicrophones;if(!d&&!x)return console.warn("❌ [EnhancedDeviceManager] No devices available for permissions"),s({title:"No Devices Available",description:"No camera or microphone found on this device",variant:"destructive"}),{success:!1,stream:null,mode:"none",error:"No devices available for requested permissions",hasVideo:!1,hasAudio:!1};const j=(g,v,f)=>{const y=g.getVideoTracks(),b=g.getAudioTracks(),_=y.length>0&&y[0].readyState==="live",k=b.length>0&&b[0].readyState==="live";return console.log("🔍 [EnhancedDeviceManager] Stream verification:",{videoTracks:y.length,audioTracks:b.length,hasActiveVideo:_,hasActiveAudio:k,expectedVideo:v,expectedAudio:f}),{hasVideo:_,hasAudio:k,isValid:(!v||_)&&(!f||k)}};if(d&&x)try{console.log("🎯 [EnhancedDeviceManager] Attempting both video and audio...");const g=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),v=j(g,!0,!0);if(v.isValid)return a(f=>({...f,permissions:{...f.permissions,camera:"granted",microphone:"granted"}})),console.log("✅ [EnhancedDeviceManager] Both permissions granted with active tracks"),{success:!0,stream:g,mode:"both",hasVideo:v.hasVideo,hasAudio:v.hasAudio};console.warn("⚠️ [EnhancedDeviceManager] Stream created but tracks are not active:",v),g.getTracks().forEach(f=>f.stop())}catch(g){if(console.log("⚠️ [EnhancedDeviceManager] Both permissions failed:",g.name,g.message),g.name==="NotFoundError"||g.name==="DevicesNotFoundError")console.log("🔄 [EnhancedDeviceManager] Device not found, trying individual requests..."),s({title:"Device Detection Issue",description:"Some devices may not be available. Trying alternatives..."});else if(g.name==="NotAllowedError")return a(v=>({...v,permissions:{...v.permissions,camera:"denied",microphone:"denied"}})),s({title:"Permission Denied",description:"Camera and microphone access denied. Please check browser settings.",variant:"destructive"}),{success:!1,stream:null,mode:"none",error:"Camera and microphone access denied",hasVideo:!1,hasAudio:!1}}if(d&&(p||!x))try{console.log("🎯 [EnhancedDeviceManager] Attempting video-only...");const g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});a(f=>({...f,permissions:{...f.permissions,camera:"granted",microphone:x?"denied":f.permissions.microphone}}));const v=j(g,!0,!1);return console.log("✅ [EnhancedDeviceManager] Video-only permission granted"),s({title:"Video Only Mode",description:"Camera access granted. Microphone not available."}),{success:!0,stream:g,mode:"video-only",hasVideo:v.hasVideo,hasAudio:!1}}catch(g){console.log("⚠️ [EnhancedDeviceManager] Video-only failed:",g.name),g.name==="NotAllowedError"&&a(v=>({...v,permissions:{...v.permissions,camera:"denied"}}))}if(x&&(h||!d))try{console.log("🎯 [EnhancedDeviceManager] Attempting audio-only...");const g=await navigator.mediaDevices.getUserMedia({video:!1,audio:!0});a(f=>({...f,permissions:{...f.permissions,microphone:"granted",camera:d?"denied":f.permissions.camera}}));const v=j(g,!1,!0);return console.log("✅ [EnhancedDeviceManager] Audio-only permission granted"),s({title:"Audio Only Mode",description:"Microphone access granted. Camera not available."}),{success:!0,stream:g,mode:"audio-only",hasVideo:!1,hasAudio:v.hasAudio}}catch(g){console.log("⚠️ [EnhancedDeviceManager] Audio-only failed:",g.name),g.name==="NotAllowedError"&&a(v=>({...v,permissions:{...v.permissions,microphone:"denied"}}))}return console.error("❌ [EnhancedDeviceManager] All permission attempts failed"),s({title:"Connection Failed",description:"Unable to access camera or microphone. Please check device connections and browser permissions.",variant:"destructive"}),{success:!1,stream:null,mode:"none",error:"Unable to access camera or microphone",hasVideo:!1,hasAudio:!1}},[t.availability,s]),i=l.useCallback(async c=>{try{const u={video:c==="camera",audio:c==="microphone"};return(await navigator.mediaDevices.getUserMedia(u)).getTracks().forEach(h=>h.stop()),s({title:`${c==="camera"?"Camera":"Microphone"} Test`,description:`Your ${c} is working properly`}),!0}catch(u){return console.error(`❌ [EnhancedDeviceManager] ${c} test failed:`,u),s({title:`${c==="camera"?"Camera":"Microphone"} Test Failed`,description:`Unable to access your ${c}`,variant:"destructive"}),!1}},[s]);return l.useEffect(()=>{n();const c=()=>{console.log("📱 [EnhancedDeviceManager] Device change detected, re-enumerating..."),n()};return navigator.mediaDevices.addEventListener("devicechange",c),()=>{navigator.mediaDevices.removeEventListener("devicechange",c)}},[n]),{deviceState:t,enumerateDevices:n,requestPermissions:o,testDevice:i,isMobile:t.capabilities.isMobile}}const Ie=$o,Me=zo,Ee=l.forwardRef(({className:s,children:t,...a},r)=>e.jsxs(Yr,{ref:r,className:C("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),...a,children:[t,e.jsx(Oo,{asChild:!0,children:e.jsx(Sa,{className:"h-4 w-4 opacity-50"})})]}));Ee.displayName=Yr.displayName;const xi=l.forwardRef(({className:s,...t},a)=>e.jsx(Wr,{ref:a,className:C("flex cursor-default items-center justify-center py-1",s),...t,children:e.jsx(lc,{className:"h-4 w-4"})}));xi.displayName=Wr.displayName;const gi=l.forwardRef(({className:s,...t},a)=>e.jsx(Qr,{ref:a,className:C("flex cursor-default items-center justify-center py-1",s),...t,children:e.jsx(Sa,{className:"h-4 w-4"})}));gi.displayName=Qr.displayName;const De=l.forwardRef(({className:s,children:t,position:a="popper",...r},n)=>e.jsx(Fo,{children:e.jsxs(Kr,{ref:n,className:C("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:a,...r,children:[e.jsx(xi,{}),e.jsx(Lo,{className:C("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),e.jsx(gi,{})]})}));De.displayName=Kr.displayName;const Rd=l.forwardRef(({className:s,...t},a)=>e.jsx(Jr,{ref:a,className:C("py-1.5 pl-8 pr-2 text-sm font-semibold",s),...t}));Rd.displayName=Jr.displayName;const H=l.forwardRef(({className:s,children:t,...a},r)=>e.jsxs(Xr,{ref:r,className:C("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",s),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(qo,{children:e.jsx(Is,{className:"h-4 w-4"})})}),e.jsx(Uo,{children:t})]}));H.displayName=Xr.displayName;const Td=l.forwardRef(({className:s,...t},a)=>e.jsx(Zr,{ref:a,className:C("-mx-1 my-1 h-px bg-muted",s),...t}));Td.displayName=Zr.displayName;const Ad=({open:s,onOpenChange:t})=>{var g,v,f;const{cameras:a,microphones:r,speakers:n,changeDevice:o,testDevices:i,cameraStatus:c}=vt(),[u,m]=l.useState(!1),[h,p]=l.useState(null),d=async(y,b)=>{try{await o(y,b)}catch(_){console.error(`Failed to change ${y}:`,_)}},x=async()=>{m(!0),p(null);try{const y=await i();p(y)}finally{m(!1)}},j=()=>{switch(c){case"available":return e.jsxs(D,{className:"gap-1",children:[e.jsx(fe,{className:"h-3 w-3"})," Available"]});case"permission-denied":return e.jsxs(D,{variant:"destructive",className:"gap-1",children:[e.jsx(Ns,{className:"h-3 w-3"})," Permission Denied"]});case"unavailable":return e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(Ns,{className:"h-3 w-3"})," Unavailable"]});case"requesting":return e.jsx(D,{variant:"outline",className:"gap-1",children:"Requesting Access..."});default:return e.jsx(D,{variant:"outline",children:"Unknown"})}};return e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"sm:max-w-[500px]",children:[e.jsx(Oe,{children:e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"h-5 w-5"}),"Device Settings"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{className:"text-sm font-medium",children:"Device Status"}),j()]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ce,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Qs,{className:"h-4 w-4"}),"Camera"]}),e.jsxs(Ie,{onValueChange:y=>d("camera",y),children:[e.jsx(Ee,{children:e.jsx(Me,{placeholder:a.length>0?((g=a[0])==null?void 0:g.label)||"Default Camera":"No cameras available"})}),e.jsxs(De,{children:[a.map(y=>e.jsx(H,{value:y.deviceId,children:y.label||`Camera ${y.deviceId.slice(0,8)}...`},y.deviceId)),a.length===0&&e.jsx(H,{value:"none",disabled:!0,children:"No cameras available"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ce,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(os,{className:"h-4 w-4"}),"Microphone"]}),e.jsxs(Ie,{onValueChange:y=>d("microphone",y),children:[e.jsx(Ee,{children:e.jsx(Me,{placeholder:r.length>0?((v=r[0])==null?void 0:v.label)||"Default Microphone":"No microphones available"})}),e.jsxs(De,{children:[r.map(y=>e.jsx(H,{value:y.deviceId,children:y.label||`Microphone ${y.deviceId.slice(0,8)}...`},y.deviceId)),r.length===0&&e.jsx(H,{value:"none",disabled:!0,children:"No microphones available"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ce,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(dt,{className:"h-4 w-4"}),"Speaker"]}),e.jsxs(Ie,{onValueChange:y=>d("speaker",y),children:[e.jsx(Ee,{children:e.jsx(Me,{placeholder:n.length>0?((f=n[0])==null?void 0:f.label)||"Default Speaker":"No speakers available"})}),e.jsxs(De,{children:[n.map(y=>e.jsx(H,{value:y.deviceId,children:y.label||`Speaker ${y.deviceId.slice(0,8)}...`},y.deviceId)),n.length===0&&e.jsx(H,{value:"none",disabled:!0,children:"No speakers available"})]})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(ce,{className:"text-sm font-medium",children:"Test Devices"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Verify that your camera and microphone are working"})]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:x,disabled:u,className:"gap-2",children:[e.jsx(dc,{className:"h-4 w-4"}),u?"Testing...":"Test"]})]}),h!==null&&e.jsx("div",{className:`mt-2 p-2 rounded text-xs ${h?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:h?"✅ Device test successful - camera and microphone are working":"❌ Device test failed - check your device connections and permissions"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("div",{children:["Cameras detected: ",a.length]}),e.jsxs("div",{children:["Microphones detected: ",r.length]}),e.jsxs("div",{children:["Speakers detected: ",n.length]})]})]})]})})},fi=Go,ji=Ho,za=l.forwardRef(({className:s,align:t="center",sideOffset:a=4,...r},n)=>e.jsx(Vo,{children:e.jsx(en,{ref:n,align:t,sideOffset:a,className:C("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...r})}));za.displayName=en.displayName;const Os=l.forwardRef(({className:s,value:t,...a},r)=>e.jsx(sn,{ref:r,className:C("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",s),...a,children:e.jsx(Yo,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})}));Os.displayName=sn.displayName;const Ed=({quality:s,isConnected:t,className:a,detailed:r=!1})=>{const[n,o]=l.useState(!1),i=()=>{switch(s.quality){case"excellent":return"text-green-600 bg-green-50 border-green-200";case"good":return"text-blue-600 bg-blue-50 border-blue-200";case"fair":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"poor":return"text-orange-600 bg-orange-50 border-orange-200";case"disconnected":return"text-red-600 bg-red-50 border-red-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},c=()=>{if(!t)return e.jsx(Cs,{className:"h-3 w-3"});switch(s.quality){case"excellent":return e.jsx(uc,{className:"h-3 w-3"});case"good":return e.jsx(Xe,{className:"h-3 w-3"});case"fair":return e.jsx(pa,{className:"h-3 w-3"});case"poor":return e.jsx(ka,{className:"h-3 w-3"});case"disconnected":return e.jsx(Cs,{className:"h-3 w-3"});default:return e.jsx(Xe,{className:"h-3 w-3"})}},u=h=>{if(h===0)return"0 B";const p=1024,d=["B","KB","MB","GB"],x=Math.floor(Math.log(h)/Math.log(p));return parseFloat((h/Math.pow(p,x)).toFixed(1))+" "+d[x]},m=()=>e.jsxs(D,{variant:"outline",className:C("gap-1 text-xs",i(),a),children:[c(),s.quality.charAt(0).toUpperCase()+s.quality.slice(1),r&&e.jsxs("span",{className:"ml-1",children:["(",s.score,"/100)"]})]});return r?e.jsxs(fi,{open:n,onOpenChange:o,children:[e.jsx(ji,{asChild:!0,children:e.jsxs(N,{variant:"ghost",size:"sm",className:"h-auto p-1 gap-1",children:[e.jsx(m,{}),e.jsx(mc,{className:"h-3 w-3 opacity-50"})]})}),e.jsx(za,{className:"w-80",align:"end",children:e.jsxs(R,{className:"border-0 shadow-none",children:[e.jsx(I,{className:"pb-2",children:e.jsxs(O,{className:"flex items-center gap-2 text-sm",children:[c(),"Connection Quality",e.jsxs(D,{variant:"outline",className:i(),children:[s.score,"/100"]})]})}),e.jsxs(T,{className:"space-y-3 pt-0",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1",children:[e.jsx("span",{children:"Overall Score"}),e.jsxs("span",{className:"font-medium",children:[s.score,"/100"]})]}),e.jsx(Os,{value:s.score,className:"h-2"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-3 w-3"}),e.jsx("span",{children:"Latency"})]}),e.jsxs("div",{className:"font-medium",children:[s.rtt.toFixed(0),"ms"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pa,{className:"h-3 w-3"}),e.jsx("span",{children:"Packet Loss"})]}),e.jsxs("div",{className:"font-medium",children:[s.packetLoss.toFixed(1),"%"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Xe,{className:"h-3 w-3"}),e.jsx("span",{children:"Bandwidth"})]}),e.jsxs("div",{className:"font-medium",children:[u(s.bandwidth),"/s"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ds,{className:"h-3 w-3"}),e.jsx("span",{children:"Resolution"})]}),e.jsxs("div",{className:"font-medium",children:[s.resolution,"@",s.fps,"fps"]})]})]}),e.jsx("div",{className:"text-xs",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Network Jitter"}),e.jsxs("span",{className:"font-medium",children:[s.jitter.toFixed(1),"ms"]})]})}),s.recommendation&&e.jsxs("div",{className:"bg-muted/50 rounded p-2 text-xs",children:[e.jsx("div",{className:"font-medium text-muted-foreground mb-1",children:"Recommendation:"}),e.jsx("div",{children:s.recommendation})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{children:"Connection Status"}),e.jsx(D,{variant:t?"default":"destructive",className:"text-xs",children:t?"Connected":"Disconnected"})]})})]})]})})]}):e.jsx(m,{})},Dt=l.forwardRef(({className:s,...t},a)=>e.jsx(tn,{className:C("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",s),...t,ref:a,children:e.jsx(Wo,{className:C("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));Dt.displayName=tn.displayName;const Dd=({adaptationState:s,qualityMetrics:t,isAdaptationEnabled:a,isAudioOnlyMode:r,onToggleAdaptation:n,onForceQualityLevel:o,onResetToMaxQuality:i,adaptationSuggestion:c,className:u})=>{const[m,h]=l.useState(!1),[p,d]=l.useState(!1),x=y=>{switch(y){case"max":return"text-green-600 bg-green-50 border-green-200";case"high":return"text-blue-600 bg-blue-50 border-blue-200";case"medium":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"low":return"text-orange-600 bg-orange-50 border-orange-200";case"audio-only":return"text-red-600 bg-red-50 border-red-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},j=y=>{switch(y){case"max":return e.jsx(ds,{className:"h-3 w-3"});case"high":return e.jsx(ds,{className:"h-3 w-3"});case"medium":return e.jsx(ds,{className:"h-3 w-3"});case"low":return e.jsx(Ss,{className:"h-3 w-3"});case"audio-only":return e.jsx(dt,{className:"h-3 w-3"});default:return e.jsx(ds,{className:"h-3 w-3"})}},g=async y=>{d(!0);try{await o(y)}finally{d(!1)}},v=async()=>{d(!0);try{await i()}finally{d(!1)}},f=()=>e.jsxs(D,{variant:"outline",className:C("gap-1 text-xs",x(s.adaptationLevel)),children:[j(s.adaptationLevel),s.adaptationLevel.toUpperCase(),s.isAdapting&&e.jsx(ns,{className:"h-3 w-3 animate-spin ml-1"})]});return e.jsx("div",{className:u,children:e.jsxs(fi,{open:m,onOpenChange:h,children:[e.jsx(ji,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2 text-xs",children:[e.jsx(hs,{className:"h-3 w-3"}),"Quality",e.jsx(f,{})]})}),e.jsx(za,{className:"w-80",align:"end",children:e.jsxs(R,{className:"border-0 shadow-none",children:[e.jsx(I,{className:"pb-3",children:e.jsxs(O,{className:"flex items-center gap-2 text-sm",children:[e.jsx(ka,{className:"h-4 w-4"}),"Adaptive Quality"]})}),e.jsxs(T,{className:"space-y-4 pt-0",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{className:"text-xs",children:"Current Quality"}),e.jsx(f,{})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.currentConstraints.width,"x",s.currentConstraints.height," @ ",s.currentConstraints.frameRate,"fps"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{className:"text-xs font-medium",children:"Auto Adaptation"}),e.jsx(Dt,{checked:a,onCheckedChange:n})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{className:"text-xs font-medium",children:"Manual Override"}),e.jsxs(Ie,{value:s.adaptationLevel,onValueChange:g,disabled:p,children:[e.jsx(Ee,{className:"text-xs",children:e.jsx(Me,{})}),e.jsxs(De,{children:[e.jsx(H,{value:"max",children:"Maximum (1280x720@30fps)"}),e.jsx(H,{value:"high",children:"High (960x540@30fps)"}),e.jsx(H,{value:"medium",children:"Medium (640x480@24fps)"}),e.jsx(H,{value:"low",children:"Low (320x240@15fps)"}),e.jsx(H,{value:"audio-only",children:"Audio Only"})]})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(N,{variant:"outline",size:"sm",onClick:v,disabled:p||s.adaptationLevel==="max",className:"w-full text-xs",children:[e.jsx(ds,{className:"h-3 w-3 mr-2"}),"Reset to Max Quality"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{className:"text-xs font-medium",children:"Last Adaptation"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.lastAdaptation?`${s.lastAdaptation.toLocaleTimeString()}: ${s.adaptationReason}`:"No adaptations yet"})]}),c&&e.jsxs("div",{className:"bg-muted/50 rounded p-2 text-xs",children:[e.jsx("div",{className:"font-medium text-muted-foreground mb-1",children:"Suggestion:"}),e.jsx("div",{children:c})]}),r&&e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded p-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-orange-700",children:[e.jsx(dt,{className:"h-3 w-3"}),e.jsx("span",{className:"font-medium",children:"Audio-Only Mode Active"})]}),e.jsx("div",{className:"text-xs text-orange-600 mt-1",children:"Video disabled due to poor connection quality"})]}),e.jsxs("div",{className:"border-t pt-3 space-y-2",children:[e.jsx(ce,{className:"text-xs font-medium",children:"Connection Metrics"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Score:"}),e.jsxs("span",{className:"ml-1 font-medium",children:[t.score,"/100"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"RTT:"}),e.jsxs("span",{className:"ml-1 font-medium",children:[t.rtt,"ms"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Loss:"}),e.jsxs("span",{className:"ml-1 font-medium",children:[t.packetLoss.toFixed(1),"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"FPS:"}),e.jsx("span",{className:"ml-1 font-medium",children:t.fps})]})]})]})]})]})})]})})};let Pd=class{constructor(t){J(this,"sessionId");J(this,"eventListeners",new Set);J(this,"realtimeChannel",null);this.sessionId=t,this.setupRealtimeSubscription()}async setupRealtimeSubscription(){const t=await this.getSessionBreakoutRoomIds();this.realtimeChannel=w.channel(`breakout-rooms-${this.sessionId}`).on("postgres_changes",{event:"*",schema:"public",table:"breakout_rooms",filter:`session_id=eq.${this.sessionId}`},a=>{console.log("🔄 [BreakoutManager] Room update:",a),this.handleRoomUpdate(a)}).on("postgres_changes",{event:"*",schema:"public",table:"breakout_room_participants",filter:t.length>0?`breakout_room_id=in.(${t})`:"breakout_room_id=eq.00000000-0000-0000-0000-000000000000"},a=>{console.log("🔄 [BreakoutManager] Participant update:",a),this.handleParticipantUpdate(a)}).subscribe()}async getSessionBreakoutRoomIds(){try{const{data:t}=await w.from("breakout_rooms").select("id").eq("session_id",this.sessionId);return(t==null?void 0:t.map(a=>a.id).join(","))||""}catch(t){return console.error("❌ [BreakoutManager] Failed to get room IDs:",t),""}}handleRoomUpdate(t){t.eventType==="INSERT"?this.emitEvent({type:"room_created",room:t.new}):t.eventType==="UPDATE"&&!t.new.is_active&&this.emitEvent({type:"room_closed",room_id:t.new.id})}handleParticipantUpdate(t){t.eventType==="INSERT"?this.emitEvent({type:"participant_joined",room_id:t.new.breakout_room_id,participant:t.new}):t.eventType==="UPDATE"&&!t.new.is_active&&this.emitEvent({type:"participant_left",room_id:t.new.breakout_room_id,participant_id:t.new.participant_id})}async createBreakoutRooms(t){try{if(console.log("🏗️ [BreakoutManager] Creating breakout rooms:",t),t.roomCount<1||t.roomCount>fs.BREAKOUT_ROOM_CONFIG.maxRoomsPerSession)throw new Error(`Room count must be between 1 and ${fs.BREAKOUT_ROOM_CONFIG.maxRoomsPerSession}`);const a=await this.getSessionParticipants();if(a.length<fs.BREAKOUT_ROOM_CONFIG.minParticipantsToCreate)throw new Error("Not enough participants to create breakout rooms");const r=[],n=t.customRoomNames||fs.BREAKOUT_ROOM_CONFIG.defaultRoomNames.slice(0,t.roomCount);for(let o=0;o<t.roomCount;o++){const i=n[o]||`Room ${o+1}`,c={session_id:this.sessionId,room_name:i,max_participants:t.maxParticipantsPerRoom},u=await this.createSingleRoom(c);r.push(u)}return t.assignmentStrategy==="auto"&&await this.autoAssignParticipants(a,r),r.forEach(o=>{this.emitEvent({type:"room_created",room:o})}),console.log("✅ [BreakoutManager] Created rooms:",r.length),r}catch(a){throw console.error("❌ [BreakoutManager] Failed to create rooms:",a),this.emitEvent({type:"error",error:a instanceof Error?a.message:"Failed to create breakout rooms"}),a}}async createSingleRoom(t){var a,r;try{console.log("🏗️ [BreakoutManager] Creating room:",{session_id:t.session_id,room_name:t.room_name,max_participants:t.max_participants});const{data:n,error:o}=await w.functions.invoke("create-breakout-room",{body:t});if(o){console.error("❌ [BreakoutManager] Edge function error:",o);let i=o.message||"Edge function failed";if(o.context&&typeof o.context=="object"){console.error("❌ [BreakoutManager] Error context (Response object):",{status:o.context.status,statusText:o.context.statusText,type:o.context.type,url:o.context.url});const c=o.context.status;c&&(i=`Edge function failed with status ${c}: ${i}`)}throw((a=o.message)!=null&&a.includes("NetworkError")||(r=o.message)!=null&&r.includes("fetch"))&&(i="Network error: Unable to connect to server. Please check your internet connection and try again."),new Error(i)}if(!n)throw console.error("❌ [BreakoutManager] No data returned from edge function"),new Error("No data returned from edge function");if(!n.success)throw console.error("❌ [BreakoutManager] Edge function returned failure:",{success:n.success,error:n.error,data:n}),new Error(n.error||"Failed to create breakout room");if(!n.breakout_room)throw console.error("❌ [BreakoutManager] No breakout_room in response:",n),new Error("Invalid response from edge function: missing breakout_room");return console.log("✅ [BreakoutManager] Room created successfully:",n.breakout_room.id),n.breakout_room}catch(n){throw console.error("❌ [BreakoutManager] createSingleRoom failed:",{error:n,request:t,errorMessage:n instanceof Error?n.message:String(n),errorStack:n instanceof Error?n.stack:void 0}),n}}async autoAssignParticipants(t,a){var m;if(console.log("🎯 [BreakoutManager] Auto-assigning participants:",{participantCount:t.length,roomCount:a.length}),t.length===0){console.log("⚠️ [BreakoutManager] No participants to assign");return}const r=[...t].sort(()=>Math.random()-.5),n=[];r.forEach((h,p)=>{const d=p%a.length;n.push({breakout_room_id:a[d].id,participant_id:h.id,user_id:h.user_id||null,participant_name:h.participant_name||"Unknown",identity:h.user_id||`participant-${h.id}`})}),console.log("📝 [BreakoutManager] Assignments to create:",n.length),console.log("📝 [BreakoutManager] Sample assignment:",n[0]||"No assignments");const{data:{session:o}}=await w.auth.getSession(),i=o==null?void 0:o.access_token;if(!i)throw new Error("No authentication token available");const u="https://aoumioacfvttagverbna.supabase.co/functions/v1/assign-breakout-participants";try{const h=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,apikey:""},body:JSON.stringify({session_id:this.sessionId,assignments:n})}),p=await h.json();if(!h.ok){console.error("❌ [BreakoutManager] Edge function error:",{status:h.status,statusText:h.statusText,error:p});const x=(p==null?void 0:p.error)||(p==null?void 0:p.message)||`Edge function returned status ${h.status}`;throw new Error("Failed to assign participants: "+x)}if(!p||!p.success){console.error("❌ [BreakoutManager] Assignment failed:",p);const x=(p==null?void 0:p.error)||"Failed to assign participants";throw console.error("❌ [BreakoutManager] Error message:",x),new Error(x)}console.log("✅ [BreakoutManager] Auto-assigned participants:",p.assigned_count||0),console.log("📢 [BreakoutManager] Sending auto-assignment broadcasts to participants...");const d=n.map(async(x,j)=>{if(!x.user_id){console.log(`⚠️ [BreakoutManager] Skipping broadcast for participant ${x.participant_id} (no user_id)`);return}await new Promise(g=>setTimeout(g,j*100));try{const g=a.find(y=>y.id===x.breakout_room_id);if(!g){console.warn(`⚠️ [BreakoutManager] Room not found for assignment: ${x.breakout_room_id}`);return}const v=`user:${x.user_id}:breakout`,f=w.channel(v);await new Promise((y,b)=>{const _=setTimeout(()=>{console.error(`⏱️ [BreakoutManager] Channel subscription timeout for user: ${x.user_id}`),b(new Error("Channel subscription timeout"))},1e4);f.subscribe(async k=>{if(k==="SUBSCRIBED"){clearTimeout(_);try{await new Promise(E=>setTimeout(E,500));const S=await f.send({type:"broadcast",event:"breakout_assignment",payload:{room_id:x.breakout_room_id,room_name:g.room_name,twilio_room_sid:g.twilio_room_sid,action:"join"}});console.log(`✅ [BreakoutManager] Auto-assignment broadcast sent to user: ${x.user_id}`,S),setTimeout(async()=>{try{await w.removeChannel(f)}catch(E){console.warn(`⚠️ [BreakoutManager] Error cleaning up channel for ${x.user_id}:`,E)}y()},15e3)}catch(S){clearTimeout(_),console.error(`❌ [BreakoutManager] Failed to send broadcast to ${x.user_id}:`,S),b(S)}}else k==="CHANNEL_ERROR"?(clearTimeout(_),console.error(`❌ [BreakoutManager] Channel error for user: ${x.user_id}`),b(new Error(`Channel error: ${k}`))):k==="CLOSED"&&console.warn(`⚠️ [BreakoutManager] Channel closed for user: ${x.user_id}`)})}).catch(y=>{console.error(`❌ [BreakoutManager] Failed to send auto-assignment broadcast to ${x.user_id}:`,y)})}catch(g){console.error(`❌ [BreakoutManager] Error sending broadcast to ${x.user_id}:`,g)}});await Promise.allSettled(d),console.log("✅ [BreakoutManager] Auto-assignment broadcasts completed"),this.emitEvent({type:"participants_assigned",count:p.assigned_count||n.length})}catch(h){throw(m=h.message)!=null&&m.includes("Failed to assign participants")?h:(console.error("❌ [BreakoutManager] Fetch error:",h),new Error("Failed to assign participants: "+(h.message||"Network error")))}}async updateRoomParticipantCounts(t){try{for(const a of t){const{count:r,error:n}=await w.from("breakout_room_participants").select("*",{count:"exact",head:!0}).eq("breakout_room_id",a).eq("is_active",!0);if(n){console.error("❌ [BreakoutManager] Failed to count participants for room:",a,n);continue}await w.from("breakout_rooms").update({current_participants:r||0}).eq("id",a)}}catch(a){console.error("❌ [BreakoutManager] Failed to update room counts:",a)}}async moveParticipant(t){var a;try{console.log("🔄 [BreakoutManager] Moving participant:",t);const{data:r,error:n}=await w.from("instant_session_participants").select("user_id, participant_name").eq("id",t.participant_id).single();if(n||!r)throw new Error("Participant not found");const{data:o,error:i}=await w.from("breakout_rooms").select("*").eq("id",t.to_room_id).single();if(i||!o)throw new Error("Breakout room not found");await w.from("breakout_room_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("participant_id",t.participant_id).eq("is_active",!0);const{error:c}=await w.from("breakout_room_participants").upsert({breakout_room_id:t.to_room_id,participant_id:t.participant_id,user_id:r.user_id,participant_name:r.participant_name,identity:r.user_id||`participant-${t.participant_id}`,is_active:!0,joined_at:new Date().toISOString(),left_at:null},{onConflict:"breakout_room_id,participant_id",ignoreDuplicates:!1});if(c)throw console.error("❌ [BreakoutManager] Failed to update participant assignment:",c),new Error("Failed to update participant assignment");if(r.user_id){console.log("📢 [BreakoutManager] Sending breakout assignment to user:",r.user_id);const u=`user:${r.user_id}:breakout`,m=w.channel(u);try{await new Promise((h,p)=>{const d=setTimeout(()=>{console.error("⏱️ [BreakoutManager] Channel subscription timeout"),p(new Error("Channel subscription timeout"))},1e4);m.subscribe(async x=>{if(console.log(`📡 [BreakoutManager] Channel status: ${x}`),x==="SUBSCRIBED"){clearTimeout(d);try{console.log("⏳ [BreakoutManager] Waiting for receiver to be ready..."),await new Promise(g=>setTimeout(g,500));const j=await m.send({type:"broadcast",event:"breakout_assignment",payload:{room_id:t.to_room_id,room_name:o.room_name,twilio_room_sid:o.twilio_room_sid,action:"join"}});console.log("✅ [BreakoutManager] Breakout assignment sent:",j),setTimeout(async()=>{console.log("🧹 [BreakoutManager] Cleaning up sender channel after delivery");try{await w.removeChannel(m)}catch(g){console.warn("⚠️ [BreakoutManager] Error during channel cleanup (non-critical):",g)}h()},3e3)}catch(j){clearTimeout(d),console.error("❌ [BreakoutManager] Failed to send message:",j),setTimeout(()=>{try{w.removeChannel(m)}catch{}h()},1e3)}}else x==="CHANNEL_ERROR"?(clearTimeout(d),console.error("❌ [BreakoutManager] Channel error:",x),setTimeout(()=>{try{w.removeChannel(m)}catch{}h()},100)):x==="CLOSED"&&(console.warn("⚠️ [BreakoutManager] Channel closed unexpectedly - message may not be delivered"),setTimeout(()=>h(),100))})})}catch(h){console.error("❌ [BreakoutManager] Failed to send breakout assignment:",h);try{await w.removeChannel(m)}catch{}}}await w.from("breakout_room_transitions").insert({participant_id:t.participant_id,from_room_id:t.from_room_id||null,to_room_id:t.to_room_id,transition_type:t.transition_type||"manual",reason:t.reason,moved_by:(a=(await w.auth.getUser()).data.user)==null?void 0:a.id}),this.emitEvent({type:"participant_moved",participant:{id:t.participant_id,name:r.participant_name,toRoomId:t.to_room_id,toRoomName:o.room_name}}),console.log("✅ [BreakoutManager] Participant moved successfully")}catch(r){throw console.error("❌ [BreakoutManager] Failed to move participant:",r),r}}async closeRoom(t,a){try{console.log("🔚 [BreakoutManager] Closing room:",t);const{data:r,error:n}=await w.functions.invoke("close-breakout-room",{body:{breakout_room_id:t,reason:a}});if(n||!r.success)throw new Error((r==null?void 0:r.error)||"Failed to close room");console.log("✅ [BreakoutManager] Room closed")}catch(r){throw console.error("❌ [BreakoutManager] Failed to close room:",r),r}}async closeAllRooms(){try{console.log("🔚 [BreakoutManager] Closing all rooms");const t=await this.getActiveRooms();await Promise.all(t.map(a=>this.closeRoom(a.id,"Session ended"))),console.log("✅ [BreakoutManager] All rooms closed")}catch(t){throw console.error("❌ [BreakoutManager] Failed to close all rooms:",t),t}}async getActiveRooms(){try{console.log("🔍 [BreakoutManager] Fetching active rooms for session:",this.sessionId);const{data:t,error:a}=await w.from("breakout_rooms").select("id, session_id, is_active, room_name").eq("session_id",this.sessionId).limit(10);console.log("🧪 [BreakoutManager] RLS test query (all rooms):",{found:(t==null?void 0:t.length)||0,error:a,errorCode:a==null?void 0:a.code,errorMessage:a==null?void 0:a.message,sample:t==null?void 0:t[0]});const{data:{user:r}}=await w.auth.getUser();if(r){const{data:c}=await w.from("instant_session_participants").select("id, user_id, is_active").eq("session_id",this.sessionId).eq("user_id",r.id).eq("is_active",!0).maybeSingle();console.log("👤 [BreakoutManager] Current user participation:",{userId:r.id,isParticipant:!!c,participation:c})}const{data:n,error:o}=await w.from("breakout_rooms").select("*").eq("session_id",this.sessionId).eq("is_active",!0).order("created_at",{ascending:!0});if(o)return console.error("❌ [BreakoutManager] Failed to get rooms:",o),console.error("❌ [BreakoutManager] Error details:",{code:o.code,message:o.message,details:o.details,hint:o.hint}),[];if(console.log("📋 [BreakoutManager] Found rooms:",(n==null?void 0:n.length)||0,n),!n||n.length===0){console.log("⚠️ [BreakoutManager] No active rooms found for session:",this.sessionId);const{data:c}=await w.from("breakout_rooms").select("id, room_name, is_active, session_id, created_at").eq("session_id",this.sessionId).order("created_at",{ascending:!0});return console.log("🔍 [BreakoutManager] All rooms (including inactive):",{count:(c==null?void 0:c.length)||0,rooms:c}),[]}return await Promise.all(n.map(async c=>{const{data:u,error:m}=await w.from("breakout_room_participants").select("*").eq("breakout_room_id",c.id).eq("is_active",!0);return m&&console.error("❌ [BreakoutManager] Failed to get participants for room:",c.id,m),{...c,participants:u||[]}}))}catch(t){return console.error("❌ [BreakoutManager] Failed to get rooms:",t),[]}}async getParticipantAssignments(){try{const{data:t,error:a}=await w.from("instant_session_participants").select("id, participant_name, user_id").eq("session_id",this.sessionId).eq("is_active",!0);return a?(console.error("❌ [BreakoutManager] Failed to get participants:",a),[]):!t||t.length===0?[]:await Promise.all(t.map(async n=>{var i;const{data:o}=await w.from("breakout_room_participants").select("breakout_room_id, breakout_rooms(room_name)").eq("participant_id",n.id).eq("is_active",!0).maybeSingle();return{participant_id:n.id,participant_name:n.participant_name,user_id:n.user_id,breakout_room_id:(o==null?void 0:o.breakout_room_id)||null,breakout_room_name:((i=o==null?void 0:o.breakout_rooms)==null?void 0:i.room_name)||null}}))}catch(t){return console.error("❌ [BreakoutManager] Failed to get assignments:",t),[]}}async getSessionParticipants(){const{data:t,error:a}=await w.from("instant_session_participants").select("*").eq("session_id",this.sessionId).eq("is_active",!0);return a?(console.error("❌ [BreakoutManager] Failed to get participants:",a),[]):t||[]}on(t){this.eventListeners.add(t)}off(t){this.eventListeners.delete(t)}emitEvent(t){this.eventListeners.forEach(a=>a(t))}cleanup(){this.realtimeChannel&&(w.removeChannel(this.realtimeChannel),this.realtimeChannel=null),this.eventListeners.clear()}};function Id(s){const{sessionId:t,enabled:a=!0}=s,{toast:r}=Z(),[n,o]=l.useState({rooms:new Map,assignments:new Map,status:"closed",activeRoomCount:0,totalParticipants:0,config:null,error:null}),[i,c]=l.useState([]),[u,m]=l.useState([]),h=l.useRef(null);l.useEffect(()=>{if(!a||!t)return;const f=new Pd(t);h.current=f;const y=b=>{switch(console.log("🏠 [useBreakoutRooms] Event:",b.type),b.type){case"room_created":r({title:"Breakout room created",description:`${b.room.room_name} is ready`}),p();break;case"room_closed":r({title:"Breakout room closed",description:"Room has been closed"}),p();break;case"participant_joined":p(),d();break;case"participant_left":p(),d();break;case"participant_moved":r({title:"Participant moved",description:"Participant has been moved to a different room"}),p(),d();break;case"error":o(_=>({..._,error:b.error,status:"error"})),r({title:"Error",description:b.error,variant:"destructive"});break}};return f.on(y),p(),d(),()=>{f.off(y),f.cleanup(),h.current=null}},[a,t]);const p=l.useCallback(async()=>{if(!h.current){console.warn("⚠️ [useBreakoutRooms] Manager not initialized, cannot refresh");return}try{console.log("🔄 [useBreakoutRooms] Refreshing rooms...");const f=await h.current.getActiveRooms();console.log("📋 [useBreakoutRooms] Refreshed rooms:",f.length,f),c(f);const y=new Map(f.map(k=>[k.id,k])),b=f.filter(k=>k.is_active).length,_=f.reduce((k,S)=>k+S.current_participants,0);console.log("📊 [useBreakoutRooms] Updated state:",{activeCount:b,totalParticipants:_,status:b>0?"active":"closed"}),o(k=>({...k,rooms:y,activeRoomCount:b,totalParticipants:_,status:b>0?"active":"closed"}))}catch(f){console.error("❌ [useBreakoutRooms] Failed to refresh rooms:",f)}},[]),d=l.useCallback(async()=>{if(h.current)try{const f=await h.current.getParticipantAssignments();m(f);const y=new Map(f.map(b=>[b.participant_id,b]));o(b=>({...b,assignments:y}))}catch(f){console.error("❌ [useBreakoutRooms] Failed to refresh assignments:",f)}},[]),x=l.useCallback(async f=>{if(!h.current){r({title:"Error",description:"Breakout room manager not initialized",variant:"destructive"});return}try{o(b=>({...b,status:"creating",config:f,error:null}));const y=await h.current.createBreakoutRooms(f);console.log("✅ [useBreakoutRooms] Rooms created, refreshing UI...",y.length),await p(),await d(),setTimeout(async()=>{await p(),await d()},500),r({title:"Breakout rooms created",description:`Successfully created ${y.length} rooms`}),o(b=>({...b,status:"active"}))}catch(y){console.error("❌ [useBreakoutRooms] Failed to create rooms:",y),o(b=>({...b,status:"error",error:y.message||"Failed to create rooms"})),r({title:"Failed to create rooms",description:y.message||"An error occurred",variant:"destructive"})}},[r,p,d]),j=l.useCallback(async f=>{if(h.current)try{o(y=>({...y,status:"closing"})),await h.current.closeRoom(f),r({title:"Room closed",description:"Breakout room has been closed"}),await p(),await d()}catch(y){console.error("❌ [useBreakoutRooms] Failed to close room:",y),r({title:"Failed to close room",description:y.message||"An error occurred",variant:"destructive"}),o(b=>({...b,status:"error",error:y.message}))}},[r,p,d]),g=l.useCallback(async()=>{if(h.current)try{o(f=>({...f,status:"closing"})),await h.current.closeAllRooms(),r({title:"All rooms closed",description:"All breakout rooms have been closed"}),await p(),await d(),o(f=>({...f,status:"closed"}))}catch(f){console.error("❌ [useBreakoutRooms] Failed to close all rooms:",f),r({title:"Failed to close rooms",description:f.message||"An error occurred",variant:"destructive"}),o(y=>({...y,status:"error",error:f.message}))}},[r,p,d]),v=l.useCallback(async f=>{if(h.current)try{await h.current.moveParticipant(f)}catch(y){console.error("❌ [useBreakoutRooms] Failed to move participant:",y),r({title:"Failed to move participant",description:y.message||"An error occurred",variant:"destructive"})}},[r]);return{state:n,rooms:i,assignments:u,createRooms:x,closeRoom:j,closeAllRooms:g,moveParticipant:v,refreshRooms:p,refreshAssignments:d}}function vi(s){const{sessionId:t,therapistName:a,isTherapist:r}=s,{toast:n}=Z(),[o,i]=l.useState(null),[c,u]=l.useState(null),[m,h]=l.useState(!1),p=pt(),d=l.useCallback(async(j,g,v)=>{if(!(!r||m))try{h(!0),p.disconnect();const f=await Qe.getAccessToken(`${a}-therapist`,v);await p.connect({roomName:v,token:f.token,audio:!0,video:!0,networkQuality:!0,dominantSpeaker:!0}),i(j),u(g),await Qe.logSessionEvent(t,"therapist_joined_breakout",{room_id:j,room_name:g}),n({title:`Joined ${g}`,description:"You are now in the breakout room"})}catch(f){console.error("❌ Failed to join breakout room:",f),n({title:"Failed to join room",description:f.message||"Could not connect to breakout room",variant:"destructive"}),await x()}finally{h(!1)}},[r,m,a,t,n]),x=l.useCallback(async()=>{if(!(!r||m))try{h(!0),p.disconnect();const{data:j,error:g}=await w.from("instant_sessions").select("session_token, room_name").eq("id",t).single();if(g||!j)throw new Error("Failed to find main session");const v=j.room_name||`session-${j.session_token}`;console.log("🏠 [TwilioVideoService] Returning to main room:",v);const f=await Qe.getAccessToken(a,v);await p.connect({roomName:v,token:f.token,audio:!0,video:!0,networkQuality:!0,dominantSpeaker:!0});const y=c;i(null),u(null),y&&await Qe.logSessionEvent(t,"therapist_returned_to_main",{previous_room:y}),n({title:"Returned to main session",description:"You are back in the main room"})}catch(j){console.error("❌ Failed to return to main session:",j),n({title:"Failed to return",description:j.message||"Could not return to main session",variant:"destructive"})}finally{h(!1)}},[r,m,a,t,c,n]);return{currentRoomId:o,currentRoomName:c,isInMainSession:o===null,isSwitching:m,joinBreakoutRoom:d,returnToMainSession:x}}const yi=l.forwardRef(({className:s,...t},a)=>e.jsx(an,{className:C("grid gap-2",s),...t,ref:a}));yi.displayName=an.displayName;const ja=l.forwardRef(({className:s,...t},a)=>e.jsx(rn,{ref:a,className:C("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(Qo,{className:"flex items-center justify-center",children:e.jsx(Na,{className:"h-2.5 w-2.5 fill-current text-current"})})}));ja.displayName=rn.displayName;const Md=({open:s,onOpenChange:t,onCreateRooms:a,sessionId:r})=>{const[n,o]=l.useState(2),[i,c]=l.useState(5),[u,m]=l.useState("auto"),[h,p]=l.useState(0),[d,x]=l.useState(!1),[j,g]=l.useState(null);l.useEffect(()=>{s&&v()},[s]);const v=async()=>{try{const y=await Qe.getSessionParticipants(r);p(y.length)}catch(y){console.error("Failed to fetch participants:",y)}},f=async()=>{if(g(null),n<1||n>10){g("Number of rooms must be between 1 and 10");return}if(i<2||i>15){g("Participants per room must be between 2 and 15");return}if(h<2){g("Need at least 2 participants to create breakout rooms");return}try{x(!0),await a({roomCount:n,maxParticipantsPerRoom:i,assignmentStrategy:u,allowSelfSwitch:!1}),await new Promise(b=>setTimeout(b,1e3)),t(!1),o(2),c(5),m("auto")}catch(y){g(y.message||"Failed to create rooms")}finally{x(!1)}};return e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"sm:max-w-md",children:[e.jsxs(Oe,{children:[e.jsx(Fe,{children:"Create Breakout Rooms"}),e.jsx($s,{children:"Configure breakout rooms for group discussions"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[j&&e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:j})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[h," ",h===1?"participant":"participants"," in session"]}),h<2&&e.jsx(ye,{variant:"default",className:"border-amber-200 bg-amber-50 text-amber-700",children:e.jsx(be,{children:"Invite at least one more participant before creating breakout rooms."})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"roomCount",children:"Number of Rooms"}),e.jsx(Ne,{id:"roomCount",type:"number",min:"1",max:"10",value:n,onChange:y=>o(parseInt(y.target.value)||1)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Maximum 10 rooms"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"maxParticipants",children:"Max Participants Per Room"}),e.jsx(Ne,{id:"maxParticipants",type:"number",min:"2",max:"15",value:i,onChange:y=>c(parseInt(y.target.value)||2)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"2-15 participants per room"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ce,{children:"Assignment Strategy"}),e.jsxs(yi,{value:u,onValueChange:y=>m(y),children:[e.jsxs("div",{className:"flex items-start space-x-3 space-y-0 p-3 border rounded-lg hover:bg-accent cursor-pointer",children:[e.jsx(ja,{value:"auto",id:"auto"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{htmlFor:"auto",className:"flex items-center gap-2 text-sm font-medium cursor-pointer",children:[e.jsx(hc,{className:"h-4 w-4"}),"Automatic (Random)"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Participants will be randomly distributed across rooms"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 space-y-0 p-3 border rounded-lg hover:bg-accent cursor-pointer",children:[e.jsx(ja,{value:"manual",id:"manual"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{htmlFor:"manual",className:"flex items-center gap-2 text-sm font-medium cursor-pointer",children:[e.jsx(pc,{className:"h-4 w-4"}),"Manual"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"You will assign participants to rooms manually"})]})]})]})]}),e.jsxs("div",{className:"p-3 bg-muted rounded-lg text-sm",children:[e.jsx("p",{className:"font-medium mb-1",children:"Preview:"}),e.jsxs("p",{className:"text-muted-foreground",children:["Creating ",n," ",n===1?"room":"rooms"," with up to"," ",i," participants each"]}),u==="auto"&&e.jsx("p",{className:"text-muted-foreground",children:"Participants will be assigned randomly"})]})]}),e.jsxs(di,{children:[e.jsx(N,{variant:"outline",onClick:()=>t(!1),disabled:d,children:"Cancel"}),e.jsx(N,{onClick:f,disabled:d||h<2,children:d?"Creating...":"Create Rooms"})]})]})})},Bd=({sessionId:s,rooms:t,assignments:a,onMoveParticipant:r,onRefresh:n})=>{const[o,i]=l.useState(null),c=async(h,p,d)=>{if(!(!d||d===p))try{i(h),await r({participant_id:h,from_room_id:p,to_room_id:d,transition_type:"manual",reason:"Moved by therapist"})}catch(x){console.error("Failed to move participant:",x)}finally{i(null)}};if(a.length===0)return e.jsxs("div",{className:"text-center py-6 text-muted-foreground",children:[e.jsx(de,{className:"h-10 w-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No participant assignments yet"})]});const u=a.filter(h=>!h.breakout_room_id),m=a.filter(h=>h.breakout_room_id);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Participant Assignments"}),e.jsxs(N,{variant:"ghost",size:"sm",onClick:n,children:[e.jsx(ns,{className:"h-3 w-3 mr-1"}),"Refresh"]})]}),m.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Assigned (",m.length,")"]}),m.map(h=>e.jsx(R,{children:e.jsx(T,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:h.participant_name||"Anonymous"}),h.breakout_room_name&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Currently in: ",h.breakout_room_name]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ie,{value:h.breakout_room_id||"",onValueChange:p=>c(h.participant_id,h.breakout_room_id,p),disabled:o===h.participant_id,children:[e.jsx(Ee,{className:"w-[140px] h-8 text-xs",children:e.jsx(Me,{placeholder:"Select room"})}),e.jsx(De,{children:t.map(p=>e.jsxs(H,{value:p.id,children:[p.room_name,p.current_participants>=p.max_participants&&p.id!==h.breakout_room_id&&" (Full)"]},p.id))})]}),o===h.participant_id&&e.jsx(zt,{className:"h-4 w-4 animate-pulse text-primary"})]})]})})},h.participant_id))]}),u.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Unassigned (",u.length,")"]}),u.map(h=>e.jsx(R,{className:"border-dashed",children:e.jsx(T,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:h.participant_name||"Anonymous"}),e.jsx(D,{variant:"outline",className:"text-xs mt-1",children:"Not in room"})]}),e.jsxs(Ie,{value:"",onValueChange:p=>c(h.participant_id,null,p),disabled:o===h.participant_id,children:[e.jsx(Ee,{className:"w-[140px] h-8 text-xs",children:e.jsx(Me,{placeholder:"Assign to room"})}),e.jsx(De,{children:t.map(p=>e.jsxs(H,{value:p.id,disabled:p.current_participants>=p.max_participants,children:[p.room_name,p.current_participants>=p.max_participants&&" (Full)"]},p.id))})]})]})})},h.participant_id))]})]})},Va=({sessionId:s,isTherapist:t})=>{var B;const[a,r]=l.useState(!1),[n,o]=l.useState(!1),{user:i}=V(),{state:c,rooms:u,assignments:m,createRooms:h,closeRoom:p,closeAllRooms:d,moveParticipant:x,refreshRooms:j,refreshAssignments:g}=Id({sessionId:s,enabled:t}),{currentRoomId:v,currentRoomName:f,isInMainSession:y,isSwitching:b,joinBreakoutRoom:_,returnToMainSession:k}=vi({sessionId:s,therapistName:((B=i==null?void 0:i.email)==null?void 0:B.split("@")[0])||"Therapist",isTherapist:t});if(!t)return null;const S=c.activeRoomCount>0,E=c.status==="creating"||c.status==="closing";return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center",children:e.jsx(de,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Breakout Rooms"}),!y&&f?e.jsxs("p",{className:"text-xs text-emerald-600 font-medium",children:["📍 You are in: ",f]}):S?e.jsxs("p",{className:"text-xs text-gray-500",children:[c.activeRoomCount," active • ",c.totalParticipants," participants"]}):e.jsx("p",{className:"text-xs text-gray-500",children:"Split group into focused discussions"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!y&&e.jsxs(N,{variant:"default",size:"sm",onClick:k,disabled:b,className:"h-8 text-xs bg-emerald-600 hover:bg-emerald-700",children:[b?e.jsx(Ke,{className:"h-3 w-3 mr-1 animate-spin"}):e.jsx(Ws,{className:"h-3 w-3 mr-1"}),"Return to Main"]}),S&&e.jsxs(N,{variant:"destructive",size:"sm",onClick:d,disabled:E,className:"h-8 text-xs",children:[e.jsx(rs,{className:"h-3 w-3 mr-1"}),"Close All"]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>{j(),g()},disabled:E,className:"h-8 w-8",children:e.jsx(ns,{className:`h-3 w-3 ${E?"animate-spin":""}`})})]})]}),e.jsxs("div",{className:"space-y-3",children:[!y&&f&&e.jsxs(ye,{className:"border-emerald-500 bg-emerald-50",children:[e.jsx(Ws,{className:"h-4 w-4 text-emerald-600"}),e.jsxs(be,{className:"text-xs text-emerald-700 font-medium",children:["You are currently in ",e.jsx("strong",{children:f}),". You can still manage all rooms from here."]})]}),c.error&&e.jsxs(ye,{variant:"destructive",className:"mb-3",children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(be,{className:"text-xs",children:c.error})]}),S?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:u.slice(0,4).map(M=>{const q=v===M.id,F=!b&&!q;return e.jsxs("div",{className:`relative p-3 bg-white border rounded-lg hover:shadow-sm transition-all ${q?"border-emerald-500 border-2 bg-emerald-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 truncate",children:M.room_name}),q&&e.jsx(D,{variant:"default",className:"text-[10px] px-1 py-0 h-4 bg-emerald-600",children:"YOU"})]}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(de,{className:"h-3 w-3 text-gray-400"}),e.jsxs("span",{className:"text-xs text-gray-600",children:[M.current_participants,"/",M.max_participants]})]})]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>p(M.id),className:"h-6 w-6 -mt-1 -mr-1",children:e.jsx(rs,{className:"h-3 w-3"})})]}),F&&e.jsx(N,{variant:"outline",size:"sm",onClick:()=>_(M.id,M.room_name,M.twilio_room_sid||""),disabled:!M.twilio_room_sid||b,className:"w-full h-7 text-xs mt-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"h-3 w-3 mr-1 animate-spin"}),"Joining..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xc,{className:"h-3 w-3 mr-1"}),"Join Room"]})}),q&&e.jsx("div",{className:"mt-2 px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-[10px] text-center font-medium",children:"Current Room"}),M.current_participants>=M.max_participants&&!q&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-1 bg-yellow-400 rounded-b-lg"})]},M.id)})}),u.length>4&&e.jsxs("p",{className:"text-xs text-center text-gray-500",children:["+",u.length-4," more rooms"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>o(!n),className:"flex-1 h-8 text-xs",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),n?"Hide":"Manage"," Assignments"]}),e.jsx(N,{onClick:()=>r(!0),variant:"outline",size:"sm",className:"h-8 text-xs",children:e.jsx(us,{className:"h-3 w-3"})})]}),n&&e.jsx("div",{className:"mt-2 p-3 bg-white border border-gray-200 rounded-lg",children:e.jsx(Bd,{sessionId:s,rooms:u,assignments:m,onMoveParticipant:x,onRefresh:g})})]}):e.jsxs(N,{onClick:()=>r(!0),className:"w-full h-9 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-sm shadow-md",disabled:E,children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"Create Breakout Rooms"]}),e.jsx(Md,{open:a,onOpenChange:r,onCreateRooms:h,sessionId:s})]})]})},Od=({isVideoEnabled:s,isAudioEnabled:t,isScreenSharing:a=!1,onToggleVideo:r,onToggleAudio:n,onToggleScreenShare:o,onReconnect:i,connectionState:c,qualityMetrics:u,adaptationControls:m,disabled:h=!1,className:p,sessionId:d,isTherapist:x=!1})=>{const[j,g]=l.useState(!1),[v,f]=l.useState(!1),[y,b]=l.useState(!1),[_,k]=l.useState(!1),[S,E]=l.useState(!1),[B,M]=l.useState(!1),[q,F]=l.useState(!1),{toast:P}=Z(),L=async()=>{if(!(j||h)){g(!0);try{await r()}finally{g(!1)}}},A=async()=>{if(!(v||h)){f(!0);try{await n()}finally{f(!1)}}},Q=async()=>{if(!(!o||y||h)){b(!0);try{await o()}finally{b(!1)}}},$=async()=>{if(!(!i||_)){k(!0);try{await i()}finally{k(!1)}}},Y=c==="CONNECTED",U=c==="FAILED"||c==="DISCONNECTED",G=async()=>{if(!d)return;const ee=`${window.location.origin}/video-conference/${d}?join=true`;try{await navigator.clipboard.writeText(ee),F(!0),P({title:"Link copied!",description:"Session link copied to clipboard"}),setTimeout(()=>F(!1),2e3)}catch{P({title:"Failed to copy",description:"Please copy the link manually",variant:"destructive"})}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:C("flex items-center justify-center gap-2 flex-wrap",p),children:[e.jsxs(N,{variant:s?"default":"secondary",size:"sm",className:C("gap-2 min-w-[100px]",!s&&"bg-red-500/10 hover:bg-red-500/20 text-red-600"),onClick:L,disabled:h||j||!Y,children:[j?e.jsx(Ke,{className:"h-4 w-4 animate-spin"}):s?e.jsx(ne,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"}),s?"Video On":"Video Off"]}),e.jsxs(N,{variant:t?"default":"secondary",size:"sm",className:C("gap-2 min-w-[100px]",!t&&"bg-red-500/10 hover:bg-red-500/20 text-red-600"),onClick:A,disabled:h||v||!Y,children:[v?e.jsx(Ke,{className:"h-4 w-4 animate-spin"}):t?e.jsx(os,{className:"h-4 w-4"}):e.jsx(gt,{className:"h-4 w-4"}),t?"Mic On":"Mic Off"]}),o&&e.jsxs(N,{variant:a?"default":"outline",size:"sm",className:"gap-2",onClick:Q,disabled:h||y||!Y,children:[y?e.jsx(Ke,{className:"h-4 w-4 animate-spin"}):a?e.jsx(ds,{className:"h-4 w-4"}):e.jsx(gc,{className:"h-4 w-4"}),a?"Stop Share":"Share Screen"]}),d&&e.jsx(N,{variant:"outline",size:"sm",className:C("gap-2",q&&"bg-green-50 border-green-300 text-green-700"),onClick:G,children:q?e.jsxs(e.Fragment,{children:[e.jsx(Is,{className:"h-4 w-4"}),"Copied!"]}):e.jsxs(e.Fragment,{children:[e.jsx(ft,{className:"h-4 w-4"}),"Share Link"]})}),x&&d&&e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2",onClick:()=>M(!0),disabled:h||!Y,children:[e.jsx(de,{className:"h-4 w-4"}),"Breakout Rooms"]}),e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2",onClick:()=>E(!0),disabled:h,children:[e.jsx(hs,{className:"h-4 w-4"}),"Devices"]}),U&&i&&e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2 text-orange-600 border-orange-200 hover:bg-orange-50",onClick:$,disabled:_,children:[_?e.jsx(Ke,{className:"h-4 w-4 animate-spin"}):e.jsx(fc,{className:"h-4 w-4"}),"Reconnect"]})]}),e.jsxs("div",{className:"flex justify-center mt-2 gap-2",children:[u&&e.jsx(Ed,{quality:u,isConnected:c==="CONNECTED",detailed:!0}),m&&e.jsx(Dd,{...m}),e.jsxs(D,{variant:c==="CONNECTED"?"default":c==="CONNECTING"?"secondary":c==="FAILED"?"destructive":"outline",className:"text-xs",children:[c==="CONNECTED"&&"Connected",c==="CONNECTING"&&"Connecting...",c==="FAILED"&&"Connection Failed",c==="DISCONNECTED"&&"Reconnecting...",c==="IDLE"&&"Ready"]})]}),e.jsx(Ad,{open:S,onOpenChange:E}),x&&d&&e.jsx(He,{open:B,onOpenChange:M,children:e.jsxs($e,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(Oe,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center",children:e.jsx(de,{className:"h-4 w-4 text-white"})}),"Breakout Rooms"]}),e.jsx($s,{children:"Create and manage breakout rooms for focused group discussions"})]}),e.jsx(Va,{sessionId:d,isTherapist:x})]})})]})},Fd=Jo,Ld=Ko,bi=l.forwardRef(({className:s,...t},a)=>e.jsx(nn,{className:C("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));bi.displayName=nn.displayName;const wi=l.forwardRef(({className:s,...t},a)=>e.jsxs(Ld,{children:[e.jsx(bi,{}),e.jsx(on,{ref:a,className:C("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...t})]}));wi.displayName=on.displayName;const Ni=({className:s,...t})=>e.jsx("div",{className:C("flex flex-col space-y-2 text-center sm:text-left",s),...t});Ni.displayName="AlertDialogHeader";const Si=({className:s,...t})=>e.jsx("div",{className:C("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});Si.displayName="AlertDialogFooter";const Ci=l.forwardRef(({className:s,...t},a)=>e.jsx(cn,{ref:a,className:C("text-lg font-semibold",s),...t}));Ci.displayName=cn.displayName;const ki=l.forwardRef(({className:s,...t},a)=>e.jsx(ln,{ref:a,className:C("text-sm text-muted-foreground",s),...t}));ki.displayName=ln.displayName;const _i=l.forwardRef(({className:s,...t},a)=>e.jsx(dn,{ref:a,className:C(ht(),s),...t}));_i.displayName=dn.displayName;const Ri=l.forwardRef(({className:s,...t},a)=>e.jsx(mn,{ref:a,className:C(ht({variant:"outline"}),"mt-2 sm:mt-0",s),...t}));Ri.displayName=mn.displayName;const qd=({participants:s=[],isTherapist:t,currentUserId:a,onRemoveParticipant:r,maxParticipants:n=10})=>{const[o,i]=l.useState(null),[c,u]=l.useState(!1),h=(Array.isArray(s)?s:[]).filter(f=>f==null?void 0:f.is_active),p=h.length>=n,d=f=>{const y=new Date(f),_=Math.floor((new Date().getTime()-y.getTime())/(1e3*60));return _<1?"Just joined":_<60?`${_}m ago`:`${Math.floor(_/60)}h ${_%60}m ago`},x=f=>f.role==="therapist"||f.role==="admin"?e.jsx(yc,{className:"h-5 w-5 text-yellow-500"}):e.jsx(Be,{className:"h-5 w-5 text-blue-500"}),j=f=>f.user_id===a,g=(f,y)=>{y||i(f)},v=async()=>{if(o){u(!0);try{await r(o)}catch(f){console.error("Failed to remove participant:",f)}finally{u(!1),i(null)}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center",children:e.jsx(de,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-lg",children:h.length}),e.jsx("span",{className:"text-muted-foreground text-sm",children:h.length===1?"participant":"participants"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:p?"Session full":`${n-h.length} spots available`})]})]}),e.jsxs(D,{variant:p?"destructive":"secondary",className:"h-6",children:[h.length,"/",n]})]}),e.jsx(jt,{}),e.jsx("div",{className:"space-y-2",children:h.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(de,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"font-medium",children:"No participants yet"}),e.jsx("p",{className:"text-xs mt-1",children:"Waiting for participants to join..."})]}):h.map((f,y)=>e.jsx(R,{className:C("transition-all duration-200 hover:shadow-md",j(f)&&"ring-2 ring-primary/20 bg-primary/5"),children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:C("h-12 w-12 rounded-full flex items-center justify-center",j(f)?"bg-gradient-to-br from-primary to-primary/80":"bg-gradient-to-br from-slate-200 to-slate-300"),children:x(f)}),e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 h-4 w-4 rounded-full bg-green-500 border-2 border-white"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:f.participant_name||"Anonymous User"}),j(f)&&e.jsx(D,{variant:"outline",className:"text-xs px-1.5 py-0",children:"You"}),f.isPlaceholder&&e.jsx(D,{variant:"secondary",className:"text-xs px-1.5 py-0",children:"Connecting..."}),(f.role==="therapist"||f.role==="admin")&&e.jsx(D,{className:"text-xs px-1.5 py-0 bg-gradient-to-r from-yellow-500 to-yellow-600",children:f.role==="therapist"?"Therapist":"Admin"})]}),e.jsx("div",{className:"flex items-center gap-3 mt-1 text-xs text-muted-foreground",children:e.jsx("span",{children:f.isPlaceholder?"Connecting…":d(f.joined_at)})}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs("div",{className:C("flex items-center gap-1 px-2 py-1 rounded-md text-xs","bg-slate-100 text-slate-600"),children:[e.jsx(ne,{className:"h-3 w-3"}),e.jsx("span",{children:f.isPlaceholder?"Pending":"On"})]}),e.jsxs("div",{className:C("flex items-center gap-1 px-2 py-1 rounded-md text-xs","bg-slate-100 text-slate-600"),children:[e.jsx(os,{className:"h-3 w-3"}),e.jsx("span",{children:f.isPlaceholder?"Pending":"On"})]}),e.jsxs("div",{className:C("flex items-center gap-1 px-2 py-1 rounded-md text-xs","bg-green-100 text-green-600"),children:[e.jsx(Xe,{className:"h-3 w-3"}),e.jsx("span",{children:f.isPlaceholder?"Syncing":"Good"})]})]})]})]}),t&&!j(f)&&!f.isPlaceholder&&e.jsxs(Ma,{children:[e.jsx(Ba,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(jc,{className:"h-4 w-4"})})}),e.jsx(Ht,{align:"end",children:e.jsxs(gs,{onClick:()=>g(f.id,f.isPlaceholder),className:"text-destructive focus:text-destructive",children:[e.jsx(vc,{className:"h-4 w-4 mr-2"}),"Remove from session"]})})]})]})})},f.id))}),p&&e.jsx(R,{className:"border-destructive/50 bg-destructive/5",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-lg bg-destructive/10 flex items-center justify-center flex-shrink-0",children:e.jsx(de,{className:"h-5 w-5 text-destructive"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:"Session at Maximum Capacity"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:"No new participants can join until someone leaves the session."})]})]})})})]}),e.jsx(Fd,{open:!!o,onOpenChange:()=>i(null),children:e.jsxs(wi,{children:[e.jsxs(Ni,{children:[e.jsx(Ci,{children:"Remove Participant?"}),e.jsx(ki,{children:"This will remove the participant from the session. They will need a new invitation to rejoin."})]}),e.jsxs(Si,{children:[e.jsx(Ri,{disabled:c,children:"Cancel"}),e.jsx(_i,{onClick:v,disabled:c,className:"bg-destructive hover:bg-destructive/90",children:c?"Removing...":"Remove"})]})]})})]})},Ud=(s,t=!0)=>{const[a,r]=l.useState([]),[n,o]=l.useState(!1),{toast:i}=Z(),c=l.useRef(null),u=l.useRef(null),m=l.useRef(!1),h=l.useCallback(async()=>{if(!s||s.trim()===""||!t){r([]),o(!1);return}o(!0);try{console.log("🔍 Fetching participants for session:",s);const _=new Date(Date.now()-2*60*1e3).toISOString();await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("session_id",s).eq("is_active",!0).lt("joined_at",_);const{data:k,error:S}=await w.from("instant_session_participants").select("*").eq("session_id",s).eq("is_active",!0).order("joined_at",{ascending:!0});S?(console.error("Error fetching participants:",S),r([])):(console.log("✅ Found active participants:",k),r(k||[]))}catch(_){console.error("Error fetching participants:",_),r([])}finally{o(!1)}},[s,t]),p=l.useCallback(async(_,k,S)=>{if(!(!s||!t))try{console.log("👤 Adding participant:",{participantName:_,userId:k,role:S});const{data:E}=await w.from("instant_session_participants").select("id").eq("session_id",s).eq("is_active",!0).or(k?`user_id.eq.${k}`:`participant_name.eq.${_}`).single();if(E){console.log("📝 Participant already exists, updating their status"),u.current=E.id,await h();return}k&&await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("session_id",s).eq("user_id",k).eq("is_active",!1);const{data:B,error:M}=await w.from("instant_session_participants").insert({session_id:s,user_id:k||null,participant_name:_,role:S||"participant",is_active:!0}).select("id").single();if(M)throw M;B&&(u.current=B.id,console.log("✅ Participant added successfully:",B.id)),await h()}catch(E){console.error("❌ Error adding participant:",E),i({title:"Error",description:"Failed to join session",variant:"destructive"})}},[s,t,i,h]),d=l.useCallback(async _=>{try{console.log("🚪 Removing participant:",_);const{error:k}=await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("id",_);if(k)throw k;console.log("✅ Participant removed successfully"),await h()}catch(k){console.error("❌ Error removing participant:",k)}},[h]),x=l.useCallback(async()=>{if(!(m.current||!u.current)){m.current=!0;try{console.log("🧹 Cleaning up current participant:",u.current),await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("id",u.current),u.current=null,console.log("✅ Current participant cleaned up")}catch(_){console.error("❌ Error cleaning up participant:",_)}finally{m.current=!1}}},[]),j=l.useCallback(()=>{c.current&&clearInterval(c.current),c.current=setInterval(async()=>{if(u.current&&s&&t)try{await w.from("instant_session_participants").update({joined_at:new Date().toISOString()}).eq("id",u.current).eq("is_active",!0),console.log("💓 Heartbeat sent for participant:",u.current)}catch(_){console.error("💔 Heartbeat failed:",_)}},15e3)},[s,t]),g=l.useCallback(()=>{c.current&&(clearInterval(c.current),c.current=null,console.log("💔 Heartbeat stopped"))},[]),v=l.useCallback(async()=>{if(console.log("🚀 Joining instant session:",s),!(!s||!t))try{const{data:_}=await w.from("instant_sessions").select("max_participants, is_active, expires_at").eq("id",s).single();if(!_||!_.is_active||new Date(_.expires_at)<new Date)throw new Error("Session is not available");const{count:k}=await w.from("instant_session_participants").select("*",{count:"exact",head:!0}).eq("session_id",s).eq("is_active",!0);if(k&&k>=_.max_participants)throw new Error("Session is full");console.log("✅ Session is available for joining")}catch(_){throw console.error("❌ Cannot join session:",_),_}},[s,t]),f=l.useCallback(async()=>{console.log("👋 Leaving instant session:",s),await x(),g()},[s,x,g]);l.useEffect(()=>{if(!s||s.trim()===""||!t){r([]);return}h();const _=w.channel(`instant-session-participants-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"instant_session_participants",filter:`session_id=eq.${s}`},M=>{console.log("📡 Real-time participant change:",M),setTimeout(()=>{h()},500)}).subscribe(M=>{console.log("📡 Subscription status:",M)}),k=()=>{console.log("🚪 Page unloading, cleaning up..."),x()},S=()=>{document.hidden&&(console.log("👁️ Page hidden, cleaning up..."),x())},E=()=>{console.log("🔄 Window blur, stopping heartbeat..."),g()},B=()=>{console.log("🔄 Window focus, restarting heartbeat..."),u.current&&j()};return window.addEventListener("beforeunload",k),document.addEventListener("visibilitychange",S),window.addEventListener("blur",E),window.addEventListener("focus",B),()=>{console.log("🧹 Cleaning up participant hook..."),w.removeChannel(_),g(),x(),window.removeEventListener("beforeunload",k),document.removeEventListener("visibilitychange",S),window.removeEventListener("blur",E),window.removeEventListener("focus",B)}},[s,t,h,x,g,j]);const y=a.length>=10,b=a.length>0;return{participants:a,loading:n,addParticipant:p,removeParticipant:d,refetch:h,startHeartbeat:j,stopHeartbeat:g,cleanupCurrentParticipant:x,joinSession:v,leaveSession:f,sessionFull:y,isSessionActive:b,participantCount:a.length,currentParticipantId:u.current}},lr=3;function $d(s={}){const{enabled:t=!0,sessionId:a,onAssigned:r,disconnectFromMainSession:n,pollingInterval:o=3e4}=s,{toast:i}=Z(),[c,u]=l.useState(!1),[m,h]=l.useState(null),[p,d]=l.useState(null),[x,j]=l.useState(null),g=l.useRef(null),v=l.useRef(new Set),f=l.useRef(0),y=l.useRef(null),b=l.useRef(null),_=l.useRef(null),k=l.useRef(!1),S=l.useRef(!1),E=l.useRef(0),B=l.useCallback(async F=>{var L;if(k.current||S.current){console.log("⏸️ [BreakoutAssignmentListener] Skipping join (cleanup or already joining)");return}const P=F.room_id;if(v.current.has(P)){console.log("⏸️ [BreakoutAssignmentListener] Skipping previously failed assignment:",P);return}S.current=!0,console.log("🚀 [BreakoutAssignmentListener] Joining breakout room:",F);try{n&&(console.log("🔌 [BreakoutAssignmentListener] Disconnecting from main session..."),await n(),console.log("✅ [BreakoutAssignmentListener] Disconnected from main session"));const{data:{user:A}}=await w.auth.getUser();if(!(A!=null&&A.id))throw new Error("No authenticated user");const Q=((L=A.email)==null?void 0:L.split("@")[0])||A.id;console.log("🎫 [BreakoutAssignmentListener] Getting token for:",F.twilio_room_sid);const $=await Qe.getAccessToken(Q,F.twilio_room_sid);console.log("🔌 [BreakoutAssignmentListener] Connecting to Twilio room...");const U=await pt().connect({roomName:F.twilio_room_sid,token:$.token,audio:!0,video:!0,networkQuality:!0,dominantSpeaker:!0});console.log("✅ [BreakoutAssignmentListener] Connected to breakout room:",U.sid),f.current=0,h(U),d(F.room_id),j(F.room_name),u(!0),i({title:`Joined ${F.room_name}`,description:"You have been assigned to a breakout room"}),r&&r(F)}catch(A){console.error("❌ [BreakoutAssignmentListener] Failed to join breakout room:",A),v.current.add(P),g.current=P,f.current+=1,v.current.has(P)||i({title:"Failed to join breakout room",description:A.message||"Please try joining manually",variant:"destructive"}),f.current>=lr&&(console.warn("⚠️ [BreakoutAssignmentListener] Too many errors, stopping polling"),y.current&&(clearInterval(y.current),y.current=null))}finally{S.current=!1}},[n,r,i]),M=l.useCallback(async()=>{console.log("🔌 [BreakoutAssignmentListener] Leaving breakout room");try{pt().disconnect(),p&&v.current.delete(p),h(null),d(null),j(null),u(!1),g.current=null,f.current=0,i({title:"Left breakout room",description:"Returning to main session"})}catch(F){console.error("❌ [BreakoutAssignmentListener] Error leaving breakout room:",F)}},[p,i]),q=l.useCallback(async()=>{if(!(k.current||!_.current||S.current)){if(f.current>=lr){console.log("⏸️ [BreakoutAssignmentListener] Polling paused due to errors");return}try{const{data:F}=await w.from("instant_session_participants").select("id").eq("user_id",_.current).maybeSingle();if(!F)return;const{data:P,error:L}=await w.from("breakout_room_participants").select(`
          breakout_room_id,
          breakout_rooms (
            id,
            room_name,
            twilio_room_sid,
            is_active
          )
        `).eq("participant_id",F.id).eq("is_active",!0).maybeSingle();if(L){console.error("❌ [BreakoutAssignmentListener] Poll error:",L),f.current+=1;return}f.current=0;const A=P==null?void 0:P.breakout_rooms;if(P&&(A!=null&&A.is_active)&&(A!=null&&A.twilio_room_sid)){const Q=A.id;if(g.current===Q||v.current.has(Q)||c&&p===Q)return;c||(console.log("📡 [BreakoutAssignmentListener] Found assignment via polling:",A),g.current=Q,await B({room_id:A.id,room_name:A.room_name,twilio_room_sid:A.twilio_room_sid,action:"join"}))}else!P&&c&&(console.log("📡 [BreakoutAssignmentListener] Assignment removed, leaving room"),await M())}catch(F){console.error("❌ [BreakoutAssignmentListener] Poll check failed:",F),f.current+=1}}},[c,p,B,M]);return l.useEffect(()=>{if(!t){console.log("⏸️ [BreakoutAssignmentListener] Disabled, skipping setup");return}let F=null;return k.current=!1,(async()=>{const{data:{user:L}}=await w.auth.getUser();if(!(L!=null&&L.id)){console.warn("⚠️ [BreakoutAssignmentListener] No authenticated user");return}_.current=L.id,console.log("📡 [BreakoutAssignmentListener] Setting up for user:",L.id),F=w.channel(`user:${L.id}:breakout`),F.on("broadcast",{event:"breakout_assignment"},async $=>{if(k.current){console.log("🧹 [BreakoutAssignmentListener] Ignoring message, cleanup started");return}console.log("📨 [BreakoutAssignmentListener] Received broadcast:",$);const Y=$.payload;Y.action==="join"?await B(Y):Y.action==="return"&&await M()}).subscribe(async $=>{console.log("📡 [BreakoutAssignmentListener] Channel status:",$),$==="SUBSCRIBED"&&console.log("✅ [BreakoutAssignmentListener] Subscribed to broadcasts")}),E.current=Date.now();const A=3e3,Q=3e4;console.log("⚡ [BreakoutAssignmentListener] Starting fast polling (3s intervals for 30s)"),b.current=setInterval(()=>{Date.now()-E.current>=Q?b.current&&(clearInterval(b.current),b.current=null,console.log("⏱️ [BreakoutAssignmentListener] Switching to slow polling")):q()},A),console.log("⏱️ [BreakoutAssignmentListener] Starting slow polling fallback"),y.current=setInterval(q,o),await q()})(),()=>{k.current=!0,F&&(console.log("🧹 [BreakoutAssignmentListener] Cleaning up channel"),w.removeChannel(F),F=null),b.current&&(console.log("🧹 [BreakoutAssignmentListener] Stopping fast polling"),clearInterval(b.current),b.current=null),y.current&&(console.log("🧹 [BreakoutAssignmentListener] Stopping slow polling"),clearInterval(y.current),y.current=null),v.current.clear(),f.current=0,S.current=!1}},[t,o,B,M,q]),l.useEffect(()=>{if(!t||!a)return;const P=(async()=>{const{data:{user:L}}=await w.auth.getUser();if(!(L!=null&&L.id))return;const{data:A}=await w.from("instant_session_participants").select("id").eq("session_id",a).eq("user_id",L.id).eq("is_active",!0).maybeSingle();if(!A)return;console.log("📡 [BreakoutAssignmentListener] Setting up DB listener for participant:",A.id);const Q=w.channel(`breakout-participant-${A.id}`).on("postgres_changes",{event:"*",schema:"public",table:"breakout_room_participants",filter:`participant_id=eq.${A.id}`},async $=>{console.log("📥 [BreakoutAssignmentListener] DB change:",$),await q()}).subscribe();return()=>{w.removeChannel(Q)}})();return()=>{P==null||P.then(L=>L==null?void 0:L())}},[t,a,q]),{isInBreakoutRoom:c,currentBreakoutRoom:m,currentRoomId:p,currentRoomName:x,leaveBreakoutRoom:M}}function zd(s){const{sessionId:t,currentRoomId:a=null,enabled:r=!0}=s,[n,o]=l.useState(new Map);l.useEffect(()=>{if(!r||!t){o(new Map);return}let p=null;const d=async()=>{try{const{data:x,error:j}=await w.from("instant_session_participants").select("id, user_id").eq("session_id",t).eq("is_active",!0);if(j||!x){console.error("❌ [useBreakoutRoomFilter] Failed to get participants:",j);return}const g=x.map(b=>b.id);if(g.length===0){o(new Map);return}const{data:v,error:f}=await w.from("breakout_room_participants").select("participant_id, user_id, breakout_room_id, breakout_rooms(room_name)").in("participant_id",g).eq("is_active",!0);if(f){console.error("❌ [useBreakoutRoomFilter] Failed to get assignments:",f);return}const y=new Map;x.forEach(b=>{if(!b.user_id)return;const _=v==null?void 0:v.find(k=>k.participant_id===b.id);y.set(b.user_id,(_==null?void 0:_.breakout_room_id)||null)}),console.log("📋 [useBreakoutRoomFilter] Room assignments:",{total:y.size,inBreakoutRooms:Array.from(y.values()).filter(Boolean).length,assignments:Array.from(y.entries())}),o(y)}catch(x){console.error("❌ [useBreakoutRoomFilter] Error fetching assignments:",x)}};return d(),p=w.channel(`breakout-assignments-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"breakout_room_participants"},()=>{d()}).subscribe(),()=>{p&&w.removeChannel(p)}},[t,r]);const i=l.useMemo(()=>{const p=new Set;return n.forEach((d,x)=>{d&&p.add(x)}),p},[n]),c=l.useCallback(p=>i.has(p),[i]),u=l.useCallback(p=>n.get(p)||null,[n]),m=l.useCallback(p=>{for(const[d]of n)if(p.includes(d))return d;return null},[n]),h=l.useCallback(p=>{const d=m(p);if(!d)return!0;const x=u(d);return a===null?x===null:x===a},[a,m,u]);return{assignments:n,participantsInBreakoutRooms:i,isUserInBreakoutRoom:c,getUserRoomId:u,shouldShowStream:h}}function Vd(s){const{room:t,enabled:a=!0}=s,[r,n]=l.useState(null),[o,i]=l.useState([]),[c,u]=l.useState(null),m=l.useRef(new Map),h=l.useCallback((g,v)=>{if(!(!g||!v))try{g.detach().forEach(f=>{f.srcObject=null}),g.attach(v),m.current.set(g.sid,v),console.log("📹 [TwilioVideoDisplay] Track attached:",g.sid)}catch(f){console.error("❌ [TwilioVideoDisplay] Failed to attach track:",f)}},[]),p=l.useCallback((g,v)=>{if(!(!g||!v))try{g.detach(v),m.current.delete(g.sid),v.srcObject=null,console.log("📹 [TwilioVideoDisplay] Track detached:",g.sid)}catch(f){console.error("❌ [TwilioVideoDisplay] Failed to detach track:",f)}},[]),d=l.useCallback(()=>{if(!(t!=null&&t.localParticipant))return null;const g=t.localParticipant;let v=null,f=null;return g.videoTracks.forEach(y=>{y.track&&(v=y.track)}),g.audioTracks.forEach(y=>{y.track&&(f=y.track)}),{participantIdentity:g.identity,participantSid:g.sid,isLocal:!0,videoTrack:v,audioTrack:f,isVideoEnabled:(v==null?void 0:v.isEnabled)??!1,isAudioEnabled:(f==null?void 0:f.isEnabled)??!1,networkQuality:g.networkQualityLevel??null}},[t]),x=l.useCallback(g=>{let v=null,f=null;return g.videoTracks.forEach(y=>{y.isSubscribed&&y.track&&(v=y.track)}),g.audioTracks.forEach(y=>{y.isSubscribed&&y.track&&(f=y.track)}),{participantIdentity:g.identity,participantSid:g.sid,isLocal:!1,videoTrack:v,audioTrack:f,isVideoEnabled:(v==null?void 0:v.isEnabled)??!1,isAudioEnabled:(f==null?void 0:f.isEnabled)??!1,networkQuality:g.networkQualityLevel??null}},[]),j=l.useCallback(()=>{if(!t||!a){n(null),i([]);return}n(d());const g=[];t.participants.forEach(v=>{g.push(x(v))}),i(g),console.log("📋 [TwilioVideoDisplay] Updated track infos:",{local:!!t.localParticipant,remoteCount:g.length})},[t,a,d,x]);return l.useEffect(()=>{if(!t||!a){n(null),i([]);return}console.log("🎥 [TwilioVideoDisplay] Setting up room listeners for:",t.sid),j();const g=S=>{console.log("👤 [TwilioVideoDisplay] Participant connected:",S.identity),S.on("trackSubscribed",f),S.on("trackUnsubscribed",y),S.on("trackEnabled",b),S.on("trackDisabled",b),j()},v=S=>{console.log("👤 [TwilioVideoDisplay] Participant disconnected:",S.identity),S.off("trackSubscribed",f),S.off("trackUnsubscribed",y),S.off("trackEnabled",b),S.off("trackDisabled",b),j()},f=S=>{console.log("📹 [TwilioVideoDisplay] Track subscribed:",S.kind,S.sid),j()},y=S=>{console.log("📹 [TwilioVideoDisplay] Track unsubscribed:",S.kind,S.sid),j()},b=()=>{j()},_=S=>{u((S==null?void 0:S.identity)??null)},k=()=>{n(d())};return t.on("participantConnected",g),t.on("participantDisconnected",v),t.on("dominantSpeakerChanged",_),t.on("trackPublished",b),t.on("trackUnpublished",b),t.participants.forEach(S=>{S.on("trackSubscribed",f),S.on("trackUnsubscribed",y),S.on("trackEnabled",b),S.on("trackDisabled",b)}),t.localParticipant.on("trackEnabled",k),t.localParticipant.on("trackDisabled",k),()=>{console.log("🧹 [TwilioVideoDisplay] Cleaning up room listeners"),t.off("participantConnected",g),t.off("participantDisconnected",v),t.off("dominantSpeakerChanged",_),t.off("trackPublished",b),t.off("trackUnpublished",b),t.participants.forEach(S=>{S.off("trackSubscribed",f),S.off("trackUnsubscribed",y),S.off("trackEnabled",b),S.off("trackDisabled",b)}),t.localParticipant.off("trackEnabled",k),t.localParticipant.off("trackDisabled",k),m.current.forEach((S,E)=>{S.srcObject=null}),m.current.clear()}},[t,a,j,d]),{localTrackInfo:r,remoteTrackInfos:o,dominantSpeaker:c,attachTrackToElement:h,detachTrackFromElement:p}}const dr=({trackInfo:s,attachTrack:t,detachTrack:a,isDominantSpeaker:r})=>{const n=l.useRef(null);l.useEffect(()=>{const i=n.current,c=s.videoTrack;if(i&&c)return console.log("📹 [TwilioVideoTile] Attaching track for:",s.participantIdentity),t(c,i),()=>{console.log("📹 [TwilioVideoTile] Detaching track for:",s.participantIdentity),a(c,i)}},[s.videoTrack,s.participantIdentity,t,a]);const o=i=>i===null?"bg-gray-400":i>=4?"bg-green-400":i>=2?"bg-yellow-400":"bg-red-400";return e.jsx(R,{className:C("relative overflow-hidden h-full min-h-[200px]",r&&"ring-2 ring-green-500"),children:e.jsxs(T,{className:"p-0 h-full bg-slate-800 flex items-center justify-center",children:[s.isVideoEnabled&&s.videoTrack?e.jsx("video",{ref:n,autoPlay:!0,playsInline:!0,muted:s.isLocal,className:"w-full h-full object-cover"}):e.jsxs("div",{className:"text-white flex flex-col items-center gap-2",children:[e.jsx(Ss,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm",children:"Video Off"})]}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/70 px-2 py-1 rounded backdrop-blur-sm flex items-center gap-2",children:[e.jsx("span",{children:s.participantIdentity}),s.isLocal&&e.jsx("span",{className:"text-green-400",children:"(You)"}),r&&e.jsx("span",{className:"text-yellow-400",children:"🎤"})]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-2",children:[e.jsx("div",{className:C("h-2 w-2 rounded-full",o(s.networkQuality)),title:`Network: ${s.networkQuality??"unknown"}/5`}),!s.isAudioEnabled&&e.jsx(gt,{className:"h-4 w-4 text-red-400"}),!s.isVideoEnabled&&e.jsx(Ss,{className:"h-4 w-4 text-red-400"})]})]})})},Gd=({room:s,roomName:t,className:a})=>{const{localTrackInfo:r,remoteTrackInfos:n,dominantSpeaker:o,attachTrackToElement:i,detachTrackFromElement:c}=Vd({room:s,enabled:!!s}),u=(r?1:0)+n.length,m=C("h-full gap-4",u<=1||u===2?"grid grid-cols-1 md:grid-cols-2":u<=4?"grid grid-cols-2":"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4");return s?e.jsxs("div",{className:C("flex-1 bg-slate-50 p-4 overflow-y-auto",a),children:[t&&e.jsxs("div",{className:"mb-4 flex items-center gap-2",children:[e.jsx("div",{className:"h-3 w-3 bg-green-500 rounded-full animate-pulse"}),e.jsxs("span",{className:"text-sm font-medium text-slate-600",children:["Breakout Room: ",t]}),e.jsxs("span",{className:"text-xs text-slate-400",children:["(",u," participant",u!==1?"s":"",")"]})]}),e.jsxs("div",{className:m,children:[r&&e.jsx(dr,{trackInfo:r,attachTrack:i,detachTrack:c,isDominantSpeaker:o===r.participantIdentity}),n.map(h=>e.jsx(dr,{trackInfo:h,attachTrack:i,detachTrack:c,isDominantSpeaker:o===h.participantIdentity},h.participantSid)),u<=1&&e.jsx(R,{className:"relative overflow-hidden h-full min-h-[200px]",children:e.jsx(T,{className:"p-0 h-full bg-slate-800 flex items-center justify-center",children:e.jsxs("div",{className:"text-white flex flex-col items-center gap-2 p-4 text-center",children:[e.jsx(Xe,{className:"h-8 w-8 opacity-50"}),e.jsx("span",{className:"text-sm font-medium",children:"Waiting for others..."}),e.jsx("span",{className:"text-xs opacity-70",children:"Other participants will appear here when they join"})]})})})]})]}):e.jsx("div",{className:C("flex items-center justify-center h-full bg-slate-900",a),children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx(Cs,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Connecting to breakout room..."})]})})},Ti=({sessionId:s,sessionType:t,className:a})=>{var je;const{videoState:r,isInSession:n,therapistInfo:o,patientInfo:i,isTherapist:c,joinSession:u,leaveSession:m,reconnectSession:h,toggleVideo:p,toggleAudio:d,toggleScreenShare:x,connectionState:j,sessionDuration:g,localVideoRef:v,remoteVideoRef:f,remoteStreams:y,sessionStatus:b,cameraStatus:_,participants:k,connectedPeers:S}=vt(),{deviceState:E}=pi(),{user:B}=V(),M=vi({sessionId:s,therapistName:((je=B==null?void 0:B.email)==null?void 0:je.split("@")[0])||"Therapist",isTherapist:c||!1}),[q,F]=l.useState(null);l.useEffect(()=>{if(c&&M.currentRoomId){const oe=pt().getRoom();F(oe),console.log("🎥 [GroupSessionContainer] Therapist Twilio room updated:",oe==null?void 0:oe.sid)}else c&&!M.currentRoomId&&(F(null),console.log("🏠 [GroupSessionContainer] Therapist returned to main session"))},[c,M.currentRoomId]);const{isInBreakoutRoom:P,currentBreakoutRoom:L,currentRoomId:A,currentRoomName:Q,leaveBreakoutRoom:$}=$d({enabled:!0,sessionId:s,onAssigned:ue=>{console.log("📢 [GroupSessionContainer] Received breakout assignment:",ue)},disconnectFromMainSession:async()=>{console.log("🔌 [GroupSessionContainer] Disconnecting from main session for breakout room"),await m()}}),Y=c&&M.currentRoomId!==null||P,U=c&&q||L,G=c&&M.currentRoomId||A,ee=c&&M.currentRoomName||Q,K=async()=>{c&&M.currentRoomId?await M.returnToMainSession():await $()},{shouldShowStream:ie}=zd({sessionId:s,currentRoomId:G,enabled:n&&!Y}),pe=se.useMemo(()=>n?y.filter(ue=>{const oe=ie(ue.id);return oe||console.log("🚫 [GroupSessionContainer] Filtering out stream (not in current room):",ue.id),oe}):[],[y,ie,n]),{participants:W,removeParticipant:ae}=Ud(s),Te=se.useMemo(()=>Array.isArray(W)?W:[],[W]),Ye=se.useMemo(()=>{if(!S||S.length===0)return[];const ue=new Set(S.filter(Boolean)),oe=new Set(Te.map(Ve=>Ve.user_id).filter(Boolean));return Array.from(ue).filter(Ve=>!oe.has(Ve)).map((Ve,yt)=>({id:`peer-${Ve}-${yt}`,session_id:s,user_id:Ve,participant_name:`Participant ${Te.length+yt+1}`,role:"participant",joined_at:new Date().toISOString(),left_at:null,is_active:!0,isPlaceholder:!0}))},[S,Te,s]),ze=se.useMemo(()=>[...Te,...Ye],[Te,Ye]),ts=l.useRef(new Map);l.useEffect(()=>{y.forEach(ue=>{const oe=ts.current.get(ue.id);oe&&oe.srcObject!==ue&&(console.log("🎥 [GroupSessionContainer] Attaching stream",ue.id,"to video element"),oe.srcObject=ue)})},[y]);const ys=()=>E.availability.loading?{camera:"detecting",microphone:"detecting",step:"Detecting available devices...",progress:25}:E.permissions.camera==="prompt"||E.permissions.microphone==="prompt"?{camera:E.permissions.camera==="prompt"?"requesting":E.permissions.camera==="granted"?"granted":E.permissions.camera==="denied"?"denied":"unavailable",microphone:E.permissions.microphone==="prompt"?"requesting":E.permissions.microphone==="granted"?"granted":E.permissions.microphone==="denied"?"denied":"unavailable",step:"Requesting device permissions...",progress:50}:{camera:E.permissions.camera==="granted"?"granted":E.permissions.camera==="denied"?"denied":"unavailable",microphone:E.permissions.microphone==="granted"?"granted":E.permissions.microphone==="denied"?"denied":"unavailable",step:he?"Establishing connection...":void 0,progress:he?75:void 0};se.useEffect(()=>{console.log("🔍 [GroupSessionContainer] Component mounted with:",{sessionId:s,sessionType:t,connectionState:j,cameraStatus:_,isInSession:n,isTherapist:c,participantCount:(k==null?void 0:k.length)||0,joinSessionAvailable:typeof u})},[s]);const[he,cs]=l.useState(!1),[ks,We]=l.useState(null);l.useEffect(()=>{n&&he&&(cs(!1),We(null))},[n,he]),l.useEffect(()=>{j==="FAILED"&&he&&(cs(!1),We("Failed to connect to the session. Please try again."))},[j,he]);const re=async()=>{if(console.log("🎯 [GroupSessionContainer] Join button clicked",{isJoining:he,isInSession:n,sessionId:s,sessionType:t,connectionState:j,cameraStatus:_,joinSession:typeof u}),he||n){console.log("⚠️ [GroupSessionContainer] Blocking join - already joining or in session");return}if(!u){console.error("❌ [GroupSessionContainer] joinSession function not available"),We("Join function not available");return}try{cs(!0),We(null),console.log("🚀 [GroupSessionContainer] Calling joinSession..."),await u(),console.log("✅ [GroupSessionContainer] joinSession completed successfully")}catch(ue){console.error("❌ [GroupSessionContainer] joinSession failed:",ue),cs(!1),We(ue instanceof Error?ue.message:"Failed to join session")}},ke=async()=>{try{await m(),cs(!1),We(null)}catch(ue){console.error("Failed to leave session:",ue)}};if(n){const ue=ze.filter(oe=>oe==null?void 0:oe.is_active).length;return e.jsxs("div",{className:C("h-full flex flex-col",a),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(cr,{connectionState:j,className:"flex-shrink-0"}),e.jsxs("span",{className:"text-sm font-medium",children:["Session Active ",g&&`• ${g}`]}),_==="permission-denied"&&e.jsx("span",{className:"text-xs text-destructive",children:"Camera access denied"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Fa,{children:[e.jsx(Vn,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Participants"}),e.jsx("span",{className:"inline sm:hidden",children:ue}),e.jsxs("span",{className:"hidden sm:inline",children:["(",ue,")"]})]})}),e.jsxs(Yt,{className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(Hn,{className:"mb-6",children:[e.jsxs(Yn,{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center",children:e.jsx(de,{className:"h-4 w-4 text-white"})}),"Session Participants"]}),e.jsx(Wn,{children:"View and manage participants in this session"})]}),c&&e.jsx("div",{className:"mb-6",children:e.jsx(Va,{sessionId:s,isTherapist:c})}),ze.length>0?e.jsx(qd,{participants:ze,isTherapist:c,currentUserId:(o==null?void 0:o.id)||(i==null?void 0:i.id),onRemoveParticipant:ae,maxParticipants:10}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(de,{className:"h-12 w-12 mb-4 opacity-30"}),e.jsx("p",{className:"text-sm",children:"No participants data available"})]})]})]}),e.jsx(N,{variant:"destructive",size:"sm",onClick:ke,children:"Leave Session"})]})]}),e.jsxs("div",{className:"flex-1 bg-slate-50 p-4 overflow-y-auto",children:[Y&&ee&&e.jsxs("div",{className:"mb-4 flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-3 w-3 bg-green-500 rounded-full animate-pulse"}),e.jsxs("span",{className:"text-sm font-medium text-blue-900",children:["Breakout Room: ",ee]}),e.jsx(D,{variant:"outline",className:"text-xs",children:"Twilio Video"})]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:K,className:"gap-1",children:[e.jsx(Rt,{className:"h-3 w-3"}),"Return to Main"]})]}),Y&&U?e.jsx(Gd,{room:U,roomName:ee||void 0}):e.jsxs("div",{className:C("h-full gap-4",pe.length===0||pe.length===1?"grid grid-cols-1 md:grid-cols-2":pe.length===2?"grid grid-cols-1 md:grid-cols-3":"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4"),children:[e.jsx(R,{className:"relative overflow-hidden h-full min-h-[200px]",children:e.jsxs(T,{className:"p-0 h-full bg-slate-900 flex items-center justify-center",children:[r.isVideoEnabled?e.jsx("video",{ref:v,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}):e.jsxs("div",{className:"text-white flex flex-col items-center gap-2",children:[e.jsx(Ss,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm",children:"Video Off"})]}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/70 px-2 py-1 rounded backdrop-blur-sm",children:["You ",c?"(Therapist)":"(Patient)"]}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1",children:[!r.isVideoEnabled&&e.jsx(bc,{className:"h-4 w-4 text-red-400"}),!r.isAudioEnabled&&e.jsx(gt,{className:"h-4 w-4 text-red-400"})]})]})}),pe.length>0?pe.map((oe,Zs)=>(console.log("🎬 [GroupSessionContainer] Rendering remote stream:",{streamId:oe.id,streamIndex:Zs,streamActive:oe.active}),e.jsx(R,{className:"relative overflow-hidden h-full min-h-[200px]",children:e.jsxs(T,{className:"p-0 h-full bg-slate-800 flex items-center justify-center",children:[e.jsx("video",{ref:Ve=>{Ve&&(ts.current.set(oe.id,Ve),Ve.srcObject!==oe&&(Ve.srcObject=oe))},autoPlay:!0,playsInline:!0,muted:!1,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/70 px-2 py-1 rounded backdrop-blur-sm",children:["Participant ",Zs+1]}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("div",{className:C("h-2 w-2 rounded-full",oe.active?"bg-green-400":"bg-red-400")})})]})},oe.id))):e.jsx(R,{className:"relative overflow-hidden h-full min-h-[200px]",children:e.jsxs(T,{className:"p-0 h-full bg-slate-800 flex items-center justify-center",children:[e.jsxs("div",{className:"text-white flex flex-col items-center gap-2 p-4",children:[e.jsx(de,{className:"h-8 w-8"}),e.jsx("span",{className:"text-sm font-medium",children:"Waiting for participants..."}),e.jsxs("div",{className:"text-xs opacity-70 text-center",children:[j==="CONNECTING"&&"Establishing connection...",j==="CONNECTED"&&y.length===0&&"Connected - waiting for others to join",j==="FAILED"&&"Connection failed - check your internet",j==="DISCONNECTED"&&"Connection lost - attempting to reconnect",j==="IDLE"&&"Ready to connect"]})]}),j==="FAILED"&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(N,{size:"sm",variant:"outline",onClick:h,className:"text-xs text-white border-white/20 hover:bg-white/10",children:"Retry"})})]})})]})]}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsx(Od,{isVideoEnabled:r.isVideoEnabled,isAudioEnabled:r.isAudioEnabled,isScreenSharing:r.isScreenSharing,onToggleVideo:p,onToggleAudio:d,onToggleScreenShare:x,onReconnect:h,connectionState:j,disabled:j==="CONNECTING",sessionId:s,isTherapist:c})})]})}return e.jsxs("div",{className:C("h-full flex items-center justify-center p-4",a),children:[e.jsx(R,{className:"max-w-md w-full",children:e.jsxs(T,{className:"p-6 text-center space-y-6",children:[ks&&e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:ks})}),_==="permission-denied"&&e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"Camera access denied. Please enable camera permissions in your browser settings and refresh the page."})}),j==="FAILED"&&e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"Connection failed. Please check your internet connection and try again."})}),e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"h-20 w-20 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(ne,{className:"h-10 w-10 text-primary"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-semibold mb-2",children:he?"Connecting...":"Ready to join your session?"}),e.jsx("p",{className:"text-muted-foreground",children:he?j==="CONNECTING"?"Establishing WebRTC connection...":"Please wait while we connect you to the session...":c?"Start your session when you're ready to begin.":"Join the session when the therapist is ready."}),j!=="IDLE"&&e.jsx(cr,{connectionState:j,className:"justify-center"})]}),e.jsx(N,{onClick:re,size:"lg",disabled:he||_==="permission-denied"||j==="FAILED",className:"px-6",children:he?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"mr-2 h-4 w-4 animate-spin"}),j==="CONNECTING"?"Connecting...":"Starting..."]}):j==="FAILED"?e.jsx(e.Fragment,{children:"Retry Connection"}):e.jsx(e.Fragment,{children:"Join Session"})})]})}),e.jsx(hi,{connectionState:j,isInSession:n||he,onRetry:re,deviceStatus:ys()})]})},Hd=()=>{const{sessionId:s}=xt(),{videoState:t,isInSession:a,waitingRoomActive:r,formatSessionDuration:n,deviceSettingsOpen:o,setDeviceSettingsOpen:i,showSessionSummary:c,setShowSessionSummary:u,sessionDuration:m,therapistInfo:h,patientInfo:p,isTherapist:d,cameras:x,microphones:j,speakers:g,changeDevice:v,testDevices:f,joinSession:y}=vt(),[b,_]=l.useState(!a),[k,S]=l.useState(!1),[E,B]=l.useState(!1);l.useEffect(()=>{(async()=>{if(!a&&!E&&s&&h){console.log("🚀 Auto-joining session..."),B(!0);try{await y(),_(!1)}catch(F){console.error("Auto-join failed:",F)}}})()},[a,E,s,h,y]);const M={title:"Group Therapy Session",patient_id:(p==null?void 0:p.id)||"",therapist_id:(h==null?void 0:h.id)||"",recording_consent:!0};return e.jsx(kd,{children:e.jsx(R,{className:"shadow-lg border-slate-200/60 bg-white/80 backdrop-blur-sm overflow-hidden",children:e.jsxs(T,{className:"p-0",children:[b&&!a?e.jsx(Cd,{appointmentId:"mock-appointment-id",onComplete:()=>_(!1)}):e.jsxs("div",{className:"flex flex-col h-[calc(100vh-160px)] md:h-[calc(100vh-180px)]",children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Sd,{appointmentDetails:M,isInSession:a,waitingRoomActive:r,isRecording:t.isRecording,deviceSettingsOpen:o,setDeviceSettingsOpen:i,videoState:t,devices:{cameras:x,microphones:j,speakers:g},changeDevice:v,testDevices:f,formatSessionDuration:n})}),d&&s&&e.jsx("div",{className:"ml-4",children:e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>S(!0),className:"gap-2",children:[e.jsx(ft,{className:"h-4 w-4"}),e.jsx(de,{className:"h-4 w-4"}),"Invite"]})})]})}),d&&a&&s&&e.jsx("div",{className:"p-4 border-b border-gray-200 bg-slate-50",children:e.jsx(Va,{sessionId:s,isTherapist:d})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:a?e.jsx(Ti,{sessionId:s||"",sessionType:"instant"}):e.jsx("div",{className:"flex flex-col items-center justify-center h-full bg-slate-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(de,{className:"h-16 w-16 mx-auto mb-4 text-gray-400"}),e.jsx("h2",{className:"text-2xl font-medium mb-2",children:d?"Ready to start your group session":"Waiting to join the session"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:d?"Your session is ready. Participants can join when you're ready to begin.":"Please wait while the host prepares the session."})]})})})]}),s&&e.jsx($a,{open:k,onOpenChange:S,sessionId:s})]})})})},Yd=({appointmentId:s,appointmentDetails:t})=>e.jsx(ci,{sessionId:s,sessionType:"appointment",children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50",children:e.jsx(Hd,{})})}),Wd=({sessionId:s})=>{const t=we(),{toast:a}=Z(),{appointments:r,fetchAppointment:n}=ii(),{getVideoSessionUrl:o,createVideoSession:i,isCreatingSession:c}=yd(),[u,m]=l.useState(null),[h,p]=l.useState(!0),[d,x]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const b=r==null?void 0:r.find(_=>_.video_meeting_id===s||_.id===s);if(b)m(b);else{const _=await n(s);m(_)}}catch(b){console.error("Error loading appointment:",b),a({title:"Session Not Found",description:"Could not load session details",variant:"destructive"})}finally{p(!1)}})()},[s,r,n,a]);const j=async()=>{if(!u)return;(o(u)||await i(u.id))&&x(!0)};if(h)return e.jsx("div",{className:"space-y-6",children:e.jsx(R,{children:e.jsx(T,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]})})})});if(!u)return e.jsx("div",{className:"space-y-6",children:e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Session Not Found"}),e.jsx(me,{children:"The requested session could not be found."})]}),e.jsx(T,{children:e.jsxs(N,{onClick:()=>t(-1),variant:"outline",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Go Back"]})})]})});if(d)return e.jsx(Yd,{appointmentId:u.id,appointmentDetails:{title:u.title,patient_id:u.patient_id,therapist_id:u.therapist_id,recording_consent:u.recording_consent||!1}});const g=new Date(u.start_time),v=new Date(u.end_time),f=u.video_enabled&&o(u);return e.jsx("div",{className:"space-y-6",children:e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[u.title,e.jsx(D,{variant:u.status==="confirmed"?"default":u.status==="scheduled"?"secondary":u.status==="completed"?"outline":"destructive",children:u.status})]}),e.jsxs(me,{children:["Session ID: ",s]})]}),e.jsxs(N,{onClick:()=>t(-1),variant:"outline",size:"sm",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Back"]})]})}),e.jsxs(T,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Date"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:xe(g,"PPP")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Time"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[xe(g,"p")," - ",xe(v,"p")]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Be,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Type"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:u.appointment_type||"Video Session"})]})]})]}),u.description&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:u.description})]}),u.video_enabled&&e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("h3",{className:"font-medium mb-4 flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"Video Session"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(N,{onClick:j,disabled:c,size:"lg",children:c?e.jsx(e.Fragment,{children:"Loading..."}):f?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Join Video Session"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Start Video Session"]})}),f&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Video session is ready to join"})]})]})]})]})})};function Qd({children:s,redirectTo:t="/auth",requireRole:a}){const{isAuthenticated:r,isInitialized:n,hasRole:o,loading:i}=V(),{toast:c}=Z(),u=we();return l.useEffect(()=>{if(!(!n||i)){if(!r){c({title:"Authentication Required",description:"Please log in to access this feature.",variant:"destructive"}),u(t);return}if(a&&!o(a)){c({title:"Access Denied",description:`You need ${a} privileges to access this feature.`,variant:"destructive"}),u("/");return}}},[r,n,i,a,o,t,u,c]),!n||i?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):!r||a&&!o(a)?null:e.jsx(e.Fragment,{children:s})}const mr=()=>{const{sessionId:s}=xt(),{user:t}=V();return s?e.jsx(Qd,{children:e.jsx(Wd,{sessionId:s})}):e.jsx("div",{children:"Session not found"})};function Kd(s){const[t,a]=l.useState(null),[r,n]=l.useState(!0),[o,i]=l.useState(null);return l.useEffect(()=>{(async()=>{if(console.log("🔍 Fetching session details for token:",s),!s){console.error("❌ Session token is missing"),i("Session token is missing."),n(!1);return}n(!0),i(null);try{console.log("📡 Querying instant_sessions table by token...");const{data:u,error:m}=await w.from("instant_sessions").select("id, session_name, session_token, therapist_id, is_active, recording_enabled, waiting_room_enabled, expires_at, max_participants").eq("session_token",s).eq("is_active",!0).single();if(console.log("📊 Query result:",{data:u,error:m}),m){if(console.error("❌ Session query error:",m),m.code==="PGRST116")i("Session not found or expired");else throw m;return}const h=new Date(u.expires_at),p=new Date;if(console.log("⏰ Session expires at:",h,"Current time:",p),h<p){console.error("❌ Session has expired"),i("Session has expired");return}console.log("✅ Session loaded successfully:",u),a(u)}catch(u){console.error("❌ Error fetching session details:",u),i("Failed to load session details")}finally{n(!1)}})()},[s]),{sessionDetails:t,isLoading:r,error:o}}const Jd=()=>{var p,d,x;const{user:s,isInitialized:t,isAuthenticated:a}=V(),{token:r}=xt(),n=we(),{toast:o}=Z(),{sessionDetails:i,isLoading:c,error:u}=Kd(r||""),[m,h]=l.useState(!1);return c||!t?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"flex items-center justify-center p-6",children:"Loading session details..."})})}):a?u?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6",children:e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:u})})})})}):i?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50",children:[e.jsx(Bt,{children:e.jsx("title",{children:"Join Session | Therapy Platform"})}),e.jsx("div",{className:"container mx-auto p-6",children:e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{className:"text-2xl font-bold",children:i.session_name}),e.jsxs(me,{children:["Join the session as ",((p=s==null?void 0:s.user_metadata)==null?void 0:p.fullName)||((d=s==null?void 0:s.user_metadata)==null?void 0:d.name)||((x=s==null?void 0:s.user_metadata)==null?void 0:x.email)||(s==null?void 0:s.email)||"User"]})]}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("span",{children:["Max Participants: ",i.max_participants]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("span",{children:["Date: ",xe(new Date,"MMMM d, yyyy")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("span",{children:["Expires: ",xe(new Date(i.expires_at),"h:mm a")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("span",{children:["Recording: ",i.recording_enabled?"Enabled":"Disabled"]})]}),e.jsxs(D,{variant:"secondary",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Instant Session"]}),e.jsx(N,{onClick:async()=>{var j,g,v,f;console.log("🎯 [InstantSessionJoin] Join Video Session clicked",{sessionDetails:i==null?void 0:i.id,user:s==null?void 0:s.id,userName:(j=s==null?void 0:s.user_metadata)==null?void 0:j.name}),h(!0);try{console.log("📝 [InstantSessionJoin] Creating participant record...");const{error:y}=await w.from("instant_session_participants").upsert({session_id:i.id,user_id:(s==null?void 0:s.id)||null,participant_name:((g=s==null?void 0:s.user_metadata)==null?void 0:g.fullName)||((v=s==null?void 0:s.user_metadata)==null?void 0:v.name)||((f=s==null?void 0:s.user_metadata)==null?void 0:f.email)||(s==null?void 0:s.email)||`User ${Date.now()}`,role:"participant",is_active:!0,joined_at:new Date().toISOString()},{onConflict:"session_id,user_id"});if(y){console.error("❌ [InstantSessionJoin] Error creating participant record:",y),o({title:"Error",description:"Failed to join session",variant:"destructive"});return}console.log("✅ [InstantSessionJoin] Participant record created successfully"),console.log("🚀 [InstantSessionJoin] Navigating to video conference:",`/video-conference/${i.id}`),n(`/video-conference/${i.id}`)}catch(y){console.error("Error joining session:",y),o({title:"Error",description:"Failed to join session",variant:"destructive"})}finally{h(!1)}},disabled:m,children:m?"Joining...":"Join Video Session"})]})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6",children:e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"Session details not found."})})})})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsxs(T,{className:"p-6 space-y-4",children:[e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"You must be signed in to join this session."})}),e.jsx(N,{onClick:()=>n("/login"),children:"Go to Login"})]})})})},oa=768;function ps(){const[s,t]=l.useState(void 0);return l.useEffect(()=>{const a=window.matchMedia(`(max-width: ${oa-1}px)`),r=()=>{t(window.innerWidth<oa)};return a.addEventListener("change",r),t(window.innerWidth<oa),()=>a.removeEventListener("change",r)},[]),!!s}function Kt(){const{toast:s}=Z(),[t,a]=l.useState({camera:"unknown",microphone:"unknown",bothGranted:!1,realCameraAccess:!1,realMicrophoneAccess:!1,isChecking:!1,hasRequestedBefore:!1,browserType:"unknown"}),[r,n]=l.useState({showInstructions:!1,instructionStep:0,maxSteps:3}),o=l.useCallback(()=>{const d=navigator.userAgent.toLowerCase();return d.includes("chrome")&&!d.includes("edge")?"chrome":d.includes("firefox")?"firefox":d.includes("safari")&&!d.includes("chrome")?"safari":d.includes("edge")?"edge":"unknown"},[]);l.useEffect(()=>{a(d=>({...d,browserType:o()}))},[o]);const i=l.useCallback(async(d=!1)=>{console.log("🔄 [UnifiedPermissionHandler] Starting permission check...",{forceCheck:d}),a(x=>({...x,isChecking:!0}));try{let x="prompt",j="prompt",g=!1,v=!1;if(navigator.permissions&&!d)try{const[y,b]=await Promise.all([navigator.permissions.query({name:"camera"}),navigator.permissions.query({name:"microphone"})]);if(x=y.state,j=b.state,console.log("📊 [UnifiedPermissionHandler] Permission API results:",{camera:x,microphone:j}),x==="granted"&&j==="granted")try{const _=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});g=!0,v=!0,_.getTracks().forEach(k=>k.stop()),console.log("✅ [UnifiedPermissionHandler] Confirmed device access")}catch(_){console.log("⚠️ [UnifiedPermissionHandler] Permission granted but access failed:",_.name),g=!1,v=!1}}catch{console.log('📊 [UnifiedPermissionHandler] Permission API not available, using default "prompt" state')}else if(d)try{const y=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});x="granted",j="granted",g=!0,v=!0,y.getTracks().forEach(b=>b.stop()),console.log("✅ [UnifiedPermissionHandler] getUserMedia test successful")}catch(y){console.log("🔍 [UnifiedPermissionHandler] getUserMedia failed:",y.name,y.message),y.name==="NotAllowedError"||y.name==="NotFoundError"?(x="denied",j="denied"):(x="prompt",j="prompt")}const f=x==="granted"&&j==="granted";a(y=>({...y,camera:x,microphone:j,bothGranted:f,realCameraAccess:g,realMicrophoneAccess:v,isChecking:!1})),console.log("🔍 [UnifiedPermissionHandler] Final permission state:",{camera:x,microphone:j,bothGranted:f,realCameraAccess:g,realMicrophoneAccess:v,forceCheck:d}),(x==="denied"||j==="denied")&&t.hasRequestedBefore&&!r.showInstructions&&n(y=>({...y,showInstructions:!0}))}catch(x){console.error("❌ [UnifiedPermissionHandler] Permission check completely failed:",x),a(j=>({...j,isChecking:!1,camera:"unknown",microphone:"unknown",bothGranted:!1,realCameraAccess:!1,realMicrophoneAccess:!1}))}},[t.hasRequestedBefore,r.showInstructions]),c=l.useCallback(async()=>{try{a(S=>({...S,hasRequestedBefore:!0,isChecking:!0})),console.log("🔒 [UnifiedPermissionHandler] Requesting permissions with device detection...");let d=[];try{d=await navigator.mediaDevices.enumerateDevices()}catch{console.log("⚠️ [UnifiedPermissionHandler] Device enumeration failed, proceeding with basic request")}const x=d.filter(S=>S.kind==="videoinput"),j=d.filter(S=>S.kind==="audioinput");console.log("📊 [UnifiedPermissionHandler] Available devices:",{cameras:x.length,microphones:j.length});let g=null,v="prompt",f="prompt",y=!1,b=!1;if(x.length>0&&j.length>0)try{console.log("🎯 [UnifiedPermissionHandler] Attempting both camera and microphone..."),g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),v="granted",f="granted",y=!0,b=!0,g.getTracks().forEach(S=>S.stop()),console.log("✅ [UnifiedPermissionHandler] Both permissions granted successfully")}catch(S){if(console.log("⚠️ [UnifiedPermissionHandler] Both permissions failed, trying individually:",S.name),S.name==="NotFoundError"){try{console.log("🎯 [UnifiedPermissionHandler] Trying camera only..."),(await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})).getTracks().forEach(B=>B.stop()),v="granted",y=!0,console.log("✅ [UnifiedPermissionHandler] Camera permission granted")}catch(E){console.log("❌ [UnifiedPermissionHandler] Camera failed:",E.name),v=E.name==="NotAllowedError"?"denied":"prompt"}try{console.log("🎯 [UnifiedPermissionHandler] Trying microphone only..."),(await navigator.mediaDevices.getUserMedia({video:!1,audio:!0})).getTracks().forEach(B=>B.stop()),f="granted",b=!0,console.log("✅ [UnifiedPermissionHandler] Microphone permission granted")}catch(E){console.log("❌ [UnifiedPermissionHandler] Microphone failed:",E.name),f=E.name==="NotAllowedError"?"denied":"prompt"}}else S.name==="NotAllowedError"&&(v="denied",f="denied")}else{if(x.length>0)try{console.log("🎯 [UnifiedPermissionHandler] Trying camera only (no microphones detected)..."),g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),g.getTracks().forEach(S=>S.stop()),v="granted",y=!0,console.log("✅ [UnifiedPermissionHandler] Camera permission granted")}catch(S){console.log("❌ [UnifiedPermissionHandler] Camera failed:",S.name),v=S.name==="NotAllowedError"?"denied":"prompt"}else console.log("⚠️ [UnifiedPermissionHandler] No cameras detected"),v="denied";if(j.length>0)try{console.log("🎯 [UnifiedPermissionHandler] Trying microphone only (no cameras detected)..."),g=await navigator.mediaDevices.getUserMedia({video:!1,audio:!0}),g.getTracks().forEach(S=>S.stop()),f="granted",b=!0,console.log("✅ [UnifiedPermissionHandler] Microphone permission granted")}catch(S){console.log("❌ [UnifiedPermissionHandler] Microphone failed:",S.name),f=S.name==="NotAllowedError"?"denied":"prompt"}else console.log("⚠️ [UnifiedPermissionHandler] No microphones detected"),f="denied"}const _=v==="granted"&&f==="granted",k=v==="granted"||f==="granted";if(a(S=>({...S,camera:v,microphone:f,bothGranted:_,realCameraAccess:y,realMicrophoneAccess:b,isChecking:!1})),_)s({title:"Permissions Granted",description:"Camera and microphone access enabled successfully"});else if(k){const S=[];v==="granted"&&S.push("camera"),f==="granted"&&S.push("microphone"),s({title:"Partial Permissions Granted",description:`${S.join(" and ")} access enabled. You can continue with limited functionality.`})}return n(S=>({...S,showInstructions:!1,instructionStep:0})),k}catch(d){console.error("❌ [UnifiedPermissionHandler] Permission request completely failed:",d),a(g=>({...g,camera:"denied",microphone:"denied",bothGranted:!1,realCameraAccess:!1,realMicrophoneAccess:!1,isChecking:!1})),n(g=>({...g,showInstructions:!0,instructionStep:1}));let x="Device access failed",j=u(t.browserType);switch(d.name){case"NotAllowedError":x="Camera and microphone access was denied";break;case"NotFoundError":case"DevicesNotFoundError":x="No camera or microphone found",j="Please ensure your devices are connected and try again";break;case"NotReadableError":x="Camera or microphone is already in use",j="Please close other applications using your camera/microphone";break;case"OverconstrainedError":x="Device constraints not supported",j="Your device may not support the required video/audio settings";break;default:x="Device access failed",j="Please check your browser settings and device connections"}return s({title:x,description:j,variant:"destructive"}),!1}},[t.browserType,s]),u=d=>{switch(d){case"chrome":return'Click the camera icon in the address bar, then select "Always allow" for this site';case"firefox":return'Click the shield icon in the address bar, then click "Allow" for camera and microphone';case"safari":return"Go to Safari > Settings > Websites > Camera/Microphone and allow access for this site";case"edge":return'Click the camera icon in the address bar, then select "Allow" for this site';default:return"Please check your browser settings to enable camera and microphone access"}},m=l.useCallback(()=>{n({showInstructions:!1,instructionStep:0,maxSteps:3})},[]),h=l.useCallback(()=>{n(d=>({...d,instructionStep:Math.min(d.instructionStep+1,d.maxSteps)}))},[]),p=l.useCallback(async()=>(m(),await c()),[c,m]);return l.useEffect(()=>{console.log("🚀 [UnifiedPermissionHandler] Initializing - running soft permission check"),i(!1)},[]),{permissionState:t,recoveryFlow:r,checkPermissions:i,requestPermissions:c,retryPermissions:p,resetRecoveryFlow:m,nextRecoveryStep:h,getBrowserSpecificInstructions:u}}function Xd(){const{toast:s}=Z(),[t,a]=l.useState({isRecovering:!1,retryCount:0,maxRetries:3,lastError:null,connectionType:"initial"}),[r,n]=l.useState({quality:"excellent",latency:0,jitter:0,packetLoss:0,bandwidth:0}),o=l.useCallback(async(x,j)=>{const{retryCount:g,maxRetries:v}=t;if(g>=v)return console.log("🛑 Max recovery attempts reached"),s({title:"Connection Failed",description:"Unable to restore connection after multiple attempts. Please refresh the page.",variant:"destructive",duration:1e4}),!1;a(y=>({...y,isRecovering:!0,retryCount:y.retryCount+1,connectionType:"recovery"}));const f=Math.pow(2,g)*1e3;console.log(`🔄 Recovery attempt ${g+1}/${v} in ${f}ms`),await new Promise(y=>setTimeout(y,f));try{return await j()?(console.log("✅ Recovery successful"),a(b=>({...b,isRecovering:!1,retryCount:0,lastError:null,connectionType:"reconnection"})),s({title:"Connection Restored",description:"Successfully reconnected to the session",duration:3e3}),!0):(console.log("❌ Recovery attempt failed"),!1)}catch(y){return console.error("Recovery attempt error:",y),a(b=>({...b,lastError:y instanceof Error?y:new Error("Unknown recovery error")})),!1}},[t,s]),i=l.useCallback(async()=>{try{const x=performance.now(),j=await fetch("/favicon.ico",{method:"HEAD",cache:"no-cache"}),v=performance.now()-x;let f="excellent";v>200?f="poor":v>100&&(f="good"),n(y=>({...y,quality:f,latency:Math.round(v)}))}catch(x){console.error("Network quality check failed:",x),n(j=>({...j,quality:"disconnected",latency:9999}))}},[]),c=l.useCallback(async()=>{try{if(await i(),!!!(window.RTCPeerConnection&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia))throw new Error("WebRTC not supported");return r.quality!=="disconnected"}catch(x){return console.error("Connection health check failed:",x),!1}},[r.quality,i]),u=l.useCallback(async x=>{console.log("🔑 Handling token expiry...");try{return await x()?(console.log("✅ Token refreshed successfully"),!0):!1}catch(j){return console.error("Token refresh failed:",j),!1}},[]),m=l.useCallback(async x=>(console.log("🌐 Handling network disconnection..."),await o("network",async()=>await c()?await x():!1)),[o,c]),h=l.useCallback(async x=>{console.log("🔒 Handling permission error...");try{return await x()}catch(j){return console.error("Permission recovery failed:",j),s({title:"Permission Required",description:"Please manually grant camera and microphone permissions in your browser settings",variant:"destructive",duration:1e4}),!1}},[s]),p=l.useCallback(()=>{a({isRecovering:!1,retryCount:0,maxRetries:3,lastError:null,connectionType:"initial"})},[]),d=l.useCallback(x=>{switch(x){case"NotAllowedError":return"Please allow camera and microphone access in your browser settings";case"NetworkError":return"Please check your internet connection and try again";case"TokenExpired":return"Session token has expired. Attempting to refresh...";case"ServerError":return"Server connection issue. Retrying automatically...";default:return"An unexpected error occurred. Attempting recovery..."}},[]);return{recoveryState:t,networkQuality:r,attemptRecovery:o,handleTokenExpiry:u,handleNetworkDisconnection:m,handlePermissionError:h,checkConnectionHealth:c,updateNetworkQuality:i,resetRecovery:p,getErrorGuidance:d}}const Zd=({children:s,className:t})=>{const a=ps();return e.jsx("div",{className:C("h-screen w-full overflow-hidden bg-gray-900","flex flex-col","p-0 m-0",t),children:e.jsx("div",{className:C("flex-1 relative",a?"flex flex-col":"grid grid-cols-1 lg:grid-cols-4 xl:grid-cols-5"),children:s})})};function em(s,t=!0){const a=l.useRef(null),r=l.useRef(null),n=l.useRef(null),o=50,i=l.useCallback(m=>{t&&(r.current=null,a.current={x:m.targetTouches[0].clientX,y:m.targetTouches[0].clientY})},[t]),c=l.useCallback(m=>{t&&(r.current={x:m.targetTouches[0].clientX,y:m.targetTouches[0].clientY})},[t]),u=l.useCallback(()=>{if(!t||!a.current||!r.current)return;const m=a.current.x-r.current.x,h=a.current.y-r.current.y,p=m>o,d=m<-o,x=h>o,j=h<-o;Math.abs(m)>Math.abs(h)?p&&s.onSwipeLeft?s.onSwipeLeft():d&&s.onSwipeRight&&s.onSwipeRight():x&&s.onSwipeUp?s.onSwipeUp():j&&s.onSwipeDown&&s.onSwipeDown()},[t,s,o]);return l.useEffect(()=>{const m=n.current;if(m)return m.addEventListener("touchstart",i,{passive:!0}),m.addEventListener("touchmove",c,{passive:!0}),m.addEventListener("touchend",u,{passive:!0}),()=>{m.removeEventListener("touchstart",i),m.removeEventListener("touchmove",c),m.removeEventListener("touchend",u)}},[i,c,u]),{elementRef:n}}function sm(){const[s,t]=l.useState(!0),[a,r]=l.useState(!1);l.useEffect(()=>{r("vibrate"in navigator);const i=localStorage.getItem("haptic-feedback-enabled");i!==null&&t(JSON.parse(i))},[]);const n=l.useCallback(i=>{if(!s||!a)return;const c={light:[10],medium:[25],heavy:[50],success:[10,50,10],warning:[25,100,25],error:[100,50,100]};try{navigator.vibrate(c[i])}catch(u){console.warn("Haptic feedback failed:",u)}},[s,a]),o=l.useCallback(()=>{const i=!s;t(i),localStorage.setItem("haptic-feedback-enabled",JSON.stringify(i)),i&&a&&n("light")},[s,a,n]);return{vibrate:n,isEnabled:s,isSupported:a,toggleHaptic:o}}function tm({onRefresh:s,threshold:t=80,resistance:a=2.5,enabled:r=!0}){const[n,o]=l.useState(0),[i,c]=l.useState(!1),[u,m]=l.useState(!1),h=l.useRef(0),p=l.useRef(0),d=l.useRef(null),x=l.useCallback(v=>{if(!r||i)return;const f=d.current;if(!f)return;const y=f.scrollTop<=0;m(y),y&&(h.current=v.touches[0].clientY)},[r,i]),j=l.useCallback(v=>{if(!r||i||!u)return;p.current=v.touches[0].clientY;const f=p.current-h.current;if(f>0){v.preventDefault();const y=Math.min(f/a,t*1.5);o(y)}},[r,i,u,a,t]),g=l.useCallback(async()=>{if(!(!r||i||!u)){if(n>=t){c(!0);try{await s()}catch(v){console.error("Refresh failed:",v)}finally{c(!1)}}o(0),m(!1)}},[r,i,u,n,t,s]);return l.useEffect(()=>{const v=d.current;if(v)return v.addEventListener("touchstart",x,{passive:!0}),v.addEventListener("touchmove",j,{passive:!1}),v.addEventListener("touchend",g,{passive:!0}),()=>{v.removeEventListener("touchstart",x),v.removeEventListener("touchmove",j),v.removeEventListener("touchend",g)}},[x,j,g]),{elementRef:d,pullDistance:n,isRefreshing:i,threshold:t}}function am(){const s=l.useCallback(a=>{if(!a)return{isValid:!1,hasActiveVideo:!1,hasActiveAudio:!1,videoTracks:0,audioTracks:0,issues:["No stream provided"]};const r=a.getVideoTracks(),n=a.getAudioTracks(),o=r.filter(h=>h.readyState==="live"&&h.enabled),i=n.filter(h=>h.readyState==="live"&&h.enabled),c=[];r.length===0&&n.length===0&&c.push("Stream has no tracks"),r.length>0&&o.length===0&&c.push("Video tracks exist but are not active"),n.length>0&&i.length===0&&c.push("Audio tracks exist but are not active");const u=o.length>0,m=i.length>0;return{isValid:u||m,hasActiveVideo:u,hasActiveAudio:m,videoTracks:r.length,audioTracks:n.length,issues:c}},[]),t=l.useCallback(a=>{if(!a)return{hasSource:!1,isPlaying:!1,hasValidDimensions:!1,issues:["No video element"]};const r=[],n=!!a.srcObject,o=!a.paused&&!a.ended&&a.readyState>2,i=a.videoWidth>0&&a.videoHeight>0;return n||r.push("No srcObject assigned"),o||r.push("Video not playing"),i||r.push("Invalid video dimensions"),{hasSource:n,isPlaying:o,hasValidDimensions:i,issues:r}},[]);return{validateStream:s,validateVideoElement:t}}const rm=({onClose:s,onRetry:t,permissionState:a})=>{const[r,n]=l.useState(0),o=[{icon:e.jsx(Xe,{className:"h-6 w-6"}),title:"Check Connection",description:"Ensure you have a stable internet connection",isComplete:!0},{icon:e.jsx(ne,{className:"h-6 w-6"}),title:"Camera Permission",description:"Allow camera access for video calls",isComplete:a.camera==="granted"},{icon:e.jsx(os,{className:"h-6 w-6"}),title:"Microphone Permission",description:"Allow microphone access for audio",isComplete:a.microphone==="granted"},{icon:e.jsx(hs,{className:"h-6 w-6"}),title:"Browser Settings",description:"Check if browser supports WebRTC",isComplete:typeof RTCPeerConnection<"u"}],i=a.camera==="denied"||a.microphone==="denied";return e.jsx("div",{className:"fixed inset-0 bg-background/95 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-card rounded-lg border shadow-lg max-w-md w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_a,{className:"h-5 w-5 text-primary"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Mobile Connection Help"})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(rs,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[i&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 dark:text-amber-200",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm font-medium",children:"Permission Required"})]}),e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300 mt-1",children:"Please allow camera and microphone access in your browser settings"})]}),e.jsx("div",{className:"space-y-3",children:o.map((c,u)=>e.jsxs("div",{className:C("flex items-center gap-3 p-3 rounded-lg border transition-colors",c.isComplete?"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800":"bg-muted/50 border-border"),children:[e.jsx("div",{className:C("p-2 rounded-full",c.isComplete?"bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400":"bg-muted text-muted-foreground"),children:c.isComplete?e.jsx(fe,{className:"h-4 w-4"}):c.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-medium",children:c.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c.description})]})]},u))}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg p-3",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800 dark:text-blue-200 mb-2",children:"Mobile Browser Tips"}),e.jsxs("ul",{className:"text-xs text-blue-700 dark:text-blue-300 space-y-1",children:[e.jsx("li",{children:"• Use Chrome, Safari, or Firefox for best compatibility"}),e.jsx("li",{children:"• Ensure you're using HTTPS (secure connection)"}),e.jsx("li",{children:"• Close other apps using camera/microphone"}),e.jsx("li",{children:"• Try refreshing the page if issues persist"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsxs(N,{onClick:t,className:"flex-1",children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(N,{variant:"outline",onClick:s,children:"Close"})]})]})]})})},nm=({localVideoRef:s,remoteVideoRef:t,remoteStreams:a=[],isVideoEnabled:r,isAudioEnabled:n,isScreenSharing:o,isRecording:i,connectionQuality:c,isConnected:u,sessionStatus:m,participantName:h,sessionDuration:p,onToggleVideo:d,onToggleAudio:x,onToggleScreenShare:j,onToggleRecording:g,onToggleChat:v,onJoinSession:f,onLeaveSession:y,sessionType:b,sessionId:_,isTherapist:k,showShareButton:S=!1})=>{const[E,B]=l.useState(!1),[M,q]=l.useState(!1),{vibrate:F}=sm(),{permissionState:P}=Kt(),{deviceState:L}=pi(),{validateStream:A,validateVideoElement:Q}=am();l.useEffect(()=>{if(t.current&&a.length>0){const re=a[0];t.current.srcObject!==re&&(console.log("📱 [MobileSessionInterface] Assigning stream to video element:",re.id),t.current.srcObject=re,t.current.play().catch(ke=>{console.warn("⚠️ [MobileSessionInterface] Video autoplay blocked:",ke),t.current.muted=!0,t.current.play().catch(je=>console.error("❌ [MobileSessionInterface] Failed to play even when muted:",je))}))}else t.current&&a.length===0&&t.current.srcObject&&(console.log("📱 [MobileSessionInterface] Clearing video element - no streams"),t.current.srcObject=null)},[a,t]);const[$,Y]=l.useState(!1),[U,G]=l.useState(0),ee=3,K=async()=>{if(!$){Y(!0),G(re=>re+1);try{await f()}finally{Y(!1)}}},ie=c==="disconnected"||m==="ended",pe=P.camera==="denied"||P.microphone==="denied",W=!L.availability.hasCameras&&!L.availability.hasMicrophones,[ae,Te]=se.useState(null);se.useCallback(A,[]),se.useCallback(Q,[]),se.useRef(),se.useEffect(()=>{if(m==="connected"){const re=setInterval(()=>{var ue,oe;const ke=(ue=s.current)==null?void 0:ue.srcObject,je=(oe=t.current)==null?void 0:oe.srcObject;Te({isValid:!!(ke||je),hasActiveVideo:!0,hasActiveAudio:!0,localElementValid:!!ke,remoteElementValid:!!je})},3e4);return()=>clearInterval(re)}},[m]);const{elementRef:Ye}=em({onSwipeLeft:()=>{F("light"),d()},onSwipeRight:()=>{F("light"),x()},onSwipeUp:()=>{F("medium"),v()}},m==="connected"),{elementRef:ze,pullDistance:ts,isRefreshing:ys}=tm({onRefresh:async()=>{F("success");try{await f()}catch(re){console.error("Failed to reconnect:",re)}},enabled:c==="poor"||c==="disconnected"});l.useEffect(()=>{if(ie||pe||W){const re=setTimeout(()=>{q(!0)},5e3);return()=>clearTimeout(re)}},[ie,pe,W]);const he=async()=>{if(q(!1),$){console.log("🔄 [Mobile] Recovery already in progress");return}try{await K()}catch(re){console.error("❌ [Mobile] Manual retry failed:",re),q(!0)}},cs=re=>{const ke=Math.floor(re/60),je=re%60;return`${ke.toString().padStart(2,"0")}:${je.toString().padStart(2,"0")}`},ks=()=>{switch(m){case"waiting":return e.jsx(D,{variant:"outline",className:"bg-yellow-50 text-yellow-700 border-yellow-200",children:"Waiting for participant"});case"connecting":return e.jsx(D,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200 animate-pulse",children:$?`Reconnecting (${U}/${ee})`:"Connecting..."});case"connected":const re=(ae==null?void 0:ae.isValid)&&((ae==null?void 0:ae.localElementValid)||(ae==null?void 0:ae.remoteElementValid));let ke=`Connected • ${cs(p)}`,je="bg-green-500";return re||(ke=`Connected (No Media) • ${cs(p)}`,je="bg-yellow-500"),e.jsx(D,{className:je,children:ke});case"reconnecting":return e.jsx(D,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200 animate-pulse",children:$?`Recovering (${U}/${ee})`:"Reconnecting..."});case"ended":return e.jsx(D,{variant:"destructive",className:"bg-red-50 text-red-700 border-red-200",children:"Session Ended"})}},We=(re,ke="medium")=>{F(ke),re()};return m==="waiting"?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex flex-col",children:[e.jsxs("div",{className:"bg-white shadow-sm p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Therapy Session"}),ks()]}),h&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["With ",h]})]}),e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6",children:e.jsx(de,{className:"h-12 w-12 text-blue-600"})}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Ready to Join"}),e.jsx("p",{className:"text-gray-600 mb-8 max-w-sm",children:"Tap the button below to join your therapy session. We'll connect you as soon as both participants are ready."}),e.jsxs(N,{size:"lg",onClick:()=>We(f,"heavy"),className:"h-14 px-8 text-lg bg-green-600 hover:bg-green-700",children:[e.jsx(ne,{className:"h-5 w-5 mr-2"}),"Join Session"]})]})]}):e.jsxs("div",{ref:re=>{Ye&&(Ye.current=re),ze&&(ze.current=re)},className:"min-h-screen bg-black flex flex-col relative overflow-hidden",style:{transform:ts>0?`translateY(${Math.min(ts,100)}px)`:void 0,transition:ys?"transform 0.3s ease-out":void 0},children:[ts>0&&e.jsx("div",{className:"absolute top-0 left-0 right-0 z-50 flex justify-center pt-4",children:e.jsx("div",{className:C("bg-white/90 backdrop-blur-sm rounded-full px-4 py-2 text-sm font-medium",ts>60?"text-green-600":"text-gray-600"),children:ys?"Reconnecting...":ts>60?"Release to reconnect":"Pull to reconnect"})}),e.jsxs("div",{className:"bg-gray-900 p-4 flex items-center justify-between text-white relative z-40",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[c==="excellent"||c==="good"?e.jsx(Xe,{className:"h-4 w-4 text-green-400"}):e.jsx(Cs,{className:"h-4 w-4 text-red-400"}),ks()]}),e.jsxs("div",{className:"flex items-center gap-2",children:[h&&e.jsx("span",{className:"text-sm",children:h}),S&&_&&e.jsx(N,{size:"sm",variant:"ghost",onClick:()=>B(!0),className:"h-8 w-8 p-0 text-white hover:bg-gray-800",children:e.jsx(ft,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1 relative bg-gray-900",children:[e.jsx(hi,{connectionState:m==="connecting"?"CONNECTING":m==="connected"?"CONNECTED":m==="reconnecting"?"DISCONNECTED":m==="ended"?"FAILED":"IDLE",isInSession:u,onRetry:he,deviceStatus:{camera:L.availability.hasCameras?P.camera==="granted"?"granted":P.camera==="denied"?"denied":"requesting":"unavailable",microphone:L.availability.hasMicrophones?P.microphone==="granted"?"granted":P.microphone==="denied"?"denied":"requesting":"unavailable",step:m==="connecting"?"Establishing video connection...":void 0,progress:m==="connecting"?75:void 0}}),(pe||W)&&e.jsxs("div",{className:"absolute top-4 left-4 right-4 z-40 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-amber-800 dark:text-amber-200",children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsx("p",{className:"text-sm font-medium",children:W?"No Camera/Microphone Found":"Camera/Microphone Access Needed"})]}),e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300 mt-1",children:W?"Please connect a camera or microphone to join the session":"Please allow access to your camera and microphone"}),e.jsx(N,{size:"sm",variant:"outline",onClick:()=>q(!0),className:"mt-2 text-xs",children:W?"Troubleshoot":"Fix Permissions"})]}),m==="connected"&&e.jsx("div",{className:"absolute bottom-20 left-4 right-4 text-white/60 text-center text-xs",children:e.jsx("p",{children:"Swipe left: Camera • Swipe right: Mic • Swipe up: Chat"})}),e.jsxs("div",{className:"h-full flex flex-col p-2 gap-2 overflow-y-auto",children:[m==="connected"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:C("flex-1 gap-2",a.length===0?"flex items-center justify-center":a.length===1?"grid grid-cols-1":"grid grid-cols-2"),children:a.length>0?a.map((re,ke)=>e.jsxs("div",{className:"relative bg-gray-800 rounded-lg overflow-hidden min-h-[200px]",children:[e.jsx("video",{ref:je=>{je&&je.srcObject!==re&&(je.srcObject=re,je.play().catch(ue=>{console.warn("⚠️ [Mobile] Video autoplay blocked:",ue),je.muted=!0,je.play().catch(oe=>console.error("❌ [Mobile] Failed to play even when muted:",oe))}))},autoPlay:!0,playsInline:!0,muted:!1,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/70 px-2 py-1 rounded backdrop-blur-sm",children:["Participant ",ke+1]})]},re.id)):e.jsxs("div",{className:"flex flex-col items-center justify-center text-white/60",children:[e.jsx(de,{className:"h-12 w-12 mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Waiting for participants..."})]})}),e.jsxs("div",{className:"h-32 bg-gray-900 rounded-lg overflow-hidden relative flex-shrink-0",children:[e.jsx("video",{ref:s,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-white bg-black/70 px-2 py-1 rounded backdrop-blur-sm",children:["You ",k?"(Therapist)":"(Patient)"]}),!r&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-800",children:e.jsx(Ss,{className:"h-8 w-8 text-white/50"})})]})]}):e.jsxs("div",{className:"flex-1 flex items-center justify-center",children:[e.jsx("video",{ref:t,style:{display:"none"}}),e.jsx("div",{style:{display:"none"},children:e.jsx("video",{ref:s})})]}),m!=="connected"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx("div",{className:"animate-pulse w-32 h-32 bg-gray-700 rounded-full flex items-center justify-center mb-4 mx-auto",children:e.jsx(ne,{className:"h-16 w-16 text-gray-400"})}),e.jsx("p",{className:"text-lg",children:"Connecting..."})]})}),m==="connected"&&a.length===0&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx(de,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"Waiting for participants..."})]})})]})]}),e.jsxs("div",{className:"bg-gray-900 p-6 relative z-40",children:[e.jsxs("div",{className:"flex items-center justify-center gap-6",children:[e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(N,{size:"lg",variant:n?"secondary":"destructive",className:C("h-16 w-16 rounded-full transition-all duration-200",n?"bg-gray-700 hover:bg-gray-600 shadow-lg":"bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/25"),onClick:()=>We(x),children:n?e.jsx(os,{className:"h-6 w-6"}):e.jsx(gt,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs text-white/80 font-medium",children:n?"Mute":"Unmute"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(N,{size:"lg",variant:"destructive",className:"h-16 w-16 rounded-full bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/25 transition-all duration-200",onClick:()=>We(y,"heavy"),children:e.jsx(wc,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs text-white/80 font-medium",children:"End Call"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(N,{size:"lg",variant:r?"secondary":"destructive",className:C("h-16 w-16 rounded-full transition-all duration-200",r?"bg-gray-700 hover:bg-gray-600 shadow-lg":"bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/25"),onClick:()=>We(d),children:r?e.jsx(ne,{className:"h-6 w-6"}):e.jsx(Ss,{className:"h-6 w-6"})}),e.jsx("span",{className:"text-xs text-white/80 font-medium",children:r?"Camera Off":"Camera On"})]})]}),e.jsxs("div",{className:"text-center mt-4 space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-400",children:m==="connected"?ae!=null&&ae.isValid?`🟢 Connected • Quality: ${c}`:`🟡 Connected (Media Issues) • Quality: ${c}`:m==="connecting"?"🔵 Connecting...":m==="reconnecting"?"🟡 Reconnecting...":"⚫ Disconnected"}),m==="connected"&&e.jsxs("div",{className:"flex justify-center items-center gap-4 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:C("w-2 h-2 rounded-full",r&&(ae!=null&&ae.hasActiveVideo)?"bg-green-500 animate-pulse":r?"bg-yellow-500":"bg-gray-500")}),e.jsxs("span",{children:["Video ",r?"On":"Off"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:C("w-2 h-2 rounded-full",n&&(ae!=null&&ae.hasActiveAudio)?"bg-green-500 animate-pulse":n?"bg-yellow-500":"bg-gray-500")}),e.jsxs("span",{children:["Audio ",n?"On":"Off"]})]})]}),L.availability&&!L.availability.loading&&e.jsxs("div",{className:"flex justify-center items-center gap-4 text-xs text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:C("w-1.5 h-1.5 rounded-full",L.availability.hasCameras?"bg-blue-400":"bg-gray-400")}),e.jsxs("span",{children:[L.availability.cameraCount," Camera(s)"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:C("w-1.5 h-1.5 rounded-full",L.availability.hasMicrophones?"bg-blue-400":"bg-gray-400")}),e.jsxs("span",{children:[L.availability.microphoneCount," Mic(s)"]})]})]})]})]}),S&&_&&e.jsx($a,{open:E,onOpenChange:B,sessionId:_}),M&&e.jsx(rm,{onClose:()=>q(!1),onRetry:he,permissionState:P})]})};function im(){const{toast:s}=Z(),{permissionState:t,checkPermissions:a,requestPermissions:r}=Kt(),[n,o]=l.useState({camera:!1,microphone:!1,speakers:!1,overall:!1}),[i,c]=l.useState(!1),u=l.useCallback(async()=>{try{const h=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),p=h.getVideoTracks(),d=h.getAudioTracks(),x={camera:p.length>0&&p[0].readyState==="live",microphone:d.length>0&&d[0].readyState==="live",speakers:!0,overall:!1};return x.overall=x.camera&&x.microphone&&x.speakers,h.getTracks().forEach(j=>j.stop()),x}catch(h){return console.error("Device test failed:",h),{camera:!1,microphone:!1,speakers:!1,overall:!1}}},[]),m=l.useCallback(async()=>{c(!0);try{if(await a(),!t.bothGranted&&!await r())return c(!1),!1;const h=await u();if(o(h),h.overall)s({title:"Device Test Successful",description:"All devices are working properly"});else{const p=[];h.camera||p.push("camera"),h.microphone||p.push("microphone"),s({title:"Device Test Issues",description:`Problems detected with: ${p.join(", ")}`,variant:"destructive"})}return h.overall}catch(h){return console.error("Complete device test failed:",h),s({title:"Device Test Failed",description:"Unable to complete device testing",variant:"destructive"}),!1}finally{c(!1)}},[a,r,t.bothGranted,u,s]);return{testResult:n,isTestingDevices:i,permissionState:t,runCompleteDeviceTest:m,requestPermissions:r,checkPermissions:a}}const om=({permissionState:s,recoveryFlow:t,onRetry:a,onNextStep:r,onDismiss:n,getBrowserInstructions:o})=>{const i=()=>{switch(s.browserType){case"chrome":return"🌐";case"firefox":return"🦊";case"safari":return"🧭";case"edge":return"🔷";default:return"🌍"}},c=()=>{switch(t.instructionStep){case 1:return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:i()}),e.jsx("h3",{className:"font-semibold",children:"Browser Permissions"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o(s.browserType)}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs font-medium mb-2",children:"Quick Fix:"}),e.jsxs("ol",{className:"text-xs space-y-1 list-decimal list-inside",children:[e.jsx("li",{children:"Look for a camera/microphone icon in your browser's address bar"}),e.jsx("li",{children:'Click it and select "Always Allow" or "Allow"'}),e.jsx("li",{children:"Refresh the page if needed"})]})]})]});case 2:return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ds,{className:"h-5 w-5"}),e.jsx("h3",{className:"font-semibold",children:"System Settings"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Check your operating system's privacy settings for camera and microphone access."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-muted/50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm mb-2",children:"Windows"}),e.jsx("p",{className:"text-xs",children:"Settings → Privacy → Camera/Microphone"})]}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm mb-2",children:"macOS"}),e.jsx("p",{className:"text-xs",children:"System Preferences → Security & Privacy → Camera/Microphone"})]})]})]});case 3:return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_a,{className:"h-5 w-5"}),e.jsx("h3",{className:"font-semibold",children:"Device Check"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ensure your camera and microphone are properly connected and not in use by other applications."}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"Camera is connected and working"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"Microphone is connected and working"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(fe,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{children:"No other apps are using your devices"})]})]})]});default:return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-5 w-5 text-yellow-500"}),e.jsx("h3",{className:"font-semibold",children:"Permission Required"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We need access to your camera and microphone for video conferencing."}),e.jsxs(N,{onClick:a,className:"w-full",children:[e.jsx(Ms,{className:"h-4 w-4 mr-2"}),"Grant Permissions"]})]})}};return t.showInstructions?e.jsxs(R,{className:"border-yellow-200 bg-yellow-50/50",children:[e.jsx(I,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"text-base flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4 text-yellow-600"}),"Permission Setup Guide"]}),e.jsxs(D,{variant:"outline",className:"text-xs",children:["Step ",t.instructionStep," of ",t.maxSteps]})]})}),e.jsxs(T,{className:"space-y-4",children:[c(),e.jsxs("div",{className:"flex gap-2",children:[t.instructionStep>0&&t.instructionStep<t.maxSteps&&e.jsx(N,{variant:"outline",size:"sm",onClick:r,className:"flex-1",children:"Next Step"}),e.jsxs(N,{size:"sm",onClick:a,className:"flex-1",children:[e.jsx(ns,{className:"h-3 w-3 mr-2"}),"Try Again"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:n,children:"Dismiss"})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(N,{variant:"link",size:"sm",className:"h-auto p-0 text-xs text-muted-foreground",onClick:()=>window.open("https://support.google.com/chrome/answer/2693767","_blank"),children:[e.jsx(kn,{className:"h-3 w-3 mr-1"}),"Need more help? Visit browser support docs"]})})]})]}):null},cm=({error:s,onRetry:t,onOpenSettings:a,onDismiss:r})=>{const n=()=>{switch(s.device){case"camera":return e.jsx(Qs,{className:"h-4 w-4"});case"microphone":return e.jsx(os,{className:"h-4 w-4"});case"speaker":return e.jsx(ds,{className:"h-4 w-4"});default:return e.jsx(_e,{className:"h-4 w-4"})}},o=()=>{switch(s.type){case"permission-denied":case"system-blocked":return"destructive";default:return"warning"}},i=()=>{switch(s.type){case"permission-denied":return c();case"device-not-found":return u();case"device-in-use":return m();case"browser-unsupported":return h();case"system-blocked":return p();default:return d()}},c=()=>{const j={chrome:["Click the camera icon in the address bar",'Select "Always allow on this site"',"Refresh the page"],firefox:["Click the shield icon in the address bar",'Click "Allow" for camera and microphone',"Reload the page if needed"],safari:["Go to Safari → Preferences → Websites","Find Camera and Microphone settings",'Set this site to "Allow"'],edge:["Click the camera icon in the address bar",'Choose "Allow" for this site',"Refresh if necessary"],unknown:["Look for a camera/microphone icon in your browser","Click it and allow permissions","Refresh the page"]};return j[s.browserType]||j.unknown},u=()=>["Check that your camera/microphone is connected","Try unplugging and reconnecting the device","Test the device in another application","Check device drivers and updates"],m=()=>["Close other video/audio applications","End video calls in other browser tabs","Restart your browser","Check task manager for apps using your devices"],h=()=>["Update your browser to the latest version","Enable WebRTC in browser settings","Try using a different supported browser","Clear browser cache and cookies"],p=()=>{const j=navigator.platform.toLowerCase().includes("win"),g=navigator.platform.toLowerCase().includes("mac");return j?["Open Windows Settings → Privacy & Security","Go to Camera/Microphone settings",'Enable "Allow apps to access camera/microphone"',"Restart your browser"]:g?["Open System Preferences → Security & Privacy","Go to Privacy tab → Camera/Microphone","Check the box next to your browser","Restart your browser"]:["Check your operating system privacy settings","Enable camera/microphone access for browsers","Restart your browser","Contact system administrator if needed"]},d=()=>["Refresh the page and try again","Check your internet connection","Restart your browser","Try using an incognito/private window"],x=()=>{switch(s.browserType){case"chrome":return"https://support.google.com/chrome/answer/2693767";case"firefox":return"https://support.mozilla.org/en-US/kb/how-manage-your-camera-and-microphone-permissions";case"safari":return"https://support.apple.com/guide/safari/websites-ibrwe2159f50/mac";case"edge":return"https://support.microsoft.com/en-us/microsoft-edge/camera-and-microphone-permissions-in-microsoft-edge-87b1fa41-5755-2b04-e4b8-cb53893c5b7a";default:return"https://support.google.com/meet/answer/7380413"}};return e.jsx(ye,{variant:o(),className:"mb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[n(),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(Jn,{className:"flex items-center gap-2 mb-2",children:[s.message,e.jsxs(D,{variant:"outline",className:"text-xs",children:[s.device," issue"]})]}),e.jsxs(be,{className:"space-y-3",children:[s.details&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.details}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-sm mb-2",children:"Quick Fix Steps:"}),e.jsx("ol",{className:"text-sm space-y-1 list-decimal list-inside",children:i().map((j,g)=>e.jsx("li",{children:j},g))})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(N,{size:"sm",onClick:t,className:"flex-1 min-w-fit",children:[e.jsx(ns,{className:"h-3 w-3 mr-2"}),"Try Again"]}),e.jsxs(N,{size:"sm",variant:"outline",onClick:a,children:[e.jsx(hs,{className:"h-3 w-3 mr-2"}),"Settings"]}),e.jsxs(N,{size:"sm",variant:"ghost",onClick:()=>window.open(x(),"_blank"),children:[e.jsx(kn,{className:"h-3 w-3 mr-2"}),"Help"]})]}),e.jsx(N,{variant:"link",size:"sm",onClick:r,className:"h-auto p-0 text-xs",children:"Dismiss this message"})]})]})]})})};function lm(s){const[t,a]=l.useState([]),[r,n]=l.useState([]),[o,i]=l.useState([]),[c,u]=l.useState(!1),[m,h]=l.useState(""),p=l.useCallback(async()=>{u(!0),h("");try{const d=await navigator.mediaDevices.enumerateDevices(),x=d.filter(v=>v.kind==="videoinput").map(v=>({deviceId:v.deviceId,label:v.label||(s?`Camera ${v.deviceId.slice(0,5)}`:"Camera"),kind:v.kind,groupId:v.groupId})),j=d.filter(v=>v.kind==="audioinput").map(v=>({deviceId:v.deviceId,label:v.label||(s?`Microphone ${v.deviceId.slice(0,5)}`:"Microphone"),kind:v.kind,groupId:v.groupId})),g=d.filter(v=>v.kind==="audiooutput").map(v=>({deviceId:v.deviceId,label:v.label||(s?`Speaker ${v.deviceId.slice(0,5)}`:"Speaker"),kind:v.kind,groupId:v.groupId}));a(x),n(j),i(g),console.log("📱 [useMediaDevices] Devices enumerated:",{cameras:x.length,microphones:j.length,speakers:g.length,hasPermissions:s})}catch(d){console.error("❌ [useMediaDevices] Error enumerating devices:",d),h("Failed to enumerate media devices")}finally{u(!1)}},[s]);return l.useEffect(()=>{p();const d=()=>{p()};return navigator.mediaDevices.addEventListener("devicechange",d),()=>{navigator.mediaDevices.removeEventListener("devicechange",d)}},[p]),{cameras:t,microphones:r,speakers:o,isLoading:c,error:m,enumerateDevices:p}}const dm=({permissionsGranted:s,onDeviceTest:t,onRequestPermissions:a,selectedDevices:r,onDeviceChange:n})=>{const{cameras:o,microphones:i,speakers:c,isLoading:u,error:m,enumerateDevices:h}=lm(s),[p,d]=l.useState(null),[x,j]=l.useState({}),[g,v]=l.useState(null);l.useEffect(()=>{s&&h()},[s,h]);const f=async(k,S)=>{if(!s){await a();return}d(S);try{const E=await t(k);if(j(B=>({...B,[S]:E})),k==="camera"&&E)try{const B=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:S}},audio:!1});v(B),setTimeout(()=>{B.getTracks().forEach(M=>M.stop()),v(null)},5e3)}catch(B){console.warn("Could not start camera preview:",B)}}catch(E){console.error("Device test failed:",E),j(B=>({...B,[S]:!1}))}finally{d(null)}},y=k=>p===k?e.jsx(ns,{className:"h-4 w-4 animate-spin text-blue-500"}):x[k]===!0?e.jsx(fe,{className:"h-4 w-4 text-green-500"}):x[k]===!1?e.jsx(Ns,{className:"h-4 w-4 text-red-500"}):e.jsx(_n,{className:"h-4 w-4 text-muted-foreground"}),b=({title:k,devices:S,deviceType:E,selectedDevice:B,icon:M})=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx("h3",{className:"font-medium text-sm",children:k}),e.jsxs(D,{variant:"outline",className:"text-xs",children:[S.length," found"]})]}),s?S.length===0?e.jsxs(ye,{children:[e.jsx(Ns,{className:"h-4 w-4"}),e.jsxs(be,{className:"text-sm",children:["No ",E," devices found. Please connect a device and refresh."]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Ie,{value:B||"",onValueChange:q=>n(E,q),disabled:!s,children:[e.jsx(Ee,{className:"w-full",children:e.jsx(Me,{placeholder:`Select ${E}`})}),e.jsx(De,{children:S.map(q=>e.jsx(H,{value:q.deviceId,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:q.label}),x[q.deviceId]!==void 0&&y(q.deviceId)]})},q.deviceId))})]}),B&&e.jsxs(N,{size:"sm",variant:"outline",onClick:()=>f(E,B),disabled:p===B,className:"w-full",children:[y(B),e.jsx("span",{className:"ml-2",children:p===B?"Testing...":x[B]===!0?"Test Passed":x[B]===!1?"Test Failed - Retry":`Test ${k}`})]})]}):e.jsxs(ye,{children:[e.jsx(_e,{className:"h-4 w-4"}),e.jsxs(be,{className:"text-sm",children:["Permissions required to detect and test devices.",e.jsx(N,{size:"sm",variant:"link",className:"h-auto p-0 ml-2",onClick:a,children:"Grant permissions"})]})]})]}),_=()=>{g&&(g.getTracks().forEach(k=>k.stop()),v(null))};return e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5"}),"Device Manager",u&&e.jsx(ns,{className:"h-4 w-4 animate-spin"})]})}),e.jsxs(T,{className:"space-y-6",children:[m&&e.jsxs(ye,{variant:"destructive",children:[e.jsx(Ns,{className:"h-4 w-4"}),e.jsx(be,{children:m})]}),e.jsx(b,{title:"Camera",devices:o,deviceType:"camera",selectedDevice:r.camera,icon:Qs}),e.jsx(b,{title:"Microphone",devices:i,deviceType:"microphone",selectedDevice:r.microphone,icon:os}),e.jsx(b,{title:"Speakers",devices:c,deviceType:"speaker",selectedDevice:r.speaker,icon:dt}),g&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Camera Preview"}),e.jsxs(N,{size:"sm",variant:"outline",onClick:_,children:[e.jsx(Nc,{className:"h-3 w-3 mr-2"}),"Stop"]})]}),e.jsx("div",{className:"relative bg-black rounded-lg overflow-hidden aspect-video",children:e.jsx("video",{autoPlay:!0,muted:!0,playsInline:!0,ref:k=>{k&&g&&(k.srcObject=g)},className:"w-full h-full object-cover"})})]}),s&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(N,{size:"sm",variant:"outline",onClick:h,disabled:u,className:"w-full",children:[e.jsx(ns,{className:"h-4 w-4 mr-2"}),"Refresh Devices"]})})]})]})};function mm(){const[s,t]=l.useState(null),[a,r]=l.useState([]),n=()=>{const d=navigator.userAgent.toLowerCase();return d.includes("chrome")&&!d.includes("edge")?"chrome":d.includes("firefox")?"firefox":d.includes("safari")&&!d.includes("chrome")?"safari":d.includes("edge")?"edge":"unknown"},o=l.useCallback((d,x)=>{var v,f;if(!d)return"unknown-error";const j=((v=d.name)==null?void 0:v.toLowerCase())||"",g=((f=d.message)==null?void 0:f.toLowerCase())||"";return j.includes("notallowed")||g.includes("permission denied")?"permission-denied":j.includes("notfound")||g.includes("device not found")?"device-not-found":j.includes("notreadable")||g.includes("in use")||g.includes("busy")?"device-in-use":g.includes("not supported")||g.includes("unsupported")?"browser-unsupported":g.includes("network")||g.includes("connection")?"network-error":g.includes("system")||g.includes("policy")?"system-blocked":"unknown-error"},[]),i=l.useCallback((d,x)=>{const j=o(d,x),g=n(),v={"permission-denied":`${x==="all"?"Camera and microphone":x} access was denied`,"device-not-found":`No ${x} device found`,"device-in-use":`${x==="all"?"Devices are":x+" is"} currently in use`,"browser-unsupported":"Your browser doesn't support this feature","system-blocked":"System settings are blocking device access","network-error":"Network connection issue detected","unknown-error":`An unexpected error occurred with your ${x}`},f={"permission-denied":'Click "Allow" when prompted or check your browser settings',"device-not-found":"Please connect your device and try again","device-in-use":"Close other applications that might be using this device","browser-unsupported":"Try updating your browser or using a different one","system-blocked":"Check your operating system privacy settings","network-error":"Please check your internet connection","unknown-error":"Please try again or contact support if the issue persists"};return{type:j,device:x,message:v[j],details:f[j],browserType:g}},[o]),c=l.useCallback((d,x)=>{const j=i(d,x);t(j),r(g=>[j,...g.slice(0,9)]),["permission-denied","system-blocked"].includes(j.type)&&ls({title:j.message,description:j.details,variant:"destructive"}),console.error("Device error:",{original:d,classified:j})},[i]),u=l.useCallback(()=>{t(null)},[]),m=l.useCallback(async d=>{if(s)try{await d(),u(),ls({title:"Success!",description:"The issue has been resolved",variant:"default"})}catch(x){c(x,s.device)}},[s,u,c]),h=l.useCallback(()=>{const d=navigator.platform.toLowerCase().includes("win"),x=navigator.platform.toLowerCase().includes("mac");let j="";if(d)j="ms-settings:privacy-webcam";else if(x){ls({title:"Open System Preferences",description:"Go to System Preferences → Security & Privacy → Privacy → Camera/Microphone",variant:"default"});return}j?window.open(j,"_blank"):ls({title:"Manual Setup Required",description:"Please check your system privacy settings for camera and microphone access",variant:"default"})},[]),p=l.useCallback(d=>a.filter(x=>x.device===d).slice(0,3),[a]);return{currentError:s,errorHistory:a,handleError:c,clearError:u,retryLastAction:m,openSystemSettings:h,getSimilarErrors:p}}const um=({appointmentId:s,onComplete:t})=>{const{testResult:a,isTestingDevices:r,runCompleteDeviceTest:n}=im(),{permissionState:o,recoveryFlow:i,requestPermissions:c,retryPermissions:u,resetRecoveryFlow:m,nextRecoveryStep:h,getBrowserSpecificInstructions:p}=Kt(),{currentError:d,handleError:x,clearError:j,retryLastAction:g,openSystemSettings:v}=mm(),[f,y]=l.useState(!1),[b,_]=l.useState({camera:null,microphone:null,speaker:null}),k=a.overall&&f&&o.bothGranted,S=async()=>{try{const P=await n();y(!0),P||x(new Error("Device test failed"),"all")}catch(P){x(P,"all")}},E=async P=>{try{return await new Promise(L=>setTimeout(L,1e3)),!0}catch(L){return x(L,P),!1}},B=(P,L)=>{_(A=>({...A,[P]:L}))},M=async()=>{try{await c()&&(m(),j())}catch(P){x(P,"all")}},q=({label:P,status:L,icon:A,showPermissionButton:Q=!1})=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(A,{className:"h-5 w-5"}),e.jsx("span",{children:P})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[L===null?e.jsx(D,{variant:"secondary",children:"Not Tested"}):e.jsx(D,{variant:L?"default":"destructive",children:L?e.jsx(Is,{className:"h-3 w-3"}):e.jsx(rs,{className:"h-3 w-3"})}),Q&&!o.bothGranted&&e.jsxs(N,{size:"sm",variant:"outline",onClick:M,children:[e.jsx(Ms,{className:"h-3 w-3 mr-1"}),"Allow"]})]})]}),F=()=>o.bothGranted?o.bothGranted&&!f?e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-blue-800",children:"Permissions granted! Now test your devices to ensure they're working properly."})}):!a.overall&&f?e.jsxs("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(rs,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-800",children:"Device Issues Detected"})]}),e.jsx("p",{className:"text-sm text-red-700 mb-3",children:"Some devices are not working properly. Please check your connections and try again."}),e.jsxs(N,{onClick:S,size:"sm",variant:"outline",disabled:r,children:[e.jsx(ns,{className:"h-4 w-4 mr-2"}),"Test Again"]})]}):null:e.jsxs("div",{className:"p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(_e,{className:"h-4 w-4 text-yellow-600"}),e.jsx("span",{className:"text-sm font-medium text-yellow-800",children:"Permission Required"})]}),e.jsx("p",{className:"text-sm text-yellow-700 mb-3",children:'Please allow camera and microphone access to continue. Click "Allow Access" below.'}),e.jsxs(N,{onClick:M,size:"sm",className:"w-full",children:[e.jsx(Ms,{className:"h-4 w-4 mr-2"}),"Allow Camera & Microphone Access"]})]});return e.jsx("div",{className:"max-w-md mx-auto mt-8",children:e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center space-x-2",children:[e.jsx(_e,{className:"h-5 w-5"}),e.jsx("span",{children:"Session Preparation"})]})}),e.jsxs(T,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Let's make sure your devices are working properly before joining the session."}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(q,{label:"Camera",status:f?a.camera:null,icon:ne,showPermissionButton:!0}),e.jsx(q,{label:"Microphone",status:f?a.microphone:null,icon:os,showPermissionButton:!0}),e.jsx(q,{label:"Speakers",status:f?a.speakers:null,icon:dt})]}),F(),e.jsx(om,{permissionState:o,recoveryFlow:i,onRetry:u,onNextStep:h,onDismiss:m,getBrowserInstructions:p}),d&&e.jsx(cm,{error:d,onRetry:()=>g(S),onOpenSettings:v,onDismiss:j}),e.jsx(dm,{permissionsGranted:o.bothGranted,onDeviceTest:E,onRequestPermissions:M,selectedDevices:b,onDeviceChange:B}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(N,{onClick:S,disabled:r||!o.bothGranted,className:"flex-1",children:r?"Testing...":"Test All Devices"}),k&&e.jsxs(N,{onClick:()=>t(!0),className:"flex-1",variant:"default",children:[e.jsx(_n,{className:"h-4 w-4 mr-2"}),"Join Session"]})]}),f&&!k&&e.jsxs("div",{className:"text-center",children:[e.jsx(N,{onClick:()=>t(o.bothGranted),variant:"outline",className:"w-full",children:"Skip Testing & Join Anyway"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"You can join even if device testing failed"})]})]})]})})},hm=({appointmentId:s,sessionId:t,sessionType:a="appointment",autoJoin:r=!1})=>{const n=ps(),{permissionState:o,requestPermissions:i}=Kt();Xd();const{videoState:c,isInSession:u,therapistInfo:m,patientInfo:h,isTherapist:p,sessionDuration:d,joinSession:x,leaveSession:j,connectionState:g,reconnectSession:v,localVideoRef:f,remoteVideoRef:y,remoteStreams:b,toggleVideo:_,toggleAudio:k,toggleScreenSharing:S,toggleRecording:E}=vt(),[B,M]=se.useState(a==="appointment"&&!u),[q,F]=se.useState("waiting"),[P,L]=se.useState(!1),[A,Q]=se.useState(0),$=3;se.useEffect(()=>{switch(g){case"CONNECTED":F("connected"),Q(0);break;case"CONNECTING":F("connecting");break;case"DISCONNECTED":F(u?"reconnecting":"waiting");break;case"FAILED":F("ended");break;default:B&&F("waiting")}},[g,u,B]);const Y=p?h==null?void 0:h.name:m==null?void 0:m.name,U=a==="instant"&&p,G=se.useCallback(()=>{_==null||_().catch(W=>console.error("[SessionConference] Failed to toggle video",W))},[_]),ee=se.useCallback(()=>{k==null||k().catch(W=>console.error("[SessionConference] Failed to toggle audio",W))},[k]),K=se.useCallback(()=>{S==null||S().catch(W=>console.error("[SessionConference] Screen share toggle failed",W))},[S]),ie=se.useCallback(()=>{E==null||E().catch(W=>console.error("[SessionConference] Recording toggle failed",W))},[E]),pe=async()=>{console.log("🎯 [SessionConference] handleJoinSession called",{sessionType:a,sessionId:t,appointmentId:s,permissionState:o,isInSession:u,connectionState:g});try{if(F("connecting"),console.log("🔄 [SessionConference] Set status to connecting"),!o.bothGranted){console.log("⚠️ [SessionConference] Permissions not granted, requesting...");const W=await i();if(console.log("🔒 [SessionConference] Permission request result:",W),!W){console.log("❌ [SessionConference] Permissions denied, ending session"),F("ended");return}}console.log("🚀 [SessionConference] Calling joinSession..."),await x(),console.log("✅ [SessionConference] joinSession completed")}catch(W){console.error("❌ [SessionConference] Failed to join session:",W),F("ended")}};return se.useEffect(()=>{if(q==="reconnecting"&&A<$){const W=setTimeout(()=>{console.log(`🔄 Attempting reconnection ${A+1}/${$}`),Q(ae=>ae+1),v==null||v()},Math.pow(2,A)*1e3);return()=>clearTimeout(W)}},[q,A,$,v]),B&&!u&&a==="appointment"&&s?e.jsx(um,{appointmentId:s,onComplete:W=>{M(!1),W&&pe()}}):(se.useEffect(()=>{a==="instant"&&r&&!u&&!B&&(console.log("🚀 Auto-joining session via shareable link"),pe())},[a,r,u,B]),n?e.jsx(nm,{localVideoRef:f,remoteVideoRef:y,remoteStreams:b,isVideoEnabled:c.isVideoEnabled,isAudioEnabled:c.isAudioEnabled,isScreenSharing:c.isScreenSharing,isRecording:c.isRecording,connectionQuality:c.connectionQuality==="fair"?"good":c.connectionQuality,isConnected:u,sessionStatus:q,participantName:Y,sessionDuration:d?parseInt(d.split(":")[0])*60+parseInt(d.split(":")[1]):0,onToggleVideo:G,onToggleAudio:ee,onToggleScreenShare:K,onToggleRecording:ie,onToggleChat:()=>{},onJoinSession:pe,onLeaveSession:j,sessionType:a,sessionId:t,isTherapist:p,showShareButton:U}):e.jsxs(e.Fragment,{children:[e.jsx(Zd,{children:e.jsx("div",{className:"col-span-full h-full",children:e.jsx(Ti,{sessionId:t||"",sessionType:a,className:"h-full"})})}),U&&t&&e.jsx($a,{open:P,onOpenChange:L,sessionId:t})]}))},pm=()=>{const{sessionId:s}=xt(),t=new URLSearchParams(window.location.search),a=t.get("join")==="true",r=t.has("join"),{user:n}=V(),{sessionDetails:o,isLoading:i,error:c}=ui(s||"");return s?i?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6 space-y-4",children:e.jsx("div",{className:"flex items-center justify-center",children:"Loading session details..."})})})}):c?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6 space-y-4",children:e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:c})})})})}):o?e.jsxs(e.Fragment,{children:[e.jsx(Bt,{children:e.jsxs("title",{children:[o.session_name," | Video Conference"]})}),e.jsx(hm,{sessionId:s,sessionType:"instant",autoJoin:a||r})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6 space-y-4",children:e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"Session not found or has expired."})})})})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(R,{className:"w-96",children:e.jsx(T,{className:"p-6",children:e.jsx(ye,{variant:"destructive",children:e.jsx(be,{children:"No session ID provided."})})})})})},xm=()=>{const{sessionId:s}=xt();return e.jsx(ci,{sessionId:s,sessionType:"instant",children:e.jsx(pm,{})})},tt=se.forwardRef(({className:s,touchOptimized:t=!0,hapticFeedback:a=!0,children:r,onClick:n,...o},i)=>{const c=ps(),u=m=>{c&&a&&"vibrate"in navigator&&navigator.vibrate(10),n&&n(m)};return e.jsx(N,{ref:i,className:C(c&&t&&["min-h-[44px]","min-w-[44px]","touch-manipulation","select-none","active:scale-95","transition-transform duration-150"],s),onClick:u,...o,children:r})});tt.displayName="MobileOptimizedButton";const Ai=se.forwardRef(({className:s,preventZoom:t=!0,touchOptimized:a=!0,...r},n)=>{const o=ps();return e.jsx(Ne,{ref:n,className:C(o&&a&&["min-h-[44px]","touch-manipulation","text-base"],s),style:o&&t?{fontSize:"16px"}:void 0,...r})});Ai.displayName="MobileOptimizedInput";const gm=({isOpen:s,onClose:t,title:a,children:r,fullScreen:n,showCloseButton:o=!0,className:i})=>{const c=ps(),u=n||c;return e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:C(!u&&"max-w-lg",u&&["h-screen max-h-screen w-screen max-w-none","rounded-none border-0","data-[state=open]:slide-in-from-bottom-0","data-[state=closed]:slide-out-to-bottom-0"],c&&["p-0","gap-0"],i),children:[c&&(a||o)&&e.jsxs(Oe,{className:"flex flex-row items-center justify-between p-4 border-b",children:[a&&e.jsx(Fe,{className:"text-lg font-semibold truncate",children:a}),o&&e.jsxs(N,{variant:"ghost",size:"icon",onClick:t,className:"h-8 w-8 flex-shrink-0",children:[e.jsx(rs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),!c&&a&&e.jsx(Oe,{children:e.jsx(Fe,{children:a})}),e.jsx("div",{className:C("flex-1 overflow-auto",c?"p-4":"p-0",u&&"pb-safe"),children:r})]})})},fm=(s=!1)=>{const[t,a]=se.useState(s),r=ps(),n=se.useCallback(()=>{a(!0),r&&(document.body.style.overflow="hidden")},[r]),o=se.useCallback(()=>{a(!1),r&&(document.body.style.overflow="")},[r]);return se.useEffect(()=>()=>{r&&(document.body.style.overflow="")},[r]),{isOpen:t,open:n,close:o,toggle:()=>t?o():n()}},jm=({onSwipeLeft:s,onSwipeRight:t,onSwipeUp:a,onSwipeDown:r,onPinch:n,onDoubleTap:o,onLongPress:i,swipeThreshold:c=50,pinchThreshold:u=.1,longPressDelay:m=500,children:h,className:p,disabled:d=!1})=>{const x=ps(),j=l.useRef(null),g=l.useRef(null),v=l.useRef(null),f=l.useRef(null),[y,b]=l.useState(null),_=M=>({x:M.clientX,y:M.clientY,timestamp:Date.now()}),k=(M,q)=>{const F=M.clientX-q.clientX,P=M.clientY-q.clientY;return Math.sqrt(F*F+P*P)},S=l.useCallback(M=>{if(d||!x)return;const q=M.touches[0],F=_(q);if(j.current=F,M.touches.length===2&&n){const P=k(M.touches[0],M.touches[1]);b(P)}if(i&&M.touches.length===1&&(f.current=setTimeout(()=>{i()},m)),o&&v.current){const P=F.timestamp-v.current.timestamp,L=Math.sqrt(Math.pow(F.x-v.current.x,2)+Math.pow(F.y-v.current.y,2));if(P<300&&L<50){o(),v.current=null;return}}v.current=F},[d,x,n,i,o,m]),E=l.useCallback(M=>{if(!(d||!x)&&(f.current&&(clearTimeout(f.current),f.current=null),M.touches.length===2&&n&&y)){const F=k(M.touches[0],M.touches[1])/y;Math.abs(F-1)>u&&n(F)}},[d,x,n,y,u]),B=l.useCallback(M=>{if(d||!x||!j.current)return;f.current&&(clearTimeout(f.current),f.current=null);const q=M.changedTouches[0];if(g.current=_(q),M.touches.length===0&&b(null),j.current&&g.current){const F=g.current.x-j.current.x,P=g.current.y-j.current.y,L=Math.abs(F),A=Math.abs(P);Math.max(L,A)>c&&(L>A?F>0&&t?t():F<0&&s&&s():P>0&&r?r():P<0&&a&&a())}j.current=null,g.current=null},[d,x,s,t,a,r,c]);return!x||d?e.jsx("div",{className:p,children:h}):e.jsx("div",{className:p,onTouchStart:S,onTouchMove:E,onTouchEnd:B,style:{touchAction:"none"},children:h})},ur=({src:s,alt:t,lazy:a=!0,responsive:r=!0,placeholder:n,errorFallback:o="Failed to load image",className:i,onLoad:c,onError:u,onLoadComplete:m,priority:h=!1,...p})=>{const[d,x]=l.useState(!0),[j,g]=l.useState(!1),[v,f]=l.useState(n||""),y=ps(),b=l.useCallback(S=>{x(!1),g(!1),c&&c(S),m&&m()},[c,m]),_=l.useCallback(S=>{x(!1),g(!0),u&&u(S)},[u]),k=l.useCallback(S=>{if(!S||!a||h){S&&s!==v&&f(s);return}const E=new IntersectionObserver(([B])=>{B.isIntersecting&&s!==v&&(f(s),E.disconnect())},{threshold:.1,rootMargin:y?"50px":"100px"});return E.observe(S),()=>E.disconnect()},[s,v,a,h,y]);return j?e.jsx("div",{className:C("flex items-center justify-center bg-muted text-muted-foreground text-sm",r&&"w-full h-full min-h-[100px]",i),children:o}):e.jsxs("div",{className:C("relative",r&&"w-full",i),children:[d&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Bs,{variant:"spinner",size:"sm"})}),e.jsx("img",{ref:k,src:v,alt:t,className:C(r&&"w-full h-auto",d&&"opacity-0",!d&&"opacity-100 transition-opacity duration-300","select-none"),onLoad:b,onError:_,loading:h?"eager":a?"lazy":"eager",decoding:"async",...p})]})};function vm({items:s,itemHeight:t,containerHeight:a,renderItem:r,overscan:n=5,className:o,emptyState:i}){const[c,u]=l.useState(0),m=l.useRef(null),{startIndex:h,endIndex:p,totalHeight:d}=l.useMemo(()=>{const g=Math.max(0,Math.floor(c/t)-n),v=Math.min(s.length-1,Math.ceil((c+a)/t)+n),f=s.length*t;return{startIndex:g,endIndex:v,totalHeight:f}},[c,t,a,s.length,n]),x=l.useMemo(()=>s.slice(h,p+1).map((g,v)=>({item:g,index:h+v})),[s,h,p]),j=g=>{u(g.currentTarget.scrollTop)};return s.length===0?e.jsx("div",{className:o,style:{height:a},children:i||e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"No items to display"})}):e.jsx("div",{ref:m,className:o,style:{height:a,overflowY:"auto",WebkitOverflowScrolling:"touch"},onScroll:j,children:e.jsx("div",{style:{height:d,position:"relative"},children:e.jsx("div",{style:{transform:`translateY(${h*t}px)`,position:"absolute",top:0,left:0,right:0},children:x.map(({item:g,index:v})=>e.jsx("div",{style:{height:t},className:"flex-shrink-0",children:r(g,v)},v))})})})}const ym=(s={})=>{const{enableFPSMonitoring:t=!0,enableMemoryMonitoring:a=!0,fpsThreshold:r=30,memoryThreshold:n=50,reportingInterval:o=5e3}=s,[i,c]=l.useState({fps:60,memoryUsage:0,loadTime:0,renderTime:0,isSlowDevice:!1}),u=l.useRef(0),m=l.useRef(performance.now()),h=l.useRef();l.useEffect(()=>{if(!t)return;const j=()=>{u.current++;const g=performance.now();if(g>=m.current+1e3){const v=Math.round(u.current*1e3/(g-m.current));c(f=>({...f,fps:v,isSlowDevice:v<r})),u.current=0,m.current=g}h.current=requestAnimationFrame(j)};return h.current=requestAnimationFrame(j),()=>{h.current&&cancelAnimationFrame(h.current)}},[t,r]),l.useEffect(()=>{if(!a||!("memory"in performance))return;const j=()=>{const v=performance.memory;if(v){const f=Math.round(v.usedJSHeapSize/1024/1024);c(y=>({...y,memoryUsage:f}))}},g=setInterval(j,o);return j(),()=>clearInterval(g)},[a,o]),l.useEffect(()=>{const j=performance.getEntriesByType("navigation")[0];if(j){const g=j.loadEventEnd-j.fetchStart;c(v=>({...v,loadTime:Math.round(g)}))}},[]);const p=()=>{const j=[];return i.fps<r&&j.push("Consider reducing animation complexity or frame rate"),i.memoryUsage>n&&j.push("High memory usage detected - consider cleanup optimizations"),i.loadTime>3e3&&j.push("Page load time is slow - consider code splitting or lazy loading"),j},d=()=>i.isSlowDevice||i.fps<r,x=()=>i.memoryUsage>n||i.isSlowDevice;return{metrics:i,recommendations:p(),shouldUseReducedMotion:d,shouldUseLightweightComponents:x,isSlowDevice:i.isSlowDevice}};function bm(){const s=ps(),{metrics:t,recommendations:a}=ym(),r=fm(),[n,o]=l.useState(""),[i,c]=l.useState(""),u=Array.from({length:1e3},(h,p)=>({id:p,title:`Item ${p+1}`,description:`This is a description for item ${p+1}`})),m=h=>{o(h),setTimeout(()=>o(""),2e3)};return e.jsxs("div",{className:"min-h-screen bg-background p-4 space-y-6",children:[e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Mobile Optimization Demo"}),e.jsx("p",{className:"text-muted-foreground",children:"Experience mobile-first optimizations and performance enhancements"}),e.jsxs("div",{className:"flex items-center justify-center gap-2 mt-4",children:[e.jsx(_a,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm",children:s?"Mobile View":"Desktop View"})]})]}),e.jsxs(R,{className:"mb-6",children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(ka,{className:"h-5 w-5"}),"Performance Metrics"]})}),e.jsxs(T,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center p-2 bg-muted rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold",children:t.fps}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"FPS"})]}),e.jsxs("div",{className:"text-center p-2 bg-muted rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold",children:t.memoryUsage}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Memory (MB)"})]}),e.jsxs("div",{className:"text-center p-2 bg-muted rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold",children:Math.round(t.loadTime/1e3)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Load Time (s)"})]}),e.jsxs("div",{className:"text-center p-2 bg-muted rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold",children:t.isSlowDevice?"Yes":"No"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Slow Device"})]})]}),a.length>0&&e.jsxs("div",{className:"text-sm text-orange-600 dark:text-orange-400",children:["Recommendations: ",a.join(", ")]})]})]}),e.jsxs(R,{className:"mb-6",children:[e.jsx(I,{children:e.jsx(O,{children:"Touch-Optimized Components"})}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Mobile-Optimized Buttons"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(tt,{variant:"default",children:"Primary Action"}),e.jsx(tt,{variant:"outline",children:"Secondary"}),e.jsx(tt,{variant:"ghost",children:"Ghost Button"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Mobile-Optimized Input"}),e.jsx(Ai,{placeholder:"Touch-optimized input field",value:i,onChange:h=>c(h.target.value)})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Modal Dialog"}),e.jsx(N,{onClick:r.open,children:"Open Mobile-Optimized Modal"})]})]})]}),e.jsxs(R,{className:"mb-6",children:[e.jsx(I,{children:e.jsx(O,{children:"Touch Gesture Detection"})}),e.jsx(T,{children:e.jsx(jm,{onSwipeLeft:()=>m("Left"),onSwipeRight:()=>m("Right"),onSwipeUp:()=>m("Up"),onSwipeDown:()=>m("Down"),className:"bg-muted rounded-lg p-8 text-center touch-none select-none",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s?"Swipe in any direction":"Touch gestures work on mobile devices"}),e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx(Rt,{className:`h-6 w-6 ${n==="Left"?"text-green-500":"text-muted-foreground"}`}),e.jsx(Sc,{className:`h-6 w-6 ${n==="Up"?"text-green-500":"text-muted-foreground"}`}),e.jsx(Cc,{className:`h-6 w-6 ${n==="Down"?"text-green-500":"text-muted-foreground"}`}),e.jsx(zt,{className:`h-6 w-6 ${n==="Right"?"text-green-500":"text-muted-foreground"}`})]}),n&&e.jsxs("p",{className:"text-green-600 font-medium",children:["Swiped ",n,"!"]})]})})})]}),e.jsxs(R,{className:"mb-6",children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(kc,{className:"h-5 w-5"}),"Image Optimization"]})}),e.jsx(T,{children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Lazy-loaded Image"}),e.jsx(ur,{src:"https://images.unsplash.com/photo-1649972904349-6e44c42644a7?w=400&h=300&fit=crop",alt:"Optimized mobile image",className:"rounded-lg w-full max-w-sm",lazy:!0})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Priority Image"}),e.jsx(ur,{src:"https://images.unsplash.com/photo-1488590528505-98d2b5aba04b?w=400&h=300&fit=crop",alt:"Priority loaded image",className:"rounded-lg w-full max-w-sm",priority:!0})]})]})})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(_c,{className:"h-5 w-5"}),"Performance: Virtualized List"]})}),e.jsxs(T,{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Rendering 1000 items efficiently using virtualization"}),e.jsx(vm,{items:u,itemHeight:60,containerHeight:300,renderItem:(h,p)=>e.jsxs("div",{className:"flex items-center p-3 border-b border-border hover:bg-muted/50",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-3",children:p+1}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:h.title}),e.jsx("div",{className:"text-sm text-muted-foreground",children:h.description})]})]}),className:"border rounded-lg"})]})]})]}),e.jsx(gm,{isOpen:r.isOpen,onClose:r.close,title:"Mobile-Optimized Modal",fullScreen:s,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{children:"This modal adapts to mobile devices:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-2 text-sm",children:[e.jsx("li",{children:"Full-screen on mobile"}),e.jsx("li",{children:"Touch-optimized close button"}),e.jsx("li",{children:"Prevents body scroll"}),e.jsx("li",{children:"Smooth animations"})]}),e.jsx(tt,{onClick:r.close,className:"w-full",children:"Close Modal"})]})})]})}const wm=()=>{const{user:s,loading:t,isAuthenticated:a,primaryRole:r,isInitialized:n,rolesLoaded:o}=V(),i=we(),c=vs();return console.log("[SmartDashboard] Current state:",{isAuthenticated:a,primaryRole:r,loading:t,isInitialized:n,rolesLoaded:o,pathname:c.pathname,user:s==null?void 0:s.id}),l.useEffect(()=>{if(console.log("[SmartDashboard] Effect triggered:",{loading:t,isInitialized:n,rolesLoaded:o,isAuthenticated:a,primaryRole:r,userRoles:s==null?void 0:s.id,pathname:c.pathname}),t||!n){console.log("[SmartDashboard] Still loading or not initialized, waiting...");return}if(!a){console.log("[SmartDashboard] Not authenticated, will redirect to login");return}if(!o){console.log("[SmartDashboard] Roles not loaded yet, waiting...");return}const u=setTimeout(()=>{if(r){const m=Gs(r);console.log(`[SmartDashboard] Redirecting ${r} to ${m}`),i(m,{replace:!0})}else console.log("[SmartDashboard] No primary role found after roles loaded, defaulting to patient"),i("/patient",{replace:!0})},100);return()=>clearTimeout(u)},[a,r,t,n,o,i,c.pathname,s]),t||!n||!o?e.jsx(Bs,{variant:"spinner",size:"lg",text:o?"Loading dashboard...":"Loading user roles...",fullscreen:!0}):a?e.jsx(Bs,{variant:"spinner",size:"lg",text:"Redirecting to dashboard...",fullscreen:!0}):e.jsx(Ge,{to:"/login",replace:!0})},Nm="sidebar:state",Sm=60*60*24*7,Cm="16rem",km="18rem",_m="3rem",Rm="b",Ei=l.createContext(null);function Jt(){const s=l.useContext(Ei);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const Xt=l.forwardRef(({defaultOpen:s=!0,open:t,onOpenChange:a,className:r,style:n,children:o,...i},c)=>{const u=ps(),[m,h]=l.useState(!1),[p,d]=l.useState(s),x=t??p,j=l.useCallback(y=>{const b=typeof y=="function"?y(x):y;a?a(b):d(b),document.cookie=`${Nm}=${b}; path=/; max-age=${Sm}`},[a,x]),g=l.useCallback(()=>u?h(y=>!y):j(y=>!y),[u,j,h]);l.useEffect(()=>{const y=b=>{b.key===Rm&&(b.metaKey||b.ctrlKey)&&(b.preventDefault(),g())};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[g]);const v=x?"expanded":"collapsed",f=l.useMemo(()=>({state:v,open:x,setOpen:j,isMobile:u,openMobile:m,setOpenMobile:h,toggleSidebar:g}),[v,x,j,u,m,h,g]);return e.jsx(Ei.Provider,{value:f,children:e.jsx(Pa,{delayDuration:0,children:e.jsx("div",{style:{"--sidebar-width":Cm,"--sidebar-width-icon":_m,...n},className:C("group/sidebar-wrapper flex flex-row h-screen w-full has-[[data-variant=inset]]:bg-sidebar",r),ref:c,...i,children:o})})})});Xt.displayName="SidebarProvider";const Ga=l.forwardRef(({side:s="left",variant:t="sidebar",collapsible:a="offcanvas",className:r,children:n,...o},i)=>{const{isMobile:c,state:u,openMobile:m,setOpenMobile:h}=Jt();return a==="none"?e.jsx("div",{className:C("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",r),ref:i,...o,children:n}):c?e.jsx(Fa,{open:m,onOpenChange:h,...o,children:e.jsx(Yt,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":km},side:s,children:e.jsx("div",{className:"flex h-full w-full flex-col",children:n})})}):e.jsxs("div",{ref:i,className:"group peer hidden md:block text-sidebar-foreground","data-state":u,"data-collapsible":u==="collapsed"?a:"","data-variant":t,"data-side":s,children:[e.jsx("div",{className:C("duration-200 relative h-screen w-[--sidebar-width] bg-transparent transition-[width] ease-linear","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",t==="floating"||t==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),e.jsx("div",{className:C("duration-200 fixed inset-y-0 z-10 hidden h-screen w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",t==="floating"||t==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",r),...o,children:e.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:n})})]})});Ga.displayName="Sidebar";const Di=l.forwardRef(({className:s,onClick:t,...a},r)=>{const{toggleSidebar:n}=Jt();return e.jsxs(N,{ref:r,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:C("h-7 w-7",s),onClick:o=>{t==null||t(o),n()},...a,children:[e.jsx(Rc,{}),e.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Di.displayName="SidebarTrigger";const Pi=l.forwardRef(({className:s,...t},a)=>{const{toggleSidebar:r}=Jt();return e.jsx("button",{ref:a,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:r,title:"Toggle Sidebar",className:C("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...t})});Pi.displayName="SidebarRail";const Tm=l.forwardRef(({className:s,...t},a)=>e.jsx("main",{ref:a,className:C("relative flex min-h-svh flex-1 flex-col bg-background","peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",s),...t}));Tm.displayName="SidebarInset";const Am=l.forwardRef(({className:s,...t},a)=>e.jsx(Ne,{ref:a,"data-sidebar":"input",className:C("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...t}));Am.displayName="SidebarInput";const Ha=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"header",className:C("flex flex-col gap-2 p-2",s),...t}));Ha.displayName="SidebarHeader";const Ya=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"footer",className:C("flex flex-col gap-2 p-2",s),...t}));Ya.displayName="SidebarFooter";const Ii=l.forwardRef(({className:s,...t},a)=>e.jsx(jt,{ref:a,"data-sidebar":"separator",className:C("mx-2 w-auto bg-sidebar-border",s),...t}));Ii.displayName="SidebarSeparator";const Wa=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"content",className:C("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...t}));Wa.displayName="SidebarContent";const Pt=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"group",className:C("relative flex w-full min-w-0 flex-col p-2",s),...t}));Pt.displayName="SidebarGroup";const Mi=l.forwardRef(({className:s,asChild:t=!1,...a},r)=>{const n=t?Xs:"div";return e.jsx(n,{ref:r,"data-sidebar":"group-label",className:C("duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...a})});Mi.displayName="SidebarGroupLabel";const Em=l.forwardRef(({className:s,asChild:t=!1,...a},r)=>{const n=t?Xs:"button";return e.jsx(n,{ref:r,"data-sidebar":"group-action",className:C("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...a})});Em.displayName="SidebarGroupAction";const It=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"group-content",className:C("w-full text-sm",s),...t}));It.displayName="SidebarGroupContent";const Mt=l.forwardRef(({className:s,...t},a)=>e.jsx("ul",{ref:a,"data-sidebar":"menu",className:C("flex w-full min-w-0 flex-col gap-1",s),...t}));Mt.displayName="SidebarMenu";const ot=l.forwardRef(({className:s,...t},a)=>e.jsx("li",{ref:a,"data-sidebar":"menu-item",className:C("group/menu-item relative",s),...t}));ot.displayName="SidebarMenuItem";const Dm=Fs("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),ct=l.forwardRef(({asChild:s=!1,isActive:t=!1,variant:a="default",size:r="default",tooltip:n,className:o,...i},c)=>{const u=s?Xs:"button",{isMobile:m,state:h}=Jt(),p=e.jsx(u,{ref:c,"data-sidebar":"menu-button","data-size":r,"data-active":t,className:C(Dm({variant:a,size:r}),o),...i});return n?(typeof n=="string"&&(n={children:n}),e.jsxs(Uc,{children:[e.jsx($c,{asChild:!0,children:p}),e.jsx(Pn,{side:"right",align:"center",hidden:h!=="collapsed"||m,...n})]})):p});ct.displayName="SidebarMenuButton";const Pm=l.forwardRef(({className:s,asChild:t=!1,showOnHover:a=!1,...r},n)=>{const o=t?Xs:"button";return e.jsx(o,{ref:n,"data-sidebar":"menu-action",className:C("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",a&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...r})});Pm.displayName="SidebarMenuAction";const Im=l.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"menu-badge",className:C("absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...t}));Im.displayName="SidebarMenuBadge";const Mm=l.forwardRef(({className:s,showIcon:t=!1,...a},r)=>{const n=l.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return e.jsxs("div",{ref:r,"data-sidebar":"menu-skeleton",className:C("rounded-md h-8 flex gap-2 px-2 items-center",s),...a,children:[t&&e.jsx(it,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),e.jsx(it,{className:"h-4 flex-1 max-w-[--skeleton-width]","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":n}})]})});Mm.displayName="SidebarMenuSkeleton";const Bm=l.forwardRef(({className:s,...t},a)=>e.jsx("ul",{ref:a,"data-sidebar":"menu-sub",className:C("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...t}));Bm.displayName="SidebarMenuSub";const Om=l.forwardRef(({...s},t)=>e.jsx("li",{ref:t,...s}));Om.displayName="SidebarMenuSubItem";const Fm=l.forwardRef(({asChild:s=!1,size:t="md",isActive:a,className:r,...n},o)=>{const i=s?Xs:"a";return e.jsx(i,{ref:o,"data-sidebar":"menu-sub-button","data-size":t,"data-active":a,className:C("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",t==="sm"&&"text-xs",t==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",r),...n})});Fm.displayName="SidebarMenuSubButton";const Qa=()=>{const{user:s}=V(),{toast:t}=Z(),a=Le(),{data:r=[],isLoading:n}=le({queryKey:["therapist-inquiries",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:d,error:x}=await w.from("patient_inquiries").select(`
          *,
          patient:patient_id!inner(
            id,
            full_name,
            avatar_url
          )
        `).eq("therapist_id",s.id).order("created_at",{ascending:!1});if(x)throw x;return d||[]},enabled:!!(s!=null&&s.id)}),{data:o=[],isLoading:i}=le({queryKey:["patient-inquiries",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:d,error:x}=await w.from("patient_inquiries").select(`
          *,
          therapist:therapist_id!inner(
            id,
            full_name,
            avatar_url
          )
        `).eq("patient_id",s.id).order("created_at",{ascending:!1});if(x)throw x;return d||[]},enabled:!!(s!=null&&s.id)}),{data:c=[],isLoading:u}=le({queryKey:["patient-therapist-relationships",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:d,error:x}=await w.from("patient_therapist_relationships").select("*").or(`patient_id.eq.${s.id},therapist_id.eq.${s.id}`).order("created_at",{ascending:!1});if(x)throw x;return d||[]},enabled:!!(s!=null&&s.id)}),m=Se({mutationFn:async d=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:x,error:j}=await w.from("patient_inquiries").insert({patient_id:s.id,...d}).select().single();if(j)throw j;return x},onSuccess:()=>{t({title:"Inquiry Sent Successfully! 🚀",description:"Your inquiry has been sent to the therapist. You'll be notified when they respond."}),a.invalidateQueries({queryKey:["patient-inquiries"]}),a.invalidateQueries({queryKey:["patient-therapist-relationships"]})},onError:d=>{console.error("Inquiry creation error:",d),t({title:"Failed to Send Inquiry",description:d.message||"Failed to send inquiry. Please try again.",variant:"destructive"})}}),h=Se({mutationFn:async({inquiryId:d,response:x})=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{error:j}=await w.from("patient_inquiries").update({status:"responded",responded_at:new Date().toISOString(),responded_by:s.id,response_message:x}).eq("id",d).eq("therapist_id",s.id);if(j)throw j},onSuccess:()=>{t({title:"Response Sent Successfully! ✅",description:"Your response has been sent to the patient. They will be notified automatically."}),a.invalidateQueries({queryKey:["therapist-inquiries"]}),a.invalidateQueries({queryKey:["patient-therapist-relationships"]})},onError:d=>{console.error("Response error:",d),t({title:"Failed to Send Response",description:d.message||"Failed to send response. Please try again.",variant:"destructive"})}}),p=Se({mutationFn:async({relationshipId:d,status:x,notes:j})=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{error:g}=await w.from("patient_therapist_relationships").update({relationship_status:x,relationship_notes:j,updated_at:new Date().toISOString()}).eq("id",d);if(g)throw g},onSuccess:()=>{t({title:"Relationship Updated",description:"The relationship status has been updated successfully."}),a.invalidateQueries({queryKey:["patient-therapist-relationships"]})},onError:d=>{console.error("Relationship update error:",d),t({title:"Failed to Update Relationship",description:d.message||"Failed to update relationship. Please try again.",variant:"destructive"})}});return{therapistInquiries:r,patientInquiries:o,relationships:c,loadingTherapistInquiries:n,loadingPatientInquiries:i,loadingRelationships:u,createInquiry:m.mutate,isCreatingInquiry:m.isPending,respondToInquiry:h.mutate,isResponding:h.isPending,updateRelationship:p.mutate,isUpdatingRelationship:p.isPending}},Bi=()=>{var h,p,d;const{user:s,signOut:t}=V(),a=we(),r=vs(),{patientInquiries:n}=Qa();Ue("PatientSidebar","useAuthRBAC");const o=n.filter(x=>x.status==="responded").length,i=[{id:"/patient",label:"Dashboard",icon:Ws,description:"Overview & quick actions"},{id:"/patient/book",label:"Book Session",icon:X,description:"Schedule appointments"},{id:"/patient/inquiries",label:"My Inquiries",icon:qe,description:"Ask questions",badge:o},{id:"/patient/treatment-plans",label:"Treatment Plans",icon:is,description:"View your plans"},{id:"/patient/history",label:"Session History",icon:te,description:"Past sessions"}],c=((h=s==null?void 0:s.user_metadata)==null?void 0:h.name)||((p=s==null?void 0:s.email)==null?void 0:p.split("@")[0])||"Patient",u=c.split(" ").map(x=>x[0]).join("").toUpperCase().slice(0,2),m=x=>x==="/patient"?r.pathname==="/patient":r.pathname.startsWith(x);return e.jsxs(Ga,{className:"border-r border-blue-200/50 bg-white/70 backdrop-blur-sm dark:bg-gray-900/70 dark:border-gray-700",children:[e.jsx(Ha,{className:"border-b border-blue-200/30 dark:border-gray-700/50",children:e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:e.jsx(ws,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-white",children:"TherapyHub"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Patient Portal"})]})]}),e.jsx(Di,{className:"h-6 w-6"})]})}),e.jsx(Wa,{className:"px-2 py-4",children:e.jsx(Pt,{children:e.jsx(It,{children:e.jsx(Mt,{children:i.map(x=>e.jsx(ot,{children:e.jsxs(ct,{onClick:()=>a(x.id),isActive:m(x.id),className:`w-full justify-start group transition-all duration-200 ${m(x.id)?"bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300":"hover:bg-blue-50 dark:hover:bg-gray-800"}`,children:[e.jsx(x.icon,{className:`h-5 w-5 mr-3 ${m(x.id)?"text-blue-600":"text-gray-500"}`}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsxs("div",{className:"font-medium flex items-center gap-2",children:[x.label,x.badge&&x.badge>0&&e.jsx(D,{variant:"destructive",className:"h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs",children:x.badge})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:x.description})]})]})},x.id))})})})}),e.jsxs(Ya,{className:"border-t border-blue-200/30 dark:border-gray-700/50 p-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[e.jsxs(es,{className:"h-10 w-10",children:[e.jsx(Us,{src:(d=s==null?void 0:s.user_metadata)==null?void 0:d.avatar_url}),e.jsx(ss,{className:"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300",children:u})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:c}),e.jsx(La,{role:"patient",variant:"compact"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>a("/profile"),children:[e.jsx(hs,{className:"h-4 w-4 mr-2"}),"Settings"]}),e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start text-red-600 hover:text-red-700 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20",onClick:t,children:[e.jsx(Ls,{className:"h-4 w-4 mr-2"}),"Sign Out"]})]})]})]})},Oi=s=>{const t=Le(),{toast:a}=Z(),[r,n]=l.useState(!1),[o,i]=l.useState([]);return l.useEffect(()=>{if(!s){n(!1);return}const c=[],u=w.channel("mood-entries-changes").on("postgres_changes",{event:"*",schema:"public",table:"mood_entries",filter:`patient_id=eq.${s}`},g=>{console.log("[Real-time] Mood entry change:",g),t.invalidateQueries({queryKey:["mood-entries",s]}),t.invalidateQueries({queryKey:["mood-streak",s]}),g.eventType==="INSERT"&&a({title:"Mood logged successfully",description:"Your mood entry has been saved."})}).subscribe(g=>{g==="SUBSCRIBED"?n(!0):g==="CLOSED"&&n(!1)});c.push(u);const m=w.channel("patient-goals-changes").on("postgres_changes",{event:"*",schema:"public",table:"patient_goals",filter:`patient_id=eq.${s}`},g=>{console.log("[Real-time] Goal change:",g),t.invalidateQueries({queryKey:["patient-goals",s]}),t.invalidateQueries({queryKey:["patient-dashboard-stats",s]}),g.eventType==="UPDATE"&&g.new.status==="completed"&&a({title:"Goal completed! 🎉",description:`Congratulations on completing "${g.new.title}"`})}).subscribe();c.push(m);const h=w.channel("appointments-changes").on("postgres_changes",{event:"*",schema:"public",table:"appointments",filter:`patient_id=eq.${s}`},g=>{if(console.log("[Real-time] Appointment change:",g),t.invalidateQueries({queryKey:["patient-dashboard-stats",s]}),t.invalidateQueries({queryKey:["patient-session-history",s]}),g.eventType==="INSERT")a({title:"New appointment scheduled",description:"You have a new appointment."});else if(g.eventType==="UPDATE"){const v=g.new.status;v==="cancelled"?a({title:"Appointment cancelled",description:"Your appointment has been cancelled.",variant:"destructive"}):v==="confirmed"&&a({title:"Appointment confirmed",description:"Your appointment has been confirmed."})}}).subscribe();c.push(h);const p=w.channel("patient-inquiries-changes").on("postgres_changes",{event:"*",schema:"public",table:"patient_inquiries",filter:`patient_id=eq.${s}`},g=>{console.log("[Real-time] Inquiry change:",g),t.invalidateQueries({queryKey:["patient-inquiries",s]}),g.eventType==="UPDATE"&&g.new.status==="responded"&&a({title:"New response received",description:"Your therapist has responded to your inquiry."})}).subscribe();c.push(p);const d=w.channel("inquiry-responses-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"inquiry_responses"},async g=>{console.log("[Real-time] New inquiry response:",g);const{data:v}=await w.from("patient_inquiries").select("patient_id").eq("id",g.new.inquiry_id).single();(v==null?void 0:v.patient_id)===s&&(t.invalidateQueries({queryKey:["patient-inquiries",s]}),a({title:"New message received",description:"You have a new response to your inquiry."}))}).subscribe();c.push(d);const x=w.channel("patient-resources-changes").on("postgres_changes",{event:"*",schema:"public",table:"patient_resources"},g=>{console.log("[Real-time] Resource change:",g),t.invalidateQueries({queryKey:["patient-resources"]}),g.eventType==="INSERT"&&g.new.is_featured&&a({title:"New featured resource",description:`New resource available: "${g.new.title}"`})}).subscribe();c.push(x);const j=w.channel("notifications-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${s}`},g=>{console.log("[Real-time] New notification:",g),a({title:g.new.title,description:g.new.message})}).subscribe();return c.push(j),i(c),()=>{console.log("[Real-time] Cleaning up subscriptions"),c.forEach(g=>{w.removeChannel(g)}),i([]),n(!1)}},[s,t,a]),{isConnected:r,channels:o}},Lm=()=>{const{user:s}=V(),{isConnected:t}=Oi((s==null?void 0:s.id)||"");return e.jsx(D,{variant:t?"default":"destructive",className:"flex items-center gap-1 text-xs",children:t?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"h-3 w-3"}),"Live"]}):e.jsxs(e.Fragment,{children:[e.jsx(Cs,{className:"h-3 w-3"}),"Offline"]})})},Fi=()=>{var o,i;const{user:s}=V(),{t}=Ze();Ue("DashboardHeader","useAuthRBAC");const a=((o=s==null?void 0:s.user_metadata)==null?void 0:o.name)||((i=s==null?void 0:s.email)==null?void 0:i.split("@")[0])||"Patient",r=new Date().getHours();let n="Good morning";return r>=12&&r<18?n="Good afternoon":r>=18&&(n="Good evening"),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold",children:[n,", ",a]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Here's an overview of your wellness journey"})]}),e.jsx(Lm,{})]})})},Li=()=>{const{user:s}=V();return le({queryKey:["patient-dashboard-stats",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t,error:a}=await w.from("appointments").select("id").eq("patient_id",s.id).eq("status","completed");if(a)throw a;const r=new Date;r.setDate(1),r.setHours(0,0,0,0);const{data:n,error:o}=await w.from("appointments").select("id").eq("patient_id",s.id).eq("status","completed").gte("start_time",r.toISOString());if(o)throw o;const{data:i}=await w.from("appointments").select(`
          start_time,
          end_time,
          therapist_id
        `).eq("patient_id",s.id).in("status",["scheduled","confirmed"]).gte("start_time",new Date().toISOString()).order("start_time",{ascending:!0}).limit(1).maybeSingle();let c="Your Therapist";if(i!=null&&i.therapist_id){const{data:d}=await w.from("profiles").select("full_name").eq("id",i.therapist_id).single();c=(d==null?void 0:d.full_name)||"Your Therapist"}const{data:u}=await w.from("appointments").select("start_time").eq("patient_id",s.id).eq("status","completed").order("start_time",{ascending:!1}).limit(1).single();let m=0;if(u!=null&&u.start_time){const d=new Date(u.start_time);m=Math.floor((new Date().getTime()-d.getTime())/(1e3*60*60*24))}const h=t?Math.min(t.length/12*100,100):0,p=m<=7?Math.max(0,7-m):0;return{totalSessions:(t==null?void 0:t.length)||0,sessionsThisMonth:(n==null?void 0:n.length)||0,nextAppointment:i?{date:new Date(i.start_time).toLocaleDateString(),time:new Date(i.start_time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),therapistName:c}:null,completedGoals:Math.floor(((t==null?void 0:t.length)||0)*.3),totalGoals:Math.max(5,Math.floor(((t==null?void 0:t.length)||0)*.5)),daysSinceLastSession:m,streakDays:p,treatmentPlanProgress:h,lastActivityDate:(u==null?void 0:u.start_time)||null}},enabled:!!(s!=null&&s.id),staleTime:5*60*1e3})},qm=()=>{var r;const{user:s}=V(),{data:t}=Li();Ue("PatientWelcomeSection","useAuthRBAC");const a=()=>{const n=new Date().getHours();return n<12?"Good morning":n<18?"Good afternoon":"Good evening"};return e.jsxs(R,{className:"mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"text-2xl font-bold text-gray-800",children:[a(),", ",((r=s==null?void 0:s.email)==null?void 0:r.split("@")[0])||"Patient","!"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Welcome to your mental health journey"})]}),e.jsx(D,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:"Patient Dashboard"})]})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Track your progress, schedule appointments, and access resources for your wellbeing."}),t&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.nextAppointment&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-white/70 rounded-lg border",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Next Session"}),e.jsxs("p",{className:"text-xs text-gray-600 truncate",children:[t.nextAppointment.date," at ",t.nextAppointment.time]}),e.jsxs("p",{className:"text-xs text-gray-500 truncate",children:["with ",t.nextAppointment.therapistName]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-white/70 rounded-lg border",children:[e.jsx(qs,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Progress"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[t.totalSessions," sessions completed"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[Math.round(t.treatmentPlanProgress),"% treatment progress"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-white/70 rounded-lg border",children:[e.jsx(te,{className:"h-5 w-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Activity"}),e.jsxs("p",{className:"text-xs text-gray-600",children:[t.sessionsThisMonth," sessions this month"]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[t.streakDays," day streak"]})]})]})]})]})})]})},qi=s=>{const{user:t}=V(),{data:a,isLoading:r,error:n}=le({queryKey:["upcoming-appointments",t==null?void 0:t.id,s],queryFn:async()=>{if(!(t!=null&&t.id))return[];const o=s==="therapist"?"therapist_id":"patient_id",{data:i,error:c}=await w.from("appointments").select("*").eq(o,t.id).gte("start_time",new Date().toISOString()).order("start_time",{ascending:!0});if(c)throw console.error("Error fetching upcoming appointments:",c),c;return i||[]},enabled:!!(t!=null&&t.id)});return{appointments:a||[],data:a||[],isLoading:r,error:n}};function Zt({className:s,classNames:t,showOutsideDays:a=!0,...r}){return e.jsx(fo,{showOutsideDays:a,className:C("p-3",s),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:C(ht({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:C(ht({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...t},components:{IconLeft:({...n})=>e.jsx(Vt,{className:"h-4 w-4"}),IconRight:({...n})=>e.jsx(js,{className:"h-4 w-4"})},...r})}Zt.displayName="Calendar";const Um=["9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM","12:00 PM","12:30 PM","1:00 PM","1:30 PM","2:00 PM","2:30 PM","3:00 PM","3:30 PM","4:00 PM","4:30 PM","5:00 PM","5:30 PM"],$m=({isOpen:s,onClose:t,appointment:a})=>{var f;const{updateAppointment:r,deleteAppointment:n}=qa(),[o,i]=l.useState(),[c,u]=l.useState(""),[m,h]=l.useState(!1),[p,d]=l.useState(!1),x=()=>{const y=new Date(a.start_time),b=new Date;return(y.getTime()-b.getTime())/(1e3*60*60)>=24},j=async()=>{if(!(!o||!c)){h(!0);try{const[y,b]=c.split(" "),[_,k]=y.split(":").map(Number);let S=_;b==="PM"&&_!==12&&(S+=12),b==="AM"&&_===12&&(S=0);const E=new Date(o);E.setHours(S,k||0,0,0);const B=new Date(a.start_time),q=new Date(a.end_time).getTime()-B.getTime(),F=new Date(E.getTime()+q);await r.mutateAsync({...a,start_time:E.toISOString(),end_time:F.toISOString(),status:"scheduled"}),t()}catch(y){console.error("Error updating appointment:",y)}finally{h(!1)}}},g=async()=>{d(!0);try{await n.mutateAsync(a.id),t()}catch(y){console.error("Error cancelling appointment:",y)}finally{d(!1)}},v=wa(new Date,1);return e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"max-w-4xl max-h-[90vh] overflow-auto",children:[e.jsxs(Oe,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Edit Appointment"]}),e.jsx($s,{children:"Update your appointment date and time, or cancel if needed"})]}),e.jsx(R,{className:"border-amber-200 bg-amber-50",children:e.jsx(T,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(_e,{className:"h-5 w-5 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-amber-800",children:"24-Hour Policy"}),e.jsxs("p",{className:"text-xs text-amber-700",children:["Appointments can only be rescheduled or cancelled at least 24 hours before the scheduled time.",!x()&&" This appointment is within 24 hours and cannot be modified."]})]})]})})}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{className:"text-base",children:"Current Appointment"})}),e.jsxs(T,{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(D,{variant:"outline",children:((f=a.therapist_profile)==null?void 0:f.full_name)||"Therapist"})}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(X,{className:"h-4 w-4"}),xe(new Date(a.start_time),"EEEE, MMMM do, yyyy")]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(te,{className:"h-4 w-4"}),xe(new Date(a.start_time),"h:mm a")," - ",xe(new Date(a.end_time),"h:mm a")]})]})]}),x()?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{className:"text-base",children:"Select New Date"}),e.jsx(me,{children:"Choose a new date for your appointment"})]}),e.jsx(T,{children:e.jsx(Zt,{mode:"single",selected:o,onSelect:i,disabled:y=>jo(y,v),className:"rounded-md border"})})]}),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{className:"text-base",children:"Select New Time"}),e.jsx(me,{children:"Choose a new time for your appointment"})]}),e.jsx(T,{children:e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-80 overflow-y-auto",children:Um.map(y=>e.jsx(N,{variant:c===y?"default":"outline",size:"sm",onClick:()=>u(y),className:"justify-start",children:y},y))})})]})]}):e.jsx(R,{className:"border-red-200 bg-red-50",children:e.jsxs(T,{className:"pt-6 text-center",children:[e.jsx(rs,{className:"h-12 w-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-red-800 mb-2",children:"Cannot Edit Appointment"}),e.jsx("p",{className:"text-sm text-red-700",children:"This appointment is scheduled within 24 hours and cannot be modified according to our policy. Please contact support if you have an emergency."})]})}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx("div",{className:"flex gap-2",children:x()&&e.jsx(N,{variant:"destructive",onClick:g,disabled:p,children:p?"Cancelling...":"Cancel Appointment"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{variant:"outline",onClick:t,children:"Close"}),x()&&e.jsx(N,{onClick:j,disabled:!o||!c||m,children:m?"Updating...":"Update Appointment"})]})]})]})})},zm=(s,t)=>{var i,c;const r=((i=s.title)==null?void 0:i.toLowerCase().includes("initial consultation"))||((c=s.title)==null?void 0:c.toLowerCase().includes("consultation"))?"Initial Consultation":"Session",n=t==="therapist"?s.patient_name:s.therapist_name;return n&&n.trim()!==""?`${r} with ${n}`:`${r} with ${t==="therapist"?"Patient":"Therapist"}`},Vm=(s,t)=>{const a=t==="therapist"?s.patient_name:s.therapist_name;return a&&a.trim()!==""?a:t==="therapist"?"Unknown Patient":"Unknown Therapist"},Gm=()=>Intl.DateTimeFormat().resolvedOptions().timeZone,lt=(s,t,a)=>{const r=a||Gm(),n=typeof s=="string"?new Date(s):s;return vo(n,r,t)},Ui=s=>`/session/${s}`,$i=(s,t)=>{const a=new Date,r=new Date(s),n=new Date(t),o=new Date(r.getTime()-15*60*1e3);return a<o?"scheduled":a>=o&&a<r?"ready":a>=r&&a<=n?"active":"ended"},hr=({appointment:s,isOpen:t,onClose:a,timeZone:r,userRole:n})=>{const{user:o}=V(),i=we();if(!s)return null;const c=n==="therapist",u=c?s.patient_name:s.therapist_name,m=c?s.patient_phone:s.therapist_phone,h=c?s.patient_email:s.therapist_email,p=r?lt(s.start_time,r,"EEEE, MMMM d, yyyy h:mm a zzz"):new Date(s.start_time).toLocaleString(),d=r?lt(s.end_time,r,"h:mm a zzz"):new Date(s.end_time).toLocaleString(),x=$i(s.start_time,s.end_time),j=()=>{const f=Ui(s.id);i(f),a()},g=()=>{console.log("Send message to:",u)},v=()=>{switch(x){case"ready":return"Join Session";case"active":return"Join Session";case"soon":return"Join Session";case"ended":return"Join Session";default:return"Join Session"}};return e.jsx(He,{open:t,onOpenChange:a,children:e.jsxs($e,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),s.title||"Session Details"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{children:"Appointment Details"})}),e.jsxs(T,{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:p})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{children:d})]}),s.description&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(is,{className:"h-4 w-4 mt-0.5"}),e.jsx("span",{children:s.description})]})]})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{children:"Participant Information"})}),e.jsxs(T,{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx("span",{children:u||"Participant"})]}),m&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ra,{className:"h-4 w-4"}),e.jsx("a",{href:`tel:${m}`,children:m})]}),h&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rn,{className:"h-4 w-4"}),e.jsx("a",{href:`mailto:${h}`,children:h})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),e.jsx(N,{variant:"link",size:"sm",onClick:g,children:"Send Message"})]})]})]}),s.video_enabled&&s.video_url&&e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{children:"Video Session Details"})}),e.jsxs(T,{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsx("span",{children:"Video Session Enabled"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4 text-yellow-500"}),e.jsx("span",{className:"text-sm text-yellow-500",children:"Please ensure your camera and microphone are working before joining."})]})]})]}),s.video_enabled&&e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[x==="ready"&&"Ready to join",x==="soon"&&"Session starts soon",x==="active"&&"Session in progress",x==="ended"&&"Session has ended",x==="scheduled"&&"Session scheduled"]}),e.jsxs(N,{variant:"therapy",onClick:j,className:"ml-4",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),v()]})]})]})]})})},zi=({appointment:s,userRole:t,variant:a="full",timeZone:r})=>{const n=we(),[o,i]=l.useState(!1),c=zm(s,t),u=Vm(s,t),m=new Date(s.start_time),h=new Date(s.end_time),p=r?lt(m,r,"MMM d, yyyy"):m.toLocaleDateString(),d=r?lt(m,r,"h:mm a"):m.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),x=r?lt(h,r,"h:mm a"):h.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),j=$i(s.start_time,s.end_time),g=()=>{const b=Ui(s.id);n(b)},v=()=>{i(!0)},f=()=>{switch(j){case"ready":return e.jsx(D,{variant:"success",children:"Ready"});case"active":return e.jsx(D,{variant:"therapy",children:"Active"});case"soon":return e.jsx(D,{variant:"warning",children:"Starting Soon"});case"ended":return e.jsx(D,{variant:"outline",children:"Ended"});default:return e.jsx(D,{variant:"secondary",children:"Scheduled"})}},y=()=>{switch(j){case"ready":return"Join Now";case"active":return"Join Session";case"soon":return"Join Session";case"ended":return"View Details";default:return"View Details"}};return a==="compact"?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"hover:shadow-md transition-shadow cursor-pointer",onClick:v,children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:c}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(X,{className:"h-3 w-3"}),e.jsx("span",{children:p}),e.jsx(te,{className:"h-3 w-3 ml-2"}),e.jsx("span",{children:d})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[f(),s.video_enabled&&(j==="ready"||j==="active"||j==="soon")&&e.jsxs(N,{size:"sm",variant:"therapy",onClick:b=>{b.stopPropagation(),g()},children:[e.jsx(ne,{className:"h-3 w-3 mr-1"}),"Join"]})]})]})})}),e.jsx(hr,{appointment:s,isOpen:o,onClose:()=>i(!1),timeZone:r,userRole:t})]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"hover:shadow-md transition-shadow",children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2",children:c}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:p})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{children:[d," - ",x]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:u})]})]}),e.jsx("div",{className:"flex flex-col items-end gap-2",children:f()})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:v,children:"View Details"}),s.video_enabled&&(j==="ready"||j==="active"||j==="soon")&&e.jsxs(N,{variant:"therapy",onClick:g,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),y()]})]})]})}),e.jsx(hr,{appointment:s,isOpen:o,onClose:()=>i(!1),timeZone:r,userRole:t})]})},Hm=()=>{const s=we(),{primaryRole:t}=V(),[a,r]=l.useState(null),n="patient",{data:o,isLoading:i,error:c}=qi(n),u=o||[];return i?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center",children:[e.jsx(X,{className:"h-5 w-5 mr-2 text-blue-600"}),"Upcoming Sessions"]}),e.jsx(me,{children:"Your scheduled therapy sessions with quick access"})]}),e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2",children:"Loading appointments..."})]})})]}):c?(console.error("[Patient UpcomingAppointments] Error loading appointments:",c),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center",children:[e.jsx(X,{className:"h-5 w-5 mr-2 text-blue-600"}),"Upcoming Sessions"]}),e.jsx(me,{children:"Your scheduled therapy sessions"})]}),e.jsx(T,{children:e.jsxs("div",{className:"text-center py-6",children:[e.jsx("p",{className:"text-muted-foreground mb-3",children:"Unable to load sessions"}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>window.location.reload(),children:"Retry"})]})})]})):e.jsxs(e.Fragment,{children:[e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center",children:[e.jsx(X,{className:"h-5 w-5 mr-2 text-blue-600"}),"Upcoming Sessions"]}),e.jsx(me,{children:"Your scheduled therapy sessions with one-click access"})]}),e.jsx(T,{children:u&&u.length>0?e.jsx("div",{className:"space-y-4",children:u.slice(0,3).map(m=>e.jsx(zi,{appointment:m,userRole:n,variant:"full"},m.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(X,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No upcoming sessions"}),e.jsx(N,{onClick:()=>s("/book-therapist"),children:"Schedule Your First Session"})]})})]}),a&&e.jsx($m,{isOpen:!!a,onClose:()=>r(null),appointment:a})]})},Ka=Xo,ea=l.forwardRef(({className:s,...t},a)=>e.jsx(un,{ref:a,className:C("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...t}));ea.displayName=un.displayName;const Ps=l.forwardRef(({className:s,...t},a)=>e.jsx(hn,{ref:a,className:C("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",s),...t}));Ps.displayName=hn.displayName;const ms=l.forwardRef(({className:s,...t},a)=>e.jsx(pn,{ref:a,className:C("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...t}));ms.displayName=pn.displayName;const Ym=({bookingData:s,updateBookingData:t,onNext:a})=>{const[r,n]=l.useState(s.therapistId||null),{data:o=[],isLoading:i}=le({queryKey:["available-therapists"],queryFn:async()=>{console.log("Fetching therapists...");const{data:m,error:h}=await w.from("profiles").select("id, full_name, account_type, approval_status").eq("account_type","therapist").eq("approval_status","approved");if(h)throw console.error("Error fetching therapists:",h),h;return console.log("Fetched therapists:",m),m||[]}}),c=m=>{n(m.id),t({therapistId:m.id,therapistName:m.full_name||"Unknown Therapist"})},u=()=>{r&&a()};return i?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Choose Your Therapist"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select a therapist for your initial consultation"})]}),e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:o.map(m=>{var h;return e.jsx(R,{className:C("cursor-pointer transition-colors hover:bg-accent",r===m.id&&"ring-2 ring-primary bg-accent"),onClick:()=>c(m),children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(es,{className:"h-12 w-12",children:e.jsx(ss,{children:((h=m.full_name)==null?void 0:h.split(" ").map(p=>p[0]).join("").slice(0,2))||"T"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm",children:m.full_name||"Unknown Therapist"}),e.jsx(D,{variant:"secondary",className:"text-xs mt-1",children:"Licensed Therapist"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ta,{className:"h-3 w-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs",children:"4.8"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 line-clamp-2",children:"Experienced therapist dedicated to helping clients achieve their mental health goals."}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[e.jsx(D,{variant:"secondary",className:"text-xs",children:"Cognitive Behavioral Therapy"}),e.jsx(D,{variant:"secondary",className:"text-xs",children:"Anxiety & Depression"})]}),e.jsx("div",{className:"flex items-center justify-between mt-2",children:e.jsx("div",{className:"text-xs text-muted-foreground",children:"5+ years experience • $120/session"})})]})]})})},m.id)})}),o.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-muted-foreground",children:"No available therapists found"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Please check back later or contact support for assistance."})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs(N,{onClick:u,disabled:!r,children:["Continue",e.jsx(js,{className:"h-4 w-4 ml-2"})]})})]})},Wm=({bookingData:s,updateBookingData:t,onNext:a,onPrevious:r})=>{const n=i=>{i&&t({selectedDate:i})},o=()=>{s.selectedDate&&a()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Date"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose an available date for your appointment"})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Zt,{mode:"single",selected:s.selectedDate,onSelect:n,disabled:i=>i<new Date||i.getDay()===0,className:"rounded-md border pointer-events-auto"})}),s.selectedDate&&e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Selected: ",xe(s.selectedDate,"EEEE, MMMM do, yyyy")]})}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsxs(N,{variant:"outline",onClick:r,children:[e.jsx(Vt,{className:"h-4 w-4 mr-2"}),"Previous"]}),e.jsxs(N,{onClick:o,disabled:!s.selectedDate,children:["Continue",e.jsx(js,{className:"h-4 w-4 ml-2"})]})]})]})},Qm=["9:00 AM","10:00 AM","11:00 AM","12:00 PM","1:00 PM","2:00 PM","3:00 PM","4:00 PM","5:00 PM"],Km=({bookingData:s,updateBookingData:t,onNext:a,onPrevious:r})=>{const n=i=>{t({selectedTime:i})},o=()=>{s.selectedTime&&a()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Time"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose an available time slot for your appointment"})]}),e.jsx(R,{children:e.jsx(T,{className:"p-6",children:e.jsx("div",{className:"grid grid-cols-3 gap-3",children:Qm.map(i=>e.jsx(N,{variant:s.selectedTime===i?"default":"outline",className:C("h-12 text-sm",s.selectedTime===i&&"ring-2 ring-primary"),onClick:()=>n(i),children:i},i))})})}),s.selectedTime&&e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Selected time: ",s.selectedTime]})}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsxs(N,{variant:"outline",onClick:r,children:[e.jsx(Vt,{className:"h-4 w-4 mr-2"}),"Previous"]}),e.jsxs(N,{onClick:o,disabled:!s.selectedTime,children:["Continue",e.jsx(js,{className:"h-4 w-4 ml-2"})]})]})]})},Jm=({therapistId:s,selectedDate:t,selectedTime:a,therapistName:r,onBookingSuccess:n,onBack:o})=>{const{user:i}=V(),{toast:c}=Z(),u=vd(),[m,h]=l.useState(!1),[p,d]=l.useState(null),x=async()=>{if(!(i!=null&&i.id)||!s||!t||!a){d("Missing required booking information");return}h(!0),d(null);try{const g=a.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);if(!g)throw new Error("Invalid time format");const[,v,f,y]=g;let b=parseInt(v);const _=parseInt(f)||0;y.toUpperCase()==="PM"&&b!==12?b+=12:y.toUpperCase()==="AM"&&b===12&&(b=0);const k=new Date(t);k.setHours(b,_,0,0);const S=new Date(k);S.setMinutes(S.getMinutes()+50);const E={patient_id:i.id,therapist_id:s,title:"Initial Consultation",description:"Initial therapy consultation session",start_time:k.toISOString(),end_time:S.toISOString(),status:"scheduled",video_enabled:!0,is_initial_consultation:!0,appointment_type:"consultation"},B=await u.mutateAsync(E);if(B&&typeof B=="object"&&"id"in B){const M=B.id;c({title:"Appointment Booked!",description:"Your consultation has been scheduled successfully."}),n(M)}else throw new Error("Failed to create appointment - invalid response")}catch(g){console.error("Error booking appointment:",g);const v=g.message||"Failed to book appointment. Please try again.";d(v),c({title:"Booking Failed",description:v,variant:"destructive"})}finally{h(!1)}};return s&&t&&a&&r?e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{children:"Confirm Appointment"})}),e.jsxs(T,{className:"space-y-6",children:[p&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Je,{className:"h-4 w-4 text-red-500 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Booking Error"}),e.jsx("p",{className:"text-sm text-red-700",children:p})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3 p-3  rounded-lg border",children:[e.jsx(Be,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Therapist"}),e.jsx("p",{className:"font-medium",children:r})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border",children:[e.jsx(X,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Date"}),e.jsx("p",{className:"font-medium",children:xe(t,"EEEE, MMMM d, yyyy")})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border",children:[e.jsx(te,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Time"}),e.jsxs("p",{className:"font-medium",children:[a," (50 minutes)"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 rounded-lg border",children:[e.jsx(Aa,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Location"}),e.jsx("p",{className:"font-medium",children:"Online Video Session"})]})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Initial Consultation:"})," This is your first session to discuss your needs and goals. Follow-up appointments will be scheduled based on your treatment plan."]})}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsx(N,{variant:"outline",onClick:o,disabled:m,children:"Back"}),e.jsx(N,{onClick:x,disabled:m,className:"min-w-[140px]",children:m?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"mr-2 h-4 w-4 animate-spin"}),"Booking..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Confirm & Book"]})})]})]})]}):e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-orange-500"}),"Complete Previous Steps"]})}),e.jsxs(T,{children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Please complete all previous steps before confirming your appointment."}),e.jsxs("div",{className:"space-y-2 text-sm",children:[!s&&e.jsx("p",{className:"text-red-500",children:"• Select a therapist"}),!t&&e.jsx("p",{className:"text-red-500",children:"• Choose a date"}),!a&&e.jsx("p",{className:"text-red-500",children:"• Pick a time"})]}),e.jsx(N,{variant:"outline",onClick:o,className:"mt-4",children:"Go Back"})]})]})},Vi=({isOpen:s,onClose:t,therapistId:a,onBookingComplete:r})=>{const[n,o]=l.useState("therapist"),[i,c]=l.useState({appointmentType:"Video Call",therapistId:a}),[u,m]=l.useState(!1),{toast:h}=Z(),p=[{id:"therapist",label:"Therapist",completed:!!i.therapistId},{id:"date",label:"Date",completed:!!i.selectedDate},{id:"time",label:"Time",completed:!!i.selectedTime},{id:"summary",label:"Summary",completed:u}],d=p.findIndex(y=>y.id===n),x=()=>{const y=d+1;y<p.length&&o(p[y].id)},j=()=>{const y=d-1;y>=0&&o(p[y].id)},g=y=>{c(b=>({...b,...y}))},v=()=>{o("therapist"),c({appointmentType:"Video Call",therapistId:a}),m(!1),t()},f=y=>{console.log("Booking successful, appointment ID:",y),m(!0),h({title:"Booking Confirmed!",description:"Your appointment has been successfully scheduled. You'll receive a confirmation email shortly."}),setTimeout(()=>{r&&r(),v()},2e3)};return e.jsx(He,{open:s,onOpenChange:v,children:e.jsx($e,{className:"w-[95vw] max-w-[95vw] sm:w-[90vw] sm:max-w-[600px] lg:max-w-[900px] xl:max-w-[1000px] max-h-[85vh] overflow-hidden p-0",children:e.jsxs("div",{className:"flex flex-col h-full max-h-[85vh]",children:[e.jsxs(Oe,{className:"px-4 sm:px-6 py-4 border-b shrink-0",children:[e.jsx(Fe,{className:"text-xl sm:text-2xl font-semibold text-center",children:u?"Booking Confirmed!":"Schedule Initial Consultation"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center mt-1",children:u?"Your appointment has been successfully scheduled":"Book your first session to begin your therapeutic journey"})]}),e.jsx("div",{className:"px-4 sm:px-6 py-4 border-b shrink-0",children:e.jsx("div",{className:"flex items-center justify-center",children:p.map((y,b)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:C("w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-medium transition-all",y.completed||u?"bg-green-500 text-white":y.id===n?"bg-primary/20 text-primary border-2 border-primary":"bg-gray-100 text-gray-400"),children:y.completed||u?e.jsx(Is,{className:"h-3 w-3 sm:h-4 sm:w-4"}):b+1}),e.jsx("span",{className:C("text-xs mt-1 font-medium hidden sm:block",y.id===n||y.completed||u?"text-primary":"text-gray-500"),children:y.label})]}),b<p.length-1&&e.jsx("div",{className:"w-8 sm:w-12 h-0.5 bg-gray-200 mx-1 sm:mx-2 mt-[-12px]",children:e.jsx("div",{className:"h-0.5 bg-primary transition-all duration-300",style:{width:`${b<d||u?100:b===d?50:0}%`}})})]},y.id))})}),u&&e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(Is,{className:"h-8 w-8 text-green-600"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Appointment Confirmed!"}),e.jsxs("p",{className:"text-muted-foreground max-w-md",children:["Your consultation with ",i.therapistName," has been scheduled for"," ",i.selectedDate&&i.selectedTime&&`${i.selectedDate.toLocaleDateString()} at ${i.selectedTime}`,"."]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You'll receive a confirmation email with video session details shortly."})]})}),!u&&e.jsxs(Ka,{value:n,onValueChange:o,className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(ea,{className:"hidden",children:p.map(y=>e.jsx(Ps,{value:y.id,children:y.label},y.id))}),e.jsxs("div",{className:"flex-1 overflow-auto px-4 sm:px-6 py-4",children:[e.jsx(ms,{value:"therapist",className:"mt-0 h-full",children:e.jsx(Ym,{bookingData:i,updateBookingData:g,onNext:x})}),e.jsx(ms,{value:"date",className:"mt-0 h-full",children:e.jsx(Wm,{bookingData:i,updateBookingData:g,onNext:x,onPrevious:j})}),e.jsx(ms,{value:"time",className:"mt-0 h-full",children:e.jsx(Km,{bookingData:i,updateBookingData:g,onNext:x,onPrevious:j})}),e.jsx(ms,{value:"summary",className:"mt-0 h-full",children:e.jsx(Jm,{therapistId:i.therapistId||null,selectedDate:i.selectedDate||null,selectedTime:i.selectedTime||null,therapistName:i.therapistName||null,onBookingSuccess:f,onBack:j})})]})]}),!u&&e.jsx("div",{className:"px-4 sm:px-6 py-4 border-t shrink-0 bg-gray-50/50",children:e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Initial consultations can be rescheduled or cancelled up to 24 hours before the scheduled time. Follow-up appointments will be scheduled during your consultation based on your treatment plan."})})]})})})},Xm=()=>{const s=we(),[t,a]=l.useState(!1),r=[{id:"book",label:"Book Consultation",icon:mt,color:"bg-blue-600 hover:bg-blue-700",onClick:()=>a(!0)},{id:"calendar",label:"Calendar",icon:X,color:"bg-green-600 hover:bg-green-700",onClick:()=>s("/calendar")},{id:"video",label:"Video Session",icon:ne,color:"bg-purple-600 hover:bg-purple-700",onClick:()=>s("/video-session/current")},{id:"messages",label:"Messages",icon:ut,color:"bg-orange-600 hover:bg-orange-700",onClick:()=>s("/messages")}];return e.jsxs(e.Fragment,{children:[e.jsxs(R,{children:[e.jsx(I,{className:"pb-3",children:e.jsx(O,{className:"text-lg",children:"Quick Actions"})}),e.jsx(T,{children:e.jsx("div",{className:"grid grid-cols-2 gap-3 md:gap-4",children:r.map(({id:n,label:o,icon:i,color:c,onClick:u})=>e.jsxs(N,{onClick:u,className:`${c} text-white p-4 md:p-6 h-auto min-h-[100px] md:min-h-[120px] flex flex-col items-center justify-center gap-3 transition-transform active:scale-95 hover:shadow-lg`,children:[e.jsx(i,{className:"h-7 w-7 md:h-8 md:w-8"}),e.jsx("span",{className:"text-sm md:text-base font-medium text-center leading-tight",children:o})]},n))})})]}),e.jsx(Vi,{isOpen:t,onClose:()=>a(!1)})]})},Zm=()=>{const{data:s,isLoading:t}=Li();if(t)return e.jsx(R,{className:"mb-6",children:e.jsx(T,{className:"py-4",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[...Array(4)].map((r,n)=>e.jsxs("div",{className:"flex items-center gap-3 animate-pulse p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"h-12 w-12 bg-muted rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx("div",{className:"h-5 bg-muted rounded w-12"}),e.jsx("div",{className:"h-3 bg-muted rounded w-16"})]})]},n))})})});if(!s)return null;const a=[{label:"Sessions",value:s.totalSessions,subtext:"completed",icon:Tc,color:"bg-blue-100 text-blue-700"},{label:"Goals",value:`${s.completedGoals}/${s.totalGoals}`,subtext:"achieved",icon:Pe,color:"bg-green-100 text-green-700"},{label:"Progress",value:`${Math.round(s.treatmentPlanProgress)}%`,subtext:"complete",icon:qs,color:"bg-purple-100 text-purple-700"},{label:"Streak",value:`${s.streakDays}d`,subtext:"current",icon:te,color:"bg-orange-100 text-orange-700"}];return e.jsx(R,{className:"mb-6",children:e.jsx(T,{className:"py-4",children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4",children:a.map((r,n)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-gradient-to-br from-gray-50 to-white border border-gray-100 hover:shadow-sm transition-shadow",children:[e.jsx(D,{variant:"secondary",className:`${r.color} h-12 w-12 rounded-full flex items-center justify-center p-0 shrink-0`,children:e.jsx(r.icon,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-base md:text-lg font-bold",children:r.value}),e.jsx("div",{className:"text-xs text-muted-foreground",children:r.label})]})]},n))})})})},Gi=()=>{const{data:s=[],isLoading:t}=le({queryKey:["patient-resources"],queryFn:async()=>{const{data:n,error:o}=await w.from("patient_resources").select("*").eq("is_active",!0).order("is_featured",{ascending:!1}).order("created_at",{ascending:!1}).limit(10);if(o)throw o;return n}}),a=s.filter(n=>n.is_featured),r=s.filter(n=>!n.is_featured);return{resources:s,featuredResources:a,recentResources:r,isLoading:t}},eu=()=>{const{t:s}=Ze(),t=we(),{resources:a,isLoading:r}=Gi(),n=c=>{switch(c){case"video":return e.jsx(ne,{className:"h-4 w-4"});case"audio":return e.jsx(An,{className:"h-4 w-4"});case"exercise":return e.jsx(Tn,{className:"h-4 w-4"});default:return e.jsx(is,{className:"h-4 w-4"})}},o=c=>{switch(c){case"video":return"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300";case"audio":return"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300";case"exercise":return"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";default:return"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300"}},i=c=>yr(new Date(c),br(new Date,7));return e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsxs("div",{children:[e.jsx(O,{children:s("resources")||"Resources"}),e.jsx(me,{children:"Helpful content for your journey"})]}),e.jsxs(N,{variant:"outline",size:"sm",className:"flex items-center gap-1",onClick:()=>t("/patient/resources"),children:[e.jsx(mt,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Browse Library"})]})]}),e.jsx(T,{children:r?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(c=>e.jsxs("div",{className:"flex items-center p-3 rounded-lg",children:[e.jsx("div",{className:"h-8 w-8 bg-muted rounded-full mr-3 animate-pulse"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"h-3 bg-muted rounded w-16 animate-pulse"})]})]},c))}):e.jsx("div",{className:"space-y-3",children:a.slice(0,3).map(c=>e.jsxs("div",{className:"flex items-center p-3 rounded-lg hover:bg-accent/50 transition-colors cursor-pointer",onClick:()=>{c.content_url&&window.open(c.content_url,"_blank")},children:[e.jsx("div",{className:`rounded-full p-2 mr-3 ${o(c.resource_type)}`,children:n(c.resource_type)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("h4",{className:"font-medium",children:c.title}),i(c.created_at)&&e.jsx("span",{className:"ml-2 px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300",children:"New"})]}),e.jsx("p",{className:"text-xs text-muted-foreground capitalize",children:c.resource_type})]}),e.jsx(zt,{className:"h-4 w-4 text-muted-foreground"})]},c.id))})}),e.jsx(Wt,{className:"pt-0",children:e.jsx(N,{variant:"ghost",size:"sm",className:"w-full",onClick:()=>t("/patient/resources"),children:"View All Resources"})})]})},su=s=>{const{toast:t}=Z(),a=Le(),{data:r=[],isLoading:n}=le({queryKey:["patient-goals",s],queryFn:async()=>{const{data:u,error:m}=await w.from("patient_goals").select("*").eq("patient_id",s).order("created_at",{ascending:!1});if(m)throw m;return u},enabled:!!s}),o=Se({mutationFn:async({goalId:u,progress:m})=>{const{data:h,error:p}=await w.from("patient_goals").update({progress_percentage:m,status:m>=100?"completed":"active"}).eq("id",u).eq("patient_id",s).select().single();if(p)throw p;return h},onSuccess:u=>{a.invalidateQueries({queryKey:["patient-goals",s]}),u.status!=="completed"&&t({title:"Goal updated",description:"Your progress has been saved."})},onError:u=>{t({title:"Error updating goal",description:u.message,variant:"destructive"})}}),i=r.filter(u=>u.status==="active"),c=r.filter(u=>u.status==="completed");return{goals:r,activeGoals:i,completedGoals:c,isLoading:n,updateGoalProgress:o.mutate,isUpdating:o.isPending}},tu=()=>{const{user:s}=V();return le({queryKey:["onboarding-status",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t,error:a}=await w.from("appointments").select("id").eq("patient_id",s.id).in("status",["scheduled","confirmed","completed"]).limit(1);if(a)throw a;const r=((t==null?void 0:t.length)||0)>0,{data:n,error:o}=await w.from("patient_therapist_relationships").select("id").eq("patient_id",s.id).eq("relationship_status","active").limit(1);if(o)throw o;const i=((n==null?void 0:n.length)||0)>0,{data:c,error:u}=await w.from("patient_goals").select("id").eq("patient_id",s.id).eq("status","active").limit(1);if(u)throw u;const m=((c==null?void 0:c.length)||0)>0;return{hasScheduledFirstSession:r,hasSelectedTherapist:i,hasSetInitialGoals:m,isOnboardingComplete:r&&i&&m}},enabled:!!(s!=null&&s.id),staleTime:30*1e3})},Hi=l.createContext(void 0),zs=()=>{const s=l.useContext(Hi);if(s===void 0)throw new Error("useOnboarding must be used within an OnboardingProvider");return s},au=({children:s})=>{const{data:t,isLoading:a,refetch:r}=tu(),[n,o]=l.useState("therapist"),i={hasScheduledFirstSession:(t==null?void 0:t.hasScheduledFirstSession)||!1,hasSelectedTherapist:(t==null?void 0:t.hasSelectedTherapist)||!1,hasSetInitialGoals:(t==null?void 0:t.hasSetInitialGoals)||!1,isOnboardingComplete:(t==null?void 0:t.isOnboardingComplete)||!1,currentStep:n};l.useEffect(()=>{t&&(t.hasSelectedTherapist?t.hasScheduledFirstSession?t.hasSetInitialGoals?o("complete"):o("goals"):o("session"):o("therapist"))},[t]);const c=m=>{o(m)},u=m=>{r()};return e.jsx(Hi.Provider,{value:{state:i,setStep:c,markStepComplete:u,isLoading:a,refetch:r},children:s})},sa=l.forwardRef(({className:s,...t},a)=>e.jsx("textarea",{className:C("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:a,...t}));sa.displayName="Textarea";const ru=[{id:"anxiety-management",title:"Manage Anxiety Better",description:"Learn coping strategies to reduce anxiety in daily situations",category:"anxiety",suggestedTimeframe:8,examples:["Practice deep breathing when feeling anxious","Identify and challenge negative thoughts","Use grounding techniques in stressful situations"]},{id:"depression-recovery",title:"Improve Daily Mood",description:"Develop habits and strategies to feel more positive day-to-day",category:"depression",suggestedTimeframe:12,examples:["Establish a consistent morning routine","Engage in enjoyable activities regularly","Build a support network"]},{id:"relationship-improvement",title:"Build Better Relationships",description:"Strengthen connections with family, friends, or romantic partners",category:"relationships",suggestedTimeframe:10,examples:["Communicate needs more clearly","Set healthy boundaries","Practice active listening skills"]},{id:"stress-reduction",title:"Reduce Daily Stress",description:"Learn to manage work, life, and emotional stress more effectively",category:"stress",suggestedTimeframe:6,examples:["Develop time management skills","Practice relaxation techniques","Learn to say no when overwhelmed"]},{id:"self-esteem-building",title:"Build Self-Confidence",description:"Develop a more positive self-image and increase self-worth",category:"self-esteem",suggestedTimeframe:10,examples:["Challenge negative self-talk","Celebrate personal achievements","Practice self-compassion"]},{id:"communication-skills",title:"Improve Communication",description:"Express thoughts and feelings more clearly and assertively",category:"communication",suggestedTimeframe:8,examples:['Use "I" statements when expressing feelings',"Practice assertiveness without aggression","Learn conflict resolution skills"]}],ca=s=>({anxiety:"bg-blue-100 text-blue-800 border-blue-200",depression:"bg-purple-100 text-purple-800 border-purple-200",relationships:"bg-pink-100 text-pink-800 border-pink-200",stress:"bg-orange-100 text-orange-800 border-orange-200","self-esteem":"bg-green-100 text-green-800 border-green-200",communication:"bg-indigo-100 text-indigo-800 border-indigo-200"})[s],Yi=()=>{const{user:s}=V(),{markStepComplete:t,setStep:a}=zs(),{toast:r}=Z(),n=Le(),[o,i]=l.useState("select"),[c,u]=l.useState([]),[m,h]=l.useState(0),p=Se({mutationFn:async f=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const y=f.map(_=>{var k;return{patient_id:s.id,title:_.title,description:_.customDescription||_.description,target_date:((k=_.targetDate)==null?void 0:k.toISOString().split("T")[0])||null,status:"active",progress_percentage:0}}),{error:b}=await w.from("patient_goals").insert(y);if(b)throw b},onSuccess:()=>{r({title:"Goals Created!",description:`You've successfully set ${c.length} therapy goals.`}),n.invalidateQueries({queryKey:["onboarding-status"]}),n.invalidateQueries({queryKey:["patient-goals"]}),t("hasSetInitialGoals"),a("complete")},onError:f=>{r({title:"Error",description:"Failed to create goals. Please try again.",variant:"destructive"})}}),d=f=>{if(c.find(y=>y.id===f.id))u(y=>y.filter(b=>b.id!==f.id));else if(c.length<3){const y=yo(new Date,f.suggestedTimeframe);u(b=>[...b,{...f,targetDate:y}])}},x=(f,y)=>{u(b=>b.map((_,k)=>k===f?{..._,...y}:_))},j=()=>{o==="select"&&c.length>0?i("customize"):o==="customize"?m<c.length-1?h(f=>f+1):i("summary"):o==="summary"&&p.mutate(c)},g=()=>{o==="customize"&&m>0?h(f=>f-1):o==="customize"&&m===0?i("select"):o==="summary"&&(h(c.length-1),i("customize"))},v=o==="customize"?c[m]:null;return o==="select"?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Set Your Therapy Goals"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose 1-3 areas you'd like to focus on. You can always adjust these later with your therapist."})]}),e.jsxs(T,{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:ru.map(f=>{const y=c.find(b=>b.id===f.id);return e.jsx(R,{className:`cursor-pointer transition-all hover:shadow-md ${y?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>d(f),children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx(D,{className:ca(f.category),children:f.category}),y&&e.jsx(fe,{className:"h-5 w-5 text-primary"})]}),e.jsx("h3",{className:"font-medium mb-2",children:f.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:f.description}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-gray-700",children:"Examples:"}),f.examples.slice(0,2).map((b,_)=>e.jsxs("p",{className:"text-xs text-gray-600",children:["• ",b]},_))]}),e.jsxs("div",{className:"flex items-center gap-1 mt-3 text-xs text-muted-foreground",children:[e.jsx(X,{className:"h-3 w-3"}),e.jsxs("span",{children:["Suggested timeframe: ",f.suggestedTimeframe," weeks"]})]})]})},f.id)})}),c.length>0&&e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:["Selected Goals (",c.length,"/3)"]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:c.map(f=>e.jsx(D,{variant:"secondary",children:f.title},f.id))})]}),e.jsxs(N,{onClick:j,className:"flex items-center gap-2",children:["Customize Goals",e.jsx(js,{className:"h-4 w-4"})]})]})}),c.length===0&&e.jsxs("div",{className:"text-center py-6 text-muted-foreground",children:[e.jsx(Pe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Select goals that resonate with you to get started"})]})]})]}):o==="customize"&&v?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Customize Goal ",m+1," of ",c.length]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Make this goal more specific to your situation"})]}),e.jsxs(T,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:v.title}),e.jsx(D,{className:ca(v.category),children:v.category})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Goal Description"}),e.jsx(sa,{value:v.customDescription||v.description,onChange:f=>x(m,{customDescription:f.target.value}),placeholder:"Describe what you want to achieve...",className:"min-h-[100px]"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You can personalize this description or keep the default"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Target Date"}),e.jsx("input",{type:"date",value:v.targetDate?xe(v.targetDate,"yyyy-MM-dd"):"",onChange:f=>{const y=f.target.value?new Date(f.target.value):void 0;x(m,{targetDate:y})},className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["When would you like to achieve this goal? (suggested: ",v.suggestedTimeframe," weeks)"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t pt-4",children:[e.jsx(N,{variant:"outline",onClick:g,children:m===0?"Back to Selection":"Previous Goal"}),e.jsxs(N,{onClick:j,className:"flex items-center gap-2",children:[m===c.length-1?"Review Goals":"Next Goal",e.jsx(js,{className:"h-4 w-4"})]})]})]})]}):o==="summary"?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Review Your Goals"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Here's a summary of your therapy goals. You can discuss and adjust these with your therapist."})]}),e.jsxs(T,{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:c.map((f,y)=>e.jsx(R,{className:"bg-muted/30",children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:f.title}),e.jsx(D,{className:ca(f.category),children:f.category})]}),f.targetDate&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Target: ",xe(f.targetDate,"MMM dd, yyyy")]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:f.customDescription||f.description})]})},f.id))}),e.jsxs("div",{className:"flex items-center justify-between border-t pt-4",children:[e.jsx(N,{variant:"outline",onClick:g,children:"Make Changes"}),e.jsxs(N,{onClick:j,disabled:p.isPending,className:"flex items-center gap-2",children:[p.isPending?"Creating Goals...":"Create My Goals",e.jsx(fe,{className:"h-4 w-4"})]})]})]})]}):null},nu=()=>{const{user:s}=V(),{state:t}=zs(),{activeGoals:a,completedGoals:r,isLoading:n}=su((s==null?void 0:s.id)||""),[o,i]=l.useState(!1);return n?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),e.jsx(O,{children:"Goals"})]}),e.jsx(me,{children:"Track your therapy progress"})]}),e.jsx(T,{children:e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"h-2 bg-muted rounded animate-pulse"})]},c))})})]}):e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),e.jsx(O,{children:"Goals"})]}),e.jsx(me,{children:"Track your therapy progress"})]}),e.jsxs("div",{className:"flex items-center text-sm text-muted-foreground",children:[e.jsx(qs,{className:"h-4 w-4 mr-1"}),r.length," completed"]})]}),e.jsx(T,{children:a.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(Pe,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),t.isOnboardingComplete?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"No active goals yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Your therapist will help you set goals during your sessions"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Set Your First Goals"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Define what you want to achieve in therapy"}),e.jsxs(N,{variant:"outline",size:"sm",className:"mt-3",onClick:()=>i(!0),children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"Set Your Goals"]})]})]}):e.jsx("div",{className:"space-y-4",children:a.slice(0,3).map(c=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium text-sm",children:c.title}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c.progress_percentage,"%"]})]}),e.jsx(Os,{value:c.progress_percentage,className:"h-2"}),c.target_date&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Target: ",xe(new Date(c.target_date),"MMM dd, yyyy")]})]},c.id))})}),e.jsx(Wt,{className:"pt-0",children:e.jsxs(N,{variant:"ghost",size:"sm",className:"w-full",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"View All Goals"]})}),e.jsx(He,{open:o,onOpenChange:i,children:e.jsxs($e,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(xn,{children:e.jsx(Oe,{children:e.jsx(Fe,{children:"Goals Setup"})})}),e.jsx(Yi,{})]})})]})},Wi=l.forwardRef(({className:s,children:t,...a},r)=>e.jsxs(gn,{ref:r,className:C("relative overflow-hidden",s),...a,children:[e.jsx(Zo,{className:"h-full w-full rounded-[inherit]",children:t}),e.jsx(Qi,{}),e.jsx(ec,{})]}));Wi.displayName=gn.displayName;const Qi=l.forwardRef(({className:s,orientation:t="vertical",...a},r)=>e.jsx(fn,{ref:r,orientation:t,className:C("flex touch-none select-none transition-colors",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...a,children:e.jsx(sc,{className:"relative flex-1 rounded-full bg-border"})}));Qi.displayName=fn.displayName;class iu{constructor(){J(this,"listeners",new Set)}addListener(t){return this.listeners.add(t),()=>this.listeners.delete(t)}addActivity(t){const a={...t,id:Date.now().toString()+Math.random().toString(36),isNew:!0};this.listeners.forEach(r=>r(a))}}const ou=new iu,cu=(s=10)=>{const[t,a]=l.useState([]);return l.useEffect(()=>{const r=ou.addListener(n=>{a(o=>[n,...o].slice(0,s)),setTimeout(()=>{a(o=>o.map(i=>i.id===n.id?{...i,isNew:!1}:i))},3e3)});return()=>{r()}},[s]),t},lu=()=>{const s=cu(10),t=n=>{switch(n){case"mood":return e.jsx(ws,{className:"h-4 w-4"});case"goal":return e.jsx(Pe,{className:"h-4 w-4"});case"appointment":return e.jsx(X,{className:"h-4 w-4"});case"message":return e.jsx(ut,{className:"h-4 w-4"});case"resource":return e.jsx(Tt,{className:"h-4 w-4"});default:return e.jsx(te,{className:"h-4 w-4"})}},a=n=>{switch(n){case"mood":return"bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300";case"goal":return"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300";case"appointment":return"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";case"message":return"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300";case"resource":return"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300";default:return"bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300"}},r=n=>bo(n)?xe(n,"h:mm a"):wo(n)?"Yesterday":xe(n,"MMM d");return e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Tt,{className:"h-5 w-5"}),"Live Activity"]})}),e.jsx(T,{children:e.jsx(Wi,{className:"h-[300px]",children:e.jsx("div",{className:"space-y-3",children:s.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(te,{className:"h-8 w-8 mx-auto text-muted-foreground mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No recent activity"})]}):s.map(n=>e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg transition-all duration-300 ${n.isNew?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":"hover:bg-muted/50"}`,children:[e.jsx("div",{className:`rounded-full p-2 ${a(n.type)}`,children:t(n.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:n.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.isNew&&e.jsx(D,{variant:"secondary",className:"text-xs",children:"New"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:r(n.timestamp)})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1 truncate",children:n.description})]})]},n.id))})})})]})},Ja=()=>{const{user:s}=V(),t=le({queryKey:["patient-inquiries",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:a,error:r}=await w.from("patient_inquiries").select("*").eq("patient_id",s.id).order("created_at",{ascending:!1});if(r)throw r;const n=[...new Set(a==null?void 0:a.map(c=>c.therapist_id))],{data:o}=await w.from("profiles").select("id, full_name").in("id",n),i=new Map((o==null?void 0:o.map(c=>[c.id,c.full_name]))||[]);return(a==null?void 0:a.map(c=>({...c,therapist_name:i.get(c.therapist_id)||"Therapist"})))||[]},enabled:!!(s!=null&&s.id)});return{...t,patientInquiries:t.data??[]}},du=s=>le({queryKey:["inquiry-responses",s],queryFn:async()=>{const{data:t,error:a}=await w.from("inquiry_responses").select("*").eq("inquiry_id",s).order("created_at",{ascending:!0});if(a)throw a;const r=[...new Set(t==null?void 0:t.map(i=>i.responder_id))],{data:n}=await w.from("profiles").select("id, full_name").in("id",r),o=new Map((n==null?void 0:n.map(i=>[i.id,i.full_name]))||[]);return(t==null?void 0:t.map(i=>({...i,responder_name:o.get(i.responder_id)||"Responder"})))||[]},enabled:!!s}),mu=()=>{const{user:s}=V(),{toast:t}=Z(),a=Le();return Se({mutationFn:async r=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:n,error:o}=await w.from("patient_inquiries").insert({...r,patient_id:s.id,priority:r.priority||"normal"}).select().single();if(o)throw o;return n},onSuccess:()=>{a.invalidateQueries({queryKey:["patient-inquiries"]}),t({title:"Inquiry sent",description:"Your inquiry has been sent to your therapist."})},onError:r=>{t({title:"Error",description:"Failed to send inquiry. Please try again.",variant:"destructive"})}})},uu=({onMenuClick:s})=>{var i,c;const{user:t}=V(),{patientInquiries:a}=Ja(),n=(((i=t==null?void 0:t.user_metadata)==null?void 0:i.name)||((c=t==null?void 0:t.email)==null?void 0:c.split("@")[0])||"Patient").split(" ").map(u=>u[0]).join("").toUpperCase().slice(0,2),o=a.filter(u=>u.status==="responded").length;return e.jsx("header",{className:"lg:hidden sticky top-0 z-40 bg-white border-b border-gray-200 safe-area-top",children:e.jsxs("div",{className:"flex items-center justify-between h-16 px-4",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:s,className:"h-10 w-10","aria-label":"Open menu",children:e.jsx(Sn,{className:"h-6 w-6"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-8 w-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-sm",children:"MB"})}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:"MindBloom"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{variant:"ghost",size:"icon",className:"h-10 w-10 relative","aria-label":"Notifications",children:[e.jsx(Tt,{className:"h-5 w-5"}),o>0&&e.jsx(D,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs",children:o})]}),e.jsx(es,{className:"h-9 w-9",children:e.jsx(ss,{className:"bg-gradient-to-br from-blue-500 to-purple-600 text-white text-sm",children:n})})]})]})})},hu=({onMoreClick:s})=>{const t=we(),a=vs(),r=[{id:"dashboard",label:"Home",icon:Ws,path:"/patient",color:"text-blue-600"},{id:"book",label:"Book",icon:X,path:"/patient/book",color:"text-green-600"},{id:"sessions",label:"Sessions",icon:ne,path:"/patient/history",color:"text-purple-600"},{id:"messages",label:"Messages",icon:ut,path:"/patient/inquiries",color:"text-orange-600"},{id:"more",label:"More",icon:Ac,path:null,color:"text-gray-600"}],n=i=>i?i==="/patient"?a.pathname==="/patient":a.pathname.startsWith(i):!1,o=i=>{i.id==="more"?s():i.path&&t(i.path)};return e.jsx("nav",{className:"lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 safe-area-bottom",style:{paddingBottom:"env(safe-area-inset-bottom)"},children:e.jsx("div",{className:"flex items-center justify-around h-16 px-2",children:r.map(i=>{const c=i.icon,u=n(i.path);return e.jsxs("button",{onClick:()=>o(i),className:C("flex flex-col items-center justify-center flex-1 min-w-0 h-full transition-colors duration-200","focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 rounded-lg","active:scale-95 transform"),"aria-label":i.label,"aria-current":u?"page":void 0,children:[e.jsx(c,{className:C("h-6 w-6 mb-1 transition-all duration-200",u?i.color:"text-gray-400",u&&"scale-110")}),e.jsx("span",{className:C("text-xs font-medium transition-colors duration-200",u?i.color:"text-gray-500"),children:i.label})]},i.id)})})})},pu=({isOpen:s,onClose:t})=>{var j,g;const a=we(),{user:r,signOut:n}=V(),{patientInquiries:o}=Ja(),i=((j=r==null?void 0:r.user_metadata)==null?void 0:j.name)||((g=r==null?void 0:r.email)==null?void 0:g.split("@")[0])||"Patient",c=(r==null?void 0:r.email)||"",u=i.split(" ").map(v=>v[0]).join("").toUpperCase().slice(0,2),m=o.filter(v=>v.status==="responded").length,h=[{id:"treatment-plans",label:"Treatment Plans",icon:is,path:"/patient/treatment-plans",badge:null},{id:"history",label:"Session History",icon:te,path:"/patient/history",badge:null},{id:"inquiries",label:"My Inquiries",icon:qe,path:"/patient/inquiries",badge:m},{id:"resources",label:"Resources",icon:mt,path:"/patient/resources",badge:null}],p=[{id:"profile",label:"Profile Settings",icon:Be,path:"/profile"},{id:"settings",label:"App Settings",icon:hs,path:"/settings"},{id:"help",label:"Help & Support",icon:Ec,path:"/help"}],d=v=>{a(v),t()},x=async()=>{await n(),t()};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:C("lg:hidden fixed inset-0 bg-black/50 z-50 transition-opacity duration-300",s?"opacity-100":"opacity-0 pointer-events-none"),onClick:t,"aria-hidden":"true"}),e.jsxs("aside",{className:C("lg:hidden fixed top-0 left-0 bottom-0 w-80 max-w-[85vw] bg-white z-50 shadow-2xl","transform transition-transform duration-300 ease-in-out","flex flex-col",s?"translate-x-0":"-translate-x-full"),"aria-label":"Navigation drawer",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(es,{className:"h-12 w-12",children:e.jsx(ss,{className:"bg-gradient-to-br from-blue-500 to-purple-600 text-white",children:u})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-gray-900 truncate",children:i}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:c})]})]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:t,className:"h-8 w-8","aria-label":"Close menu",children:e.jsx(rs,{className:"h-5 w-5"})})]}),e.jsxs("nav",{className:"flex-1 overflow-y-auto p-4 space-y-1",children:[e.jsx("div",{className:"space-y-1",children:h.map(v=>{const f=v.icon;return e.jsxs("button",{onClick:()=>d(v.path),className:"w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors hover:bg-gray-100 active:bg-gray-200",children:[e.jsx(f,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"flex-1 font-medium text-gray-900",children:v.label}),v.badge&&v.badge>0&&e.jsx(D,{variant:"destructive",className:"h-5 min-w-[20px] rounded-full px-1.5 text-xs",children:v.badge})]},v.id)})}),e.jsx(jt,{className:"my-4"}),e.jsx("div",{className:"space-y-1",children:p.map(v=>{const f=v.icon;return e.jsxs("button",{onClick:()=>d(v.path),className:"w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors hover:bg-gray-100 active:bg-gray-200",children:[e.jsx(f,{className:"h-5 w-5 text-gray-600"}),e.jsx("span",{className:"flex-1 font-medium text-gray-900",children:v.label})]},v.id)})})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs(N,{variant:"ghost",onClick:x,className:"w-full justify-start text-red-600 hover:text-red-700 hover:bg-red-50",children:[e.jsx(Ls,{className:"h-5 w-5 mr-3"}),"Sign Out"]})})]})]})},xu=({onOpenOnboardingFlow:s})=>{const{state:t,setStep:a}=zs(),r=[{key:"therapist",title:"Choose Your Therapist",description:"Find the right match for your needs",completed:t.hasSelectedTherapist},{key:"session",title:"Schedule First Session",description:"Book your initial consultation",completed:t.hasScheduledFirstSession},{key:"goals",title:"Set Your Goals",description:"Define what you want to achieve",completed:t.hasSetInitialGoals}],n=r.filter(m=>m.completed).length,o=n/r.length*100,i=r.findIndex(m=>!m.completed),c=i!==-1?r[i]:null,u=()=>{c&&(a(c.key),s==null||s())};return e.jsxs(R,{className:"bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200 mb-6",children:[e.jsx(I,{children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-full",children:e.jsx(ws,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(O,{className:"text-2xl font-bold text-gray-800",children:"Welcome to Your Mental Health Journey"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Let's get you started with just a few simple steps"})]})]})})}),e.jsxs(T,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium text-gray-700",children:"Setup Progress"}),e.jsxs("span",{className:"text-gray-600",children:[n," of ",r.length," complete"]})]}),e.jsx(Os,{value:o,className:"h-2"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:r.map((m,h)=>e.jsxs("div",{className:`flex items-start gap-3 p-4 rounded-lg transition-all ${m.completed?"bg-green-50 border border-green-200":(c==null?void 0:c.key)===m.key?"bg-blue-50 border border-blue-200":"bg-white border border-gray-200"}`,children:[m.completed?e.jsx(fe,{className:"h-5 w-5 text-green-600 mt-0.5 flex-shrink-0"}):e.jsx(Na,{className:`h-5 w-5 mt-0.5 flex-shrink-0 ${(c==null?void 0:c.key)===m.key?"text-blue-600":"text-gray-400"}`}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:`font-medium ${m.completed?"text-green-800":(c==null?void 0:c.key)===m.key?"text-blue-800":"text-gray-800"}`,children:m.title}),e.jsx("p",{className:`text-sm ${m.completed?"text-green-600":(c==null?void 0:c.key)===m.key?"text-blue-600":"text-gray-600"}`,children:m.description})]})]},m.key))}),!t.isOnboardingComplete&&c&&e.jsxs("div",{className:"flex items-center justify-between bg-white/70 p-4 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-800",children:"Next Step"}),e.jsx("p",{className:"text-sm text-gray-600",children:c.description})]}),e.jsxs(N,{onClick:u,className:"flex items-center gap-2",children:[c.title,e.jsx(zt,{className:"h-4 w-4"})]})]}),t.isOnboardingComplete&&e.jsx("div",{className:"bg-green-50 border border-green-200 p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{className:"h-6 w-6 text-green-600"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-green-800",children:"Setup Complete!"}),e.jsx("p",{className:"text-sm text-green-600",children:"You're all set to begin your therapy journey. Explore your dashboard below."})]})]})})]})]})},gu=()=>{const{user:s}=V(),{markStepComplete:t,setStep:a}=zs(),{toast:r}=Z(),n=Le(),[o,i]=l.useState(null),{data:c=[],isLoading:u}=le({queryKey:["onboarding-therapists"],queryFn:async()=>{const{data:d,error:x}=await w.from("profiles").select(`
          id, 
          full_name, 
          bio, 
          specializations, 
          hourly_rate, 
          years_experience, 
          avatar_url, 
          accepting_new_patients,
          location
        `).eq("account_type","therapist").eq("approval_status","approved").eq("accepting_new_patients",!0);if(x)throw x;return d||[]}}),m=Se({mutationFn:async d=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{error:x}=await w.from("patient_therapist_relationships").insert({patient_id:s.id,therapist_id:d,relationship_status:"active",start_date:new Date().toISOString().split("T")[0]});if(x)throw x;return d},onSuccess:d=>{r({title:"Therapist Selected!",description:"You can now schedule your first session."}),n.invalidateQueries({queryKey:["onboarding-status"]}),t("hasSelectedTherapist"),a("session")},onError:d=>{r({title:"Error",description:"Failed to select therapist. Please try again.",variant:"destructive"})}}),h=d=>{i(d),m.mutate(d)},p=d=>{const x=["bg-blue-100 text-blue-800","bg-green-100 text-green-800","bg-purple-100 text-purple-800","bg-pink-100 text-pink-800","bg-orange-100 text-orange-800"];return x[d.length%x.length]};return u?e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(ws,{className:"h-5 w-5"}),"Choose Your Therapist"]})}),e.jsx(T,{className:"flex justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"})})]}):e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(ws,{className:"h-5 w-5"}),"Choose Your Therapist"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Find a therapist who feels right for you. This is an important decision, so take your time."})]}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-6",children:[c.map(d=>{var x;return e.jsx(R,{className:`overflow-hidden transition-all hover:shadow-md ${o===d.id?"ring-2 ring-primary":""}`,children:e.jsx(T,{className:"p-4 md:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-start gap-4 sm:gap-6",children:[e.jsxs(es,{className:"h-16 w-16 sm:h-20 sm:w-20 shrink-0",children:[e.jsx(Us,{src:d.avatar_url||void 0,alt:d.full_name||"Therapist"}),e.jsx(ss,{className:"bg-gradient-to-br from-blue-500 to-purple-600 text-white text-lg",children:((x=d.full_name)==null?void 0:x.split(" ").map(j=>j[0]).join("").toUpperCase())||"T"})]}),e.jsxs("div",{className:"flex-1 min-w-0 w-full",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900",children:d.full_name||"Therapist"}),d.location&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-gray-600 mt-1",children:[e.jsx(Aa,{className:"h-4 w-4"}),e.jsx("span",{children:d.location})]})]}),e.jsx("p",{className:"text-sm sm:text-base text-gray-600 mb-4 line-clamp-3",children:d.bio||"Experienced therapist dedicated to helping clients achieve their mental health goals."}),d.specializations&&d.specializations.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Areas of Focus:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[d.specializations.slice(0,4).map((j,g)=>e.jsx(D,{variant:"secondary",className:`text-xs ${p(j)}`,children:j},g)),d.specializations.length>4&&e.jsxs(D,{variant:"outline",className:"text-xs",children:["+",d.specializations.length-4," more"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsx("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:d.years_experience&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{children:[d.years_experience," years experience"]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>{},className:"w-full sm:w-auto min-w-[120px]",children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"Learn More"]}),e.jsxs(N,{size:"sm",onClick:()=>h(d.id),disabled:m.isPending,className:"flex items-center justify-center gap-2 w-full sm:w-auto min-w-[160px]",children:[o===d.id?e.jsx(fe,{className:"h-4 w-4"}):e.jsx(ws,{className:"h-4 w-4"}),e.jsx("span",{className:"whitespace-nowrap",children:m.isPending&&o===d.id?"Selecting...":o===d.id?"Selected":"Choose This Therapist"})]})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"text-xs sm:text-sm font-medium text-blue-800 mb-1",children:"Why this might be a good match:"}),e.jsxs("p",{className:"text-xs sm:text-sm text-blue-700",children:[d.specializations&&d.specializations.length>0?`Specializes in ${d.specializations.slice(0,2).join(" and ")}`:"Experienced in general therapy approaches",d.years_experience&&` with ${d.years_experience} years of experience`]})]})]})]})})},d.id)}),c.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ws,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No Therapists Available"}),e.jsx("p",{className:"text-gray-600",children:"There are currently no therapists accepting new patients. Please check back later."})]})]})})]})},pr=({isOpen:s,onClose:t,therapistId:a})=>{const{user:r}=V(),{markStepComplete:n,setStep:o}=zs(),{toast:i}=Z(),c=Le(),[u,m]=l.useState(void 0),[h,p]=l.useState(""),{data:d}=le({queryKey:["therapist",a],queryFn:async()=>{const{data:f,error:y}=await w.from("profiles").select("full_name").eq("id",a).single();if(y)throw y;return f},enabled:!!a}),x=["09:00","10:00","11:00","14:00","15:00","16:00"],j=Se({mutationFn:async()=>{if(!(r!=null&&r.id)||!u||!h)throw new Error("Missing required information");const[f,y]=h.split(":").map(Number),b=rr(nr(u,f),y),_=rr(nr(u,f+1),y),{error:k}=await w.from("appointments").insert({patient_id:r.id,therapist_id:a,start_time:b.toISOString(),end_time:_.toISOString(),title:"Initial Consultation",appointment_type:"video",is_initial_consultation:!0,status:"scheduled",video_enabled:!0});if(k)throw k},onSuccess:()=>{i({title:"Session Scheduled!",description:"Your first consultation has been booked successfully."}),c.invalidateQueries({queryKey:["onboarding-status"]}),c.invalidateQueries({queryKey:["patient-dashboard-stats"]}),n("hasScheduledFirstSession"),o("goals"),t()},onError:f=>{i({title:"Error",description:"Failed to schedule session. Please try again.",variant:"destructive"})}}),g=()=>{j.mutate()},v=f=>{const y=new Date;return y.setHours(0,0,0,0),f<y||f.getDay()===0||f.getDay()===6};return e.jsx(He,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Oe,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Schedule Your First Session"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Book your initial consultation with ",(d==null?void 0:d.full_name)||"your therapist"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{className:"text-lg",children:"Choose a Date"})}),e.jsx(T,{children:e.jsx(Zt,{mode:"single",selected:u,onSelect:m,disabled:v,fromDate:new Date,toDate:wa(new Date,30),className:"rounded-md border"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsx(O,{className:"text-lg",children:"Choose a Time"})}),e.jsx(T,{children:u?e.jsx("div",{className:"grid grid-cols-2 gap-2",children:x.map(f=>e.jsxs(N,{variant:h===f?"default":"outline",size:"sm",onClick:()=>p(f),className:"justify-center",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),f]},f))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Please select a date first"})})]}),e.jsxs(R,{className:"bg-blue-50 border-blue-200",children:[e.jsx(I,{children:e.jsxs(O,{className:"text-lg flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-blue-600"}),"About Your First Session"]})}),e.jsxs(T,{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"60-minute initial consultation"})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Video call from the comfort of your home"})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Discuss your goals and create a treatment plan"})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"No commitment - see if it's a good fit"})]})]})]}),u&&h&&e.jsx(R,{className:"bg-green-50 border-green-200",children:e.jsxs(T,{className:"pt-6",children:[e.jsx("h3",{className:"font-medium text-green-800 mb-2",children:"Session Summary"}),e.jsxs("div",{className:"space-y-1 text-sm text-green-700",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",xe(u,"EEEE, MMMM d, yyyy")]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Time:"})," ",h]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Duration:"})," 60 minutes"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Type:"})," Video Call"]})]}),e.jsx(N,{className:"w-full mt-4",onClick:g,disabled:j.isPending,children:j.isPending?"Booking...":"Book This Session"})]})})]})]}),e.jsxs(R,{className:"mt-6",children:[e.jsx(I,{children:e.jsx(O,{className:"text-lg",children:"Preparing for Your First Session"})}),e.jsx(T,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"What to Expect:"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• Introductions and getting to know each other"}),e.jsx("li",{children:"• Discussion of your concerns and goals"}),e.jsx("li",{children:"• Overview of therapy approaches"}),e.jsx("li",{children:"• Q&A about the process"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"How to Prepare:"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• Think about what brought you to therapy"}),e.jsx("li",{children:"• Consider your hopes and goals"}),e.jsx("li",{children:"• Prepare any questions you have"}),e.jsx("li",{children:"• Find a quiet, private space"})]})]})]})})]})]})})},fu=({isOpen:s,onClose:t})=>{const{user:a}=V(),{state:r}=zs(),[n,o]=l.useState(!1),{data:i}=le({queryKey:["selected-therapist",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return null;const{data:u,error:m}=await w.from("patient_therapist_relationships").select("therapist_id").eq("patient_id",a.id).eq("relationship_status","active").single();return m?null:(u==null?void 0:u.therapist_id)||null},enabled:!!(a!=null&&a.id)&&r.hasSelectedTherapist});se.useEffect(()=>{r.hasSelectedTherapist&&!r.hasScheduledFirstSession&&i&&o(!0)},[r.hasSelectedTherapist,r.hasScheduledFirstSession,i]);const c=()=>{switch(r.currentStep){case"therapist":return e.jsx(gu,{});case"session":return i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Great! You've selected your therapist."}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Now let's schedule your first session."})]}),e.jsx(pr,{isOpen:n,onClose:()=>o(!1),therapistId:i})]}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading therapist information..."})});case"goals":return e.jsx(Yi,{});case"complete":return e.jsx("div",{className:"text-center py-12",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"All Set!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"You've completed your onboarding. Your therapy journey starts now!"}),e.jsx("button",{onClick:t,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary",children:"Explore Your Dashboard"})]})});default:return null}};return e.jsxs(e.Fragment,{children:[e.jsx(He,{open:s&&!n,onOpenChange:t,children:e.jsxs($e,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(xn,{children:e.jsx(Oe,{children:e.jsx(Fe,{children:"Onboarding Flow"})})}),c()]})}),i&&e.jsx(pr,{isOpen:n,onClose:()=>o(!1),therapistId:i})]})},ju=()=>{const{user:s}=V(),{state:t}=zs(),[a,r]=l.useState(!1),[n,o]=l.useState(!1);Ue("PatientDashboard","useAuthRBAC"),Oi((s==null?void 0:s.id)||"");const i=()=>{r(!0)},c=()=>{r(!1)},u=()=>{o(!0)},m=()=>{o(!1)};return e.jsxs(Xt,{children:[e.jsxs("div",{className:"min-h-screen flex w-full bg-gray-50",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsx(Bi,{})}),e.jsx("div",{className:"lg:hidden w-full",children:e.jsx(uu,{onMenuClick:u})}),e.jsx("main",{className:"flex-1 overflow-auto w-full",children:e.jsxs("div",{className:"p-4 pb-20 lg:p-6 lg:pb-6 space-y-4 lg:space-y-6 max-w-7xl mx-auto",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsx(Fi,{})}),t.isOnboardingComplete?e.jsx(qm,{}):e.jsx(xu,{onOpenOnboardingFlow:i}),e.jsx(Zm,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(Hm,{})}),e.jsx("div",{children:e.jsx(Xm,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6",children:[e.jsx("div",{children:e.jsx(nu,{})}),e.jsx("div",{children:e.jsx(eu,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6",children:[e.jsx("div",{children:e.jsx(lu,{})}),e.jsx("div",{})]})]})})]}),e.jsx(hu,{onMoreClick:u}),e.jsx(pu,{isOpen:n,onClose:m}),e.jsx(fu,{isOpen:a,onClose:c})]})},vu=()=>e.jsx(au,{children:e.jsx(ju,{})}),yu=()=>{const{data:s,isLoading:t}=Ja(),a=mu(),[r,n]=l.useState(!1),[o,i]=l.useState(null),[c,u]=l.useState({subject:"",message:"",inquiry_type:"general",therapist_id:"",priority:"normal"}),m=async()=>{var x;if(!c.subject||!c.message)return;const d=((x=s==null?void 0:s[0])==null?void 0:x.therapist_id)||"";await a.mutateAsync({...c,therapist_id:d}),n(!1),u({subject:"",message:"",inquiry_type:"general",therapist_id:"",priority:"normal"})},h=d=>{switch(d){case"pending":return"bg-yellow-100 text-yellow-800";case"responded":return"bg-green-100 text-green-800";case"closed":return"bg-gray-100 text-gray-800";default:return"bg-blue-100 text-blue-800"}},p=d=>{switch(d){case"high":return e.jsx(Je,{className:"h-4 w-4 text-red-500"});case"medium":return e.jsx(te,{className:"h-4 w-4 text-yellow-500"});default:return e.jsx(Ea,{className:"h-4 w-4 text-green-500"})}};return t?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-muted rounded w-1/4"}),[...Array(3)].map((d,x)=>e.jsxs(R,{children:[e.jsx(I,{children:e.jsx("div",{className:"h-4 bg-muted rounded w-3/4"})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 bg-muted rounded"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6"})]})})]},x))]})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"My Inquiries"}),e.jsx("p",{className:"text-muted-foreground",children:"Communicate with your therapist"})]}),e.jsxs(He,{open:r,onOpenChange:n,children:[e.jsx(Ua,{asChild:!0,children:e.jsxs(N,{children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"New Inquiry"]})}),e.jsxs($e,{className:"sm:max-w-md",children:[e.jsx(Oe,{children:e.jsx(Fe,{children:"Send New Inquiry"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ce,{htmlFor:"subject",children:"Subject"}),e.jsx(Ne,{id:"subject",value:c.subject,onChange:d=>u({...c,subject:d.target.value}),placeholder:"Brief description of your inquiry"})]}),e.jsxs("div",{children:[e.jsx(ce,{htmlFor:"type",children:"Type"}),e.jsxs(Ie,{value:c.inquiry_type,onValueChange:d=>u({...c,inquiry_type:d}),children:[e.jsx(Ee,{children:e.jsx(Me,{})}),e.jsxs(De,{children:[e.jsx(H,{value:"general",children:"General Question"}),e.jsx(H,{value:"appointment",children:"Appointment Related"}),e.jsx(H,{value:"treatment",children:"Treatment Question"}),e.jsx(H,{value:"billing",children:"Billing Question"}),e.jsx(H,{value:"urgent",children:"Urgent Matter"})]})]})]}),e.jsxs("div",{children:[e.jsx(ce,{htmlFor:"priority",children:"Priority"}),e.jsxs(Ie,{value:c.priority,onValueChange:d=>u({...c,priority:d}),children:[e.jsx(Ee,{children:e.jsx(Me,{})}),e.jsxs(De,{children:[e.jsx(H,{value:"low",children:"Low"}),e.jsx(H,{value:"normal",children:"Normal"}),e.jsx(H,{value:"high",children:"High"})]})]})]}),e.jsxs("div",{children:[e.jsx(ce,{htmlFor:"message",children:"Message"}),e.jsx(sa,{id:"message",value:c.message,onChange:d=>u({...c,message:d.target.value}),placeholder:"Describe your question or concern...",rows:4})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:m,disabled:!c.subject||!c.message||a.isPending,className:"flex-1",children:a.isPending?"Sending...":"Send Inquiry"}),e.jsx(N,{variant:"outline",onClick:()=>n(!1),children:"Cancel"})]})]})]})]})]}),s&&s.length>0?e.jsx("div",{className:"space-y-4",children:s.map(d=>e.jsxs(R,{className:"hover:shadow-md transition-shadow",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:d.subject}),p(d.priority)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ut,{className:"h-4 w-4"}),d.inquiry_type]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),Js(new Date(d.created_at),{addSuffix:!0})]}),e.jsxs("span",{children:["To: ",d.therapist_name]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:h(d.status),children:d.status}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>i(o===d.id?null:d.id),children:e.jsx(nt,{className:"h-4 w-4"})})]})]})}),e.jsxs(T,{children:[e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:d.message}),o===d.id&&e.jsx(bu,{inquiryId:d.id,inquiry:d})]})]},d.id))}):e.jsx(R,{children:e.jsxs(T,{className:"text-center py-12",children:[e.jsx(ut,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No inquiries yet"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Send your first inquiry to communicate with your therapist"}),e.jsxs(N,{onClick:()=>n(!0),children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"Send Your First Inquiry"]})]})})]})},bu=({inquiryId:s,inquiry:t})=>{const{data:a}=du(s);return e.jsxs("div",{className:"mt-4 pt-4 border-t space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Full Message"}),e.jsx("p",{className:"text-sm bg-muted p-3 rounded",children:t.message})]}),a&&a.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Responses"}),e.jsx("div",{className:"space-y-3",children:a.map(r=>e.jsxs("div",{className:"bg-blue-50 p-3 rounded",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:r.responder_name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:Js(new Date(r.created_at),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm",children:r.content})]},r.id))})]})]})},wu=()=>{const{user:s}=V();return le({queryKey:["patient-treatment-plans",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t}=await w.from("appointments").select("therapist_id").eq("patient_id",s.id).limit(1).maybeSingle();let a="Your Therapist";if(t!=null&&t.therapist_id){const{data:c}=await w.from("profiles").select("full_name").eq("id",t.therapist_id).single();a=(c==null?void 0:c.full_name)||"Your Therapist"}const{data:r}=await w.from("appointments").select("id").eq("patient_id",s.id).eq("status","completed"),n=(r==null?void 0:r.length)||0,o=Math.min(n/12*100,100),i={id:"1",title:"Anxiety Management and Coping Strategies",description:"A comprehensive treatment plan focused on developing healthy coping mechanisms and reducing anxiety symptoms through evidence-based therapeutic approaches.",goals:["Identify personal anxiety triggers","Learn and practice breathing techniques","Develop cognitive restructuring skills","Establish healthy daily routines","Build confidence in social situations"],start_date:new Date(Date.now()-30*24*60*60*1e3).toISOString(),end_date:new Date(Date.now()+60*24*60*60*1e3).toISOString(),status:n>0?"active":"pending",progress_percentage:o,therapist_id:(t==null?void 0:t.therapist_id)||"",therapist_name:a,created_at:new Date(Date.now()-30*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()};return n>0||t?[i]:[]},enabled:!!(s!=null&&s.id)})},Nu=()=>{const{user:s}=V();return le({queryKey:["patient-goals",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t}=await w.from("appointments").select("id").eq("patient_id",s.id).eq("status","completed"),a=(t==null?void 0:t.length)||0;return[{id:"1",title:"Complete initial assessment",description:"Participate in comprehensive initial therapy session",target_date:new Date(Date.now()+7*24*60*60*1e3).toISOString(),status:a>0?"completed":"in_progress",progress_notes:a>0?"Assessment completed successfully":"Scheduled for next session",created_at:new Date(Date.now()-30*24*60*60*1e3).toISOString()},{id:"2",title:"Learn breathing techniques",description:"Master 3 different breathing exercises for anxiety management",target_date:new Date(Date.now()+14*24*60*60*1e3).toISOString(),status:a>2?"completed":a>0?"in_progress":"pending",progress_notes:a>2?"All techniques learned and practiced":a>0?"Making good progress":null,created_at:new Date(Date.now()-25*24*60*60*1e3).toISOString()},{id:"3",title:"Develop daily mindfulness routine",description:"Establish a consistent 10-minute daily mindfulness practice",target_date:new Date(Date.now()+21*24*60*60*1e3).toISOString(),status:a>4?"completed":a>1?"in_progress":"pending",progress_notes:a>4?"Routine established successfully":a>1?"Started practicing regularly":null,created_at:new Date(Date.now()-20*24*60*60*1e3).toISOString()}]},enabled:!!(s!=null&&s.id)})},Su=()=>{const{data:s,isLoading:t}=wu(),{data:a,isLoading:r}=Nu(),n=i=>{switch(i){case"completed":return"bg-green-100 text-green-800";case"active":return"bg-blue-100 text-blue-800";case"in_progress":return"bg-yellow-100 text-yellow-800";case"pending":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}},o=i=>{switch(i){case"completed":return e.jsx(Ea,{className:"h-4 w-4 text-green-600"});case"active":case"in_progress":return e.jsx(te,{className:"h-4 w-4 text-blue-600"});case"pending":return e.jsx(Je,{className:"h-4 w-4 text-gray-600"});default:return e.jsx(te,{className:"h-4 w-4 text-gray-600"})}};return t||r?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-muted rounded w-1/3"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsx("div",{className:"h-6 bg-muted rounded w-3/4"})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-4 bg-muted rounded"}),e.jsx("div",{className:"h-4 bg-muted rounded w-5/6"}),e.jsx("div",{className:"h-2 bg-muted rounded"})]})})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsx("div",{className:"h-6 bg-muted rounded w-1/2"})}),e.jsx(T,{children:e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((i,c)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-muted rounded"})]},c))})})]})]})]})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Treatment Plans"}),e.jsx("p",{className:"text-muted-foreground",children:"Your personalized therapy journey and goals"})]}),s&&s.length>0?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5"}),"Active Treatment Plans"]}),s.map(i=>e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx(O,{className:"text-lg",children:i.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Be,{className:"h-4 w-4"}),i.therapist_name]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),"Started ",Js(new Date(i.start_date),{addSuffix:!0})]})]})]}),e.jsx(D,{className:n(i.status),children:i.status})]})}),e.jsxs(T,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:i.description}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Progress"}),e.jsxs("span",{children:[Math.round(i.progress_percentage),"%"]})]}),e.jsx(Os,{value:i.progress_percentage,className:"h-2"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-sm mb-2",children:"Treatment Goals"}),e.jsx("ul",{className:"space-y-1 text-sm",children:i.goals.map((c,u)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"h-1.5 w-1.5 bg-blue-600 rounded-full mt-2 flex-shrink-0"}),c]},u))})]}),i.end_date&&e.jsxs("div",{className:"text-xs text-muted-foreground pt-2 border-t",children:["Expected completion: ",xe(new Date(i.end_date),"MMM dd, yyyy")]})]})]},i.id))]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Current Goals"]}),a&&a.length>0?e.jsx("div",{className:"space-y-4",children:a.map(i=>e.jsx(R,{children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[o(i.status),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h4",{className:"font-medium text-sm",children:i.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:i.description})]})]}),e.jsx(D,{variant:"outline",className:n(i.status),children:i.status.replace("_"," ")})]}),i.target_date&&e.jsxs("div",{className:"text-xs text-muted-foreground mb-2",children:["Target: ",xe(new Date(i.target_date),"MMM dd, yyyy")]}),i.progress_notes&&e.jsxs("div",{className:"bg-muted p-2 rounded text-xs mt-2",children:[e.jsx("span",{className:"font-medium",children:"Progress: "}),i.progress_notes]})]})},i.id))}):e.jsx(R,{children:e.jsxs(T,{className:"text-center py-8",children:[e.jsx(Pe,{className:"h-8 w-8 text-muted-foreground mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No goals set yet"})]})})]})]}):e.jsx(R,{children:e.jsxs(T,{className:"text-center py-12",children:[e.jsx(mt,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Treatment Plan Yet"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Your therapist will create a personalized treatment plan after your initial consultation."}),e.jsx("div",{className:"bg-muted p-4 rounded-lg text-sm",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(qs,{className:"h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-medium",children:"Getting Started"}),e.jsx("p",{className:"text-muted-foreground",children:"Book your first session to begin developing your treatment plan and therapy goals."})]})]})})]})})]})},Cu=()=>{const{user:s}=V();return le({queryKey:["patient-session-history",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t,error:a}=await w.from("appointments").select(`
          id,
          title,
          start_time,
          end_time,
          status,
          appointment_type,
          session_notes,
          therapist_id
        `).eq("patient_id",s.id).in("status",["completed","cancelled"]).order("start_time",{ascending:!1});if(a)throw a;const r=[...new Set(t==null?void 0:t.map(i=>i.therapist_id))],{data:n}=await w.from("profiles").select("id, full_name").in("id",r),o=new Map((n==null?void 0:n.map(i=>[i.id,i.full_name]))||[]);return(t==null?void 0:t.map(i=>{const c=new Date(i.start_time),u=new Date(i.end_time),m=Math.round((u.getTime()-c.getTime())/(1e3*60));return{...i,therapist_name:o.get(i.therapist_id)||"Therapist",duration:m}}))||[]},enabled:!!(s!=null&&s.id)})},ku=()=>{const{user:s}=V();return le({queryKey:["patient-session-notes",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))throw new Error("User not authenticated");const{data:t,error:a}=await w.from("patient_notes").select(`
          id,
          title,
          content,
          note_type,
          created_at,
          is_private,
          therapist_id
        `).eq("patient_id",s.id).eq("is_private",!1).order("created_at",{ascending:!1});if(a)throw a;const r=[...new Set(t==null?void 0:t.map(i=>i.therapist_id))],{data:n}=await w.from("profiles").select("id, full_name").in("id",r),o=new Map((n==null?void 0:n.map(i=>[i.id,i.full_name]))||[]);return(t==null?void 0:t.map(i=>({...i,therapist_name:o.get(i.therapist_id)||"Therapist"})))||[]},enabled:!!(s!=null&&s.id)})},_u=()=>{const{data:s,isLoading:t}=Cu(),{data:a,isLoading:r}=ku(),[n,o]=l.useState(null),i=m=>{switch(m){case"completed":return"bg-green-100 text-green-800";case"cancelled":return"bg-red-100 text-red-800";case"no_show":return"bg-orange-100 text-orange-800";default:return"bg-gray-100 text-gray-800"}},c=m=>{switch(m){case"completed":return e.jsx(Ea,{className:"h-4 w-4 text-green-600"});case"cancelled":return e.jsx(Ns,{className:"h-4 w-4 text-red-600"});default:return e.jsx(te,{className:"h-4 w-4 text-gray-600"})}},u=m=>{switch(m){case"video":return e.jsx(ne,{className:"h-4 w-4"});case"phone":return e.jsx(X,{className:"h-4 w-4"});default:return e.jsx(X,{className:"h-4 w-4"})}};return t||r?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse space-y-6",children:[e.jsx("div",{className:"h-8 bg-muted rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-muted rounded w-full"}),e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((m,h)=>e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx("div",{className:"h-6 bg-muted rounded w-3/4"}),e.jsx("div",{className:"h-4 bg-muted rounded w-1/2"})]}),e.jsx(T,{children:e.jsx("div",{className:"h-4 bg-muted rounded"})})]},h))})]})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Session History"}),e.jsx("p",{className:"text-muted-foreground",children:"Your therapy journey and session records"})]}),e.jsxs(Ka,{defaultValue:"sessions",className:"space-y-6",children:[e.jsxs(ea,{children:[e.jsx(Ps,{value:"sessions",children:"Sessions"}),e.jsx(Ps,{value:"notes",children:"Notes"})]}),e.jsx(ms,{value:"sessions",className:"space-y-4",children:s&&s.length>0?e.jsx("div",{className:"space-y-4",children:s.map(m=>e.jsxs(R,{className:"hover:shadow-md transition-shadow",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[u(m.appointment_type),e.jsx("h3",{className:"font-semibold",children:m.title})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),xe(new Date(m.start_time),"MMM dd, yyyy")]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),xe(new Date(m.start_time),"h:mm a")," - ",xe(new Date(m.end_time),"h:mm a")]}),m.duration&&e.jsxs("span",{children:[m.duration," minutes"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Be,{className:"h-4 w-4"}),m.therapist_name]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(D,{className:i(m.status),children:[c(m.status),m.status]}),m.session_notes&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>o(n===m.id?null:m.id),children:n===m.id?e.jsx(Ct,{className:"h-4 w-4"}):e.jsx(nt,{className:"h-4 w-4"})})]})]})}),e.jsxs(T,{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:Js(new Date(m.start_time),{addSuffix:!0})}),n===m.id&&m.session_notes&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Session Notes"}),e.jsx("div",{className:"bg-muted p-3 rounded text-sm",children:m.session_notes})]})]})]},m.id))}):e.jsx(R,{children:e.jsxs(T,{className:"text-center py-12",children:[e.jsx(X,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Sessions Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Your completed therapy sessions will appear here"})]})})}),e.jsx(ms,{value:"notes",className:"space-y-4",children:a&&a.length>0?e.jsx("div",{className:"space-y-4",children:a.map(m=>e.jsxs(R,{children:[e.jsx(I,{children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsxs(O,{className:"text-lg flex items-center gap-2",children:[e.jsx(is,{className:"h-5 w-5"}),m.title]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-2",children:[e.jsxs("span",{children:["By: ",m.therapist_name]}),e.jsx("span",{children:xe(new Date(m.created_at),"MMM dd, yyyy")}),e.jsx(D,{variant:"outline",children:m.note_type})]})]})})}),e.jsx(T,{children:e.jsx("div",{className:"prose prose-sm max-w-none",children:e.jsx("p",{children:m.content})})})]},m.id))}):e.jsx(R,{children:e.jsxs(T,{className:"text-center py-12",children:[e.jsx(is,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Notes Available"}),e.jsx("p",{className:"text-muted-foreground",children:"Session notes and therapy documents will appear here when available"})]})})})]})]})},Ru=()=>{const{resources:s,isLoading:t}=Gi(),[a,r]=l.useState(""),[n,o]=l.useState(null),i=p=>{switch(p){case"video":return e.jsx(ne,{className:"h-5 w-5"});case"audio":return e.jsx(An,{className:"h-5 w-5"});case"exercise":return e.jsx(Tn,{className:"h-5 w-5"});default:return e.jsx(is,{className:"h-5 w-5"})}},c=p=>{switch(p){case"video":return"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300";case"audio":return"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300";case"exercise":return"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";default:return"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300"}},u=p=>yr(new Date(p),br(new Date,7)),m=s.filter(p=>{var j;const d=p.title.toLowerCase().includes(a.toLowerCase())||((j=p.description)==null?void 0:j.toLowerCase().includes(a.toLowerCase())),x=!n||p.resource_type===n;return d&&x}),h=["article","video","audio","exercise"];return e.jsx(Xt,{children:e.jsxs("div",{className:"min-h-screen flex w-full",children:[e.jsx(Bi,{}),e.jsx("main",{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(Fi,{}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Resource Library"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Access helpful resources for your mental health journey"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Da,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Ne,{placeholder:"Search resources...",value:a,onChange:p=>r(p.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{variant:n===null?"default":"outline",size:"sm",onClick:()=>o(null),children:"All"}),h.map(p=>e.jsx(N,{variant:n===p?"default":"outline",size:"sm",onClick:()=>o(p),className:"capitalize",children:p},p))]})]}),t?e.jsx("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:[1,2,3,4,5,6].map(p=>e.jsxs(R,{className:"animate-pulse",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"h-10 w-10 bg-muted rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx("div",{className:"h-4 bg-muted rounded"}),e.jsx("div",{className:"h-3 bg-muted rounded w-20"})]})]})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 bg-muted rounded"}),e.jsx("div",{className:"h-3 bg-muted rounded w-3/4"})]})})]},p))}):e.jsx("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:m.map(p=>e.jsxs(R,{className:"hover:shadow-lg transition-shadow cursor-pointer",onClick:()=>{p.content_url&&window.open(p.content_url,"_blank")},children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`rounded-full p-2 ${c(p.resource_type)}`,children:i(p.resource_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"text-lg truncate",children:p.title}),u(p.created_at)&&e.jsx(D,{variant:"secondary",className:"text-xs",children:"New"}),p.is_featured&&e.jsx(D,{variant:"default",className:"text-xs",children:"Featured"})]}),e.jsx(me,{className:"capitalize",children:p.resource_type})]})]})}),p.description&&e.jsx(T,{children:e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:p.description})})]},p.id))}),!t&&m.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(is,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No resources found"}),e.jsx("p",{className:"text-muted-foreground",children:a||n?"Try adjusting your search criteria":"Resources will appear here as they become available"})]})]})]})})]})})},Tu=()=>{const s=we(),[t,a]=l.useState(null),[r,n]=l.useState(!1),{data:o=[],isLoading:i}=le({queryKey:["enhanced-therapists"],queryFn:async()=>{const{data:h,error:p}=await w.from("profiles").select(`
          id, 
          full_name, 
          bio, 
          specializations, 
          hourly_rate, 
          years_experience, 
          avatar_url, 
          accepting_new_patients,
          location
        `).eq("account_type","therapist").eq("approval_status","approved");if(p)throw p;return h||[]}}),c=h=>{a(h),n(!0)},u=h=>{s(`/therapist/${h}`)},m=()=>{n(!1),a(null)};return i?e.jsx(R,{children:e.jsx(T,{className:"flex justify-center py-6",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"})})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-6",children:[o.map(h=>{var p;return e.jsx(R,{className:"overflow-hidden hover:shadow-lg transition-shadow",children:e.jsx(T,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-6",children:[e.jsxs(es,{className:"h-20 w-20",children:[e.jsx(Us,{src:h.avatar_url||void 0,alt:h.full_name||"Therapist"}),e.jsx(ss,{className:"bg-gradient-to-br from-blue-500 to-purple-600 text-white text-lg",children:((p=h.full_name)==null?void 0:p.split(" ").map(d=>d[0]).join("").toUpperCase())||"T"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:h.full_name||"Unnamed Therapist"}),h.location&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-gray-600 mt-1",children:[e.jsx(Aa,{className:"h-4 w-4"}),e.jsx("span",{children:h.location})]})]}),h.rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ta,{className:"h-4 w-4 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-sm font-medium",children:h.rating})]})]}),e.jsx("p",{className:"text-gray-600 mb-4 line-clamp-3",children:h.bio||"Experienced therapist dedicated to helping clients achieve their mental health goals."}),h.specializations&&h.specializations.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[h.specializations.slice(0,4).map((d,x)=>e.jsx(D,{variant:"secondary",className:"text-xs",children:d},x)),h.specializations.length>4&&e.jsxs(D,{variant:"outline",className:"text-xs",children:["+",h.specializations.length-4," more"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[h.years_experience&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{children:[h.years_experience," years"]})]}),h.hourly_rate&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Dc,{className:"h-4 w-4"}),e.jsxs("span",{children:["$",h.hourly_rate,"/session"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>u(h.id),children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"View Profile"]}),e.jsxs(N,{size:"sm",onClick:()=>c(h),disabled:h.accepting_new_patients===!1,className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),h.accepting_new_patients===!1?"Not Available":"Book Session"]})]})]}),h.accepting_new_patients===!1&&e.jsx("div",{className:"text-xs text-orange-600 bg-orange-50 p-2 rounded mt-2",children:"This therapist is currently not accepting new patients"})]})]})})},h.id)}),o.length===0&&e.jsx(R,{children:e.jsxs(T,{className:"text-center py-12",children:[e.jsx(Be,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No Therapists Available"}),e.jsx("p",{className:"text-gray-600",children:"There are currently no approved therapists available. Please check back later."})]})})]}),t&&e.jsx(Vi,{isOpen:r,onClose:()=>n(!1),therapistId:t.id,onBookingComplete:m})]})},Au=()=>e.jsxs("div",{className:"p-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Book a Session"}),e.jsx(Tu,{})]}),Eu=()=>{const{isPatient:s,isAdmin:t,loading:a}=V();return a?e.jsx("div",{children:"Loading..."}):!s&&!t?e.jsx(Ge,{to:"/dashboard",replace:!0}):e.jsxs(Ot,{children:[e.jsx(ge,{path:"/",element:e.jsx(vu,{})}),e.jsx(ge,{path:"/book",element:e.jsx(Au,{})}),e.jsx(ge,{path:"/inquiries",element:e.jsx(yu,{})}),e.jsx(ge,{path:"/treatment-plans",element:e.jsx(Su,{})}),e.jsx(ge,{path:"/history",element:e.jsx(_u,{})}),e.jsx(ge,{path:"/resources",element:e.jsx(Ru,{})})]})},va=()=>{const{theme:s,toggleTheme:t}=Gt(),{user:a,signOut:r,userRoles:n,primaryRole:o}=V();Ue("EnhancedNavbar","useAuthRBAC");const c=a?n.includes("admin")?{border:"border-t-orange-500",bg:"bg-orange-50/50"}:n.includes("therapist")?{border:"border-t-purple-500",bg:"bg-purple-50/50"}:{border:"border-t-blue-500",bg:"bg-blue-50/50"}:{border:"border-t-blue-500",bg:"bg-blue-50/50"};return e.jsx("nav",{className:C("w-full h-16 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800 fixed top-0 z-50 border-t-2 transition-colors","bg-white/95 dark:bg-gray-900/95",c.border,a&&c.bg),children:e.jsx("div",{className:"container mx-auto px-4 h-full",children:e.jsxs("div",{className:"flex justify-between items-center h-full",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Un,{}),a&&o&&e.jsx(La,{role:o,variant:"compact"})]}),e.jsx("div",{className:"hidden lg:flex items-center",children:e.jsx($n,{})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"hidden md:flex items-center space-x-2",children:[e.jsx(Oa,{}),e.jsx(N,{variant:"ghost",size:"sm",onClick:t,className:"rounded-full h-9 w-9","aria-label":s==="dark"?"Switch to light mode":"Switch to dark mode",children:s==="dark"?e.jsx($t,{className:"h-4 w-4"}):e.jsx(Ca,{className:"h-4 w-4"})})]}),a?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"hidden md:block",children:e.jsx(zn,{})}),e.jsxs(N,{variant:"outline",size:"sm",onClick:r,className:"hidden md:flex items-center gap-2 border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300",children:[e.jsx(Ls,{className:"h-4 w-4"}),"Logout"]})]}):e.jsx("div",{className:"hidden md:block",children:e.jsx(Kn,{})}),e.jsx("div",{className:"md:hidden",children:e.jsx(Qn,{})})]})]})})})},Du=({children:s,sidebar:t,showNavbar:a=!1,className:r})=>(Ue("DashboardLayout","useAuthRBAC"),t?e.jsx(Et,{variant:"dashboard",className:r,children:e.jsxs(Xt,{children:[a&&e.jsx(va,{}),t,e.jsx("div",{className:"main-content",children:s})]})}):e.jsxs(Et,{variant:"dashboard",className:r,children:[a&&e.jsx(va,{}),e.jsx("div",{className:"main-content",children:s})]})),Pu=({isConnected:s,isDegraded:t,className:a})=>t?e.jsxs(D,{variant:"secondary",className:C("gap-1",a),children:[e.jsx(_e,{className:"h-3 w-3"}),"Limited"]}):s?e.jsxs(D,{variant:"default",className:C("gap-1",a),children:[e.jsx(Xe,{className:"h-3 w-3"}),"Connected"]}):e.jsxs(D,{variant:"destructive",className:C("gap-1",a),children:[e.jsx(Cs,{className:"h-3 w-3"}),"Offline"]}),Iu=({activeSection:s,setActiveSection:t,isConnected:a=!0,isDegraded:r=!1})=>{var m;const{theme:n,toggleTheme:o}=Gt(),{signOut:i,user:c}=V(),u=[{id:"overview",label:"Overview",icon:Ws},{id:"analytics",label:"Analytics",icon:En},{id:"availability",label:"Availability",icon:te},{id:"calendar",label:"Calendar",icon:X},{id:"treatment",label:"Treatment Planning",icon:Cn},{id:"video-sessions",label:"Video Sessions",icon:ne}];return e.jsxs(Ga,{className:"border-r bg-white h-full flex flex-col",children:[e.jsx(Ha,{className:"border-b flex-shrink-0",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Therapist Dashboard"}),c&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:((m=c.user_metadata)==null?void 0:m.name)||c.email})]}),e.jsx(Pu,{isConnected:a,isDegraded:r})]})}),e.jsx(Wa,{className:"flex-1 overflow-y-auto",children:e.jsxs(Pt,{children:[e.jsx(Mi,{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Navigation"}),e.jsx(It,{children:e.jsx(Mt,{children:u.map(h=>{const p=h.icon,d=s===h.id;return e.jsx(ot,{children:e.jsxs(ct,{onClick:()=>t(h.id),className:C("w-full justify-start gap-3 text-left transition-colors rounded-md",d?"bg-blue-50 text-blue-700 font-medium":"text-gray-700 hover:bg-gray-50"),children:[e.jsx(p,{className:"h-4 w-4"}),e.jsx("span",{children:h.label})]})},h.id)})})})]})}),e.jsx(Ya,{className:"border-t flex-shrink-0",children:e.jsx(Pt,{children:e.jsx(It,{children:e.jsxs(Mt,{children:[e.jsx(ot,{children:e.jsxs(ct,{onClick:o,className:"w-full justify-start gap-3 text-gray-700 hover:bg-gray-50",children:[n==="dark"?e.jsx($t,{className:"h-4 w-4"}):e.jsx(Pc,{className:"h-4 w-4"}),e.jsx("span",{children:n==="dark"?"Light Mode":"Dark Mode"})]})}),e.jsx(Ii,{className:"my-2"}),e.jsx(ot,{children:e.jsxs(ct,{onClick:i,className:"w-full justify-start gap-3 text-red-600 hover:text-red-700 hover:bg-red-50",children:[e.jsx(Ls,{className:"h-4 w-4"}),e.jsx("span",{children:"Logout"})]})})]})})})}),e.jsx(Pi,{})]})},Mu=()=>{const{user:s}=V();Ue("TherapistDashboardHeader","useAuthRBAC");const{data:t,isLoading:a}=le({queryKey:["therapist-dashboard-real-stats",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return null;const{data:r,error:n}=await w.from("patient_assignments").select("patient_id").eq("therapist_id",s.id).eq("status","active");if(n)throw n;const o=new Date,i=new Date(o.setHours(0,0,0,0)).toISOString(),c=new Date(o.setHours(23,59,59,999)).toISOString(),{data:u,error:m}=await w.from("appointments").select("start_time, end_time").eq("therapist_id",s.id).gte("start_time",i).lte("start_time",c).in("status",["scheduled","confirmed"]).order("start_time",{ascending:!0});if(m)throw m;const h=new Date;h.setDate(h.getDate()+7);const{data:p,error:d}=await w.from("appointments").select("id").eq("therapist_id",s.id).gte("start_time",new Date().toISOString()).lte("start_time",h.toISOString()).in("status",["scheduled","confirmed"]);if(d)throw d;const{data:x,error:j}=await w.from("patient_inquiries").select("id").eq("therapist_id",s.id).eq("status","pending");if(j)throw j;const g=u!=null&&u[0]?new Date(u[0].start_time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):null;return{patientCount:(r==null?void 0:r.length)||0,todaySessionCount:(u==null?void 0:u.length)||0,nextSessionTime:g,weekSessionCount:(p==null?void 0:p.length)||0,notificationCount:(x==null?void 0:x.length)||0}},enabled:!!(s!=null&&s.id),refetchInterval:5*60*1e3});return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsxs(R,{className:"border-l-4 border-l-blue-500",children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Active Patients"}),e.jsx(Ic,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a?"...":(t==null?void 0:t.patientCount)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total active patients"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Today's Sessions"}),e.jsx(te,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a?"...":(t==null?void 0:t.todaySessionCount)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t!=null&&t.nextSessionTime?`Next at ${t.nextSessionTime}`:"No sessions scheduled today"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Upcoming Sessions"}),e.jsx(X,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a?"...":(t==null?void 0:t.weekSessionCount)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Next 7 days"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Pending Inquiries"}),e.jsx(Tt,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a?"...":(t==null?void 0:t.notificationCount)||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Require attention"})]})]})]})},Bu=()=>{const{primaryRole:s}=V(),{data:t,isLoading:a,error:r}=qi("therapist"),n=t||[],o=s==="therapist"?"therapist":"patient",i=(n==null?void 0:n.filter(c=>new Date(c.start_time)>=new Date))||[];return r?(console.error("[TodaysSessionsCard] Error loading appointments:",r),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),"Upcoming Sessions"]}),e.jsx(me,{children:"Your scheduled therapy sessions"})]}),e.jsx(T,{children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(X,{className:"h-12 w-12 text-red-400 mx-auto mb-4"}),e.jsx("p",{className:"text-red-600 mb-2",children:"Failed to load sessions"}),e.jsx("p",{className:"text-sm text-red-500",children:"Please refresh the page to try again"})]})})]})):a?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),"Upcoming Sessions"]}),e.jsx(me,{children:"Your scheduled therapy sessions"})]}),e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2",children:"Loading sessions..."})]})})]}):e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),"Upcoming Sessions",i.length>0&&e.jsx(D,{variant:"secondary",children:i.length})]}),e.jsx(me,{children:"Quick access to your upcoming sessions with one-click join"})]}),e.jsx(T,{children:i.length>0?e.jsx("div",{className:"space-y-3",children:i.slice(0,5).map(c=>e.jsx(zi,{appointment:c,userRole:o,variant:"compact"},c.id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(X,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-2",children:"No upcoming sessions scheduled"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Your schedule is clear"})]})})]})},Ki=()=>{const{user:s}=V(),t=we(),{data:a,isLoading:r}=le({queryKey:["treatment-plans-widget",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:u,error:m}=await w.from("treatment_plans").select(`
          *,
          patient_profile:profiles!treatment_plans_patient_id_fkey (
            full_name
          )
        `).eq("therapist_id",s.id).order("created_at",{ascending:!1}).limit(5);if(m)throw m;return u},enabled:!!(s!=null&&s.id)}),n=u=>{switch(u){case"active":return e.jsx(fe,{className:"h-4 w-4 text-green-600"});case"completed":return e.jsx(fe,{className:"h-4 w-4 text-blue-600"});case"paused":return e.jsx(te,{className:"h-4 w-4 text-yellow-600"});default:return e.jsx(Pe,{className:"h-4 w-4 text-gray-400"})}},o=u=>{switch(u){case"active":return e.jsx(D,{variant:"success",className:"text-xs",children:"Active"});case"completed":return e.jsx(D,{className:"bg-blue-100 text-blue-800 text-xs",children:"Completed"});case"paused":return e.jsx(D,{variant:"warning",className:"text-xs",children:"Paused"});case"cancelled":return e.jsx(D,{variant:"destructive",className:"text-xs",children:"Cancelled"});default:return e.jsx(D,{variant:"outline",className:"text-xs",children:"Unknown"})}},i=()=>{t("/therapist?section=treatment")},c=()=>{t("/therapist/treatment-plan/new")};return r?e.jsxs(R,{className:"border",children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Pe,{className:"h-5 w-5 text-blue-600"}),"Treatment Planning"]})}),e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Loading treatment plans..."})]})})]}):e.jsxs(R,{className:"border",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(Pe,{className:"h-5 w-5 text-blue-600"}),"Treatment Planning",a&&a.length>0&&e.jsx(D,{variant:"secondary",children:a.length})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:c,children:[e.jsx(us,{className:"h-4 w-4 mr-1"}),"New Plan"]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:i,children:"View All"})]})]})}),e.jsx(T,{children:a&&a.length>0?e.jsxs("div",{className:"space-y-3",children:[a.map(u=>{var m;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[n(u.status),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:u.title}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[o(u.status),e.jsxs("div",{className:"flex items-center text-xs text-gray-500",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),((m=u.patient_profile)==null?void 0:m.full_name)||"Unknown Patient"]}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Started ",new Date(u.start_date).toLocaleDateString()]})]})]})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(js,{className:"h-4 w-4"})})]},u.id)}),a.length>=5&&e.jsx(N,{variant:"ghost",className:"w-full text-sm mt-2",onClick:i,children:"View All Treatment Plans"})]}):e.jsxs("div",{className:"text-center py-6",children:[e.jsx(Pe,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No treatment plans created"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:"Create structured treatment plans for your patients"}),e.jsxs(N,{size:"sm",onClick:c,children:[e.jsx(us,{className:"h-4 w-4 mr-1"}),"Create First Plan"]})]})})]})},Ou=s=>{const{user:t}=V(),{toast:a}=Z(),r=Le(),{data:n,isLoading:o,error:i}=le({queryKey:["therapist-availability",t==null?void 0:t.id],queryFn:async()=>{const m=t==null?void 0:t.id;if(!m)return[];const{data:h,error:p}=await w.from("therapist_availability_slots").select("*").eq("therapist_id",m).order("slot_date",{ascending:!0});if(p)throw p;return h||[]},enabled:!!(t!=null&&t.id)}),c=Se({mutationFn:async m=>{const{data:h,error:p}=await w.from("therapist_availability_slots").insert([{...m,therapist_id:t==null?void 0:t.id}]).select();if(p)throw p;return h},onSuccess:()=>{r.invalidateQueries({queryKey:["therapist-availability"]}),a({title:"Success",description:"Availability slot created successfully"})},onError:m=>{a({title:"Error",description:"Failed to create availability slot",variant:"destructive"})}}),u=Se({mutationFn:async m=>{const{error:h}=await w.from("therapist_availability_slots").delete().eq("id",m);if(h)throw h},onSuccess:()=>{r.invalidateQueries({queryKey:["therapist-availability"]}),a({title:"Success",description:"Availability slot deleted successfully"})},onError:m=>{a({title:"Error",description:"Failed to delete availability slot",variant:"destructive"})}});return{availabilitySlots:n||[],isLoading:o,error:i,createAvailabilitySlot:c,deleteAvailabilitySlot:u}},Ji=()=>{const{availabilitySlots:s,isLoading:t,error:a}=Ou(),n=s==null?void 0:s.filter(o=>{const i=new Date(o.slot_date),c=No(new Date);return i>=c&&i<wa(c,7)});return e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Weekly Availability"}),e.jsx(me,{children:"Manage your availability for the week"})]}),e.jsx(T,{children:t?e.jsx("div",{children:"Loading availability..."}):a?e.jsxs("div",{children:["Error: ",a.message]}):e.jsxs("div",{className:"space-y-2",children:[n==null?void 0:n.map(o=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[xe(new Date(o.slot_date),"EEE, MMM d"),": ",o.slot_start_time," - ",o.slot_end_time]}),e.jsx(D,{variant:o.is_available?"default":"secondary",children:o.is_available?"Available":"Not Available"})]},o.id)),(n==null?void 0:n.length)===0&&e.jsx("div",{children:"No availability slots for this week."})]})})]})},Xi=()=>{const s=we(),t=new Date,a=Array.from({length:7},(r,n)=>{const o=new Date(t);return o.setDate(t.getDate()-t.getDay()+n+1),o});return e.jsxs(R,{className:"border",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"flex items-center gap-2 text-lg font-semibold",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),"This Week's Calendar"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"ghost",size:"sm",children:e.jsx(Vt,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"sm",children:e.jsx(js,{className:"h-4 w-4"})}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>s("/calendar"),children:"View Calendar"})]})]})}),e.jsxs(T,{children:[e.jsx("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{className:"text-sm text-green-700",children:"Calendar Sync Active"})]}),e.jsx(D,{variant:"outline",className:"text-xs",children:"Google Calendar"})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500",children:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(r=>e.jsx("div",{children:r},r))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:a.map((r,n)=>e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm cursor-pointer ${r.toDateString()===t.toDateString()?"bg-blue-600 text-white":"hover:bg-gray-100"}`,children:r.getDate()}),n<5&&e.jsx("div",{className:"mt-1 flex justify-center",children:e.jsx("div",{className:"w-1 h-1 bg-blue-400 rounded-full"})})]},r.toISOString()))})]}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Schedule"]}),e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Availability"]})]})})]})]})},Fu=()=>{const{therapistInquiries:s,relationships:t}=Qa(),{user:a}=V(),r=we();Ue("TherapistDailyOverview","useAuthRBAC");const{data:n,isLoading:o}=le({queryKey:["therapist-patients",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return{activePatients:0,totalPatients:0};const{data:p,error:d}=await w.from("patient_assignments").select("id, status, patient_id").eq("therapist_id",a.id);if(d)throw d;const x=(p==null?void 0:p.filter(g=>g.status==="active").length)||0,j=(p==null?void 0:p.length)||0;return{activePatients:x,totalPatients:j}},enabled:!!(a!=null&&a.id)}),i=s.filter(p=>p.status==="pending"),c=i.filter(p=>new Date().getTime()-new Date(p.created_at).getTime()>24*60*60*1e3),u=s.filter(p=>new Date(p.created_at).toDateString()===new Date().toDateString());t.filter(p=>p.relationship_status==="active").length;const m=t.filter(p=>p.relationship_status==="consultation_scheduled").length,h=()=>{r("/therapist/patients")};return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs(R,{className:`${c.length>0?"border-red-200 bg-red-50":"border-gray-200"}`,children:[e.jsx(I,{className:"pb-2",children:e.jsxs(O,{className:"text-lg flex items-center gap-2",children:[c.length>0?e.jsx(_e,{className:"h-5 w-5 text-red-600"}):e.jsx(fe,{className:"h-5 w-5 text-green-600"}),"Urgent Items"]})}),e.jsx(T,{children:c.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-2xl font-bold text-red-600",children:c.length}),e.jsx(D,{variant:"destructive",children:"Overdue"})]}),e.jsxs("p",{className:"text-sm text-red-700",children:[c.length===1?"inquiry needs":"inquiries need"," immediate attention"]}),e.jsx(N,{size:"sm",variant:"destructive",onClick:()=>r("/therapist/inquiries"),className:"w-full",children:"Review Now"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-2xl font-bold text-green-600",children:"0"}),e.jsx(D,{className:"bg-green-600",children:"All Clear"})]}),e.jsx("p",{className:"text-sm text-green-700",children:"No overdue inquiries"})]})})]}),e.jsxs(R,{children:[e.jsx(I,{className:"pb-2",children:e.jsxs(O,{className:"text-lg flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5 text-blue-600"}),"Today's Activity"]})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"New Inquiries"}),e.jsx("span",{className:"text-lg font-semibold",children:u.length})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Pending Responses"}),e.jsx("span",{className:"text-lg font-semibold",children:i.length})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Active Patients"}),e.jsx("span",{className:"text-lg font-semibold",children:o?e.jsx("span",{className:"inline-block w-6 h-6 bg-gray-200 animate-pulse rounded"}):(n==null?void 0:n.activePatients)||0})]})]})})]}),e.jsxs(R,{children:[e.jsx(I,{className:"pb-2",children:e.jsxs(O,{className:"text-lg flex items-center gap-2",children:[e.jsx(qs,{className:"h-5 w-5 text-purple-600"}),"Quick Actions"]})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>r("/therapist/inquiries"),children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Review Inquiries (",i.length,")"]}),e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:()=>r("/calendar"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Schedule Consultations (",m,")"]}),e.jsxs(N,{variant:"outline",size:"sm",className:"w-full justify-start",onClick:h,children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Manage Patients (",o?"...":(n==null?void 0:n.activePatients)||0,")"]})]})})]}),i.length>0&&e.jsxs(R,{className:"md:col-span-2 lg:col-span-3",children:[e.jsxs(I,{children:[e.jsxs(O,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5 text-blue-600"}),"Recent Inquiries"]}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>r("/therapist/inquiries"),children:"View All"})]}),e.jsx(me,{children:"Latest patient inquiries requiring your attention"})]}),e.jsx(T,{children:e.jsx("div",{className:"space-y-3",children:i.slice(0,3).map(p=>{var d;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium",children:((d=p.patient)==null?void 0:d.full_name)||"Anonymous"}),e.jsx(D,{variant:p.priority==="urgent"?"destructive":"outline",children:p.priority})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:p.subject}),e.jsxs("p",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(te,{className:"h-3 w-3"}),Js(new Date(p.created_at),{addSuffix:!0})]})]}),e.jsx(N,{size:"sm",onClick:()=>r("/therapist/inquiries"),children:"Respond"})]},p.id)})})})]})]})},xr=()=>(Ue("TherapistOverview","useAuthRBAC"),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Mu,{}),e.jsx(Fu,{}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(Bu,{}),e.jsx(Ki,{})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(Ji,{}),e.jsx(Xi,{})]})]})),Lu=()=>{const{user:s}=V(),{data:t,isLoading:a,error:r}=le({queryKey:["appointmentData",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:h,error:p}=await w.from("appointments").select("start_time").eq("therapist_id",s.id);if(p)throw console.error("Error fetching appointment data:",p),p;const d=h==null?void 0:h.reduce((j,g)=>{const v=new Date(g.start_time).toLocaleDateString();return j[v]=(j[v]||0)+1,j},{});return Object.entries(d||{}).map(([j,g])=>({date:j,count:g}))},enabled:!!(s!=null&&s.id)}),{data:n,isLoading:o,error:i}=le({queryKey:["patientDemographics",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:h,error:p}=await w.from("patient_assignments").select(`
          patient_id,
          profiles!patient_assignments_patient_id_fkey(full_name)
        `).eq("therapist_id",s.id).eq("status","active");if(p)throw p;const d=(h==null?void 0:h.length)||0;return[{gender:"Male",count:Math.floor(d*.4)},{gender:"Female",count:Math.floor(d*.55)},{gender:"Other",count:Math.floor(d*.05)}].filter(j=>j.count>0)},enabled:!!(s!=null&&s.id)}),{data:c}=le({queryKey:["therapist-revenue",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:h,error:p}=await w.from("appointments").select("start_time, end_time").eq("therapist_id",s.id).eq("status","completed").gte("start_time",new Date(new Date().setMonth(new Date().getMonth()-6)).toISOString());if(p)throw p;const d=(h==null?void 0:h.reduce((j,g)=>{const v=new Date(g.start_time).toLocaleDateString("en-US",{month:"short"});return j[v]=(j[v]||0)+100,j},{}))||{};return["Jan","Feb","Mar","Apr","May","Jun"].map(j=>({month:j,revenue:d[j]||0}))},enabled:!!(s!=null&&s.id)}),u=c,m=["#0088FE","#00C49F","#FFBB28","#FF8042"];return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Appointment Statistics"}),e.jsx(me,{children:"Number of appointments per day"})]}),e.jsx(T,{children:a?e.jsx("div",{className:"text-center",children:"Loading..."}):r?e.jsx("div",{className:"text-center text-red-500",children:"Error loading data"}):e.jsx(at,{width:"100%",height:300,children:e.jsxs(So,{data:t,children:[e.jsx(da,{strokeDasharray:"3 3"}),e.jsx(ma,{dataKey:"date"}),e.jsx(ua,{}),e.jsx(rt,{}),e.jsx(ta,{}),e.jsx(Co,{dataKey:"count",fill:"#8884d8"})]})})})]}),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Revenue Statistics"}),e.jsx(me,{children:"Monthly revenue overview"})]}),e.jsx(T,{children:e.jsx(at,{width:"100%",height:300,children:e.jsxs(wr,{data:u,children:[e.jsx(da,{strokeDasharray:"3 3"}),e.jsx(ma,{dataKey:"month"}),e.jsx(ua,{}),e.jsx(rt,{}),e.jsx(ta,{}),e.jsx(St,{type:"monotone",dataKey:"revenue",stroke:"#82ca9d"})]})})})]}),e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Patient Demographics"}),e.jsx(me,{children:"Distribution of patients by gender"})]}),e.jsx(T,{children:o?e.jsx("div",{className:"text-center",children:"Loading..."}):i?e.jsx("div",{className:"text-center text-red-500",children:"Error loading data"}):e.jsx(at,{width:"100%",height:300,children:e.jsxs(Nr,{children:[e.jsx(Sr,{data:n,dataKey:"count",nameKey:"gender",cx:"50%",cy:"50%",outerRadius:80,fill:"#8884d8",label:!0,children:n.map((h,p)=>e.jsx(Cr,{fill:m[p%m.length]},`cell-${p}`))}),e.jsx(rt,{}),e.jsx(ta,{})]})})})]})]})},qu=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Analytics & Reports"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"View detailed insights about your practice and patient progress"})]}),e.jsx(Lu,{})]}),Uu=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Availability Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your schedule and set your availability for appointments"})]}),e.jsx(Ji,{})]}),$u=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Calendar"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"View and manage your appointments and schedule"})]}),e.jsx(Xi,{})]}),zu=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Treatment Planning"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Create and manage treatment plans for your patients"})]}),e.jsx(Ki,{})]}),Vu=()=>{const s=we(),{createInstantSession:t,loading:a}=mi(),[r,n]=l.useState(!1),[o,i]=l.useState({session_name:"",max_participants:2,duration_hours:1,recording_enabled:!1,waiting_room_enabled:!0}),c=async m=>{if(m.preventDefault(),!o.session_name.trim()){bt.error("Session name is required");return}try{console.log("🎬 Starting session creation process...");const h=await t(o);h?(console.log("✅ Session created, navigating to:",`/video-conference/${h.id}`),n(!1),bt.success("Instant session created successfully!"),s(`/video-conference/${h.id}`),i({session_name:"",max_participants:2,duration_hours:1,recording_enabled:!1,waiting_room_enabled:!0})):(console.error("❌ No session returned from creation"),bt.error("Failed to create session - no session data returned"))}catch(h){console.error("❌ Error creating instant session:",h),bt.error("Failed to create instant session. Please try again.")}},u=(m,h)=>{i(p=>({...p,[m]:h}))};return e.jsxs(He,{open:r,onOpenChange:n,children:[e.jsx(Ua,{asChild:!0,children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),"Start Instant Session"]})}),e.jsxs($e,{className:"sm:max-w-md",children:[e.jsxs(Oe,{children:[e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),"Create Instant Session"]}),e.jsx($s,{children:"Set session details and invite participants."})]}),e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"session_name",children:"Session Name *"}),e.jsx(Ne,{id:"session_name",value:o.session_name,onChange:m=>u("session_name",m.target.value),placeholder:"Enter session name",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"max_participants",children:"Max Participants"}),e.jsx(Ne,{id:"max_participants",type:"number",min:"2",max:"10",value:o.max_participants,onChange:m=>u("max_participants",parseInt(m.target.value)||2)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{htmlFor:"duration_hours",children:"Duration (hours)"}),e.jsx(Ne,{id:"duration_hours",type:"number",min:"0.5",max:"8",step:"0.5",value:o.duration_hours,onChange:m=>u("duration_hours",parseFloat(m.target.value)||1)})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{htmlFor:"recording_enabled",children:"Enable Recording"}),e.jsx(Dt,{id:"recording_enabled",checked:o.recording_enabled,onCheckedChange:m=>u("recording_enabled",m)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{htmlFor:"waiting_room_enabled",children:"Enable Waiting Room"}),e.jsx(Dt,{id:"waiting_room_enabled",checked:o.waiting_room_enabled,onCheckedChange:m=>u("waiting_room_enabled",m)})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>n(!1),className:"flex-1",disabled:a,children:"Cancel"}),e.jsx(N,{type:"submit",className:"flex-1 flex items-center gap-2",disabled:a,children:a?e.jsxs(e.Fragment,{children:[e.jsx(hs,{className:"h-4 w-4 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4"}),"Create Session"]})})]})]})]})]})},Gu=()=>{const{user:s}=V(),t=we(),[a,r]=l.useState([]),[n,o]=l.useState(!0),i=async()=>{try{o(!0),await w.rpc("cleanup_expired_instant_sessions");const{data:d,error:x}=await w.from("instant_sessions").select(`
          id,
          session_name,
          therapist_id,
          created_at,
          expires_at,
          is_active,
          session_token,
          max_participants
        `).eq("is_active",!0).gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1});if(x){console.error("Error fetching sessions:",x),ls({title:"Error",description:"Failed to fetch active sessions",variant:"destructive"});return}if(!d||d.length===0){r([]);return}const j=await Promise.all(d.map(async g=>{const{count:v}=await w.from("instant_session_participants").select("*",{count:"exact",head:!0}).eq("session_id",g.id).eq("is_active",!0),{data:f}=await w.from("profiles").select("full_name").eq("id",g.therapist_id).single();return{...g,participant_count:v||0,therapist_name:(f==null?void 0:f.full_name)||"Unknown Therapist"}}));r(j)}catch(d){console.error("Error in fetchActiveSessions:",d),ls({title:"Error",description:"Failed to load sessions",variant:"destructive"})}finally{o(!1)}};l.useEffect(()=>{i();const d=w.channel("instant-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"instant_sessions"},()=>{i()}).on("postgres_changes",{event:"*",schema:"public",table:"instant_session_participants"},()=>{i()}).subscribe();return()=>{w.removeChannel(d)}},[]);const c=d=>{console.log("Join button clicked for session token:",d),console.log("Navigating to:",`/session/instant/${d}`),t(`/session/instant/${d}`)},u=async d=>{try{const{error:x}=await w.from("instant_sessions").update({is_active:!1}).eq("id",d);if(x){ls({title:"Error",description:"Failed to end session",variant:"destructive"});return}await w.from("instant_session_participants").update({is_active:!1,left_at:new Date().toISOString()}).eq("session_id",d),ls({title:"Success",description:"Session ended successfully"})}catch(x){console.error("Error ending session:",x),ls({title:"Error",description:"Failed to end session",variant:"destructive"})}},m=d=>{const x=a.find(g=>g.session_token===d),j=x?`${window.location.origin}/video-conference/${x.id}?join=true`:`${window.location.origin}/session/instant/${d}`;navigator.clipboard.writeText(j),ls({title:"Link Copied",description:"Session link copied to clipboard"})},h=d=>{const x=a.find(j=>j.session_token===d);return x?`${window.location.origin}/video-conference/${x.id}?join=true`:`${window.location.origin}/session/instant/${d}`},p=d=>new Date(d).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return n?e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Active Instant Sessions"}),e.jsx(me,{children:"Join ongoing therapy sessions for immediate support."})]}),e.jsx(T,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"text-center text-muted-foreground",children:"Loading active sessions..."})})})]}):e.jsxs(R,{children:[e.jsxs(I,{children:[e.jsx(O,{children:"Active Instant Sessions"}),e.jsxs(me,{children:["Join ongoing therapy sessions for immediate support.",e.jsxs("span",{className:"block text-sm text-orange-600 mt-1 flex items-center",children:[e.jsx(Je,{className:"h-4 w-4 mr-1"}),"This displays real session data from the database"]})]})]}),e.jsx(T,{className:"space-y-4",children:a.length===0?e.jsxs("div",{className:"text-center text-muted-foreground py-8",children:[e.jsx(ne,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No active sessions at the moment"}),e.jsx("p",{className:"text-sm",children:"Check back later or create a new instant session!"})]}):e.jsx("div",{className:"space-y-3",children:a.map(d=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border hover:bg-accent/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(es,{className:"h-12 w-12",children:[e.jsx(Us,{src:`https://avatar.vercel.sh/${d.session_name}.png`,alt:d.session_name}),e.jsx(ss,{className:"bg-primary/10 text-primary font-semibold",children:d.session_name.substring(0,2).toUpperCase()})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-lg",children:d.session_name}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsxs("span",{children:[d.participant_count||0,"/",d.max_participants," participants"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsxs("span",{children:["Started ",p(d.created_at)]})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Hosted by ",d.therapist_name]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(D,{variant:d.is_active?"default":"secondary",className:"capitalize",children:d.is_active?"Live":"Inactive"}),e.jsxs(He,{children:[e.jsx(Ua,{asChild:!0,children:e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(ft,{className:"h-4 w-4 mr-2"}),"Share"]})}),e.jsxs($e,{children:[e.jsxs(Oe,{children:[e.jsx(Fe,{children:"Share Session Link"}),e.jsx($s,{children:"Share this link with participants to join the session"})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"text",value:h(d.session_token),readOnly:!0,className:"flex-1 px-3 py-2 border rounded-md bg-muted"}),e.jsx(N,{size:"sm",onClick:()=>m(d.session_token),children:e.jsx(ha,{className:"h-4 w-4"})})]})})]})]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>c(d.session_token),disabled:!d.is_active||(d.participant_count||0)>=d.max_participants,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),(d.participant_count||0)>=d.max_participants?`Full (${d.participant_count}/${d.max_participants})`:`Join (${d.participant_count||0}/${d.max_participants})`]}),(s==null?void 0:s.id)===d.therapist_id&&e.jsxs(N,{variant:"destructive",size:"sm",onClick:x=>{x.preventDefault(),x.stopPropagation(),u(d.id)},children:[e.jsx(Dn,{className:"h-4 w-4 mr-2"}),"End"]})]})]},d.id))})})]})},Hu=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs(R,{className:"border-slate-200",children:[e.jsxs(I,{className:"pb-3",children:[e.jsxs(O,{className:"flex items-center gap-2 text-lg font-semibold text-slate-900",children:[e.jsx(ne,{className:"h-5 w-5 text-blue-600"}),"Video Session Tools",e.jsxs(D,{variant:"secondary",className:"ml-2",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Active"]})]}),e.jsx(me,{className:"text-slate-600",children:"Create instant video sessions and manage your active sessions"})]}),e.jsx(T,{className:"pt-0",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("p",{className:"text-sm text-slate-600",children:"Start an instant session to quickly connect with patients without scheduling. Share the generated link for immediate access."}),e.jsx(Vu,{})]})})]}),e.jsx(Gu,{})]}),gr=({onSelectTemplate:s,selectedTemplate:t})=>{const[a]=l.useState([{id:"1",title:"Initial Response - General",content:`Thank you for reaching out to me. I appreciate you taking the first step in seeking support. 

I would be happy to help you work through the concerns you've shared. Based on your inquiry, I believe we could make good progress together.

I have availability for an initial consultation this week. During this session, we can discuss your goals, my approach, and determine if we're a good fit to work together.

Would you like to schedule a brief 15-minute consultation call to get started?

Best regards,
[Your name]`,category:"general",isDefault:!0,usageCount:15},{id:"2",title:"Urgent Case Response",content:`Thank you for your inquiry. I understand this is an urgent matter for you, and I want to respond quickly.

Based on what you've shared, I believe I can help. I have some immediate availability and would like to schedule a consultation with you as soon as possible.

Please let me know your preferred times, and I'll do my best to accommodate your schedule. If this is a crisis situation, please also consider reaching out to:
- Crisis Text Line: Text HOME to 741741
- National Suicide Prevention Lifeline: 988

I look forward to speaking with you soon.

Best regards,
[Your name]`,category:"urgent",isDefault:!1,usageCount:8},{id:"3",title:"Specialty Match Response",content:`Thank you for your inquiry about [specific concern]. This is an area I specialize in, and I'm confident I can provide the support you're looking for.

I work with many clients facing similar challenges, and I've seen great success using [therapeutic approach]. My approach focuses on [brief description of methodology].

I'd love to set up an initial consultation to learn more about your specific situation and explain how I can help. This session is also an opportunity for you to ask any questions about my background or approach.

Would you prefer to start with a phone consultation or meet in person?

Looking forward to working with you,
[Your name]`,category:"specialty",isDefault:!1,usageCount:12},{id:"4",title:"Waitlist Response",content:`Thank you for your interest in working with me. I'm honored that you're considering me as your therapist.

Currently, my practice is at capacity, but I do have a waitlist for new clients. Based on my current schedule, I anticipate having availability in [timeframe].

In the meantime, I'd be happy to provide you with referrals to other qualified therapists who may have immediate availability. I can also keep you updated on any earlier openings that might arise.

Would you like me to add you to my waitlist and/or provide some referral options?

Best regards,
[Your name]`,category:"waitlist",isDefault:!1,usageCount:5}]),[r,n]=l.useState("all"),o=r==="all"?a:a.filter(c=>c.category===r),i=c=>{s==null||s(c)};return e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-5 w-5"}),"Response Templates"]}),e.jsxs(N,{size:"sm",variant:"outline",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"New Template"]})]})}),e.jsxs(T,{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(Ie,{value:r,onValueChange:n,children:[e.jsx(Ee,{className:"w-48",children:e.jsx(Me,{placeholder:"Filter by category"})}),e.jsxs(De,{children:[e.jsx(H,{value:"all",children:"All Categories"}),e.jsx(H,{value:"general",children:"General"}),e.jsx(H,{value:"urgent",children:"Urgent"}),e.jsx(H,{value:"specialty",children:"Specialty"}),e.jsx(H,{value:"waitlist",children:"Waitlist"})]})]})}),e.jsx("div",{className:"space-y-3",children:o.map(c=>e.jsx(R,{className:`cursor-pointer transition-colors hover:bg-gray-50 ${t===c.id?"ring-2 ring-primary":""}`,onClick:()=>i(c),children:e.jsxs(T,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-medium",children:c.title}),c.isDefault&&e.jsxs(D,{variant:"secondary",className:"text-xs",children:[e.jsx(Ta,{className:"h-3 w-3 mr-1"}),"Default"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(Mc,{className:"h-3 w-3"})}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-8 w-8 p-0",children:e.jsx(Dn,{className:"h-3 w-3"})})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-2",children:c.content}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(D,{variant:"outline",className:"text-xs capitalize",children:c.category}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Used ",c.usageCount," times"]})]})]})},c.id))}),o.length===0&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(is,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No templates found for this category."}),e.jsxs(N,{variant:"outline",size:"sm",className:"mt-2",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"Create Template"]})]})]})]})},Yu=({inquiries:s=[],relationships:t=[]})=>{const a=s.length;s.filter(p=>p.status==="pending").length;const r=s.filter(p=>p.status==="responded").length,n=a>0?r/a*100:0,o=t.filter(p=>p.relationship_status==="consultation_scheduled").length,i=t.filter(p=>p.relationship_status==="active").length,c=a>0?i/a*100:0,u=[{name:"Urgent",value:s.filter(p=>p.priority==="urgent").length,color:"#ef4444"},{name:"High",value:s.filter(p=>p.priority==="high").length,color:"#f97316"},{name:"Normal",value:s.filter(p=>p.priority==="normal").length,color:"#10b981"},{name:"Low",value:s.filter(p=>p.priority==="low").length,color:"#6b7280"}],m=[{week:"Week 1",inquiries:8,responses:7,conversions:3},{week:"Week 2",inquiries:12,responses:11,conversions:4},{week:"Week 3",inquiries:15,responses:13,conversions:6},{week:"Week 4",inquiries:10,responses:9,conversions:4}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(R,{children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Inquiries"}),e.jsx("p",{className:"text-2xl font-bold",children:a})]}),e.jsx(qe,{className:"h-8 w-8 text-blue-500"})]}),e.jsx("div",{className:"mt-2",children:e.jsx(D,{variant:"secondary",className:"text-xs",children:"This month"})})]})}),e.jsx(R,{children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Response Rate"}),e.jsxs("p",{className:"text-2xl font-bold",children:[n.toFixed(1),"%"]})]}),e.jsx(fe,{className:"h-8 w-8 text-green-500"})]}),e.jsx("div",{className:"mt-2",children:e.jsx(Os,{value:n,className:"h-2"})})]})}),e.jsx(R,{children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Avg Response Time"}),e.jsx("p",{className:"text-2xl font-bold",children:"2.4 hours"})]}),e.jsx(te,{className:"h-8 w-8 text-yellow-500"})]}),e.jsx("div",{className:"mt-2",children:e.jsx(D,{variant:"outline",className:"text-xs",children:"Target: <4 hours"})})]})}),e.jsx(R,{children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Conversion Rate"}),e.jsxs("p",{className:"text-2xl font-bold",children:[c.toFixed(1),"%"]})]}),e.jsx(qs,{className:"h-8 w-8 text-purple-500"})]}),e.jsx("div",{className:"mt-2",children:e.jsx(Os,{value:c,className:"h-2"})})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5"}),"Inquiry Priority Distribution"]})}),e.jsx(T,{children:e.jsx("div",{className:"h-64",children:e.jsx(at,{width:"100%",height:"100%",children:e.jsxs(Nr,{children:[e.jsx(Sr,{data:u,cx:"50%",cy:"50%",labelLine:!1,label:({name:p,percent:d})=>`${p} ${(d*100).toFixed(0)}%`,outerRadius:80,fill:"#8884d8",dataKey:"value",children:u.map((p,d)=>e.jsx(Cr,{fill:p.color},`cell-${d}`))}),e.jsx(rt,{})]})})})})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5"}),"Weekly Trends"]})}),e.jsx(T,{children:e.jsx("div",{className:"h-64",children:e.jsx(at,{width:"100%",height:"100%",children:e.jsxs(wr,{data:m,children:[e.jsx(da,{strokeDasharray:"3 3"}),e.jsx(ma,{dataKey:"week"}),e.jsx(ua,{}),e.jsx(rt,{}),e.jsx(St,{type:"monotone",dataKey:"inquiries",stroke:"#3b82f6",strokeWidth:2,name:"Inquiries"}),e.jsx(St,{type:"monotone",dataKey:"responses",stroke:"#10b981",strokeWidth:2,name:"Responses"}),e.jsx(St,{type:"monotone",dataKey:"conversions",stroke:"#8b5cf6",strokeWidth:2,name:"Conversions"})]})})})})]})]}),e.jsxs(R,{children:[e.jsx(I,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Patient Acquisition Funnel"]})}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:"1"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Inquiries Received"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Initial patient interest"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:a}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"100%"})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:"2"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Responses Sent"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Therapist engagement"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:r}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[n.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-yellow-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:"3"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Consultations Scheduled"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Initial meetings booked"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:o}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a>0?(o/a*100).toFixed(1):0,"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-purple-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:"4"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Active Patients"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ongoing treatment"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:i}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.toFixed(1),"%"]})]})]})]})})]})]})},Wu=()=>{const{therapistInquiries:s,relationships:t,loadingTherapistInquiries:a,respondToInquiry:r,isResponding:n,updateRelationship:o,isUpdatingRelationship:i}=Qa(),[c,u]=l.useState(null),[m,h]=l.useState(""),[p,d]=l.useState(""),[x,j]=l.useState("all"),[g,v]=l.useState("all"),[f,y]=l.useState(null),b=s.filter(A=>{var U,G;const Q=((G=(U=A.patient)==null?void 0:U.full_name)==null?void 0:G.toLowerCase().includes(p.toLowerCase()))||A.subject.toLowerCase().includes(p.toLowerCase())||A.message.toLowerCase().includes(p.toLowerCase()),$=x==="all"||A.status===x,Y=g==="all"||A.priority===g;return Q&&$&&Y}),_=A=>{switch(A){case"urgent":return"destructive";case"high":return"secondary";case"normal":return"outline";case"low":return"outline";default:return"outline"}},k=A=>{switch(A){case"pending":return"destructive";case"in_progress":return"secondary";case"responded":return"default";case"resolved":return"default";case"closed":return"outline";default:return"outline"}},S=A=>{switch(A){case"inquiry":return"outline";case"consultation_scheduled":return"secondary";case"consultation_completed":return"default";case"active":return"default";case"on_hold":return"secondary";case"completed":return"outline";case"terminated":return"destructive";default:return"outline"}},E=A=>{switch(A){case"email":return e.jsx(Rn,{className:"h-4 w-4"});case"phone":return e.jsx(Ra,{className:"h-4 w-4"});case"video_call":return e.jsx(ne,{className:"h-4 w-4"});default:return e.jsx(qe,{className:"h-4 w-4"})}},B=A=>{m.trim()&&(r({inquiryId:A,response:m}),h(""),u(null),y(null))},M=A=>{h(A.content),y(A.id)},q=A=>{var Q;console.log("Schedule consultation for:",(Q=A.patient)==null?void 0:Q.full_name)},F=(A,Q)=>{o({relationshipId:A,status:Q})},P=A=>t.find(Q=>Q.patient_id===A.patient_id&&Q.therapist_id===A.therapist_id),L={total:s.length,pending:s.filter(A=>A.status==="pending").length,urgent:s.filter(A=>A.priority==="urgent").length,activeRelationships:t.filter(A=>A.relationship_status==="active").length};return a?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Patient Inquiries"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage patient inquiries and track the conversion journey"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(D,{variant:"outline",className:"px-3 py-1",children:[L.pending," pending"]}),L.urgent>0&&e.jsxs(D,{variant:"destructive",className:"px-3 py-1",children:[L.urgent," urgent"]}),e.jsxs(D,{variant:"secondary",className:"px-3 py-1",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),L.activeRelationships," active"]})]})]}),e.jsxs(Ka,{defaultValue:"inbox",className:"space-y-6",children:[e.jsxs(ea,{className:"grid w-full grid-cols-3",children:[e.jsxs(Ps,{value:"inbox",className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),"Inbox (",L.total,")"]}),e.jsxs(Ps,{value:"templates",className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4"}),"Templates"]}),e.jsxs(Ps,{value:"analytics",className:"flex items-center gap-2",children:[e.jsx(En,{className:"h-4 w-4"}),"Analytics"]})]}),e.jsxs(ms,{value:"inbox",className:"space-y-6",children:[e.jsx(R,{children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Da,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(Ne,{placeholder:"Search inquiries...",value:p,onChange:A=>d(A.target.value),className:"pl-10"})]})}),e.jsxs(Ie,{value:x,onValueChange:j,children:[e.jsx(Ee,{className:"w-32",children:e.jsx(Me,{placeholder:"Status"})}),e.jsxs(De,{children:[e.jsx(H,{value:"all",children:"All Status"}),e.jsx(H,{value:"pending",children:"Pending"}),e.jsx(H,{value:"responded",children:"Responded"}),e.jsx(H,{value:"resolved",children:"Resolved"})]})]}),e.jsxs(Ie,{value:g,onValueChange:v,children:[e.jsx(Ee,{className:"w-32",children:e.jsx(Me,{placeholder:"Priority"})}),e.jsxs(De,{children:[e.jsx(H,{value:"all",children:"All Priority"}),e.jsx(H,{value:"urgent",children:"Urgent"}),e.jsx(H,{value:"high",children:"High"}),e.jsx(H,{value:"normal",children:"Normal"}),e.jsx(H,{value:"low",children:"Low"})]})]})]})})}),b.length===0?e.jsx(R,{children:e.jsxs(T,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(qe,{className:"h-16 w-16 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:s.length===0?"No Inquiries Yet":"No Matching Inquiries"}),e.jsx("p",{className:"text-muted-foreground text-center max-w-md",children:s.length===0?"You haven't received any patient inquiries yet. When patients contact you, they'll appear here.":"Try adjusting your search or filter criteria to find what you're looking for."})]})}):e.jsx("div",{className:"grid gap-4",children:b.map(A=>{var $,Y;const Q=P(A);return e.jsxs(R,{className:"hover:shadow-md transition-shadow",children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(es,{children:[e.jsx(Us,{src:($=A.patient)==null?void 0:$.avatar_url}),e.jsx(ss,{children:e.jsx(Be,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx(O,{className:"text-lg",children:(Y=A.patient)==null?void 0:Y.full_name}),e.jsxs(O,{className:"text-sm text-muted-foreground flex items-center gap-2 mt-1",children:[e.jsx(te,{className:"h-3 w-3"}),Js(new Date(A.created_at),{addSuffix:!0})]})]})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(D,{variant:_(A.priority),children:A.priority}),e.jsx(D,{variant:k(A.status),children:A.status}),Q&&e.jsx(D,{variant:S(Q.relationship_status),children:Q.relationship_status.replace("_"," ")})]})]})}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-1",children:A.subject}),e.jsx("p",{className:"text-sm text-muted-foreground",children:A.message})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[E(A.preferred_contact_method),e.jsx("span",{className:"capitalize",children:A.preferred_contact_method.replace("_"," ")})]}),e.jsx(D,{variant:"outline",className:"text-xs",children:A.inquiry_type.replace("_"," ")})]}),Q&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-800",children:"Relationship Status"}),e.jsx("p",{className:"text-sm text-blue-700 capitalize",children:Q.relationship_status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ie,{value:Q.relationship_status,onValueChange:U=>F(Q.id,U),disabled:i,children:[e.jsx(Ee,{className:"w-48",children:e.jsx(Me,{})}),e.jsxs(De,{children:[e.jsx(H,{value:"inquiry",children:"Inquiry"}),e.jsx(H,{value:"consultation_scheduled",children:"Consultation Scheduled"}),e.jsx(H,{value:"consultation_completed",children:"Consultation Completed"}),e.jsx(H,{value:"active",children:"Active Treatment"}),e.jsx(H,{value:"on_hold",children:"On Hold"}),e.jsx(H,{value:"completed",children:"Completed"}),e.jsx(H,{value:"terminated",children:"Terminated"})]})]}),Q.relationship_status==="inquiry"&&A.status==="responded"&&e.jsxs(N,{size:"sm",variant:"outline",onClick:()=>q(A),className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-3 w-3"}),"Schedule"]})]})]}),Q.relationship_notes&&e.jsxs("p",{className:"text-sm text-blue-600 mt-2",children:["Notes: ",Q.relationship_notes]})]}),A.status==="responded"&&A.response_message&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-green-800 mb-1",children:"Your Response:"}),e.jsx("p",{className:"text-sm text-green-700",children:A.response_message})]}),A.status==="pending"&&e.jsx("div",{className:"border-t pt-4",children:c===A.id?e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-3",children:[e.jsx(sa,{value:m,onChange:U=>h(U.target.value),placeholder:"Type your response to the patient...",rows:6}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{onClick:()=>B(A.id),disabled:n||!m.trim(),children:n?"Sending...":"Send Response"}),e.jsx(N,{variant:"outline",onClick:()=>{u(null),h(""),y(null)},children:"Cancel"}),e.jsxs(N,{variant:"outline",onClick:()=>q(A),className:"ml-auto",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Schedule Consultation"]})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(gr,{onSelectTemplate:M,selectedTemplate:f})})]})}):e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{onClick:()=>u(A.id),className:"flex-1",children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),"Respond to Inquiry"]}),e.jsxs(N,{variant:"outline",onClick:()=>q(A),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Schedule"]})]})})]})]},A.id)})})]}),e.jsx(ms,{value:"templates",children:e.jsx(gr,{})}),e.jsx(ms,{value:"analytics",children:e.jsx(Yu,{inquiries:s,relationships:t})})]})]})},Qu=({activeSection:s,isPageLoading:t})=>{const a=se.useRef(null);if(se.useEffect(()=>{a.current&&(a.current.scrollTop=0)},[s]),t)return e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(Bs,{variant:"spinner",size:"lg",text:"Loading dashboard..."})});const r=()=>{switch(s){case"overview":return e.jsx(xr,{});case"inquiries":return e.jsx(Wu,{});case"analytics":return e.jsx(qu,{});case"availability":return e.jsx(Uu,{});case"calendar":return e.jsx($u,{});case"treatment":return e.jsx(zu,{});case"video-sessions":return e.jsx(Hu,{});default:return e.jsx(xr,{})}};return e.jsx("div",{ref:a,className:"flex-1 overflow-y-auto bg-gray-50 h-full",children:e.jsx("div",{className:"max-w-7xl mx-auto px-6 py-6",children:r()})})},Es=class Es{constructor(){J(this,"connections",new Map);J(this,"maxConnections",10);J(this,"maxRetries",3);J(this,"retryDelay",1e3);J(this,"connectionTimeout",1e4);J(this,"errorCount",0)}static getInstance(){return Es.instance||(Es.instance=new Es),Es.instance}async getConnection(t){console.log(`[SimpleConnectionManager] Getting connection: ${t}`);const a=this.connections.get(t);if(a&&a.channel)return a.lastActivity=Date.now(),console.log(`[SimpleConnectionManager] Reusing existing connection: ${t}`),a.channel;this.connections.size>=this.maxConnections&&this.cleanup();try{const{supabase:r}=await ko(async()=>{const{supabase:i}=await Promise.resolve().then(()=>Gc);return{supabase:i}},void 0);console.log(`[SimpleConnectionManager] Creating new channel: ${t}`);const n=r.channel(t,{config:{presence:{key:t}}}),o={id:t,channel:n,lastActivity:Date.now(),retryCount:0};return this.connections.set(t,o),console.log(`[SimpleConnectionManager] Connection created successfully: ${t}`),n}catch(r){throw this.errorCount++,console.error(`[SimpleConnectionManager] Failed to create connection ${t}:`,r),r}}removeConnection(t){const a=this.connections.get(t);if(a!=null&&a.channel)try{a.channel.unsubscribe()}catch(r){console.warn(`[SimpleConnectionManager] Error unsubscribing channel ${t}:`,r)}this.connections.delete(t),console.log(`[SimpleConnectionManager] Connection removed: ${t}`)}getStatus(){return{connected:Array.from(this.connections.values()).filter(a=>a.channel&&a.channel.state==="joined").length,total:this.connections.size,errors:this.errorCount}}cleanup(){const t=Date.now(),a=5*60*1e3;for(const[r,n]of this.connections.entries())t-n.lastActivity>a&&(console.log(`[SimpleConnectionManager] Cleaning up stale connection: ${r}`),this.removeConnection(r))}reset(){console.log("[SimpleConnectionManager] Resetting all connections");for(const t of this.connections.keys())this.removeConnection(t);this.errorCount=0}};J(Es,"instance");let ya=Es;const Ku=(s,t={})=>{const{isAuthenticated:a,isInitialized:r,loading:n}=V(),o=ya.getInstance(),[i,c]=l.useState({isConnected:!1,isConnecting:!1,isDegraded:!1,error:null,retryCount:0}),u=l.useRef(null),m=l.useRef(new Map),h=l.useRef(!0),{enabled:p=!0,retryOnFailure:d=!0,gracefulDegradation:x=!0}=t,j=l.useCallback(async()=>{if(!p||!s||!a||!r||n){console.log("[SimplifiedRealtime] Skipping connection - conditions not met:",{enabled:p,channelId:!0,isAuthenticated:a,isInitialized:r,loading:n});return}if(i.isConnecting||i.isConnected){console.log("[SimplifiedRealtime] Already connecting or connected");return}console.log(`[SimplifiedRealtime] Connecting to channel: ${s}`),c(b=>({...b,isConnecting:!0,error:null}));try{const b=await o.getConnection(s);if(!h.current)return;m.current.forEach((k,S)=>{b.on(S,k)});const _=b.subscribe(k=>{h.current&&(console.log(`[SimplifiedRealtime] Channel ${s} status: ${k}`),c(S=>{const E={...S,isConnecting:!1,isConnected:k==="SUBSCRIBED",isDegraded:k==="CHANNEL_ERROR"&&x,error:k==="CHANNEL_ERROR"&&!x?"Connection failed":null};return k==="CHANNEL_ERROR"&&d&&S.retryCount<3&&(console.log(`[SimplifiedRealtime] Retrying connection (${S.retryCount+1}/3)`),setTimeout(()=>{c(B=>({...B,retryCount:B.retryCount+1})),j()},1e3*(S.retryCount+1))),E}))});u.current=b,console.log(`[SimplifiedRealtime] Connection initiated for: ${s}`)}catch(b){if(console.error(`[SimplifiedRealtime] Connection failed for ${s}:`,b),!h.current)return;c(_=>({..._,isConnecting:!1,isConnected:!1,isDegraded:x,error:x?null:b.message})),b instanceof Error&&b.message.includes("__cf_bm")&&(console.log("[SimplifiedRealtime] Cloudflare Bot Management detected, using degraded mode"),c(_=>({..._,isDegraded:!0,error:null})))}},[s,p,a,r,n,o,i.isConnecting,i.isConnected,d,x]),g=l.useCallback(()=>{u.current&&(console.log(`[SimplifiedRealtime] Disconnecting from: ${s}`),o.removeConnection(s),u.current=null),c(b=>({...b,isConnected:!1,isConnecting:!1,isDegraded:!1,error:null,retryCount:0}))},[s,o]),v=l.useCallback((b,_)=>{m.current.set(b,_),u.current&&u.current.on(b,_)},[]),f=l.useCallback(b=>{m.current.delete(b),u.current&&u.current.off(b)},[]),y=l.useCallback((b,_)=>{if(!i.isConnected||!u.current)return console.warn(`[SimplifiedRealtime] Cannot send ${b}: not connected`),!1;try{return u.current.send({type:"broadcast",event:b,payload:_}),!0}catch(k){return console.error("[SimplifiedRealtime] Send failed:",k),!1}},[i.isConnected]);return l.useEffect(()=>{if(p&&a&&r&&!n){const b=setTimeout(j,100);return()=>clearTimeout(b)}},[p,a,r,n,j]),l.useEffect(()=>()=>{h.current=!1,g()},[g]),{...i,connect:j,disconnect:g,on:v,off:f,send:y}},Ju=()=>{const{user:s,loading:t,isAdmin:a,isTherapist:r,isAuthenticated:n}=V(),{toast:o}=Z(),i=we(),[c,u]=l.useState("overview"),[m,h]=l.useState(!0);Ue("TherapistDashboard","useAuthRBAC");const{isConnected:p,isDegraded:d}=Ku("therapist-dashboard",{enabled:n&&!t,gracefulDegradation:!0});return l.useEffect(()=>{if(t)return;if(!n){console.log("[TherapistDashboard] No authenticated user, will redirect to login");return}if(!r&&!a){console.log("[TherapistDashboard] User doesn't have therapist access, redirecting"),o({title:"Access Restricted",description:"This dashboard is only available to therapists.",variant:"destructive"}),i("/dashboard");return}o({title:"Welcome",description:"Ready to help your patients today."});const x=setTimeout(()=>{h(!1)},300);return()=>clearTimeout(x)},[s,t,r,a,n,o,i]),t?e.jsx(Bs,{variant:"spinner",size:"lg",text:"Loading dashboard...",fullscreen:!0}):n?!r&&!a?e.jsx(Ge,{to:"/dashboard",replace:!0}):e.jsx(Du,{sidebar:e.jsx(Iu,{activeSection:c,setActiveSection:u,isConnected:p,isDegraded:d}),children:e.jsx(Qu,{activeSection:c,isPageLoading:m})}):e.jsx(Ge,{to:"/login",replace:!0})},Xu=({patient:s,onSchedule:t,onViewProfile:a,onSendMessage:r})=>{const n=we(),o=m=>{const h={urgent:"destructive",high:"secondary",medium:"outline",low:"default"};return e.jsx(D,{variant:h[m]||"outline",children:m.charAt(0).toUpperCase()+m.slice(1)})},i=m=>{const h={active:"default",inactive:"secondary",suspended:"destructive"};return e.jsx(D,{variant:h[m]||"outline",children:m.charAt(0).toUpperCase()+m.slice(1)})},c=m=>m.split(" ").map(h=>h[0]).join("").toUpperCase().slice(0,2),u=s.lastSessionDate?Math.floor((Date.now()-new Date(s.lastSessionDate).getTime())/(1e3*60*60*24)):null;return e.jsx(R,{className:"group hover:shadow-lg transition-all duration-300 border-l-4 border-l-primary",children:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(es,{className:"h-12 w-12 bg-primary/10",children:e.jsx(ss,{className:"bg-primary/10 text-primary font-medium",children:c(s.full_name)})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-lg font-semibold leading-none",children:s.full_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email}),s.phone_number&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(Ra,{className:"h-3 w-3"}),s.phone_number]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[i(s.status),o(s.assignment.priority_level)]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{size:"sm",variant:"outline",onClick:()=>{a?a(s.id):n(`/therapist/patient/${s.id}`)},children:[e.jsx(is,{className:"h-4 w-4 mr-1"}),"Profile"]}),e.jsxs(N,{size:"sm",onClick:()=>{t?t(s.id):n(`/therapist/schedule?patient=${s.id}`)},children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"Schedule"]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Assigned"}),e.jsx("div",{className:"font-medium",children:xe(new Date(s.assignment.start_date),"MMM d, yyyy")})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Sessions"}),e.jsxs("div",{className:"font-medium flex items-center justify-center gap-1",children:[e.jsx(qs,{className:"h-4 w-4 text-green-600"}),s.totalSessions]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Last Session"}),e.jsx("div",{className:"font-medium",children:s.lastSessionDate?e.jsxs("div",{children:[e.jsx("div",{children:xe(new Date(s.lastSessionDate),"MMM d")}),u&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:[u," days ago"]})]}):e.jsx("span",{className:"text-muted-foreground",children:"None"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Next Session"}),e.jsx("div",{className:"font-medium",children:s.upcomingSessionDate?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(te,{className:"h-3 w-3 text-blue-600"}),xe(new Date(s.upcomingSessionDate),"MMM d")]}):e.jsx("span",{className:"text-muted-foreground",children:"None"})})]})]}),s.assignment.assignment_reason&&e.jsxs("div",{className:"mt-4 p-3 bg-muted/50 rounded-lg",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-1",children:"Assignment Reason"}),e.jsx("div",{className:"text-sm",children:s.assignment.assignment_reason})]}),e.jsx("div",{className:"mt-4 flex gap-2",children:e.jsxs(N,{size:"sm",variant:"ghost",onClick:()=>r==null?void 0:r(s.id),className:"flex-1",children:[e.jsx(qe,{className:"h-4 w-4 mr-1"}),"Message"]})})]})})},Zu=({searchTerm:s,onSearchChange:t,statusFilter:a,onStatusFilterChange:r,priorityFilter:n,onPriorityFilterChange:o,sortBy:i,onSortByChange:c,sortOrder:u,onSortOrderChange:m,onClearFilters:h,totalPatients:p,filteredCount:d})=>{const x=s||a!=="all"||n!=="all";return e.jsx(R,{children:e.jsxs(T,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Da,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(Ne,{placeholder:"Search by name, email, or assignment reason...",value:s,onChange:j=>t(j.target.value),className:"pl-10"})]}),x&&e.jsxs(N,{variant:"outline",size:"sm",onClick:h,className:"shrink-0",children:[e.jsx(rs,{className:"h-4 w-4 mr-1"}),"Clear"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bc,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Filters:"})]}),e.jsxs(Ie,{value:a,onValueChange:r,children:[e.jsx(Ee,{className:"w-[140px]",children:e.jsx(Me,{placeholder:"Status"})}),e.jsxs(De,{children:[e.jsx(H,{value:"all",children:"All Status"}),e.jsx(H,{value:"active",children:"Active"}),e.jsx(H,{value:"inactive",children:"Inactive"}),e.jsx(H,{value:"suspended",children:"Suspended"})]})]}),e.jsxs(Ie,{value:n,onValueChange:o,children:[e.jsx(Ee,{className:"w-[140px]",children:e.jsx(Me,{placeholder:"Priority"})}),e.jsxs(De,{children:[e.jsx(H,{value:"all",children:"All Priority"}),e.jsx(H,{value:"urgent",children:"Urgent"}),e.jsx(H,{value:"high",children:"High"}),e.jsx(H,{value:"medium",children:"Medium"}),e.jsx(H,{value:"low",children:"Low"})]})]}),e.jsxs("div",{className:"flex items-center gap-1 ml-auto",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sort:"}),e.jsxs(Ie,{value:i,onValueChange:c,children:[e.jsx(Ee,{className:"w-[160px]",children:e.jsx(Me,{})}),e.jsxs(De,{children:[e.jsx(H,{value:"name",children:"Name"}),e.jsx(H,{value:"assigned_date",children:"Assigned Date"}),e.jsx(H,{value:"last_session",children:"Last Session"}),e.jsx(H,{value:"total_sessions",children:"Total Sessions"}),e.jsx(H,{value:"priority",children:"Priority"})]})]}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>m(u==="asc"?"desc":"asc"),children:u==="asc"?e.jsx(Oc,{className:"h-4 w-4"}):e.jsx(Fc,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex items-center justify-between text-sm text-muted-foreground border-t pt-3",children:e.jsxs("div",{children:["Showing ",d," of ",p," patients",x&&e.jsx(D,{variant:"secondary",className:"ml-2",children:"Filtered"})]})})]})})},eh=({totalPatients:s,activePatients:t,inactivePatients:a,urgentPatients:r,sessionsThisWeek:n,upcomingSessions:o,overduePatients:i,averageSessionsPerPatient:c})=>{const u=s>0?t/s*100:0,m=[{title:"Total Patients",value:s,icon:de,trend:null,color:"text-blue-600",bgColor:"bg-blue-50"},{title:"Active Patients",value:t,icon:fe,trend:`${u.toFixed(1)}% of total`,color:"text-green-600",bgColor:"bg-green-50"},{title:"Urgent Cases",value:r,icon:_e,trend:r>0?"Requires attention":"All good",color:r>0?"text-red-600":"text-green-600",bgColor:r>0?"bg-red-50":"bg-green-50"},{title:"Sessions This Week",value:n,icon:X,trend:null,color:"text-purple-600",bgColor:"bg-purple-50"},{title:"Upcoming Sessions",value:o,icon:te,trend:null,color:"text-orange-600",bgColor:"bg-orange-50"},{title:"Overdue Follow-ups",value:i,icon:Lc,trend:i>0?"Need scheduling":"Up to date",color:i>0?"text-red-600":"text-green-600",bgColor:i>0?"bg-red-50":"bg-green-50"}];return e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6",children:m.map(h=>{const p=h.icon;return e.jsx(R,{className:"relative overflow-hidden",children:e.jsx(T,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:h.title}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-2xl font-bold",children:h.value}),h.value>0&&h.title==="Urgent Cases"&&e.jsx(D,{variant:"destructive",className:"text-xs",children:"!"})]}),h.trend&&e.jsx("p",{className:`text-xs ${h.color.replace("text-","text-")}`,children:h.trend})]}),e.jsx("div",{className:`p-2 rounded-full ${h.bgColor}`,children:e.jsx(p,{className:`h-5 w-5 ${h.color}`})})]})})},h.title)})})},sh=()=>{const s=we(),{toast:t}=Z(),{user:a}=V(),[r,n]=l.useState(""),[o,i]=l.useState("all"),[c,u]=l.useState("all"),[m,h]=l.useState("name"),[p,d]=l.useState("asc"),{data:x=[],isLoading:j,isError:g,error:v}=le({queryKey:["patients",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:$,error:Y}=await w.from("patient_assignments").select("id, patient_id, start_date, status, priority_level, assignment_reason").eq("therapist_id",a.id).eq("status","active");if(Y)throw console.error("Error fetching patient assignments:",Y),new Error(Y.message);if(!$||$.length===0)return[];const U=$.map(W=>W.patient_id),{data:G,error:ee}=await w.from("profiles").select("id, full_name, email, phone_number, status, created_at").in("id",U);if(ee)throw console.error("Error fetching patient profiles:",ee),new Error(ee.message);const{data:K,error:ie}=await w.from("appointments").select("patient_id, start_time, status").in("patient_id",U).eq("therapist_id",a.id).order("start_time",{ascending:!1});if(ie)throw console.error("Error fetching appointments:",ie),new Error(ie.message);return $.map(W=>{const ae=G==null?void 0:G.find(he=>he.id===W.patient_id);if(!ae)return console.warn(`Profile not found for patient_id: ${W.patient_id}`),null;const Te=(K==null?void 0:K.filter(he=>he.patient_id===ae.id))||[],Ye=Te.filter(he=>he.status==="completed"),ze=Te.filter(he=>he.status==="scheduled"&&new Date(he.start_time)>new Date),ts=Ye.length>0?Ye[0].start_time:void 0,ys=ze.length>0?ze[ze.length-1].start_time:void 0;return{id:ae.id,full_name:ae.full_name||"Unknown",email:ae.email||"",phone_number:ae.phone_number,status:ae.status||"active",created_at:ae.created_at,assignment:{id:W.id,start_date:W.start_date,status:W.status,priority_level:W.priority_level,assignment_reason:W.assignment_reason},lastSessionDate:ts,upcomingSessionDate:ys,totalSessions:Ye.length}}).filter(Boolean)},enabled:!!(a!=null&&a.id)}),f=l.useMemo(()=>x?x.filter($=>{const Y=new RegExp(r,"i"),U=Y.test($.full_name)||Y.test($.email)||($.assignment.assignment_reason?Y.test($.assignment.assignment_reason):!1),G=o==="all"||$.status===o,ee=c==="all"||$.assignment.priority_level===c;return U&&G&&ee}):[],[x,r,o,c]),y=l.useMemo(()=>{if(!f)return[];const $=[...f];return $.sort((Y,U)=>{let G=0;switch(m){case"name":G=Y.full_name.localeCompare(U.full_name);break;case"assigned_date":G=new Date(Y.assignment.start_date).getTime()-new Date(U.assignment.start_date).getTime();break;case"last_session":const ee=Y.lastSessionDate?new Date(Y.lastSessionDate).getTime():0,K=U.lastSessionDate?new Date(U.lastSessionDate).getTime():0;G=ee-K;break;case"total_sessions":G=Y.totalSessions-U.totalSessions;break;case"priority":const ie={urgent:1,high:2,medium:3,low:4},pe=ie[Y.assignment.priority_level]||5,W=ie[U.assignment.priority_level]||5;G=pe-W;break;default:G=Y.full_name.localeCompare(U.full_name)}return p==="asc"?G:-G}),$},[f,m,p]),b=x.length,_=x.filter($=>$.status==="active").length,k=x.filter($=>$.status==="inactive").length,S=x.filter($=>$.assignment.priority_level==="urgent").length,E=x.filter($=>$.upcomingSessionDate).length,B=x.reduce(($,Y)=>$+Y.totalSessions,0),M=b>0?B/b:0,q=new Date;q.setDate(q.getDate()-q.getDay()),q.setHours(0,0,0,0);const F=new Date(q);F.setDate(q.getDate()+6),F.setHours(23,59,59,999);const P=x.filter($=>{if(!$.lastSessionDate)return!1;const Y=new Date($.lastSessionDate);return Y>=q&&Y<=F}).length,L=new Date;L.setDate(L.getDate()-30);const A=x.filter($=>$.lastSessionDate?new Date($.lastSessionDate)<L:!0).length,Q=()=>{n(""),i("all"),u("all")};return j?e.jsx("div",{children:"Loading patients..."}):g?e.jsxs("div",{children:["Error fetching patients: ",(v==null?void 0:v.message)||"Unknown error"]}):e.jsxs("div",{className:"container mx-auto py-8",children:[e.jsx("div",{className:"mb-8",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Patient Management"})}),e.jsx(eh,{totalPatients:b,activePatients:_,inactivePatients:k,urgentPatients:S,sessionsThisWeek:P,upcomingSessions:E,overduePatients:A,averageSessionsPerPatient:M}),e.jsx("div",{className:"mt-6",children:e.jsx(Zu,{searchTerm:r,onSearchChange:n,statusFilter:o,onStatusFilterChange:i,priorityFilter:c,onPriorityFilterChange:u,sortBy:m,onSortByChange:h,sortOrder:p,onSortOrderChange:d,onClearFilters:Q,totalPatients:b,filteredCount:f.length})}),e.jsx("div",{className:"mt-6 grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:y.map($=>e.jsx(Xu,{patient:$,onViewProfile:Y=>s(`/therapist/patient/${Y}`),onSchedule:Y=>s(`/therapist/schedule?patient=${Y}`),onSendMessage:Y=>{t({title:"Send Message",description:`Feature not implemented.  Would send message to patient ${Y}`})}},$.id))})]})},th=()=>{const{isTherapist:s,isAdmin:t,loading:a}=V();return a?e.jsx("div",{children:"Loading..."}):!s&&!t?(console.log("[TherapistRoutes] Non-therapist user, redirecting to patient dashboard"),e.jsx(Ge,{to:"/patient",replace:!0})):e.jsxs(Ot,{children:[e.jsx(ge,{path:"/",element:e.jsx(Ju,{})}),e.jsx(ge,{path:"/patients",element:e.jsx(sh,{})})]})},ah=({children:s,allowedRoles:t=[],redirectPath:a="/login",requireAll:r=!1,silent:n=!1,...o})=>{const{user:i,loading:c,hasAnyRole:u,hasAllRoles:m,roles:h}=V(),{toast:p}=Z(),d=vs();return c?e.jsx(Bs,{variant:"spinner",text:"Verifying permissions...",size:"md",className:"min-h-[200px]"}):i?t.length>0&&!(r?m(t):u(t))?(n||p({title:"Access Denied",description:"You don't have permission to access this page.",variant:"destructive"}),h.includes("admin")?e.jsx(Ge,{to:"/admin",replace:!0}):h.includes("therapist")?e.jsx(Ge,{to:"/therapist",replace:!0}):h.includes("patient")?e.jsx(Ge,{to:"/patient",replace:!0}):e.jsx(Ge,{to:"/login",replace:!0})):e.jsx("div",{...o,children:s}):(n||p({title:"Authentication Required",description:"Please log in to access this page.",variant:"destructive"}),e.jsx(Ge,{to:"/login",state:{from:d.pathname},replace:!0}))},rh=()=>{const{user:s}=V(),[t,a]=l.useState([]),{data:r,isLoading:n,error:o}=le({queryKey:["realtime-notifications",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];const{data:i,error:c}=await w.from("notifications").select("*").eq("user_id",s.id).order("created_at",{ascending:!1});if(c)throw console.error("Error fetching notifications:",c),c;return i||[]},enabled:!!(s!=null&&s.id)});return l.useEffect(()=>{r&&a(r)},[r]),l.useEffect(()=>{if(!(s!=null&&s.id))return;const i=w.channel("public:notifications").on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:`user_id=eq.${s.id}`},c=>{console.log("Change received!",c),a(u=>{const m=c.new;if(m&&m.id){const h=u.findIndex(p=>p.id===m.id);if(h!==-1){const p=[...u];return p[h]=m,p}else return[m,...u]}return u})}).subscribe();return()=>{w.removeChannel(i)}},[s==null?void 0:s.id]),{notifications:t,isLoading:n,error:o}},nh=({children:s,title:t,description:a})=>(rh(),e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs(Bt,{children:[e.jsx("title",{children:t?`${t} | Therapy Platform`:"Therapy Platform"}),a&&e.jsx("meta",{name:"description",content:a})]}),e.jsx(va,{}),e.jsx("main",{className:"flex-1",children:s})]})),ih=()=>{const{user:s}=V();return e.jsx(ah,{allowedRoles:["admin"],children:e.jsxs(nh,{children:[e.jsx(Bt,{children:e.jsx("title",{children:"Admin Dashboard | MindBloom"})}),e.jsxs("div",{className:"container mx-auto p-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Admin Dashboard"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Total Users"}),e.jsx(de,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:"1,234"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+12% from last month"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Security Events"}),e.jsx(Ms,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:"23"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Last 24 hours"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Active Sessions"}),e.jsx(pa,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:"89"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Currently online"})]})]}),e.jsxs(R,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(O,{className:"text-sm font-medium",children:"Alerts"}),e.jsx(_e,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"text-2xl font-bold",children:"5"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Requiring attention"})]})]})]})]})]})})},oh=()=>{const{isAdmin:s,loading:t}=V();return t?e.jsx("div",{children:"Loading..."}):s?e.jsx(Ot,{children:e.jsx(ge,{path:"/",element:e.jsx(ih,{})})}):(console.log("[AdminRoutes] Non-admin user, redirecting to patient dashboard"),e.jsx(Ge,{to:"/patient",replace:!0}))},Zi=({text:s="Loading...",className:t=""})=>e.jsx("div",{className:`flex items-center justify-center min-h-[200px] ${t}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:s})]})}),xs=({children:s,redirectPath:t,...a})=>{const{user:r,loading:n,isAuthenticated:o}=V(),i=vs();if(Ue("AuthRoute","useAuthRBAC"),n)return e.jsx(Zi,{text:"Verifying authentication..."});if(!o){const c=t||ol();return e.jsx(Ge,{to:c,state:{from:i.pathname},replace:!0})}return e.jsx("div",{...a,children:s})},la=({children:s,redirectPath:t})=>{const{user:a,loading:r,primaryRole:n,isInitialized:o}=V(),i=vs();if(Ue("GuestRoute","useAuthRBAC"),r||!o)return e.jsx(Zi,{text:"Checking authentication..."});if(a&&n){const c=t||Gs(n);return e.jsx(Ge,{to:c,replace:!0,state:{from:i.pathname}})}return e.jsx(e.Fragment,{children:s})},ch=()=>{const{isAuthenticated:s,loading:t,isInitialized:a}=V();return console.log("[AppRouter] Current state:",{isAuthenticated:s,loading:t,isInitialized:a}),!a||t?e.jsx(Bs,{variant:"spinner",size:"lg",text:"Loading application...",fullscreen:!0}):e.jsxs(il,{children:[e.jsxs(Ot,{children:[e.jsx(ge,{path:"/",element:e.jsx(Wl,{})}),e.jsx(ge,{path:"/login",element:e.jsx(la,{children:e.jsx(na,{})})}),e.jsx(ge,{path:"/register",element:e.jsx(la,{children:e.jsx(na,{})})}),e.jsx(ge,{path:"/auth",element:e.jsx(la,{children:e.jsx(na,{})})}),e.jsx(ge,{path:"/dashboard",element:e.jsx(xs,{children:e.jsx(wm,{})})}),e.jsx(ge,{path:"/profile",element:e.jsx(xs,{children:e.jsx(cd,{})})}),e.jsx(ge,{path:"/admin/*",element:e.jsx(xs,{children:e.jsx(oh,{})})}),e.jsx(ge,{path:"/therapist/*",element:e.jsx(xs,{children:e.jsx(th,{})})}),e.jsx(ge,{path:"/patient/*",element:e.jsx(xs,{children:e.jsx(Eu,{})})}),e.jsx(ge,{path:"/session/:appointmentId",element:e.jsx(xs,{children:e.jsx(mr,{})})}),e.jsx(ge,{path:"/video/:appointmentId",element:e.jsx(xs,{children:e.jsx(mr,{})})}),e.jsx(ge,{path:"/video-conference/:sessionId",element:e.jsx(xs,{children:e.jsx(xm,{})})}),e.jsx(ge,{path:"/session/instant/:token",element:e.jsx(xs,{children:e.jsx(Jd,{})})}),e.jsx(ge,{path:"/mobile-optimization",element:e.jsx(bm,{})}),e.jsx(ge,{path:"*",element:e.jsx(Ge,{to:"/login",replace:!0})})]}),e.jsx(dl,{})]})},lh=new kr;function dh(){return e.jsx(_r,{client:lh,children:e.jsxs(Pa,{children:[e.jsx(qc,{}),e.jsx(el,{showHealthIndicator:!1,children:e.jsx(ch,{})}),e.jsx(_o,{})]})})}const fr=tc,ba=l.forwardRef(({className:s,...t},a)=>e.jsx(jn,{ref:a,className:C("fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",s),...t}));ba.displayName=jn.displayName;const mh=Fs("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground",warning:"border-amber-500 bg-amber-500/10 text-amber-700 dark:text-amber-400",success:"border-green-500 bg-green-500/10 text-green-700 dark:text-green-400",secondary:"border bg-secondary text-secondary-foreground",outline:"border border-input bg-transparent"}},defaultVariants:{variant:"default"}}),eo=l.forwardRef(({className:s,variant:t,...a},r)=>e.jsx(vn,{ref:r,className:C(mh({variant:t}),s),...a}));eo.displayName=vn.displayName;const uh=l.forwardRef(({className:s,...t},a)=>e.jsx(yn,{ref:a,className:C("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",s),...t}));uh.displayName=yn.displayName;const so=l.forwardRef(({className:s,...t},a)=>e.jsx(bn,{ref:a,className:C("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",s),"toast-close":"",...t,children:e.jsx(rs,{className:"h-4 w-4"})}));so.displayName=bn.displayName;const to=l.forwardRef(({className:s,...t},a)=>e.jsx(wn,{ref:a,className:C("text-sm font-semibold",s),...t}));to.displayName=wn.displayName;const ao=l.forwardRef(({className:s,...t},a)=>e.jsx(Nn,{ref:a,className:C("text-sm opacity-90",s),...t}));ao.displayName=Nn.displayName;function hh(){const{toasts:s}=Z();return!s||!Array.isArray(s)?l.createElement(fr,null,l.createElement(ba,{key:"viewport"})):l.createElement(fr,null,[...s.map(function({id:t,title:a,description:r,action:n,...o}){return l.createElement(eo,{key:t,...o},[l.createElement("div",{className:"grid gap-1",key:"content"},[a?l.createElement(to,{key:"title"},a):null,r?l.createElement(ao,{key:"desc"},r):null].filter(Boolean)),n,l.createElement(so,{key:"close"})])}),l.createElement(ba,{key:"viewport"})])}class jr extends l.Component{constructor(a){super(a);J(this,"handleRetry",()=>{this.setState({hasError:!1,error:void 0,errorInfo:void 0,errorId:Math.random().toString(36).substr(2,9)})});this.state={hasError:!1,errorId:Math.random().toString(36).substr(2,9)}}static getDerivedStateFromError(a){return{hasError:!0,error:a,errorId:Math.random().toString(36).substr(2,9)}}componentDidCatch(a,r){console.error("[ErrorBoundary] Caught error:",{error:a.message,stack:a.stack,componentStack:r.componentStack,errorId:this.state.errorId}),this.setState({error:a,errorInfo:r}),this.props.onError&&this.props.onError(a,r)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gray-50",children:e.jsxs(R,{className:"w-full max-w-lg",children:[e.jsxs(I,{className:"text-center",children:[e.jsx(_e,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx(O,{children:"Application Error"}),e.jsx(me,{children:"Something went wrong. Please try refreshing or contact support if the problem persists."})]}),e.jsxs(T,{className:"space-y-4",children:[!1,e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{onClick:this.handleRetry,className:"flex-1",variant:"default",children:[e.jsx(ns,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(N,{onClick:()=>window.location.reload(),className:"flex-1",variant:"outline",children:"Refresh Page"})]}),!1]})]})}):this.props.children}}const ph=({children:s})=>{const[t]=se.useState(()=>new kr({defaultOptions:{queries:{staleTime:3e5,refetchOnWindowFocus:!1,retry:1}}}));return e.jsx(jr,{children:e.jsx(Ro,{children:e.jsx(_r,{client:t,children:e.jsx(To,{children:e.jsx(ml,{children:e.jsx(Pa,{children:e.jsx(_l,{children:e.jsx(jr,{children:e.jsxs(nl,{children:[s,e.jsx(hh,{})]})})})})})})})})})},ro=document.getElementById("root");if(!ro)throw new Error("Root element not found");const xh=Ao(ro);xh.render(e.jsx(ph,{children:e.jsx(dh,{})}));
